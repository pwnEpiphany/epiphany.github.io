

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/head.png">
  <link rel="icon" href="/img/head.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Epiphany">
  <meta name="keywords" content="">
  
    <meta name="description" content="üòÑÂ†Ü‰∏äÁöÑÁü•ËØÜÂ•ΩÂÉèÈÉΩ‰∏çËÆ∞Âæó‰∫ÜÔºå‰∏ìÈó®ÂÅöÊÄªÁªìÂõûÈ°æ‰∏Ä‰∏ãÔºå‰ª•ÂêéÂÜçÂõûÊù•ÁúãÂ∞±Ê≤°ÂøÖË¶ÅÈáçÊñ∞ÂºÄÂßãÂ≠¶‰π†„ÄÇ basic Âá†ÁßçbinsÁöÑËøõÂÖ•ÈÄÄÂá∫ÊñπÂºè   fastbinÔºö FILOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•ÂíåÂèñÂá∫   unsorted binÔºö FIFOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•Ôºå‰ªéÂ∞æÈÉ®ÂèñÂá∫   tcacheÔºö LIFOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•ÔºåÂ§¥ÈÉ®ÂèñÂá∫   mmapÂáΩÊï∞ÂàÜÈÖçÁöÑÊò†Â∞ÑÁ©∫Èó¥ÂíåmallocÂàÜÈÖçÁöÑÁ©∫Èó¥‰∏ç‰∏ÄÊ†∑ÔºåÊúâ‰∏Ä‰∏™Ë¶ÅÊ≥®ÊÑèÁöÑÂú∞ÊñπÊòØÔºåmmapÂá∫Êù•ÁöÑÂú∞ÂùÄÂíål">
<meta property="og:type" content="article">
<meta property="og:title" content="Â†ÜÂà©Áî®ÂõûÈ°æ">
<meta property="og:url" content="http://example.com/2022/11/22/%E5%A0%86%E5%88%A9%E7%94%A8%E5%9B%9E%E9%A1%BE/index.html">
<meta property="og:site_name" content="Epiphany&#39;s blog">
<meta property="og:description" content="üòÑÂ†Ü‰∏äÁöÑÁü•ËØÜÂ•ΩÂÉèÈÉΩ‰∏çËÆ∞Âæó‰∫ÜÔºå‰∏ìÈó®ÂÅöÊÄªÁªìÂõûÈ°æ‰∏Ä‰∏ãÔºå‰ª•ÂêéÂÜçÂõûÊù•ÁúãÂ∞±Ê≤°ÂøÖË¶ÅÈáçÊñ∞ÂºÄÂßãÂ≠¶‰π†„ÄÇ basic Âá†ÁßçbinsÁöÑËøõÂÖ•ÈÄÄÂá∫ÊñπÂºè   fastbinÔºö FILOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•ÂíåÂèñÂá∫   unsorted binÔºö FIFOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•Ôºå‰ªéÂ∞æÈÉ®ÂèñÂá∫   tcacheÔºö LIFOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•ÔºåÂ§¥ÈÉ®ÂèñÂá∫   mmapÂáΩÊï∞ÂàÜÈÖçÁöÑÊò†Â∞ÑÁ©∫Èó¥ÂíåmallocÂàÜÈÖçÁöÑÁ©∫Èó¥‰∏ç‰∏ÄÊ†∑ÔºåÊúâ‰∏Ä‰∏™Ë¶ÅÊ≥®ÊÑèÁöÑÂú∞ÊñπÊòØÔºåmmapÂá∫Êù•ÁöÑÂú∞ÂùÄÂíål">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png">
<meta property="article:published_time" content="2022-11-22T00:30:58.000Z">
<meta property="article:modified_time" content="2022-11-26T00:19:54.131Z">
<meta property="article:author" content="Epiphany">
<meta property="article:tag" content="heap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png">
  
  
  
  <title>Â†ÜÂà©Áî®ÂõûÈ°æ - Epiphany&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/test.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"üòä","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"syTAHbVDGa0ZSug10p7Z9QM4-gzGzoHsz","app_key":"BDZY8j2r1l97VE3uLcsrU2Vd","server_url":"https://sytahbvd.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Epiphany&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                È¶ñÈ°µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                ÂΩíÊ°£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-category-fill"></i>
                ÂàÜÁ±ª
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/CTF">
                    
                    CTF
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/CVE">
                    
                    CVE
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/others">
                    
                    others
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/chats">
                    
                    chats
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Ê†áÁ≠æ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                ÂÖ≥‰∫é
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Â†ÜÂà©Áî®ÂõûÈ°æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-22 08:30" pubdate>
          ÊòüÊúü‰∫å, ÂçÅ‰∏ÄÊúà 22Êó• 2022, 8:30 Êó©‰∏ä
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          16k Â≠ó
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          131 ÂàÜÈíü
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> Ê¨°
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Â†ÜÂà©Áî®ÂõûÈ°æ</h1>
            
            
              <div class="markdown-body">
                
                <p>üòÑÂ†Ü‰∏äÁöÑÁü•ËØÜÂ•ΩÂÉèÈÉΩ‰∏çËÆ∞Âæó‰∫ÜÔºå‰∏ìÈó®ÂÅöÊÄªÁªìÂõûÈ°æ‰∏Ä‰∏ãÔºå‰ª•ÂêéÂÜçÂõûÊù•ÁúãÂ∞±Ê≤°ÂøÖË¶ÅÈáçÊñ∞ÂºÄÂßãÂ≠¶‰π†„ÄÇ</p>
<h1>basic</h1>
<p><strong>Âá†ÁßçbinsÁöÑËøõÂÖ•ÈÄÄÂá∫ÊñπÂºè</strong></p>
<ul>
<li>
<p>fastbinÔºö FILOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•ÂíåÂèñÂá∫</p>
</li>
<li>
<p>unsorted binÔºö FIFOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•Ôºå‰ªéÂ∞æÈÉ®ÂèñÂá∫</p>
</li>
<li>
<p>tcacheÔºö LIFOÔºå‰ªéÂ§¥ÈÉ®ÊèíÂÖ•ÔºåÂ§¥ÈÉ®ÂèñÂá∫</p>
</li>
</ul>
<p><strong>mmap</strong>ÂáΩÊï∞ÂàÜÈÖçÁöÑÊò†Â∞ÑÁ©∫Èó¥ÂíåmallocÂàÜÈÖçÁöÑÁ©∫Èó¥‰∏ç‰∏ÄÊ†∑ÔºåÊúâ‰∏Ä‰∏™Ë¶ÅÊ≥®ÊÑèÁöÑÂú∞ÊñπÊòØÔºåmmapÂá∫Êù•ÁöÑÂú∞ÂùÄÂíå<strong>libcÂü∫ÂùÄ</strong>Â≠òÂú®Âõ∫ÂÆöÁöÑÂÅèÁßªÔºåÂú®leakÁöÑÊó∂ÂÄôÂèØ‰ª•ËÄÉËôë„ÄÇ</p>
<h2 id="fastbinÁöÑ‰∏Ä‰∫õÊú∫Âà∂"><a class="header-anchor" href="#fastbinÁöÑ‰∏Ä‰∫õÊú∫Âà∂">¬∂</a>fastbinÁöÑ‰∏Ä‰∫õÊú∫Âà∂</h2>
<p>È¶ñÂÖàÔºåfastbin‰∏ÄËà¨ÊÉÖÂÜµ‰∏ã‰∏ç‰ºöÂèëÁîüÂêàÂπ∂ÔºåÈô§ÈùûËß¶Âèë<code>malloc_consolidate()</code>ÔºåÂΩì‰∏Ä‰∏™Â†ÜÂùóÂä†Ëøõ<code>fast bin</code>ÁöÑÊó∂ÂÄôÔºå‰∏ç‰ºöÊ£ÄÊü•‰∏ã‰∏Ä‰∏™chunkÁöÑ<code>prev_inuse</code>ÔºåËøô‰πüÊÑèÂë≥ÁùÄÔºåfastbinÂ§ßÂ∞èÁöÑchunkË¢´‰ΩøÁî®ÂíåÈáäÊîæÈÉΩ‰∏ç‰ºöËß¶ÂèëÂíå‰∏ã‰∏Ä‰∏™chunkÊúâÂÖ≥ÁöÑÂÆâÂÖ®Êú∫Âà∂„ÄÇ</p>
<p>‰ΩÜÊòØfastbinÂú®ÈáäÊîæÁöÑÊó∂ÂÄô‰ºöÊ£ÄÊü•Ëá™Â∑±ÁöÑsizeÂ§ßÂ∞èÔºåÁÑ∂ÂêéÊîæÂÖ•Âà∞ÂêàÈÄÇÁöÑfastbinÈìæ‰∏≠ÔºåÂêåÊ†∑ÁöÑÔºå‰ªéfastbin‰∏≠ÂèñÂá∫Êó∂Ôºå‰πü‰ºöÊ£ÄÊü•sizeÁöÑÂ§ßÂ∞èÊòØÂê¶ÂíåÂΩìÂâçÈìæÁõ∏Á¨¶ÂêàÔºåËøôË¶ÅÊ±ÇÂêéÁª≠‰º™ÈÄ†fastbin chunkÁöÑÊó∂ÂÄôÊ≥®ÊÑè<code>size</code></p>
<p><strong>malloc_consolidate</strong>Ôºö ÂΩìÁî≥ËØ∑‰∏Ä‰∏™Â§ß‰∫é<code>large chunk</code>ÊúÄÂ∞èÂ§ßÂ∞è‰πãÂêéÔºàÂåÖÊã¨ÂΩìÁî≥ËØ∑ÁöÑ<code>chunk</code>ÈúÄË¶ÅË∞ÉÁî®<code>brk()</code>Áî≥ËØ∑Êñ∞ÁöÑ<code>top chunk</code>ÊàñË∞ÉÁî®<code>mmap()</code>ÂáΩÊï∞Êó∂ÔºâÔºå<strong>Ëß¶Âèëmalloc_consolidate</strong>ÔºåÁ®ãÂ∫è‰ºöÂ∞Ü<code>fastbin</code>ÂÜÖÁöÑchunkÂèñÂá∫ÔºåÁõ∏ÈÇªÁöÑf<code>ree chunk</code>ÂêàÂπ∂ÂêéÊîæÂÖ•<code>unsorted bin</code>ÔºåÊ≠§Êó∂ÂÆåÊàê‰∫ÜËØ•ÂÆåÊàêÁöÑÊâÄÊúâÂêàÂπ∂‰πãÂêéÔºåÂØªÊâæ‰πãÂâçmallocÁöÑlarge chunkÔºåÁêÜËÆ∫‰∏äsmall binÊó†Ê≥ïÊª°Ë∂≥ÈúÄÊ±ÇÔºå‰∫éÊòØ‰ºöÈÅçÂéÜ<code>unsorted bin</code>ÔºåÊ≠§Êó∂<code>unsorted bin</code>Â∞Ü‰πãÂâçÂêàÂπ∂ÁöÑ<code>chunk</code>ÂÆåÊàêÂÜçÂàÜÈÖç„ÄÇ</p>
<p>ÂèØ‰ª•È¢ÑËßÅÂà∞ÊúÄÂêéÁöÑÊïàÊûúÊòØ<code>fast bin</code>‰∏≠ÁöÑchunkË¢´Â°´ÂÖ•‰∫Ü<code>small bin</code>ÔºåÊàñËÄÖÂêàÂπ∂Âà∞‰∫Üunsorted binÔºåË¢´ÂêûÂÖ•‰∫Ü<code>top chunk</code>„ÄÇ</p>
<h2 id="unsorted-bin"><a class="header-anchor" href="#unsorted-bin">¬∂</a>unsorted bin</h2>
<p>unsorted bin‰∏ÄËà¨ÊòØ<code>leak</code>ÁöÑ‰∏ªË¶ÅÂú∞ÁÇπÔºåÂíåfast bin‰∏çÂêåÁöÑÊòØÔºåunsorted binÊòØ‰∏Ä‰∏™ÂèåÂêëÈìæË°®ÔºåÁî±<code>fd</code>Âíå<code>bk</code>ÈìæÊé•Ôºå‰∏ªË¶ÅËøòÊòØÁî±<code>bk</code>ÈÅçÂéÜÔºàÊ∫êÁ†ÅÂÜ≥ÂÆöÔºâ<code>A&lt;-B&lt;-C</code>Ëøõ‰∏Ä‰∏™<code>D</code>Âèò‰∏∫<code>D&lt;-A&lt;-B&lt;-C</code>ÔºåÊãøÂá∫‰∏Ä‰∏™<code>C</code>ÔºåÂèò‰∏∫<code>D&lt;-A&lt;-B</code>„ÄÇ<code>bin</code>‰∏≠Â†ÜÂùóÂ§ßÂ∞èÂèØ‰ª•‰∏çÂêåÔºå‰∏çÊéíÂ∫è„ÄÇ</p>
<p><strong>Ê≥ÑÈú≤libc</strong>ÔºåËøôÊòØÂõ†‰∏∫<code>unsorted bin</code>‰∏≠ÊúÄÂÖàËøõÊù•ÁöÑchunkÔºåÂÖ∂‰∏≠<code>fd</code>Âíå<code>bk</code>ÈÉΩÊåáÂêë<code>bin</code>ÔºåËÄåËøô‰∏™<code>bin</code>ÔºåÂ≠òÂú®‰∫é<code>main_arena</code>ÁöÑÁªìÊûÑ‰Ωì‰∏≠ÔºåÂú®64‰Ωç‰ΩéÁâàÊú¨ÁöÑlibc‰∏≠Ôºå‰∏ÄËà¨ÊòØ<code>&lt;main_arena+88&gt;</code>ÔºåÁâàÊú¨Á®çÂæÆÈ´ò‰∏ÄÁÇπÂ∞±Âú®<code>&lt;main_arena+96&gt;</code>Ôºå‰∏ÄËà¨Ê≥ÑÈú≤libcÈÉΩ‰ºöÂà©Áî®Ëøô‰∏™Âú∞ÂùÄ„ÄÇ</p>
<p>ÂêåÊó∂main_arenaÁöÑÂú∞ÂùÄÂíåmalloc_hookÂæàËøëÔºåÂç≥<code>malloc_hook+0x10=main_arena</code></p>
<h2 id="large-bin"><a class="header-anchor" href="#large-bin">¬∂</a>large bin</h2>
<p>ËøôÊòØ‰∏Ä‰∏™ÈáçÁÇπÔºåÂú®Áé∞Âú®È´òÁâàÊú¨ÁöÑlibc‰∏≠ÔºåÂá†‰πéÈÉΩÊòØÁî®large bin attackÂä†‰∏äÂÖ∂‰ªñÁöÑÊâãÊ≥ïÊîªÂáªÔºålarge binÊòØÂèåÈìæË°®Áª¥Êä§Ôºå‰ΩÜÊòØÁª¥Êä§ÁöÑÊñπÂºèÊúâÁÇπÁâπÂà´Ôºå‰∏çÂÜçÊòØÂçï‰∏ÄÁöÑÈìæË°®ÁÆ°ÁêÜÔºåËÄåÊòØÂàÜÂùóÁÆ°ÁêÜ„ÄÇlarge bin ‰ª•ÂâçÂ≠¶‰π†ÁöÑ‰πü‰∏çÂ§öÔºå‰∏ãÈù¢ÂÅö‰∏Ä‰∏™ËØ¶ÁªÜÁöÑÂü∫Á°Ä‰ªãÁªç</p>
<p>Âü∫Êú¨ÁöÑÁêÜËß£ÂèØ‰ª•ÁêÜËß£‰∏∫Ê®™ÂêëÂíåÁ∫µÂêëÈìæÊé•Ôºå‰ªéÁ©∫Èó¥‰∏äÊù•Á±ªÊØîÂü∫Êú¨‰∏äÊòØ‰∏Ä‰∏™ÁΩëÁä∂ÁªìÊûÑÔºå‰ΩÜÊòØÂèà‰∏çÂÆåÂÖ®ÊòØÁΩëÁä∂Ôºå<strong>‰∏ÄÊù°Áª≥Â≠ê‰∏ä‰∏Ä‰∏™Âå∫ÂüüÂÜÖÂ§ßÂ∞èÁöÑchunkÈÄöËøáfd_nextsizeÂíåbk_nextsizeËøûÊé•Âú®‰∏ÄËµ∑ÔºåÁõ∏ÂêåÂ§ßÂ∞èÁöÑchunkÂèàÈÄöËøáfdÂíåbkÁõ∏ÈìæÊé•</strong></p>
<p>Âú®ËßÇÂØüÂ¶Ç‰ΩïÂèñÂá∫ÂíåÂ≠òÂÖ•chunkÁöÑÊó∂ÂÄô‰∏çÂ¶®Áúã‰∏ÄÊÆµÊ∫êÁ†Å</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_largebin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Âà§Êñ≠ÊòØÂê¶Â±û‰∫élargebin  </span>
            <span class="token punctuation">&#123;</span>  
              victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ÂØªÊâæÂΩìÂâçsizeÂú®largebin‰∏≠ÁöÑ  </span>
              bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ÂØªÊâæmain_arena  </span>
              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span><span class="token comment">//sizeÊúÄÂ§ßÁöÑchunkÁöÑÂú∞ÂùÄ  </span>
   
              <span class="token comment">/* maintain large bins in sorted order */</span>  
              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span> <span class="token comment">//Â¶ÇÊûúË°®‰∏ç‰∏∫Á©∫  </span>
                <span class="token punctuation">&#123;</span>  
                  <span class="token comment">/* Or with inuse bit to speed comparisons */</span>  
                  size <span class="token operator">|=</span> PREV_INUSE<span class="token punctuation">;</span>  
                  <span class="token comment">/* if smaller than smallest, bypass loop below */</span>  
                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span>  
 <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//bck->bkÊòØÂΩìÂâçÊúÄÂ∞èÁöÑchunkÔºåÂ¶ÇÊûúsizeÊØîÂÆÉËøòÂ∞èÔºåÈÇ£‰πàÁõ¥Êé•ÊèíÂÖ•Âà∞Ë°®Â∞æ  </span>
                    <span class="token punctuation">&#123;</span>  
                      fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span><span class="token comment">//ÊÑüËßâËøô‰∏™‰∏çÁ¨¶ÂêàÊàëËá™Â∑±ÁöÑÁºñÁ†Å‰π†ÊÉØÔºåÂ¶ÇÊûúÊàëÂÜôÊàëËÇØÂÆöfwd=bck->fdÔºå‰πüÂ•ΩÁêÜËß£‰∏Ä‰∫õ  </span>
                      bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>  
   
                      victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>  
                      victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  
                      fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
<span class="token comment">//ÊÄªÁöÑÊù•ËØ¥ÔºåÂ∞±ÊòØÈìæË°®ÁöÑÊèíÂÖ•Êìç‰Ωú  </span>
                    <span class="token punctuation">&#125;</span>  
                  <span class="token keyword">else</span><span class="token comment">//Â¶ÇÊûú‰∏çÊòØÊúÄÂ∞èÔºåÈÇ£Â∞±Áî±Â∞èÂà∞Â§ßÊâæÂà∞Á¨¨‰∏Ä‰∏™ÊØîÂÆÉÂ∞èÁöÑÊèíÂú®ÂÆÉÁöÑÂâçÈù¢  </span>
                    <span class="token punctuation">&#123;</span>  
                      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>  
                        <span class="token punctuation">&#123;</span>  
                          fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>  
              <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                        <span class="token punctuation">&#125;</span>  
   
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size  
              <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>  
                        <span class="token comment">/* Always insert in the second position.  */</span>  
                        fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span><span class="token comment">//Â¶ÇÊûúËØ¥ÊòØÂ∑≤ÁªèÂ≠òÂú®Áõ∏ÂêåÂ§ßÂ∞èÁöÑchunkÔºåÂ∞±Á∫µÂêëÊèíÂÖ•  </span>
                      <span class="token keyword">else</span>  
                        <span class="token punctuation">&#123;</span>  
                          victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  
                          victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  
                          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//Ëøô‰∏™Ê£ÄÊü•Â•ΩÂÉèÂíåunlink‰∏ÄÊ†∑ÔºåÈÉΩÊòØÊ£ÄÊü•fwdÁöÑÊåáÈíàÊúâÊ≤°ÊúâË¢´ÊÅ∂ÊÑè‰øÆÊîπ  </span>
                            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): largebin double linked list corrupted (nextsize)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                          fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
                          victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
                        <span class="token punctuation">&#125;</span>  
                      bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span><span class="token comment">//ËøôÈáåÁöÑbckÊòØÁî®Êù•Á∫µÂêëÊèíÂÖ•ÁöÑ  </span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> fwd<span class="token punctuation">)</span>  
                        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): largebin double linked list corrupted (bk)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ÂêåÊ†∑ÊòØÁ∫µÂêëÊ£ÄÊü•ÊåáÈíàÊúâÊ≤°ÊúâË¢´ÊÅ∂ÊÑè‰øÆÊîπ  </span>
                    <span class="token punctuation">&#125;</span>  
                <span class="token punctuation">&#125;</span>  
              <span class="token keyword">else</span>  
                victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//Â¶ÇÊûúË°®‰∏∫Á©∫ÔºåÈÇ£‰πàÊåáÈíàËá™Êåá  </span>
            <span class="token punctuation">&#125;</span>  
   
          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>  
          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//‰∏çÁÆ°Âà∞Â∫ïÊúâÊ≤°ÊúâÈáçÂ§çÔºåÈÉΩËøõË°å‰∏ÄÊ¨°Á∫µÂêëÈìæÊé•Ôºå‰øùËØÅ‰∏Ä‰∫õÊåáÈíà‰∏∫NULL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>‰ªé‰ª£Á†Å‰∏≠ÂèØ‰ª•ÁúãÂá∫Ôºåfastbin ÈìæÊé•ÊòØ‰ªéÂ§ßÂà∞Â∞èÂºÄÂßãÊéíÂàó„ÄÇ</p>
<h3 id="Â¶Ç‰ΩïÊèíÂÖ•chunk"><a class="header-anchor" href="#Â¶Ç‰ΩïÊèíÂÖ•chunk">¬∂</a>Â¶Ç‰ΩïÊèíÂÖ•chunk</h3>
<ul>
<li>ÂØªÊâæindexÔºåÂç≥ÂØªÊâæÂú®Âì™‰∏ÄÊù°Áª≥Â≠ê‰∏ä</li>
<li>Êúâ‰∫Üindex‰πãÂêéÔºåÈ¶ñÂÖàÂà§Á©∫ÔºåÂ¶ÇÊûúÈìæË°®‰∏∫Á©∫Âàô<br>
<code>victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</code>Ëá™Â∑±ÊåáÂêëËá™Â∑±</li>
<li>‰πãÂêéÂà§Êñ≠sizeÔºåÊòØÂê¶ÊØîÊúÄÂ∞èÁöÑchunkËøòË¶ÅÂ∞èÔºåÂ¶ÇÊûúÊØîÊúÄÂ∞èÁöÑËøòË¶ÅÂ∞èÔºåÈÇ£‰πàÁõ¥Êé•ÊèíÂÖ•Âà∞ÈìæË°®ÁöÑÊú´Â∞æ</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>  

victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>  
victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  
fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ËøôÈáåÂÆåÊàêÂâç‰∏§Ê≠•ÁöÑËµãÂÄº‰πãÂêéÔºåfwdÂ∞±ÊòØbinÔºåÂèØ‰ª•ÂèëÁé∞Â∞±ÊòØÊäävictimÊèíÂÖ•Âà∞ÈìæË°®ÁöÑÊú´Â∞æ„ÄÇ</p>
<ul>
<li>Â¶ÇÊûú‰∏çÊòØÊúÄÂ∞èÁöÑÔºå<strong>ÈÇ£‰πà‰ªéÂ§ßÂà∞Â∞èÂºÄÂßãÈÅçÂéÜ</strong>
<ul>
<li>Â¶ÇÊûúÊâæÂà∞‰∏ÄÊ†∑Â§ßÂ∞èÁöÑÔºåÂàô‰ΩøÁî®Â§¥ÊèíÊ≥ïÔºåÊèíÂÖ•ÁõÆÊ†áÈìæË°®</li>
<li>Â¶ÇÊûúÊ≤°Êúâ‰∏ÄÊ†∑Â§ßÂ∞èÁöÑÔºåÂú®‰∏≠Èó¥ÊèíÂÖ•Âç≥ÂèØ<br>
Ê≠§Êó∂ÔºåÂèàfwdÁöÑÂÜÖÂ≠òÊ£ÄÊµãÔºåÊ£ÄÊµãÂíå<code>unlink</code>Â∑Æ‰∏çÂ§ö<br>
ÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºåÊúÄÂêé‰∏ÄÊÆµËµãÂÄºÁöÑ‰ª£Á†ÅÔºåÊØè‰∏ÄÁßçÊÉÖÂÜµÈÉΩ‰ºöÊâßË°å</li>
</ul>
</li>
</ul>
<h3 id="ÂèñÂá∫chunk"><a class="header-anchor" href="#ÂèñÂá∫chunk">¬∂</a>ÂèñÂá∫chunk</h3>
<p>ËøôÈáåÈªòËÆ§ËÉΩÂ§ü‰ªélargebin‰∏≠ÂèñÂá∫„ÄÇÂÖàÊâæÂà∞Áõ∏Â∫îÁöÑindexÔºåÂú®index‰∏≠‰ªéÂ∞èÂà∞Â§ßÈÅçÂéÜÂ†ÜÂùóÔºåÊâæÂà∞Á¨¨‰∏Ä‰∏™ÊØîÊâÄÈúÄÂ§ßÂ∞èÂ§ßÔºàÊàñÁ≠â‰∫éÔºâÁöÑÂ†ÜÂùó„ÄÇÁÑ∂ÂêéunlinkÔºåÂíåÂÖ∂ÂÆÉÁöÑbins‰∏ÄÊ†∑ÔºåÂ≠òÂú®ÁùÄÂØπfdÔºåbkÔºåfd_nextsize‰ª•Âèäbk_nextsizeÁöÑÊ£ÄÊµã„ÄÇÂØπÂèñ‰∏ãÁöÑchunkÂ¶ÇÊûúÂ§ßÂ∞è‰∏çÁ≠â‰∫éÁî≥ËØ∑ÁöÑsizeÔºåÈÇ£Â∞±Â≠òÂú®ÁùÄÂàáÂâ≤Êìç‰Ωú„ÄÇÂ¶ÇÊûúÂâ©‰ΩôÂ§ßÂ∞èÂ§ß‰∫éMINSIZE„ÄÇÂàôËøîËøòÁªôunsorted binÔºåÂê¶Âàô‰∏ÄÂπ∂ÁªôÁî®Êà∑„ÄÇ</p>
<h3 id="tcache"><a class="header-anchor" href="#tcache">¬∂</a>tcache</h3>
<p>Ëøô‰πüÊòØ2.26Áâà‰πãÂêéÂá∫Áé∞ÁöÑÁÆ°ÁêÜÊú∫Âà∂Ôºå‰ªéÊüêÁßçÁ®ãÂ∫¶‰∏äÊù•ËØ¥ÔºåÁÆ°ÁêÜÁöÑÂÆâÂÖ®ÊÄßËÉΩ‰∏çÂ¶ÇfastbinÔºå‰ΩÜÊòØÈÄüÂ∫¶Á°ÆÂÆûÊèêÂçá‰∫Ü„ÄÇ</p>
<ul>
<li>
<p><code>tcache_perthread_struct</code>ÊòØ‰∏Ä‰∏™ÁÆ°ÁêÜTcacheÁöÑÁªìÊûÑ‰ΩìÔºåËøô‰∏™ÁªìÊûÑ‰Ωì‰πü‰Ωú‰∏∫‰∏Ä‰∏™Â§ßÁöÑchunkÔºåÂ≠òÂú®‰∫éheapÁöÑÂºÄÂßã‰ΩçÁΩÆÔºålibc2.27ËØ•chunkÁöÑÂ§ßÂ∞è‰∏∫0x250ÔºåÂêéÈù¢Â¢ûÂä†Âà∞‰∫Ü0x290Ôºå<code>tcache bin</code>ÁöÑ‰ø°ÊÅØÈÉΩÁî±ËØ•chunkÂ≠òÂÇ®Ôºå<strong>Âä´ÊåÅ</strong>Ëøô‰∏™chunkÂèØ‰ª•ÊéßÂà∂tcache binÁöÑÊâÄÊúâÊÉÖÂÜµ„ÄÇ</p>
</li>
<li>
<p>‰ªé<code>fastbin</code> Âíå <code>smallbin</code>‰∏≠ÊãøÂá∫chunk‰πãÂêéÔºåÂâ©‰∏ãÁöÑchunkÂÖ®ÈÉ®ÈÉΩ‰ºöÊªëÂÖ•tcache</p>
</li>
<li>
<p>Âú®<code>__libc_malloc()</code>Ë∞ÉÁî®<code>__int_malloc()</code>‰πãÂâçÔºåÂ¶ÇÊûú<code>tcache bin</code>‰∏≠ÊúâÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑ<code>chunk</code>Â∞±Áõ¥Êé•Â∞ÜÂÖ∂ËøîÂõû„ÄÇ</p>
</li>
<li>
<p><code>calloc()</code>Ë∂äËøá<code>tcache</code>Âèñ<code>chunk</code>ÔºåÈÄöËøá<code>calloc()</code>ÂàÜÈÖçÁöÑÂ†ÜÂùó‰ºö<strong>Ê∏ÖÈõ∂</strong>„ÄÇ<strong>Ë°•ÂÖÖÔºö</strong><code>realloc()</code>ÁöÑÁâπÊÆäÁî®Ê≥ïÔºö<code>size == 0</code>Êó∂ÔºåÁ≠âÂêå‰∫é<code>free</code>Ôºõ<code>realloc_ptr == 0 &amp;&amp; size &gt; 0</code> Êó∂Á≠âÂêå‰∫é<code>malloc</code>„ÄÇÂ¶ÇÊûúÂΩìÂâçËøûÁª≠ÂÜÖÂ≠òÂùóË∂≥Â§ü<code>realloc</code>ÁöÑËØùÔºåÂè™ÊòØÂ∞Ü<code>p</code>ÊâÄÊåáÂêëÁöÑÁ©∫Èó¥Êâ©Â§ßÔºåÂπ∂ËøîÂõû<code>p</code>ÁöÑÊåáÈíàÂú∞ÂùÄÔºõÂ¶ÇÊûúÂΩìÂâçËøûÁª≠ÂÜÖÂ≠òÂùó‰∏çÂ§üÔºåÂàôÂÜçÊâæ‰∏Ä‰∏™Ë∂≥Â§üÂ§ßÁöÑÂú∞ÊñπÔºåÂàÜÈÖç‰∏ÄÂùóÊñ∞ÁöÑÂÜÖÂ≠ò<code>q</code>ÔºåÂπ∂Â∞Ü<code>p</code>ÊåáÂêëÁöÑÂÜÖÂÆπ<code>copy</code>Âà∞<code>q</code>ÔºåËøîÂõû <code>q</code>„ÄÇÂπ∂Â∞Ü<code>p</code>ÊâÄÊåáÂêëÁöÑÂÜÖÂ≠òÁ©∫Èó¥<code>free</code>ÔºõËã•ÊòØÈÄöËøá<code>realloc</code>Áº©Â∞èÂ†ÜÂùóÔºåÂàôËøîÂõûÁöÑÊåáÈíà<code>p</code>‰∏çÂèòÔºå‰ΩÜÂéüÂÖàÁõ∏ÊØîÁº©Â∞èÂêéÂ§ö‰ΩôÁöÑÈÇ£ÈÉ®ÂàÜÂ∞Ü‰ºöË¢´<code>free</code>Êéâ„ÄÇ</p>
</li>
</ul>
<p>Âú®libcÁâàÊú¨ÁöÑËø≠‰ª£‰∏≠Ôºåtcache‰πüÊúâÂæàÂ§öÁöÑ‰øùÊä§Êú∫Âà∂ÁöÑÊõ¥Êñ∞ÔºåÂêéÈù¢‰ºöÂú®ÂÖ∑‰ΩìÁöÑÂà©Áî®‰∏≠ÊèêÂà∞</p>
<h3 id="topchunk"><a class="header-anchor" href="#topchunk">¬∂</a>topchunk</h3>
<p>topchunkÁöÑÂà©Áî®ËæÉÂ∞ëÔºåÂá†‰πéÂè™Êúâ‰∏Ä‰∏™<code>house of force</code>ÔºåÈô§Ê≠§‰πãÂ§ñËøòÊúâ‰∏Ä‰∫õÂ∞ètrick</p>
<blockquote>
<p>ÂΩìÁî≥ËØ∑ÁöÑ<code>size</code>‰∏çÂ§ß‰∫é<code>mmap</code>ÁöÑÈòàÂÄºÔºå‰ΩÜ<code>top chunk</code>ÂΩìÂâçÁöÑÂ§ßÂ∞èÂèà‰∏çË∂≥‰ª•ÂàÜÈÖçÔºåÂàô‰ºöÊâ©Â±ï<code>top chunk</code>ÔºåÁÑ∂Âêé‰ªéÊñ∞<code>top chunk</code>ÈáåËøõË°åÂàÜÈÖç„ÄÇ</p>
</blockquote>
<p>‰ΩÜÊòØÔºåÂΩìÁî≥ËØ∑ÁöÑsizeÂ§ß‰∫étopchunkÁöÑÊó∂ÂÄôÔºå‰∏ç‰∏ÄÂÆö‰ºöÁõ¥Êé•Êâ©Â±ïtopchunkÁöÑÂ§ßÂ∞èÔºåËÄåÊòØfreeÂéüÊù•ÁöÑtopchunkÔºåÁÑ∂ÂêéÂÜçmalloc‰∏ÄÂùóÊñ∞ÁöÑtopchunkÔºåËøôÁßçÊú∫Âà∂ÂÜçhouse of orange‰∏≠Ë¢´Áî®Âà∞ÔºåÂ∏∏Áî®‰∫éÁ®ãÂ∫è‰∏≠Ê≤°ÊúâfreeÁöÑÊú∫‰ºö„ÄÇ</p>
<p>ÂÖ∑‰ΩìÊòØÔºåÂ¶ÇÊûú<code>brk</code>Á≠â‰∫éËØ•‰∏çÂ§üÂ§ßÂ∞èÁöÑ<code>top chunk</code>ÔºàË¢´ËÆ∞‰Ωú<code>old_top_chunk</code>ÔºâÁöÑ<code>end</code>‰ΩçÁΩÆÔºà<code>old_end</code>ÔºåÁ≠â‰∫é<code>old_top + old_size</code>ÔºâÔºåÂç≥<code>top chunk</code>ÁöÑ<code>size</code>Âπ∂Ê≤°ÊúâË¢´‰øÆÊîπÔºåÂÆåÂÖ®ÊòØËá™ÁÑ∂Âú∞ÂàÜÈÖçÂ†ÜÂùóÔºåÂØºËá¥‰∫Ü<code>top chunk</code>‰∏çÂ§üÁî®ÔºåÂàô‰ºö‰ªé<code>old_top</code>Â§ÑÂºÄËæüÊõ¥Â§ßÁöÑ‰∏ÄÂùóÁ©∫Èó¥‰Ωú‰∏∫Êñ∞ÁöÑ<code>top chunk</code>Ôºå‰πüÂ∞±ÊòØÂ∞ÜÂéüÂÖàÁöÑ<code>old_top_chunk</code>ËøõË°åÊâ©Â±ï‰∫ÜÔºåÊ≠§Êó∂Ê≤°Êúâ<code>free</code>Ôºå‰∏î<code>top chunk</code>ÁöÑËµ∑Âßã‰ΩçÁΩÆ‰πüÊ≤°ÊúâÊîπÂèòÔºå‰ΩÜÊòØÂ¶ÇÊûú<code>brk</code>‰∏çÁ≠â‰∫é<code>old_end</code>ÔºåÂàô‰ºöÂÖà<code>free</code>Êéâ<code>old_top_chunk</code>ÔºåÂÜç‰ªé<code>brk</code>Â§ÑÂºÄËæü‰∏ÄÁâáÁ©∫Èó¥‰Ωú‰∏∫<code>new_top_chunk</code>ÔºåÊ≠§Êó∂ÁöÑ<code>top chunk</code>Â§¥ÈÉ®‰ΩçÁΩÆÂèò‰∏∫‰∫ÜÂéüÂÖàÁöÑ<code>brk</code>ÔºåËÄåÂ¶Ç‰ªäÁöÑ<code>brk</code>‰πüÂÅö‰∫ÜÁõ∏Â∫îÁöÑÊâ©Â±ïÔºåÂπ∂‰∏î<code>unsorted bin</code>Êàñ<code>tcache</code>‰∏≠Ôºà‰∏ÄËà¨‰øÆÊîπÁöÑÂ§ßÂ∞èÈÉΩËá≥Â∞ë‰ºöÊòØ<code>small bin</code>ËåÉÂõ¥Ôºå‰ΩÜÂÖ∑‰ΩìÂú®Âì™ÂæóÂàÜÊÉÖÂÜµÁúãÔºâ‰ºöÊúâË¢´<code>free</code>ÁöÑ<code>old_top_chunk</code>„ÄÇ Âõ†Ê≠§ÔºåÂèØ‰ª•ÈÄöËøáÊîπÂ∞è<code>top chunk</code>ÁöÑ<code>size</code>ÔºåÂÜçÁî≥ËØ∑Â§ßÂ†ÜÂùóÔºåÂÅöÂà∞ÂØπÊóß<code>top chunk</code>ÁöÑ<code>free</code>Ôºå‰∏çËøá‰øÆÊîπÁöÑ<code>size</code>ÈúÄË¶ÅÁªïËøá‰∏Ä‰∫õÊ£ÄÊµã„ÄÇ Áõ∏ÂÖ≥Ê∫êÁ†ÅÂ¶Ç‰∏ãÔºö</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">old_top <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>  
old_size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>old_top<span class="token punctuation">)</span><span class="token punctuation">;</span>  
old_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>old_top<span class="token punctuation">,</span> old_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// old_end = old_top + old_size  </span>
<span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_top <span class="token operator">==</span> <span class="token function">initial_top</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> old_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>  
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>old_size<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE <span class="token operator">&amp;&amp;</span>  
         <span class="token function">prev_inuse</span> <span class="token punctuation">(</span>old_top<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> old_end <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pagesize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ÈúÄË¶ÅÁªïËøá‰ª•‰∏äÁöÑÊñ≠Ë®ÄÔºå‰∏ªË¶ÅÂ∞±ÊòØË¶ÅÊ±ÇË¢´‰øÆÊîπÁöÑ<code>top chunk</code>ÁöÑ<code>size</code>ÁöÑ<code>prev_inuse</code>‰ΩçË¶Å‰∏∫<code>1</code>Âπ∂‰∏î<code>old_end</code>Ë¶ÅÂÜÖÂ≠òÈ°µÂØπÈΩêÔºåÊâÄ‰ª•Â∞±Ë¶ÅÊ±ÇË¢´‰øÆÊîπÁöÑ<code>size</code>ÁöÑÂêé‰∏â‰ΩçÂíåÂéüÂÖàË¶Å‰øùÊåÅ‰∏ÄËá¥„ÄÇ</p>
<h1>Vulnerable &amp; exploit</h1>
<p>‰∏ãÈù¢ÊòØÊÄªÁªì‰∏Ä‰∫õÊºèÊ¥ûÂá∫Áé∞ÁöÑÊÉÖÂÜµÂíåÂà©Áî®ÊñπÂºè</p>
<p>ÁõÆÂâçÊù•ÁúãÔºåÊºèÊ¥ûÂá∫Áé∞ÁöÑÊ®°ÂºèÂ∞±Âè™ÊúâÂõõÁßçÔºö</p>
<ol>
<li>
<p>Ê∫¢Âá∫ÔºåÊú¥ÂÆûÊó†ÂçéÁöÑÊ∫¢Âá∫</p>
</li>
<li>
<p>ÁâπÊÆäÁöÑÊ∫¢Âá∫ÔºåÂç≥off_by_one</p>
</li>
<li>
<p>UAFÔºå‰ª£Á†ÅÁºñÂÜô‰∏äÁöÑbug</p>
</li>
<li>
<p>Â†ÜÈ£éÊ∞¥</p>
</li>
</ol>
<p>Âú®ÊºèÊ¥ûÂà©Áî®‰∏äÈù¢ÔºåÂÖà‰∏çËÄÉËôëÊºèÊ¥ûÁöÑÁ±ªÂûãÔºå‰ªéÂ†ÜÊºèÊ¥ûÂà∞rceÁöÑËøáÁ®ã‰∏≠ÔºåÊúÄÊ†∏ÂøÉÁöÑÂá†‰∏™Ê≠•È™§Â∞±ÊòØËÉΩÂ§üleakÔºåleak‰πãÂêéËÉΩÂ§üÂä´ÊåÅchunkÁöÑÂàÜÈÖçÔºåÂç≥ÈÄöËøáÊºèÊ¥ûËé∑Âæó‰ªªÊÑèÂú∞ÂùÄÂÜôÔºå‰øÆÊîπhookÊàñËÄÖIOÔºåËé∑Âæóshell</p>
<p>ÊääÊºèÊ¥ûÂíåÂà©Áî®ÁöÑÁõÆÁöÑÁªìÂêàÂú®‰∏ÄËµ∑ÁúãÔºå‰ºº‰πéÊõ¥ËÉΩÂ§üÁúãÂà∞ÂÖ∂‰∏≠ÁöÑËÅîÁ≥ª</p>
<h2 id="leak"><a class="header-anchor" href="#leak">¬∂</a>leak?</h2>
<p>Ê≥ÑÈú≤ÁöÑÊñπÊ≥ïÊúâÁÇπÂçïË∞ÉÔºåÂú®Êó©ÊúüÊó†ÈùûÂ∞±ÊòØunsorted binÔºåÈÄöËøáUAFÊàñËÄÖÂà´ÁöÑÊñπÊ≥ïÔºåËé∑Âæóunsorted bin‰∏≠ÁöÑÊåáÈíàÔºå‰ªéËÄåÊ≥ÑÈú≤Âá∫main_arenaÁöÑÂú∞ÂùÄÔºåÂêéÈù¢ÂàôËøòÂèØ‰ª•ÈÄöËøáIOÁöÑÂä´ÊåÅÊù•ËææÂà∞ÁõÆÊ†á„ÄÇ</p>
<p>ÂÖàËØ¥Âä´ÊåÅ<code>unsorted bin</code>‰∏≠ÁöÑÊåáÈíàÔºåÂÖ∂‰∏≠Êúâ‰∏ÄÁÇπÊòØÔºåÂú®Êüê‰∏™ÁâàÊú¨‰πãÂâçÔºåunsorted bin‰∏≠ÁöÑchunkÂèñÂá∫Êù•ÁöÑÊó∂ÂÄô‰∏ç‰ºöÊ∂àÈô§ÂÖ∂‰∏≠ÊÆãÁïôÁöÑÊåáÈíàÔºåÊâÄ‰ª•ÂæàÁÆÄÂçïÁöÑ<code>free malloc</code>Â∞±ÂèØ‰ª•Ëé∑ÂæólibcÁöÑÂü∫ÂùÄ</p>
<p><img src="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122210635583.png" srcset="/img/loading.gif" lazyload alt="image-20221122210635583"></p>
<p>ËøôÁßçÊñπÊ≥ïÁúãËµ∑Êù•ÁÆÄÂçïÔºå‰ΩÜÊòØÂÆûÈôÖ‰∏äËøêÁî®ÁöÑÊØîËæÉÂ∞ëÔºåÊØïÁ´üËøô‰πàÁÆÄÂçïÁöÑÊú∫‰ºöÔºåÊÄªÊúâ‰∫õÈôêÂà∂Êù°‰ª∂ÁªôpassÊéâÁöÑ„ÄÇ‰∏ÄËà¨ËÉΩÂ§üÂà©Áî®ÁöÑleakÊñπÊ≥ïÂíåÂä´ÊåÅÈÉΩÊòØÁõ∏ÈÄöÁöÑÔºåÂú®Ê≤°ÊúâÁõ¥Êé•UAFÁöÑÊù°‰ª∂‰∏ãÔºåÊûÑÈÄ†Âá∫Êù•<code>chunk overlap</code>Âç≥‰∏Ä‰∏™chunkÂêåÊó∂Â§ÑÂú®unsorted binÂíåÂà´ÁöÑ‰ΩçÁΩÆÔºåËøôÁßçÊÉÖÂÜµ‰∏ã‰∏ÄËà¨Êúâ‰∏§‰∏™ÊåáÈíàÔºåptr1Âíåptr2ÈÉΩÊåáÂêëchunkÔºå‰ΩÜÊòØptr2ÊåáÂêëunsorted binÔºåÊâÄ‰ª•Â∞±Êó†Ê≥ï‰ΩøÁî®Ôºå‰ΩÜÊòØÂèØ‰ª•Âà©Áî®ptr1Ê≥ÑÈú≤„ÄÇ</p>
<p>Ê≠§Â§ñÔºåÂà©Áî®IOËøõË°åleak‰πüÊòØÊØîËæÉÂ∏∏ËßÅÁöÑÊñπÊ≥ïÔºåËøôÁßçÊñπÊ≥ïÂ§öÁî®‰∫éÊ≤°ÊúâleakÂáΩÊï∞ÁöÑÊÉÖÂÜµÔºåIOÁöÑÂà©Áî®ËøôÈáå‰∏çÂ§öËÆ≤ÔºåÂÜÖÂÆπÊØîËæÉÂ§öÔºåÂêéÈù¢ÂçïÁã¨ÊÄªÁªì„ÄÇ</p>
<p>Èô§‰∫ÜlibcÁöÑÂü∫ÂùÄ‰πãÂ§ñÔºåËøòÊúâheapÁöÑÂü∫ÂùÄÔºåheapÁöÑÂü∫ÂùÄleakËµ∑Êù•ÂíålibcÂ∑Æ‰∏çÂ§öÔºå‰∏ÄËà¨libcÁöÑÈöæÂ∫¶ÊØîËæÉÂ§ßÔºå‰ΩÜÊòØ‰∏çÊéíÈô§ÂâçÈù¢ËÆ≤ÁöÑlibcÂü∫ÂùÄÁõ¥Êé•ÈÄöËøáunsorted binÂ∏¶Âá∫Êù•ÔºåËøôÁßçÊÉÖÂÜµ‰∏ãleak heapÁöÑÂú∞ÂùÄÂ∞±Ë¶Å‰∏Ä‰∫õÁâπÊÆäÁöÑÊñπÊ≥ï„ÄÇ</p>
<p>ËßÇÂØü<code>large bin</code>ÊèíÂÖ•chunkÊó∂ÁöÑÊ∫êÁ†ÅÔºåÂèØ‰ª•ÂèëÁé∞Â¶ÇÊûúÊèíÂÖ•ÁöÑ‰ΩçÁΩÆÂéüÊù•‰∏∫Á©∫ÔºåÂàô<code>fd_nextsize</code>Âíå<code>bk_nextsize</code>ÈÉΩÊåáÂêëËá™Â∑±</p>
<p><img src="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>ÈÄöËøáËøôÊ†∑ÁöÑÁâπÊÆäÊù°‰ª∂ÂèØ‰ª•leakÂá∫Êù•heapÂü∫ÂùÄ„ÄÇ</p>
<p>Ê≠§Â§ñÔºåÂú®<code>libc2.32</code>‰ª•Âèä‰ª•ÂêéÁöÑÁâàÊú¨Ôºå‰ºöÂØπ<code>tcache ÁöÑ fd</code>ÊåáÈíàÂÅö‰∏Ä‰∏™ÁâπÊÆäÁöÑÂºÇÊàñ‰øùÊä§Êìç‰ΩúÔºå‰ΩÜÊòØÂú®ËøôÁßçÊú∫Âà∂‰∏ãÔºåÁ¨¨‰∏Ä‰∏™chunkË¢´ÈìæÂÖ•ÁöÑÊó∂ÂÄôÔºåÂèØ‰ª•Áõ¥Êé•leakÂá∫Â†ÜÂú∞ÂùÄÔºåËøô‰∏™ÂêéÈù¢ÂèØ‰ª•ËØ¶ÁªÜËØ¥„ÄÇ</p>
<p>ÊÄªÁªì‰ª•‰∏äÁöÑleakÊñπÊ≥ïÔºåÂàÜ‰ª•‰∏ãÂá†ÁßçÊÉÖÂÜµ„ÄÇÔºàÈÉΩÂª∫Á´ãÂú®Êúâleak ÂáΩÊï∞ÁöÑÊù°‰ª∂Ôºâ</p>
<ol>
<li>
<p>Â¶ÇÊûúÂèØ‰ª•Áõ¥Êé• free mallocÂ∏¶Âá∫main_arenaÁöÑÂú∞ÂùÄÔºåÂèØ‰ª•Áõ¥Êé•leak</p>
</li>
<li>
<p>Â¶ÇÊûú‰ª•‰∏äÊù°‰ª∂‰∏çÊª°Ë∂≥Ôºå‰∏îÊºèÊ¥ûÊù°‰ª∂‰∏∫UAFÔºåÂàôÁõ¥Êé•free‰πãÂêéÂèØ‰ª•leak</p>
</li>
<li>
<p>Â¶ÇÊûúÊºèÊ¥û‰∏ç‰∏∫UAFÔºåÂàôÈúÄË¶ÅËÄÉËôëÂà´ÁöÑÊñπÊ≥ïÔºåÊâì‰∏Ä‰∏™Â†ÜÈáçÂè†chunkËøõunsorted bin</p>
</li>
</ol>
<h3 id="Âà©Áî®"><a class="header-anchor" href="#Âà©Áî®">¬∂</a>Âà©Áî®</h3>
<p>Âà©Áî®ÁöÑÊñπÊ≥ïÂ∞±ÊØîËæÉÂ§öÊ†∑Âåñ‰∫ÜÔºå‰ΩÜÊòØÂà©Áî®ÁöÑÁõÆÊ†áËøòÊòØ‰∏çÂèòÁöÑÔºå‰ªªÊÑèÂú∞ÂùÄÂÜôÊàñËÄÖËØ¥‰ªªÊÑèÂú∞ÂùÄÂ†ÜÂàÜÈÖçÁöÑÊùÉÂäõÔºåÂÜçÂæÄ‰∏ãÁªÜ‰∏ÄÁÇπÂ∞±ÊòØÔºåÈúÄË¶ÅÂä´ÊåÅ<code>fd</code>ÊåáÈíàÔºåÁÑ∂ÂêéÂÜçËøõ‰∏ÄÊ≠•ÊéßÂà∂Á®ãÂ∫èÊµÅÁ®ã„ÄÇ</p>
<p>Ëøô‰∏™Êó∂ÂÄôÂ∞±‰ºöËÄÉËôëÂà∞ÂæàÂ§öÁöÑ ‰øùÊä§ÊñπÊ≥ïÔºåÊâÄ‰ª•ËøôÈáå‰∏ªË¶ÅÂØπÂêÑÂ§ßlibcÁâàÊú¨ÁöÑ‰øùÊä§ÊñπÊ≥ïÂÅö‰∏Ä‰∏™ÊÄªÁªì</p>
<p>ÂÖ≥Ê≥®Áé∞Âú®ÊØîËæÉ‰∏ªÊµÅÁöÑÔºålibc2.27ÂºÄÂßã‰∏ÄÁõ¥Âà∞libc2.34Ôºå23ÁâàÊú¨Â∞±‰∏çÂ§öËØ¥‰∫ÜÔºåÂá∫Áé∞ËæÉÂ∞ëÔºåÊîªÂáªÊñπÂºèÂÆûÈôÖ‰∏ä‰πüÊØîËæÉÂçï‰∏Ä„ÄÇ</p>
<h4 id="libc2-27"><a class="header-anchor" href="#libc2-27">¬∂</a>libc2.27</h4>
<p>ÂÆûÈôÖ‰∏äÂú®libc2.27ÂàÜ‰∏∫‰∏§‰∏™ÁâàÊú¨Ôºå‰∏ªË¶ÅÊòØÂú®2.27‰∏≠ÂÅö‰∫Ü‰∏ÄÊ¨°Â∞èÊõ¥Êñ∞Ôºå‰øÆÂ§ç‰∫Ü<code>tcache</code>ÁöÑÊó†ËÑë<code>double free</code>ÔºåÂõ†‰∏∫Âú®ÊúÄÂºÄÂßãÁöÑtcache‰∏≠Ê≤°Êúâdouble freeÊ£ÄÊü•ÔºåÊâÄ‰ª•ÈÅáÂà∞È¢òÁõÆÊòØ2.27ÁöÑÔºåÈÉΩÂèØ‰ª•ËØï‰∏Ä‰∏ãËÉΩ‰∏çËÉΩdouble free„ÄÇ</p>
<p>ÂÖ∂Ê¨°ÔºåtcacheÊòØÂèØ‰ª•‰ªªÊÑèÂú∞ÂùÄÂÜôÁöÑÔºåÊ≤°Êúâfast binÈÇ£ÁßçÈôêÂà∂sizeÁöÑÊ£ÄÊü•Ôºå‰ΩÜÂêåÊó∂Ë¶ÅÊ≥®ÊÑèÁöÑÊòØ<strong>fdÊåáÂêëÁöÑÂπ∂‰∏çÊòØÂ†ÜÂ§¥ÔºåËÄåÊòØÂ†ÜÂÜÖÂÆπ</strong>ÔºåÂç≥‰º™ÈÄ†fdÁöÑÊó∂ÂÄôÔºå<code>fd</code>Â∫îËØ•Áõ¥Êé•ÂÜôÂà∞<code>target address</code>ÔºåÂú®Êúâ<code>tcache</code>ÁöÑ<code>libc</code>ÂèëË°åÁâà‰∏≠Ôºå‰øùÊä§ÊúÄËñÑÂº±ÁöÑÂ∞±ÊòØ2.27‰∫ÜÔºå‰πüÊ≤°‰ªÄ‰πàÂ•ΩÊÄªÁªìÁöÑÔºåÊ≤°ÊúâÁâπÊÆäÁöÑÂà©Áî®ÊñπÊ≥ïÔºåÂ∞±ÊòØÂæàÊú¥Á¥†ÁöÑÂä´ÊåÅfdÊåáÈíàÔºåÁÑ∂Âêé‰ªªÊÑèÂú∞ÂùÄÂÜô„ÄÇ</p>
<p>ËøôÈáåÊèê‰∏Ä‰∏™ÊúâÊÑèÁöÑÂà©Áî®ÊñπÊ≥ïÔºåËøô‰∏™ÊñπÊ≥ïÂú®ÂêéÁª≠ÁöÑÁâàÊú¨‰∏≠‰πüÈÄÇÁî®Ôºå‰ΩÜÊòØÈÄ†ÊàêÁöÑÂç±ÂÆ≥‰∏ç‰∏ÄÊ†∑„ÄÇ</p>
<h5 id="Tcache-Stashing-Unlink-Attack"><a class="header-anchor" href="#Tcache-Stashing-Unlink-Attack">¬∂</a>Tcache Stashing Unlink Attack</h5>
<p>ËøôÁßçattackÂà©Áî®ÁöÑÊòØ<code>small bin</code>ÂíåtcacheÁöÑÂÖ≥Á≥ªÔºåÂú®È´òÁâàÊú¨‰∏≠ËøòÊúâproÁâàÊú¨„ÄÇÁúã‰∏ãÈù¢ÁöÑ‰ª£Á†ÅÔºö</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// Ëé∑Âèñ small bin ‰∏≠ÂÄíÊï∞Á¨¨‰∫å‰∏™ chunk „ÄÇ  </span>
bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>  
<span class="token comment">// Ê£ÄÊü• bck->fd ÊòØ‰∏çÊòØ victimÔºåÈò≤Ê≠¢‰º™ÈÄ†  </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>  
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
<span class="token comment">// ËÆæÁΩÆ victim ÂØπÂ∫îÁöÑ inuse ‰Ωç  </span>
<span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">// ‰øÆÊîπ small bin ÈìæË°®ÔºåÂ∞Ü small bin ÁöÑÊúÄÂêé‰∏Ä‰∏™ chunk ÂèñÂá∫Êù•  </span>
bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ËøôÊòØ<code>small bin</code>ÂèñÂá∫ÊúÄÂêé‰∏Ä‰∏™chunkÁöÑÊìç‰ΩúÔºåÂèØ‰ª•ÂèëÁé∞ÔºåÊ£ÄÊü•‰∫ÜÂèåÈìæÁöÑÂÆåÊï¥ÊÄßÔºå‰ΩÜÊòØÊ≤°ÊúâÊ£ÄÊü•bckÁöÑÂêàÊ≥ïÊÄß„ÄÇÂú®‰∏äÈù¢ÁöÑtcacheÁâπÊÄß‰∏≠ÊèêÂà∞‰∫ÜÔºå‰ªé<code>small bin</code>‰∏≠ÂèñÂá∫‰∏Ä‰∏™chunk‰πãÂêéÔºåÂâ©‰∏ãÁöÑÊâÄÊúâchunk‰ºöÊªëÂÖ•ÂØπÂ∫îÂ§ßÂ∞èÁöÑ<code>tcache bin</code>‰∏≠Ôºå‰∏ãÈù¢Áúãtcache‰∏≠ÁöÑ‰ª£Á†Å</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE    </span></span>
      <span class="token comment">/* While we're here, if we see other chunks of the same size,   
         stash them in the tcache. */</span>    
      <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Ëé∑ÂèñÂØπÂ∫îsizeÁöÑtcacheÁ¥¢Âºï    </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span> <span class="token comment">//Â¶ÇÊûúËØ•Á¥¢ÂºïÂú®tcache binËåÉÂõ¥    </span>
        <span class="token punctuation">&#123;</span>    
          mchunkptr tc_victim<span class="token punctuation">;</span>    
    
          <span class="token comment">/* While bin not empty and tcache not full, copy chunks over. */</span>    
          <span class="token keyword">while</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count  <span class="token comment">//ÂΩìtcache bin‰∏ç‰∏∫Á©∫Âπ∂‰∏îÊ≤°Êª°ÔºåÂπ∂‰∏îsmall bin‰∏ç‰∏∫Á©∫ÔºåÂàô‰æùÊ¨°ÂèñÊúÄÂêé‰∏Ä‰∏™chunkÊèíÂÖ•Âà∞tcache binÈáå    </span>
             <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span>    
        <span class="token punctuation">&#123;</span>    
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    
            <span class="token punctuation">&#123;</span>    
              bck <span class="token operator">=</span> tc_victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>    
              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>    
              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>    
            <span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">)</span><span class="token punctuation">;</span>    
              bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span> <span class="token comment">//Â∞ÜÂΩìÂâçchunk‰ªésmall binÈáåÂç∏‰∏ã    </span>
              bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>    
                      <span class="token comment">//ÊîæÂÖ•tcache binÈáå    </span>
              <span class="token function">tcache_put</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token punctuation">&#125;</span>    
        <span class="token punctuation">&#125;</span>    
        <span class="token punctuation">&#125;</span>    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ËøôÈáåÈÄªËæëÊØîËæÉÁÆÄÂçïÔºåwhileÂæ™ÁéØ‰∏≠Ôºå‰∏çÊñ≠ÁöÑÈÄöËøá<code>tcache_put</code>ÔºåÊäächunk‰ªé<code>small bin</code>‰∏≠ËΩ¨ÁßªÂà∞tcache‰∏≠ÔºåËøô‰∏™ËøáÁ®ãÊ≤°Êúâ‰ªª‰ΩïÁöÑÊ£ÄÊü•ÔºåÂπ∂‰∏îÔºåËÑ±ÈìæÁöÑÊó∂ÂÄô‰πüÊ≤°ÊúâÊ£ÄÊü•ÈìæË°®ÁöÑÂÆåÊï¥ÊÄßÔºåÂõ†‰∏∫Âú®ÂâçÈù¢ÁöÑ<code>small binËÑ±Èìæ‰∏≠</code>Â∑≤ÁªèÊ£ÄÊü•‰∫ÜÂΩìÊó∂ÁöÑVictimÂíåbckÈìæË°®ÁöÑÂÆåÊï¥„ÄÇ</p>
<p><strong>ÈÇ£‰πàÂèØ‰ª•ÊÄùËÄÉ</strong>ÔºåÂ¶ÇÊûúsmall bin‰∏≠Â≠òÂú®3‰∏™chunkÔºåÂàÜÂà´‰∏∫chunk1 chunk2 chunk3ÔºåÂ¶ÇÊûúÊàë‰ª¨ÂèØ‰ª•ÊéßÂà∂chunk2ÁöÑbkÊåáÈíàÔºåÂä´ÊåÅËøô‰∏™bkÂà∞target addressÔºåÁÑ∂ÂêéÊâßË°åÂà∞<code>bck = tc_victim-&gt;bk;</code>ÁöÑÊó∂ÂÄôÔºåËøô‰∏™bckÊòØ<code>target address</code>ÔºåÂêéÈù¢ÊâßË°å<code>bck-&gt;fd=bin</code>ÂàôÂæÄ<code>target address+0x10</code>‰∏≠ÂÜôÂÖ•‰∫Ü‰∏Ä‰∏™<code>main_arena</code>ÁöÑÂú∞ÂùÄÔºåÂπ∂‰∏îÈÄöËøá<code>tcache_put</code>ËÉΩÂ§üÊää<code>victim</code>ÂÜôÂÖ•<code>tcache bin</code>‰∏≠ÔºåÊ≠§Â§ñËøòÈúÄË¶Å‰∏Ä‰∏™Êù°‰ª∂ÔºåÂ∞±ÊòØtcacheÂàöÂ•ΩÂè™Áïô‰∏ãÊù•‰∫Ü‰∏Ä‰∏™‰ΩçÁΩÆÔºåËøôÊòØÊúÄÁêÜÊÉ≥ÁöÑÔºåÂõ†‰∏∫ÁêÜËÆ∫‰∏äÂàÜÊûêÔºåÂ¶ÇÊûúÊçüÂùèsmall binÁöÑbkÊåáÈíàÔºå‰∏ã‰∏ÄÊ¨°ÁöÑÊìç‰ΩúÂøÖÁÑ∂‰ºöÂá∫Áé∞ÈîôËØØÔºåÊâÄ‰ª•ÊúÄÂ•ΩÊòØËÉΩÂ§üÊéßÂà∂‰ΩètcacheÁöÑcountÔºåËææÂà∞ÊºèÊ¥ûÁõÆÊ†á‰πãÂêéÂÅúÊ≠¢whileÂæ™ÁéØ„ÄÇ</p>
<p>ÊºèÊ¥ûÂç±ÂÆ≥ÁúãËµ∑Êù•ËõÆÂ§ßÔºå‰ΩÜÊòØÊúâ‰∏™bugÔºåÊºèÊ¥ûÈúÄË¶ÅÁöÑÂâçÊèêÊù°‰ª∂ÊòØÔºå‰ªésmall bin‰∏≠ÂèñÂá∫Êù•‰∏Ä‰∏™chunkÔºå‰ΩÜÊòØÂú®ÊúâtcacheÁöÑÊù°‰ª∂‰∏ãÔºåÈúÄË¶Åtcache‰∏∫Á©∫‰ºº‰πéÊâçÂèØ‰ª•ËææÂà∞Ëøô‰∏™Êù°‰ª∂Ôºå‰ΩÜÊòØËøôÊ†∑ÁöÑËØùÂ¶ÇÊûúÈúÄË¶Å‰ªésmall binÂèñÂá∫chunkÔºåÈÇ£‰πàÂ∞±ÈúÄË¶Åtcache‰∏∫Á©∫ÔºåÊ≠§Êó∂ÂèàÊó†Ê≥ïÊéßÂà∂tcacheÁöÑÊï∞ÈáèÔºåÊâÄ‰ª•ËØ¥Â¶ÇÊûú‰ªÖ‰ªÖÊòØmallocÁöÑËØùÔºåËøòÊòØÂ≠òÂú®‰∏ÄÂÆöÁüõÁõæÁöÑÔºåÊâÄ‰ª•ËøôÁßçattack‰∏ÄËà¨‰ΩøÁî®Âú®callocÁöÑÊó∂ÂÄô„ÄÇ</p>
<blockquote>
<p>ÊïàÊûú &amp; Âà©Áî®Êù°‰ª∂</p>
</blockquote>
<p>ÈÄ†ÊàêÁöÑÁªìÊûúÊòØ‰ªªÊÑèÂú∞ÂùÄÂÜô‰∏Ä‰∏™main_arenaÁöÑÂú∞ÂùÄÔºåÂíå‰ªªÊÑèÂú∞ÂùÄÈìæÊé•ËøõtcacheÔºåÂà©Áî®Êù°‰ª∂Â¶Ç‰∏ã</p>
<ul>
<li>Êúâtcache</li>
<li>Ëá≥Â∞ëÊúâ‰∏ÄÊ¨°ËÉΩÂ§üË∂äËøátcache ‰ªésmall bin‰∏≠ÂèñÂá∫chunk Ôºà calloc Ôºâ</li>
<li>ÊúâÊú∫‰ºöËÆ©chunk‰ªé<code>unsorted bin</code>‰∏≠ÊªëÂÖ•<code>small bin</code></li>
<li>ÂèØ‰ª•Âä´ÊåÅbkÊåáÈíà<br>
Âà©Áî®‰πãÂêéÁöÑÂ†ÜÁ©∫Èó¥</li>
</ul>
<p><img src="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221123201213840.png" srcset="/img/loading.gif" lazyload alt="image-20221123201213840"></p>
<blockquote>
<p>Âà©Áî®ÊñπÊ≥ï</p>
</blockquote>
<ul>
<li>È¶ñÂÖàÂ°´Êª°tcache</li>
<li>ÁÑ∂Âêéfree‰∏§‰∏™chunkËøõunsorted binÔºåÔºà‰∏çÂèØ‰ª•ÂêàÂπ∂Ôºâ</li>
<li>ÁÑ∂ÂêéÁî≥ËØ∑‰∏Ä‰∏™Â§ßÁöÑchunkÔºåÊääunsorted binÈáåÈù¢ÁöÑchunkÊªëÂÖ•small bin</li>
<li>UAFÂä´ÊåÅÂÄíÊï∞Á¨¨‰∫å‰∏™chunkÁöÑbkÔºåÊ≥®ÊÑèËøô‰∏™bkÊòØchunkÂ§¥ÔºåÂÆÉÊòØË¶ÅË¢´ÈìæÂÖ•tcacheÁöÑ„ÄÇËÄåfake_chunkÊåáÂêëÁöÑbkÂèØ‰ª•ÊåáÂêë‰ªªÊÑè‰ΩçÁΩÆ‚Üívul_addrÔºåËØ•‰ΩçÁΩÆË¢´ËÆ§‰∏∫ÊòØ‰∏ã‰∏Ä‰∏™bckÔºå‰ºöÈÄ†Êàêvul_addr+0x10=bin</li>
</ul>
<h4 id="libc2-29"><a class="header-anchor" href="#libc2-29">¬∂</a>libc2.29</h4>
<p>‰ªélibc2.27Âà∞2.29ÊúÄÊòéÊòæÁöÑÂ∞±ÊòØÊ∑ªÂä†‰∫Ü<code>tcache key</code>ÔºåÂç≥ÊîπÂèò‰∫ÜtcacheÁöÑÁªìÊûÑ‰ΩìÔºåÁî®‰∫éË°®Á§∫<code>chunk</code>ÊòØÂê¶Â∑≤ÁªèÂú®ÊâÄÂ±ûÁöÑ<code>tcache bin</code>‰∏≠ÔºåÂØπ‰∫éÊØè‰∏™<code>chunk</code>ËÄåË®ÄÔºå<code>key</code>Âú®ÂÖ∂<code>bk</code>ÊåáÈíàÁöÑ‰ΩçÁΩÆ‰∏ä„ÄÇÊ£ÄÊü•‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> tcache<span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  
    tcache_entry <span class="token operator">*</span>tmp<span class="token punctuation">;</span>  
    <span class="token function">LIBC_PROBE</span><span class="token punctuation">(</span>memory_tcache_double_free<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span> tmp<span class="token punctuation">;</span> tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">)</span>  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> e<span class="token punctuation">)</span>  
        <span class="token function">malloc_printerr</span><span class="token punctuation">(</span><span class="token string">"free(): double free detected in tcache 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>Ê£ÄÊü•‰∫Ü<code>double free</code>ÔºåÂ¶ÇÊûúÂΩìÊó∂eÂ∑≤ÁªèÊúâkey‰∫ÜÔºå‰∏îeÂíåtcache binÁöÑÁ¨¨‰∏Ä‰∏™chunkÊòØ‰∏ÄÊ†∑ÁöÑÔºåÂàôËß¶Âèëdouble freeÁöÑÊ£ÄÊü•ÔºåËøô‰∏™ÂÖ≥ÈîÆÁöÑ<code>key</code>ÔºåÂú®ËøõË°åtcache_putÁöÑÊó∂ÂÄô‰ºöË¢´ËµãÂÄº‰∏∫<code>tcache_struct</code>ÁöÑÂú∞ÂùÄÔºåÂú®<code>tcache_get</code>ÁöÑÊó∂ÂÄôËøõË°åÊ∏ÖÁ©∫„ÄÇ</p>
<p>ÁªïËøáÁöÑÊñπÊ≥ï‰πüÊØîËæÉÁÆÄÂçïÔºåÊÉ≥ÂäûÊ≥ïÁ†¥ÂùèÊéâËøô‰∏™keyÔºåÈÇ£‰πàÂ∞±‰∏ç‰ºöËøõÂÖ•ifÁöÑÊù°‰ª∂ÔºåÊ≠§Êó∂Áõ∏ÂΩì‰∫éÂèØ‰ª•Áõ¥Êé•double free„ÄÇ</p>
<p>Ê≠§Â§ñÊ∑ªÂä†‰∫Ü‰∏Ä‰∏™<code>unlink</code>Ê£ÄÊü•Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* consolidate backward */</span>  
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    prevsize <span class="token operator">=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    size <span class="token operator">+=</span> prevsize<span class="token punctuation">;</span>  
    p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!=</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//add  </span>
        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size while consolidating"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//add  </span>
    <span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>‰ª£Á†ÅÊ∑ªÂä†Âú®<code>free</code>ÁöÑÊó∂ÂÄôÔºåfreeÊìç‰ΩúÊó∂Ôºå‰ºöÊâßË°å‰∏äÈù¢ÁöÑ<code>unlink</code>Ê£ÄÊü•ÔºåËøô‰∏™Ê£ÄÊü•Ê£ÄÊü•‰∫Ü<code>pre_inuse</code>‰ΩçÔºåÂ¶ÇÊûúpÁöÑpre_inuse‰∏∫0ÔºåÂç≥Ââç‰∏Ä‰∏™chunk‰∏∫freeÁä∂ÊÄÅÔºåÈÇ£‰πà‰ºöÈÄöËøá<code>pre_size</code>ÁöÑÂ§ßÂ∞èËé∑ÂæóÂâç‰∏Ä‰∏™chunkÁöÑsizeÔºåÁÑ∂ÂêéÂÜçÂèëÁîü<code>unlink</code>„ÄÇÂú®‰ª•ÂâçÁöÑÁâàÊú¨‰∏çÂ≠òÂú®Ëøô‰∏™Ê£ÄÊü•ÔºåÊâÄ‰ª•ÂèØ‰ª•ÈÄöËøá<code>off_by_NULL</code>ÂæàÁÆÄÂçïÁöÑÊûÑÈÄ†<code>chunk_overlap</code>ÔºåÊñπÊ≥ïÂ¶Ç‰∏ãÔºö</p>
<h5 id="off-by-NULLÂà©Áî®"><a class="header-anchor" href="#off-by-NULLÂà©Áî®">¬∂</a>off_by_NULLÂà©Áî®</h5>
<blockquote>
<ul>
<li>
<p>malloc(0x500) Ëé∑Âæóchunk1 malloc(0xf8) * 3 Ëé∑Âæóchunk 2 3 4</p>
</li>
<li>
<p>ÁºñËæëchunk 3 ÊîπÂèòchunk 4ÁöÑpresize = chunk1 + chunk2 + chunk3 ‰∏îË¶ÜÁõñchunk4ÁöÑpre_inuse</p>
</li>
<li>
<p>free chunk1 Ê≠§Êó∂chunk1 ËøõÂÖ•unsorted bin</p>
</li>
<li>
<p>free chunk4 Â¶ÇÊûúÊ≤°Êúâ‰∏äËø∞Ê£ÄÊü•ÂàôÔºåchunk4Âíåchunk1 ÂèëÁîüunlinkÔºåÊäächunk1 Âà∞chunk4ÁöÑÊâÄÊúâÁ©∫Èó¥ÂêûÂÖ•unsorted bin</p>
</li>
<li>
<p>Ê≠§Êó∂chunk2 chunk3 Êó¢Â≠òÂú®‰∫éunsorted binÔºåÂèàÂèØ‰ª•Ë¢´Áî®Êà∑‰ΩøÁî®</p>
</li>
</ul>
</blockquote>
<p>Â±û‰∫éoff_by_oneÊØîËæÉÁªèÂÖ∏ÁöÑÂà©Áî®‰∫Ü„ÄÇ‰ΩÜÊòØlibc2.29Âú®free chunk4ÁöÑÊó∂ÂÄôÂá∫Áé∞‰∫ÜsizeÁöÑÊ£ÄÊü•ÔºåÊåâÁÖßÂéüÊù•ÁöÑÊñπÊ≥ïÔºåÂøÖÁÑ∂ÊòØ‰∏çËÉΩÈÄöËøáÊ£ÄÊü•ÁöÑÔºåÊâÄ‰ª•ËøòÈúÄË¶ÅËÄÉËôëÂè¶Â§ñÁöÑÊñπÊ≥ïÊù•ÂÆåÊàêÂà©Áî®ÔºåÊúÄÁÆÄÂçïÁõ¥Êé•ÁöÑÂäûÊ≥ïÂ∞±ÊòØÂú®chunkÁöÑuser_dataÂüüÂÜç‰º™ÈÄ†‰∏Ä‰∏™chunkÔºåËøôÊ†∑Â∞±ÂèØ‰ª•Êª°Ë∂≥sizeÁöÑË¶ÅÊ±Ç‰∫Ü„ÄÇ</p>
<p>‰ΩÜÊòØÈóÆÈ¢òÂèàÊù•‰∫ÜÔºåÁúã<code>unlink</code>ÁöÑ‰ª£Á†Å</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Take a chunk off a bin list. */</span>  
<span class="token keyword">static</span> <span class="token keyword">void</span>  
<span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  mchunkptr fd <span class="token operator">=</span> p<span class="token operator">-></span>fd<span class="token punctuation">;</span>  
  mchunkptr bk <span class="token operator">=</span> p<span class="token operator">-></span>bk<span class="token punctuation">;</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>fd<span class="token operator">-></span>bk <span class="token operator">!=</span> p <span class="token operator">||</span> bk<span class="token operator">-></span>fd <span class="token operator">!=</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// ÈìæË°®ÈáåÔºåp->ÂâçÂêë->ÂêéÂêë==p„ÄÇ  </span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted double-linked list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ÁªïËøá‰∫ÜÁ¨¨‰∏ÄÊ¨°Ê£ÄÊü•Ôºåunlink‰æùÁÑ∂Ë¶ÅÊ£ÄÊü•ÂèåÂêëÈìæË°®ÁöÑÂÆåÊï¥ÊÄßÔºåÊ≠§Êó∂ÂØπ‰∫éËøô‰∏™unlinkÊ£ÄÊü•ÔºåËÄÉËôë‰ª•‰∏ãÂá†ÁÇπÔºö</p>
<ul>
<li>
<p>Â¶ÇÊûúÂèØ‰ª•Ëé∑ÂæóheapÂú∞ÂùÄÔºåÁõ¥Êé•‰º™ÈÄ†Âç≥ÂèØÔºåËÆ©fdÂíåbkÈÉΩÊåáÂêëËá™Â∑±ÔºàËøôÈáåÁöÑ<code>fd</code>Âíå<code>bk</code>ÊåáÁöÑÊòØ<code>fake_chunk</code>ÁöÑ<code>fd</code>Âíå<code>bk</code>ÔºåËá™Â∑±ÊåáÁöÑÊòØ<code>fake_chunk</code>Ôºâ</p>
</li>
<li>
<p>Ê≤°Êúâheap baseÔºåÊÉ≥ÂäûÊ≥ïÂàõÈÄ†Êù°‰ª∂ÔºåÂà©Áî®heapÊìç‰ΩúÊÆãÁïôÁöÑheapÂú∞ÂùÄ</p>
</li>
</ul>
<p>Á¨¨‰∫åÁÇπËÅîÂêàÁ¨¨‰∏ÄÁÇπÂæàÂÆπÊòìÊÉ≥Ëµ∑Êù•<code>large bin</code>ÔºåÂΩì<code>large bin</code>‰∏≠Âêå‰∏Ä‰∏™indexÁöÑchunk‰ΩøÁî®<code>fd_nextsize</code>Âíå<code>bk_nextsize</code>Áõ∏ËøûÊé•„ÄÇ<br>
Âú®Ê≤°ÊúâÊ≥ÑÈú≤ÁöÑÂâçÊèê‰∏ãÂà©Áî®<code>fd_nextsizeÂíåbk_nextsize</code>‰∏§‰∏™heapÊåáÈíàÔºåÊûÑÈÄ†ÊñπÊ≥ïÂ¶Ç‰∏ã„ÄÇ</p>
<h6 id="ÊÆã‰ΩôÁöÑheapÊåáÈíàÔºàÂü∫Êú¨Êó†Ê≥ï‰ΩøÁî®Ôºâ"><a class="header-anchor" href="#ÊÆã‰ΩôÁöÑheapÊåáÈíàÔºàÂü∫Êú¨Êó†Ê≥ï‰ΩøÁî®Ôºâ">¬∂</a>ÊÆã‰ΩôÁöÑheapÊåáÈíàÔºàÂü∫Êú¨Êó†Ê≥ï‰ΩøÁî®Ôºâ</h6>
<ul>
<li>È¶ñÂÖàmallocÂá∫Êù•‰∏Ä‰∏™large bin chunkÔºåÁÑ∂ÂêémallocÂá∫Êù•ÔºåmallocÂá∫Êù•ÁöÑÊó∂ÂÄôÂà©Áî®editÁöÑÊú∫‰ºöÔºåÂØπ<code>fd_nextsize</code>ËøõË°å<code>partial overwrite</code>Ôºå‰ΩøÂæóËØ•ÊåáÈíàÊåáÂêëÂè¶Â§ñ‰∏Ä‰∏™ÊúâheapÊåáÈíàÁöÑchunkÔºåËøôÊó∂ÂÄôfd_nextsize‰Ωú‰∏∫fake chunkÁöÑfdÊåáÈíàÔºåÂà©Áî®Âè¶Â§ñ‰∏Ä‰∏™ÊúâheapÊåáÈíàÁöÑchunkÔºåÂÆåÊàê‰∫Ü<code>fd-&gt;bk = p</code>ÁöÑÊ£ÄÊü•ÔºåÊ≠§Â§ÑÊ≥®ÊÑèÔºåËøô‰∏™ÊúâheapÊåáÈíàÁöÑchunk‰πüÈúÄË¶ÅÊèêÂâçËøõË°åpartial overwrite‰ΩøÂæóÂÖ∂heapÊåáÈíàÊåáÂêëp„ÄÇ</li>
<li>free ‰∏Ä‰∏™chunkËøõÂÖ•tcacheÔºåÁÑ∂ÂêéÂÜçÂà©Áî®off_by_oneÊîπÂèòÂâçÈù¢ÈÇ£‰∏™large bin chunkÁöÑÂ§ßÂ∞èÔºå‰ΩøÂæóÂÖ∂‰∏∫tcacheÂ§ßÂ∞èÔºåÁÑ∂Âêéfree Ëøô‰∏™chunkÔºåËøôÊó∂ÂÄôÔºå‰πãÂâçÈÇ£‰∏™large bin chunkÁöÑfdÊåáÈíàÔºåÊåáÂêë‰∫ÜËøô‰∏ÄÊ≠•ÂàöÂºÄÂßãË¢´freeÁöÑtcacheÔºåÂç≥Âú®large bin + 0x10ÁöÑ‰ΩçÁΩÆË∏©Âá∫‰∏Ä‰∏™heapÂú∞ÂùÄ</li>
<li>ÊúÄÂêémallocÂá∫Êù•Ëøô‰∏™‰øÆÊîπÂ§ßÂ∞èÂêéËøõÂÖ•tcache ÁöÑ large bin chunkÔºåÁÑ∂Âêépartial overwrite‰øÆÊîπ‰Ωé‰ΩçÔºå‰ΩøÂæó+0x10‰ΩçÁΩÆÁöÑheapÂú∞ÂùÄÊåáÂêëpÔºå‰ªéËÄåÁªïËøábk-&gt;fd = pÁöÑÊ£ÄÊü•</li>
</ul>
<p>ËøáÁ®ãÊûÅ‰∏∫ÁπÅÁêêÔºå‰∏î<strong>‰∏çÂÆûÁî®</strong>ÔºåÂú®ÂêéÊù•ÁöÑÁâàÊú¨Ôºà<font color="#ff0000">glibc2.29</font>ÔºâÔºåÂá∫Áé∞‰∫ÜtcacheÁöÑkeyÊú∫Âà∂ÔºåÂØºËá¥fake_chunkÁöÑsize‰ºöÂú®Ë∏©Âá∫heapÂú∞ÂùÄÁöÑÊó∂ÂÄôË¢´keyË¶ÜÁõñÔºåÊâÄ‰ª•ÊñπÊ≥ïÈúÄË¶ÅÊîπÂà∞<code>fast bin</code>‰∏≠ÊâßË°åÔºåËøôÊòØÈôêÂà∂Êù°‰ª∂‰πã‰∏ÄÔºåÈôêÂà∂Êù°‰ª∂‰πã‰∫åÊòØÔºåÂæàÂ§öÁöÑËæìÂÖ•Ë¶ÅÊ±Ç‰∏≠Ôºå‰ºöÂú®ËæìÂÖ•ÁöÑÊú´Â∞æËæìÂÖ•<code>\x00Âíå\n</code>ÔºåËøôÂØºËá¥‰∫Üpartial overwrite‰ºöÂ§±Ë¥•ÔºåÊàñËÄÖËØ¥ÈúÄË¶ÅÁàÜÁ†¥„ÄÇ</p>
<p>ÊâÄ‰ª•‰ª•‰∏äÁöÑÊñπÊ≥ïÁé∞Âú®Âü∫Êú¨‰∏äÈÉΩÊó†Ê≥ï‰ΩøÁî®„ÄÇÁé∞Âú®Áî®ÁöÑÂá†‰πéÈÉΩÊòØ‰∏ãÈù¢ÁöÑÊñπÊ≥ï„ÄÇ</p>
<h6 id="unsorted-binÂíålarge-binÁöÑÈìæÊú∫Âà∂"><a class="header-anchor" href="#unsorted-binÂíålarge-binÁöÑÈìæÊú∫Âà∂">¬∂</a>unsorted binÂíålarge binÁöÑÈìæÊú∫Âà∂</h6>
<p>ËøôÁßçÊñπÊ≥ïÊàëÊòØ‰ªéNepCTF‰∏≠Â≠¶Êù•ÁöÑÔºåNepCTF‰∏≠Áî±NepÊàòÈòüÁöÑFMYYÂ∏àÂÇÖÂá∫‰∫Ü‰∏ÄÈÅìÈ¢òÔºå<strong>NULL_FXCK</strong>ÔºåËøôÈÅìÈ¢òÁöÑËß£Ê≥ïÂ§öÊ†∑Ôºå‰∏îÂØπÂ†ÜÁöÑÊûÑÈÄ†Ë¶ÅÊ±ÇÊûÅÈ´òÔºåÊØîËµõ‰∏≠‰ªÖÊúâcnitlrtÂ∏àÂÇÖÂÆåÊàêÔºåÊòØ‰∏ÄÈÅìÂæàÊúâÊÑèÊÄùÁöÑÈ¢òÁõÆÔºàÈ£éÊ≤ê‰∫ëÁÉüyydsÔºâ</p>
<p>Âú®ÂèÇËÄÉwjhÂ∏àÂÇÖÁöÑÂçöÂÆ¢‰πãÂêéÔºåÂΩìÊó∂ÁÆóÊòØÂÆåÂñÑ‰∫Ü‰∏ÄÂùóÁü≠ÊùøÔºåÈÇ£Êó∂ÂÄô‰ªéÊù•Ê≤°ÊúâÂú®È´òÁâàÊú¨ÁöÑlibc‰∏ãÂ∞ùËØïËøáoff_by_oneÁöÑÊûÑÈÄ†„ÄÇ</p>
<p>È¶ñÂÖàËÆ≤Â∏∏ËßÑÁöÑÂà©Áî®large binÈìæÂ≠êÁöÑÊâìÊ≥ïÔºåËøôÁßçÊñπÊ≥ïÊòØÈúÄË¶Å<font color="#ff0000">ÁàÜÁ†¥</font>ÁöÑÔºåÂÖ∑‰Ωì<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45209963/article/details/126758789">ÈìæÊé•</a>ÔºåÂú®ÊàëÁúãÊù•Êú¨Ë¥®‰∏äÁöÑÂå∫Âà´‰∏çÊòØÂæàÂ§öÔºå‰∏ªË¶ÅÊòØÊç¢‰∫Üunsorted binÊâìÔºå‰ΩÜÊòØÂú®‰ΩøÁî®ÁöÑÂ§çÊùÇÂ∫¶‰∏ä‰∏ç‰Ωé‰∫é‰∏äÈù¢ÁöÑÊñπÊ≥ïÔºåÂè™ÊòØunsorted binÊØîfastbinÁÆÄÂçïÔºåÊúÄÂêéÁöÑpartial overwriteÊó∂ÔºåÂõ†‰∏∫ÈúÄË¶ÅË¶ÜÁõñ‰∏§‰ΩçÔºåÊâÄ‰ª•ÂØπ‰∫éÁ¨¨‰∫å‰∏™Â≠óËäÇÁöÑÈ´ò4bitÊòØÊó†Ê≥ïÊéßÂà∂ÁöÑÔºåËøôÂ∞±ÈúÄË¶ÅÁàÜÁ†¥ÔºåÊ¶ÇÁéá‰∏∫1/16„ÄÇ</p>
<p>ÁÑ∂ÂêéËÆ≤ÁöÑÊòØ‰∏ÄÁßç‰∏çÈúÄË¶ÅÁàÜÁ†¥ÁöÑÊñπÊ≥ïÔºå<strong>ËøôÁßçÊñπÊ≥ï‰∏ç‰æùËµñ‰∫élarge bin</strong>ÔºåËÄåÊòØÂçïÁ∫ØÁöÑÂà©Áî®unsorted binÂíåheapÂú®ÂêàÂπ∂ÂíåÂàÜÂâ≤ÁöÑÊó∂ÂÄôÊÆãÁïôÁöÑheapÊåáÈíà„ÄÇ<br>
ÁØáÂπÖÊúâÈôêÔºåÂÖ∑‰ΩìÂèØ‰ª•Áúã‰∏ãÈù¢ÁöÑÊñáÁ´†Ôºö<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45209963/article/details/126758789">https://blog.csdn.net/weixin_45209963/article/details/126758789</a><br>
<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/archives/193/">https://blog.wjhwjhn.com/archives/193/</a></p>
<hr>
<p>Èô§‰∫Ü‰ª•‰∏äÁöÑÊ£ÄÊü•‰πãÂ§ñÔºåËøòÊ∑ªÂä†‰∫Ütop chunkÁöÑÊ£ÄÊü•ÔºåÈò≤Êä§‰Ωè‰∫Ühouse of forceÁöÑÊîªÂáªÔºåÂêåÊó∂ÔºåunlinkÁî±‰∏Ä‰∏™ÂÆèÔºåÂèòÊàê‰∫Ü‰∏Ä‰∏™‰∏ìÈó®ÁöÑÂáΩÊï∞ÔºåÊ∑ªÂä†‰∫ÜÂèåÈìæÂÆåÊï¥ÊÄßÁöÑÊ£ÄÊü•Ôºå‰ΩøÂæóunsorted bin attackÂèòÂæóÊó†Ê≥ï‰ΩøÁî®ÔºåÊâÄ‰ª•Âú®È´òÁâàÊú¨‰∏≠Ôºå‰∏ÄËà¨‰ΩøÁî®large bin attack Êõø‰ª£unsorted bin attack„ÄÇ</p>
<h4 id="libc2-31"><a class="header-anchor" href="#libc2-31">¬∂</a>libc2.31</h4>
<p>ËØ•ÁâàÊú¨‰∏≠ÔºåÂØπlarge binÁöÑfd_nextsizeÂíåbk_nextsizeÂÅö‰∫ÜÈôêÂà∂ÔºåÊôÆÈÄöÁöÑÊûÑÈÄ†large bin attackÁöÑÂäûÊ≥ïÂ∑≤ÁªèÂ§±ÊïàÔºå‰ΩÜÊòØÂ¶Ç‰∏ãÁöÑpayload DemoËøòËÉΩÂ§ü‰ΩøÁî®</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x4a8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x478</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// trigger chunk1 into largebin</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>victim<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">;</span>

<span class="token comment">// largebin attack</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>‰πãÂêéÁõ∏ÊØî‰∫é2.29Ê≤°ÊúâÂÅöÊØîËæÉÂ§ßÁöÑÊõ¥Êñ∞ÔºåÂü∫Êú¨‰∏ä‰øùÊä§Êú∫Âà∂ÈÉΩ‰∏ÄÊ†∑ÔºåËøôÈáå‰∏ªË¶ÅÊòØ‰ªãÁªçÂá†ÁßçÁªèÂÖ∏ÁöÑÂà©Áî®ÊñπÊ≥ïÔºåÂπ≥Êó∂‰πüÁÆóÊØîËæÉÂ∞ëËßÅÁöÑ„ÄÇ<br>
ËØ•ÁâàÊú¨‰∏ã‰∏ªË¶ÅÂà©Áî®ÁöÑÊñπÊ≥ïÂ¶Ç‰∏ãÔºö<br>
tcache stash unlink ÂÖ®ÂÆ∂Ê°∂ #House_of_botcake #fastbin_reverse_into_tcache<br>
‰ª•‰∏äÁöÑ‰∏âÁßçÊñπÊ≥ïÂùáÂèØ‰ª•Âà©Áî®Âú®libc2.29ÁâàÊú¨ÔºåÊàñËÄÖËØ¥ÈÄÇÁî®‰∫étcacheÁâàÊú¨„ÄÇ<br>
tcache ÁöÑstashÊú∫Âà∂ÂâçÈù¢‰ªãÁªçËøá‰∫ÜÔºåËøôÈáå‰∏ªË¶ÅÊèê‰∏Ä‰∏ãbotcakeÁöÑÂà©Áî®ÊñπÊ≥ï„ÄÇÔºàfastbinÁöÑÂà©Áî®ÊñπÊ≥ïÂíåstashÊú∫Âà∂Á±ª‰ººÔºå‰∏çËøáÊÑüËßâÊúâÁÇπÈ∏°ËÇãÔºâ</p>
<h5 id="house-of-botcake"><a class="header-anchor" href="#house-of-botcake">¬∂</a>house of botcake</h5>
<p>ËøôÊòØ‰∏ÄÁßçÂú®UAFÁöÑÊù°‰ª∂‰∏ãÁöÑÂà©Áî®Ôºå‰∏ªË¶ÅÈÄÇÁî®‰∫éÔºåÂ≠òÂú®UAF‰ΩÜÊòØÊ≤°ÊúâeditÁöÑÂäûÊ≥ïÔºåÂç≥Âè™ËÉΩÂ§üÂú®malloc‰πãÂêéÈ©¨‰∏äeditÔºåËÄå‰∏çÂèØ‰ª•ÂçïÁã¨ÁöÑÊâßË°åedit„ÄÇ<br>
Êù°‰ª∂Ôºö</p>
<ul>
<li>Êúâtcache</li>
<li>ÂèØ‰ª•UAf<br>
Âà©Áî®ÁöÑÊú¨Ë¥®ÊòØÔºåÂêå‰∏Ä‰∏™chunkËøõË°å‰∏§Ê¨°freeÂØºËá¥chunkÂàÜÂà´‰Ωç‰∫éunsorted binÂíåtcacheÔºåÁî±‰∫é‰Ωç‰∫é<code>unsorted bin</code>‰∏≠ÁöÑchunkÊ≤°ÊúâkeyÔºåÊâÄ‰ª•ÁªïËøá‰∫Ü<code>tcache bin</code>ÁöÑÊ£ÄÊü•„ÄÇ<br>
Âà©Áî®ËøáÁ®ãÔºö</li>
<li>Â°´Êª°tcache binÔºåfree chunk1 chunk2ÔºåÊ≠§Êó∂chunk1Âíå2ËøõÂÖ•‰∫Üunsorted binÔºå‰∏îË¶Å‰øùËØÅ1 Âíå 2Áõ∏ÈÇªÔºåËøõÂÖ•unsorted bin‰πãÂêé‰∫åËÄÖÂêàÂπ∂</li>
<li>mallocÂá∫Êù•‰∏Ä‰∏™chunk3ÔºåÊ≠§Êó∂ÂÜçÊ¨°free chunk2 ÔºåËøôÊó∂ÂÄôchunk2ËøõÂÖ•tcache binÔºåÈÇ£‰πàchunk2 Êó¢Âú®unsorted bin‰∏≠ÂèàÂú®tcache‰∏≠</li>
<li>malloc‰∏Ä‰∏™chunkÔºå‰ΩøÂæóunsorted binÂàÜÂâ≤Ôºå‰∏îËÉΩÂ§üËé∑Âæóchunk2 user dataÂå∫ÂüüÁöÑÊéßÂà∂ÊùÉÔºåÂ¶ÇÊ≠§ÔºåÂ∞±ÂèØ‰ª•Âä´ÊåÅfdÊåáÈíà‰∫Ü„ÄÇ</li>
</ul>
<p><strong>Ë°•ÂÖÖ</strong>Ôºö ÊúâÊó∂ÂÄôÔºåÈ¢òÁõÆ‰ºöÂØπmallocÁöÑÂ§ßÂ∞èÂÅöÈôêÂà∂ÔºåÊàë‰ª¨‰ªÖ‰ªÖÈúÄË¶Å‰∏ÄÊ¨°Â∞èÁöÑmalloc ÊâçËÉΩÂ§üËææÂà∞‰∏äÈù¢ÁöÑÊù°‰ª∂„ÄÇ</p>
<h4 id="libc2-32"><a class="header-anchor" href="#libc2-32">¬∂</a>libc2.32</h4>
<p>Ëøô‰∏™ÁâàÊú¨‰∏ãÁöÑÊñπÊ≥ïÂèØ‰ª•ÂÖ≥Ê≥® <code>VNCTF2021</code> ËøôÂú∫ÊØîËµõ‰∏≠Â§ßÈÉ®ÂàÜÁöÑpwnÈ¢òÈÉΩÊòØ2.32ÁöÑÁâàÊú¨„ÄÇ<br>
2.32Âíå2.31ÁöÑ‰∏ªË¶ÅÂå∫Âà´Âú®‰∫éÔºåtcacheÂèàÂÅö‰∫Ü‰∏ÄÊ¨°ÂÆâÂÖ®Âä†Âº∫Ôºåtcache_put‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's room
   for more chunks.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Mark this chunk as "in the tcache" so the test in _int_free will
     detect a double free.  */</span>
  e<span class="token operator">-></span>key <span class="token operator">=</span> tcache<span class="token punctuation">;</span>

  e<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token operator">-></span>next<span class="token punctuation">,</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's
   available chunks to remove.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): unaligned tcache chunk detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ÊîπÂèòÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>tcache_getÂáΩÊï∞‰∏≠ÔºåÂØπÂèñÂá∫ÁöÑchunkÂÅö‰∫ÜÂ†ÜÂú∞ÂùÄÂØπÈΩêÁöÑÊ£ÄÊü•</li>
<li>ÂØπnextÊåáÈíàÊ∑ªÂä†‰∫ÜÂä†ÂØÜÂíåËß£ÂØÜÊ£ÄÊü•</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#define PROTECT_PTR(pos, ptr) \</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>__typeof <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> pos<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#define REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>
<p>Âç≥ÔºånextÊåáÈíàÂ≠òÂÇ®ÁöÑÊòØÂéüÊù•ÁöÑÂÄºÂè≥Áßª12‰ΩçÔºåÁÑ∂ÂêéÂíåËá™Â∑±ÁöÑÂú∞ÂùÄÂºÇÊàñ‰πãÂêéÁöÑÂÄºÔºåËøôÊÑèÂë≥ÁùÄÔºåÂØπfdËøõË°åÂä´ÊåÅ‰ªéËÄå‰ªªÊÑèÂÜôÁöÑÂâçÊèêÊòØÔºåÂ∑≤Áªèleak‰∫ÜheapÂú∞ÂùÄ„ÄÇÁªô‰º†ÁªüÁöÑÂà©Áî®ÊñπÊ≥ïÂ¢ûÂä†‰∫Ü‰∏çÂ∞ëÈöæÂ∫¶„ÄÇ</p>
<blockquote>
<p>‰∏çËøáËã•ÊòØÊàë‰ª¨ËÉΩÂ§üÁõ¥Êé•ÊéßÂà∂¬†<code>tcache struct</code>ÔºåÂàô‰ªçÁÑ∂ÂèØ‰ª•Áõ¥Êé•ËøõË°å‰ªªÊÑèÂú∞ÂùÄÂÜôÔºåËøôÊòØÂõ†‰∏∫Âú® tcache struct ‰∏≠Â≠òÊîæÁöÑ‰ªçÊòØÊú™ÁªèÂºÇÊàñËøêÁÆóÁöÑÂéüÂßã chunk Âú∞ÂùÄ</p>
</blockquote>
<p>ÈíàÂØπÊñ∞ÁöÑ‰øùÊä§ÊñπÊ≥ïÔºåÂêåÊ†∑ÁöÑ‰πüÊúâÊñ∞ÁöÑÂà©Áî®ÊñπÊ≥ïÔºå‰∏çÈöæÂèëÁé∞ÔºåÂΩìÁ¨¨‰∏Ä‰∏™chunkËøõÂÖ•tcacheÁöÑÊó∂ÂÄôÔºåËá™Â∑±ÁöÑnextÂ≠òÂÇ®ÁöÑÊòØNULLÔºåËøôÊó∂ÂÄô‰πü‰ºöËøõË°åÂºÇÊàñÔºåÂºÇÊàñ‰πãÂêéÂæóÂà∞ÁöÑÂÄºÂ∞±Áõ¥Êé•ÊòØËá™Â∑±ÁöÑÂú∞ÂùÄÔºåÂΩìÊúâUAFÁöÑÊó∂ÂÄôÔºåÂ∞±ÂèØ‰ª•Áõ¥Êé•leakÂá∫Êù•heapÂú∞ÂùÄ‰∫Ü„ÄÇ</p>
<h4 id="libc2-34"><a class="header-anchor" href="#libc2-34">¬∂</a>libc2.34</h4>
<p>Ê≤°Âï•Â•ΩËØ¥ÁöÑÔºåÁõÆÂâçÊù•ÁúãÔºå‰∏ªÊµÅÊñπÊ≥ïÈÉΩÊòØÊâìIOÔºåHookÁöÑÂéªÈô§ÂØºËá¥ÂæàÂ§ö‰º†ÁªüÁöÑÊñπÊ≥ïÈÉΩÊ≤°‰∫Ü‰ΩúÁî®„ÄÇ</p>
<p>House of emma</p>
<h2 id="others"><a class="header-anchor" href="#others">¬∂</a>others</h2>
<p>‰∫ÜËß£‰∫ÜÂêÑ‰∏™ÁâàÊú¨‰∏≠Ê∑ªÂä†ÁöÑ‰øùÊä§‰πãÂêéÔºå‰πü‰∏ç‰∏ÄÂÆöËÉΩÂ§üËß£ÂÜ≥Â§ßÈÉ®ÂàÜÁöÑÂ†ÜÈ¢òÁõÆÔºåÂõ†‰∏∫Âú®ÊØè‰∏™È¢ò‰∏≠ÁöÑÈôêÂà∂Êù°‰ª∂‰∏ç‰∏ÄÊ†∑ÔºåÂú®‰∏çÂêåÁöÑÊù°‰ª∂‰∏ãÊûÑÈÄ†ÁöÑÂ†ÜÂà©Áî®ÊñπÊ≥ï‰∏çÂêå„ÄÇ</p>
<p>Âà©Áî®ÊñπÊ≥ïÁõÆÂâçÊØîËæÉÂá∫ÂêçÁöÑÊòØhow2heapÁöÑ‰∏ÄÁ≥ªÂàóÂà©Áî®ÊñπÂºèÔºåÂÖ∂‰∏≠ÁöÑhouse of Á≥ªÂàóÁöÑÂà©Áî®ÊñπÂºèËæÉ‰∏∫Â§öÊ†∑ÔºåÂèØ‰ª•Â§öÂÅöÂ≠¶‰π†ÔºåËøôÈáå‰∏ç‰∏Ä‰∏Ä‰ªãÁªçÔºåÈô§Ê≠§‰πãÂ§ñÔºåËøòÊúâ‰∏Ä‰∫õÂæàÊúâÊÑèÊÄùÁöÑtrickÔºåÊØîÂ¶ÇËØ¥ÂØπ<code>environ</code>ÁéØÂ¢ÉÂèòÈáèÁöÑÊîªÂáªÔºå<code>global_max_fast</code>ÁöÑÂà©Áî®ÔºåËøòÊúâVN2021‰∏≠Âá∫Áé∞ÁöÑ<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/archives/192/">LittleReadFlower</a>Ôºå‰øÆÊîπ<code>TCACHE_MAX_BINS</code>„ÄÇ„ÄÇ„ÄÇ„ÄÇ</p>
<p>ÊîªÂáªÂà©Áî®ÊñπÊ≥ïÂ±ÇÂá∫‰∏çÁ©∑ÔºåËøôÈáå‰πüÊó†Ê≥ïÂÆåÂÖ®ËÆ∞ÂΩïÔºåÊÄªÁªì‰∏ãÊù•Â∞±ÊòØÁôæÊó†Á¶ÅÂøåÔºåÂè™Ë¶ÅËÉΩÊÉ≥Âà∞ÁöÑÊñπÊ≥ïÔºåÈÉΩÂèØ‰ª•Âà©Áî®Ëµ∑Êù•„ÄÇÊñáÁ´†Âà∞Ê≠§ÁªìÊùüÔºåexploit‰ªéÊú™ÂÅúÊ≠¢„ÄÇ</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/heap/">#heap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Â†ÜÂà©Áî®ÂõûÈ°æ</div>
      <div>http://example.com/2022/11/22/Â†ÜÂà©Áî®ÂõûÈ°æ/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>‰ΩúËÄÖ</div>
          <div>Epiphany</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>ÂèëÂ∏É‰∫é</div>
          <div>2022Âπ¥11Êúà22Êó•</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>ËÆ∏ÂèØÂçèËÆÆ</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ÁΩ≤Âêç">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/18/web%E4%B8%AD%E4%B8%80%E4%BA%9B%E7%AE%80%E5%8D%95%E7%9A%84php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8Cjs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/" title="web‰∏≠‰∏Ä‰∫õÁÆÄÂçïÁöÑphpÂèçÂ∫èÂàóÂåñÂíåjsÂéüÂûãÈìæÊ±°Êüì">
                        <span class="hidden-mobile">web‰∏≠‰∏Ä‰∫õÁÆÄÂçïÁöÑphpÂèçÂ∫èÂàóÂåñÂíåjsÂéüÂûãÈìæÊ±°Êüì</span>
                        <span class="visible-mobile">‰∏ã‰∏ÄÁØá</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"QC4vvYPEM2BYGMlNkxfbdllW-gzGzoHsz","appKey":"nsnNub648pvsc3yts6pFQY1A","path":"window.location.pathname","placeholder":"ÁïôË®ÄÂè≠","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://qc4vvype.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ÁõÆÂΩï</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">ÊêúÁ¥¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">ÂÖ≥ÈîÆËØç</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="website-duration">ËΩΩÂÖ•ÁΩëÁ´ôËøêË°åÊó∂Èó¥...</span> <script src="/js/duration.js"></script> </div>   
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        ÊÄªËÆøÈóÆÈáè 
        <span id="leancloud-site-pv"></span>
         Ê¨°
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        ÊÄªËÆøÂÆ¢Êï∞ 
        <span id="leancloud-site-uv"></span>
         ‰∫∫
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">ÂçöÂÆ¢Âú®ÂÖÅËÆ∏ JavaScript ËøêË°åÁöÑÁéØÂ¢É‰∏ãÊµèËßàÊïàÊûúÊõ¥‰Ω≥</div>
  </noscript>
</body>
</html>
