

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/head.png">
  <link rel="icon" href="/img/head.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Epiphany">
  <meta name="keywords" content="">
  
    <meta name="description" content="ğŸ˜„å †ä¸Šçš„çŸ¥è¯†å¥½åƒéƒ½ä¸è®°å¾—äº†ï¼Œä¸“é—¨åšæ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä»¥åå†å›æ¥çœ‹å°±æ²¡å¿…è¦é‡æ–°å¼€å§‹å­¦ä¹ ã€‚ basic å‡ ç§binsçš„è¿›å…¥é€€å‡ºæ–¹å¼   fastbinï¼š FILOï¼Œä»å¤´éƒ¨æ’å…¥å’Œå–å‡º   unsorted binï¼š FIFOï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œä»å°¾éƒ¨å–å‡º   tcacheï¼š LIFOï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œå¤´éƒ¨å–å‡º   mmapå‡½æ•°åˆ†é…çš„æ˜ å°„ç©ºé—´å’Œmallocåˆ†é…çš„ç©ºé—´ä¸ä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œmmapå‡ºæ¥çš„åœ°å€å’Œl">
<meta property="og:type" content="article">
<meta property="og:title" content="å †åˆ©ç”¨å›é¡¾">
<meta property="og:url" content="http://example.com/2022/11/22/%E5%A0%86%E5%88%A9%E7%94%A8%E5%9B%9E%E9%A1%BE/index.html">
<meta property="og:site_name" content="Epiphany&#39;s blog">
<meta property="og:description" content="ğŸ˜„å †ä¸Šçš„çŸ¥è¯†å¥½åƒéƒ½ä¸è®°å¾—äº†ï¼Œä¸“é—¨åšæ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä»¥åå†å›æ¥çœ‹å°±æ²¡å¿…è¦é‡æ–°å¼€å§‹å­¦ä¹ ã€‚ basic å‡ ç§binsçš„è¿›å…¥é€€å‡ºæ–¹å¼   fastbinï¼š FILOï¼Œä»å¤´éƒ¨æ’å…¥å’Œå–å‡º   unsorted binï¼š FIFOï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œä»å°¾éƒ¨å–å‡º   tcacheï¼š LIFOï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œå¤´éƒ¨å–å‡º   mmapå‡½æ•°åˆ†é…çš„æ˜ å°„ç©ºé—´å’Œmallocåˆ†é…çš„ç©ºé—´ä¸ä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œmmapå‡ºæ¥çš„åœ°å€å’Œl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png">
<meta property="article:published_time" content="2022-11-22T00:30:58.000Z">
<meta property="article:modified_time" content="2022-11-26T00:19:54.131Z">
<meta property="article:author" content="Epiphany">
<meta property="article:tag" content="heap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png">
  
  
  
  <title>å †åˆ©ç”¨å›é¡¾ - Epiphany&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/test.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"ğŸ˜Š","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"syTAHbVDGa0ZSug10p7Z9QM4-gzGzoHsz","app_key":"BDZY8j2r1l97VE3uLcsrU2Vd","server_url":"https://sytahbvd.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Epiphany&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/CTF">
                    
                    CTF
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/CVE">
                    
                    CVE
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/others">
                    
                    others
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/chats">
                    
                    chats
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="å †åˆ©ç”¨å›é¡¾"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-22 08:30" pubdate>
          æ˜ŸæœŸäºŒ, åä¸€æœˆ 22æ—¥ 2022, 8:30 æ—©ä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          16k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          131 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">å †åˆ©ç”¨å›é¡¾</h1>
            
            
              <div class="markdown-body">
                
                <p>ğŸ˜„å †ä¸Šçš„çŸ¥è¯†å¥½åƒéƒ½ä¸è®°å¾—äº†ï¼Œä¸“é—¨åšæ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä»¥åå†å›æ¥çœ‹å°±æ²¡å¿…è¦é‡æ–°å¼€å§‹å­¦ä¹ ã€‚</p>
<h1>basic</h1>
<p><strong>å‡ ç§binsçš„è¿›å…¥é€€å‡ºæ–¹å¼</strong></p>
<ul>
<li>
<p>fastbinï¼š FILOï¼Œä»å¤´éƒ¨æ’å…¥å’Œå–å‡º</p>
</li>
<li>
<p>unsorted binï¼š FIFOï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œä»å°¾éƒ¨å–å‡º</p>
</li>
<li>
<p>tcacheï¼š LIFOï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œå¤´éƒ¨å–å‡º</p>
</li>
</ul>
<p><strong>mmap</strong>å‡½æ•°åˆ†é…çš„æ˜ å°„ç©ºé—´å’Œmallocåˆ†é…çš„ç©ºé—´ä¸ä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œmmapå‡ºæ¥çš„åœ°å€å’Œ<strong>libcåŸºå€</strong>å­˜åœ¨å›ºå®šçš„åç§»ï¼Œåœ¨leakçš„æ—¶å€™å¯ä»¥è€ƒè™‘ã€‚</p>
<h2 id="fastbinçš„ä¸€äº›æœºåˆ¶"><a class="header-anchor" href="#fastbinçš„ä¸€äº›æœºåˆ¶">Â¶</a>fastbinçš„ä¸€äº›æœºåˆ¶</h2>
<p>é¦–å…ˆï¼Œfastbinä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿåˆå¹¶ï¼Œé™¤éè§¦å‘<code>malloc_consolidate()</code>ï¼Œå½“ä¸€ä¸ªå †å—åŠ è¿›<code>fast bin</code>çš„æ—¶å€™ï¼Œä¸ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„<code>prev_inuse</code>ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œfastbinå¤§å°çš„chunkè¢«ä½¿ç”¨å’Œé‡Šæ”¾éƒ½ä¸ä¼šè§¦å‘å’Œä¸‹ä¸€ä¸ªchunkæœ‰å…³çš„å®‰å…¨æœºåˆ¶ã€‚</p>
<p>ä½†æ˜¯fastbinåœ¨é‡Šæ”¾çš„æ—¶å€™ä¼šæ£€æŸ¥è‡ªå·±çš„sizeå¤§å°ï¼Œç„¶åæ”¾å…¥åˆ°åˆé€‚çš„fastbiné“¾ä¸­ï¼ŒåŒæ ·çš„ï¼Œä»fastbinä¸­å–å‡ºæ—¶ï¼Œä¹Ÿä¼šæ£€æŸ¥sizeçš„å¤§å°æ˜¯å¦å’Œå½“å‰é“¾ç›¸ç¬¦åˆï¼Œè¿™è¦æ±‚åç»­ä¼ªé€ fastbin chunkçš„æ—¶å€™æ³¨æ„<code>size</code></p>
<p><strong>malloc_consolidate</strong>ï¼š å½“ç”³è¯·ä¸€ä¸ªå¤§äº<code>large chunk</code>æœ€å°å¤§å°ä¹‹åï¼ˆåŒ…æ‹¬å½“ç”³è¯·çš„<code>chunk</code>éœ€è¦è°ƒç”¨<code>brk()</code>ç”³è¯·æ–°çš„<code>top chunk</code>æˆ–è°ƒç”¨<code>mmap()</code>å‡½æ•°æ—¶ï¼‰ï¼Œ<strong>è§¦å‘malloc_consolidate</strong>ï¼Œç¨‹åºä¼šå°†<code>fastbin</code>å†…çš„chunkå–å‡ºï¼Œç›¸é‚»çš„f<code>ree chunk</code>åˆå¹¶åæ”¾å…¥<code>unsorted bin</code>ï¼Œæ­¤æ—¶å®Œæˆäº†è¯¥å®Œæˆçš„æ‰€æœ‰åˆå¹¶ä¹‹åï¼Œå¯»æ‰¾ä¹‹å‰mallocçš„large chunkï¼Œç†è®ºä¸Šsmall binæ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œäºæ˜¯ä¼šéå†<code>unsorted bin</code>ï¼Œæ­¤æ—¶<code>unsorted bin</code>å°†ä¹‹å‰åˆå¹¶çš„<code>chunk</code>å®Œæˆå†åˆ†é…ã€‚</p>
<p>å¯ä»¥é¢„è§åˆ°æœ€åçš„æ•ˆæœæ˜¯<code>fast bin</code>ä¸­çš„chunkè¢«å¡«å…¥äº†<code>small bin</code>ï¼Œæˆ–è€…åˆå¹¶åˆ°äº†unsorted binï¼Œè¢«åå…¥äº†<code>top chunk</code>ã€‚</p>
<h2 id="unsorted-bin"><a class="header-anchor" href="#unsorted-bin">Â¶</a>unsorted bin</h2>
<p>unsorted binä¸€èˆ¬æ˜¯<code>leak</code>çš„ä¸»è¦åœ°ç‚¹ï¼Œå’Œfast binä¸åŒçš„æ˜¯ï¼Œunsorted binæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œç”±<code>fd</code>å’Œ<code>bk</code>é“¾æ¥ï¼Œä¸»è¦è¿˜æ˜¯ç”±<code>bk</code>éå†ï¼ˆæºç å†³å®šï¼‰<code>A&lt;-B&lt;-C</code>è¿›ä¸€ä¸ª<code>D</code>å˜ä¸º<code>D&lt;-A&lt;-B&lt;-C</code>ï¼Œæ‹¿å‡ºä¸€ä¸ª<code>C</code>ï¼Œå˜ä¸º<code>D&lt;-A&lt;-B</code>ã€‚<code>bin</code>ä¸­å †å—å¤§å°å¯ä»¥ä¸åŒï¼Œä¸æ’åºã€‚</p>
<p><strong>æ³„éœ²libc</strong>ï¼Œè¿™æ˜¯å› ä¸º<code>unsorted bin</code>ä¸­æœ€å…ˆè¿›æ¥çš„chunkï¼Œå…¶ä¸­<code>fd</code>å’Œ<code>bk</code>éƒ½æŒ‡å‘<code>bin</code>ï¼Œè€Œè¿™ä¸ª<code>bin</code>ï¼Œå­˜åœ¨äº<code>main_arena</code>çš„ç»“æ„ä½“ä¸­ï¼Œåœ¨64ä½ä½ç‰ˆæœ¬çš„libcä¸­ï¼Œä¸€èˆ¬æ˜¯<code>&lt;main_arena+88&gt;</code>ï¼Œç‰ˆæœ¬ç¨å¾®é«˜ä¸€ç‚¹å°±åœ¨<code>&lt;main_arena+96&gt;</code>ï¼Œä¸€èˆ¬æ³„éœ²libcéƒ½ä¼šåˆ©ç”¨è¿™ä¸ªåœ°å€ã€‚</p>
<p>åŒæ—¶main_arenaçš„åœ°å€å’Œmalloc_hookå¾ˆè¿‘ï¼Œå³<code>malloc_hook+0x10=main_arena</code></p>
<h2 id="large-bin"><a class="header-anchor" href="#large-bin">Â¶</a>large bin</h2>
<p>è¿™æ˜¯ä¸€ä¸ªé‡ç‚¹ï¼Œåœ¨ç°åœ¨é«˜ç‰ˆæœ¬çš„libcä¸­ï¼Œå‡ ä¹éƒ½æ˜¯ç”¨large bin attackåŠ ä¸Šå…¶ä»–çš„æ‰‹æ³•æ”»å‡»ï¼Œlarge binæ˜¯åŒé“¾è¡¨ç»´æŠ¤ï¼Œä½†æ˜¯ç»´æŠ¤çš„æ–¹å¼æœ‰ç‚¹ç‰¹åˆ«ï¼Œä¸å†æ˜¯å•ä¸€çš„é“¾è¡¨ç®¡ç†ï¼Œè€Œæ˜¯åˆ†å—ç®¡ç†ã€‚large bin ä»¥å‰å­¦ä¹ çš„ä¹Ÿä¸å¤šï¼Œä¸‹é¢åšä¸€ä¸ªè¯¦ç»†çš„åŸºç¡€ä»‹ç»</p>
<p>åŸºæœ¬çš„ç†è§£å¯ä»¥ç†è§£ä¸ºæ¨ªå‘å’Œçºµå‘é“¾æ¥ï¼Œä»ç©ºé—´ä¸Šæ¥ç±»æ¯”åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªç½‘çŠ¶ç»“æ„ï¼Œä½†æ˜¯åˆä¸å®Œå…¨æ˜¯ç½‘çŠ¶ï¼Œ<strong>ä¸€æ¡ç»³å­ä¸Šä¸€ä¸ªåŒºåŸŸå†…å¤§å°çš„chunké€šè¿‡fd_nextsizeå’Œbk_nextsizeè¿æ¥åœ¨ä¸€èµ·ï¼Œç›¸åŒå¤§å°çš„chunkåˆé€šè¿‡fdå’Œbkç›¸é“¾æ¥</strong></p>
<p>åœ¨è§‚å¯Ÿå¦‚ä½•å–å‡ºå’Œå­˜å…¥chunkçš„æ—¶å€™ä¸å¦¨çœ‹ä¸€æ®µæºç </p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_largebin_range</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//åˆ¤æ–­æ˜¯å¦å±äºlargebin  </span>
            <span class="token punctuation">&#123;</span>  
              victim_index <span class="token operator">=</span> <span class="token function">largebin_index</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å¯»æ‰¾å½“å‰sizeåœ¨largebinä¸­çš„  </span>
              bck <span class="token operator">=</span> <span class="token function">bin_at</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å¯»æ‰¾main_arena  </span>
              fwd <span class="token operator">=</span> bck<span class="token operator">-></span>fd<span class="token punctuation">;</span><span class="token comment">//sizeæœ€å¤§çš„chunkçš„åœ°å€  </span>
   
              <span class="token comment">/* maintain large bins in sorted order */</span>  
              <span class="token keyword">if</span> <span class="token punctuation">(</span>fwd <span class="token operator">!=</span> bck<span class="token punctuation">)</span> <span class="token comment">//å¦‚æœè¡¨ä¸ä¸ºç©º  </span>
                <span class="token punctuation">&#123;</span>  
                  <span class="token comment">/* Or with inuse bit to speed comparisons */</span>  
                  size <span class="token operator">|=</span> PREV_INUSE<span class="token punctuation">;</span>  
                  <span class="token comment">/* if smaller than smallest, bypass loop below */</span>  
                  <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span>  
 <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>bk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//bck->bkæ˜¯å½“å‰æœ€å°çš„chunkï¼Œå¦‚æœsizeæ¯”å®ƒè¿˜å°ï¼Œé‚£ä¹ˆç›´æ¥æ’å…¥åˆ°è¡¨å°¾  </span>
                    <span class="token punctuation">&#123;</span>  
                      fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span><span class="token comment">//æ„Ÿè§‰è¿™ä¸ªä¸ç¬¦åˆæˆ‘è‡ªå·±çš„ç¼–ç ä¹ æƒ¯ï¼Œå¦‚æœæˆ‘å†™æˆ‘è‚¯å®šfwd=bck->fdï¼Œä¹Ÿå¥½ç†è§£ä¸€äº›  </span>
                      bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>  
   
                      victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>  
                      victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  
                      fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
<span class="token comment">//æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯é“¾è¡¨çš„æ’å…¥æ“ä½œ  </span>
                    <span class="token punctuation">&#125;</span>  
                  <span class="token keyword">else</span><span class="token comment">//å¦‚æœä¸æ˜¯æœ€å°ï¼Œé‚£å°±ç”±å°åˆ°å¤§æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”å®ƒå°çš„æ’åœ¨å®ƒçš„å‰é¢  </span>
                    <span class="token punctuation">&#123;</span>  
                      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size <span class="token operator">&lt;</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>  
                        <span class="token punctuation">&#123;</span>  
                          fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd_nextsize<span class="token punctuation">;</span>  
              <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token function">chunk_main_arena</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                        <span class="token punctuation">&#125;</span>  
   
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> size  
              <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">chunksize_nomask</span> <span class="token punctuation">(</span>fwd<span class="token punctuation">)</span><span class="token punctuation">)</span>  
                        <span class="token comment">/* Always insert in the second position.  */</span>  
                        fwd <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span><span class="token comment">//å¦‚æœè¯´æ˜¯å·²ç»å­˜åœ¨ç›¸åŒå¤§å°çš„chunkï¼Œå°±çºµå‘æ’å…¥  </span>
                      <span class="token keyword">else</span>  
                        <span class="token punctuation">&#123;</span>  
                          victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  
                          victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  
                          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>fwd<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">!=</span> fwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//è¿™ä¸ªæ£€æŸ¥å¥½åƒå’Œunlinkä¸€æ ·ï¼Œéƒ½æ˜¯æ£€æŸ¥fwdçš„æŒ‡é’ˆæœ‰æ²¡æœ‰è¢«æ¶æ„ä¿®æ”¹  </span>
                            <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): largebin double linked list corrupted (nextsize)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                          fwd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
                          victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
                        <span class="token punctuation">&#125;</span>  
                      bck <span class="token operator">=</span> fwd<span class="token operator">-></span>bk<span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œçš„bckæ˜¯ç”¨æ¥çºµå‘æ’å…¥çš„  </span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> fwd<span class="token punctuation">)</span>  
                        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): largebin double linked list corrupted (bk)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŒæ ·æ˜¯çºµå‘æ£€æŸ¥æŒ‡é’ˆæœ‰æ²¡æœ‰è¢«æ¶æ„ä¿®æ”¹  </span>
                    <span class="token punctuation">&#125;</span>  
                <span class="token punctuation">&#125;</span>  
              <span class="token keyword">else</span>  
                victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//å¦‚æœè¡¨ä¸ºç©ºï¼Œé‚£ä¹ˆæŒ‡é’ˆè‡ªæŒ‡  </span>
            <span class="token punctuation">&#125;</span>  
   
          <span class="token function">mark_bin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim_index<span class="token punctuation">)</span><span class="token punctuation">;</span>  
          victim<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
          victim<span class="token operator">-></span>fd <span class="token operator">=</span> fwd<span class="token punctuation">;</span>  
          fwd<span class="token operator">-></span>bk <span class="token operator">=</span> victim<span class="token punctuation">;</span>  
          bck<span class="token operator">-></span>fd <span class="token operator">=</span> victim<span class="token punctuation">;</span><span class="token comment">//ä¸ç®¡åˆ°åº•æœ‰æ²¡æœ‰é‡å¤ï¼Œéƒ½è¿›è¡Œä¸€æ¬¡çºµå‘é“¾æ¥ï¼Œä¿è¯ä¸€äº›æŒ‡é’ˆä¸ºNULL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œfastbin é“¾æ¥æ˜¯ä»å¤§åˆ°å°å¼€å§‹æ’åˆ—ã€‚</p>
<h3 id="å¦‚ä½•æ’å…¥chunk"><a class="header-anchor" href="#å¦‚ä½•æ’å…¥chunk">Â¶</a>å¦‚ä½•æ’å…¥chunk</h3>
<ul>
<li>å¯»æ‰¾indexï¼Œå³å¯»æ‰¾åœ¨å“ªä¸€æ¡ç»³å­ä¸Š</li>
<li>æœ‰äº†indexä¹‹åï¼Œé¦–å…ˆåˆ¤ç©ºï¼Œå¦‚æœé“¾è¡¨ä¸ºç©ºåˆ™<br>
<code>victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</code>è‡ªå·±æŒ‡å‘è‡ªå·±</li>
<li>ä¹‹ååˆ¤æ–­sizeï¼Œæ˜¯å¦æ¯”æœ€å°çš„chunkè¿˜è¦å°ï¼Œå¦‚æœæ¯”æœ€å°çš„è¿˜è¦å°ï¼Œé‚£ä¹ˆç›´æ¥æ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">fwd <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
bck <span class="token operator">=</span> bck<span class="token operator">-></span>bk<span class="token punctuation">;</span>  

victim<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token punctuation">;</span>  
victim<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize<span class="token punctuation">;</span>  
fwd<span class="token operator">-></span>fd<span class="token operator">-></span>bk_nextsize <span class="token operator">=</span> victim<span class="token operator">-></span>bk_nextsize<span class="token operator">-></span>fd_nextsize <span class="token operator">=</span> victim<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>è¿™é‡Œå®Œæˆå‰ä¸¤æ­¥çš„èµ‹å€¼ä¹‹åï¼Œfwdå°±æ˜¯binï¼Œå¯ä»¥å‘ç°å°±æ˜¯æŠŠvictimæ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚</p>
<ul>
<li>å¦‚æœä¸æ˜¯æœ€å°çš„ï¼Œ<strong>é‚£ä¹ˆä»å¤§åˆ°å°å¼€å§‹éå†</strong>
<ul>
<li>å¦‚æœæ‰¾åˆ°ä¸€æ ·å¤§å°çš„ï¼Œåˆ™ä½¿ç”¨å¤´æ’æ³•ï¼Œæ’å…¥ç›®æ ‡é“¾è¡¨</li>
<li>å¦‚æœæ²¡æœ‰ä¸€æ ·å¤§å°çš„ï¼Œåœ¨ä¸­é—´æ’å…¥å³å¯<br>
æ­¤æ—¶ï¼Œåˆfwdçš„å†…å­˜æ£€æµ‹ï¼Œæ£€æµ‹å’Œ<code>unlink</code>å·®ä¸å¤š<br>
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæœ€åä¸€æ®µèµ‹å€¼çš„ä»£ç ï¼Œæ¯ä¸€ç§æƒ…å†µéƒ½ä¼šæ‰§è¡Œ</li>
</ul>
</li>
</ul>
<h3 id="å–å‡ºchunk"><a class="header-anchor" href="#å–å‡ºchunk">Â¶</a>å–å‡ºchunk</h3>
<p>è¿™é‡Œé»˜è®¤èƒ½å¤Ÿä»largebinä¸­å–å‡ºã€‚å…ˆæ‰¾åˆ°ç›¸åº”çš„indexï¼Œåœ¨indexä¸­ä»å°åˆ°å¤§éå†å †å—ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”æ‰€éœ€å¤§å°å¤§ï¼ˆæˆ–ç­‰äºï¼‰çš„å †å—ã€‚ç„¶åunlinkï¼Œå’Œå…¶å®ƒçš„binsä¸€æ ·ï¼Œå­˜åœ¨ç€å¯¹fdï¼Œbkï¼Œfd_nextsizeä»¥åŠbk_nextsizeçš„æ£€æµ‹ã€‚å¯¹å–ä¸‹çš„chunkå¦‚æœå¤§å°ä¸ç­‰äºç”³è¯·çš„sizeï¼Œé‚£å°±å­˜åœ¨ç€åˆ‡å‰²æ“ä½œã€‚å¦‚æœå‰©ä½™å¤§å°å¤§äºMINSIZEã€‚åˆ™è¿”è¿˜ç»™unsorted binï¼Œå¦åˆ™ä¸€å¹¶ç»™ç”¨æˆ·ã€‚</p>
<h3 id="tcache"><a class="header-anchor" href="#tcache">Â¶</a>tcache</h3>
<p>è¿™ä¹Ÿæ˜¯2.26ç‰ˆä¹‹åå‡ºç°çš„ç®¡ç†æœºåˆ¶ï¼Œä»æŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œç®¡ç†çš„å®‰å…¨æ€§èƒ½ä¸å¦‚fastbinï¼Œä½†æ˜¯é€Ÿåº¦ç¡®å®æå‡äº†ã€‚</p>
<ul>
<li>
<p><code>tcache_perthread_struct</code>æ˜¯ä¸€ä¸ªç®¡ç†Tcacheçš„ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¹Ÿä½œä¸ºä¸€ä¸ªå¤§çš„chunkï¼Œå­˜åœ¨äºheapçš„å¼€å§‹ä½ç½®ï¼Œlibc2.27è¯¥chunkçš„å¤§å°ä¸º0x250ï¼Œåé¢å¢åŠ åˆ°äº†0x290ï¼Œ<code>tcache bin</code>çš„ä¿¡æ¯éƒ½ç”±è¯¥chunkå­˜å‚¨ï¼Œ<strong>åŠ«æŒ</strong>è¿™ä¸ªchunkå¯ä»¥æ§åˆ¶tcache binçš„æ‰€æœ‰æƒ…å†µã€‚</p>
</li>
<li>
<p>ä»<code>fastbin</code> å’Œ <code>smallbin</code>ä¸­æ‹¿å‡ºchunkä¹‹åï¼Œå‰©ä¸‹çš„chunkå…¨éƒ¨éƒ½ä¼šæ»‘å…¥tcache</p>
</li>
<li>
<p>åœ¨<code>__libc_malloc()</code>è°ƒç”¨<code>__int_malloc()</code>ä¹‹å‰ï¼Œå¦‚æœ<code>tcache bin</code>ä¸­æœ‰ç¬¦åˆè¦æ±‚çš„<code>chunk</code>å°±ç›´æ¥å°†å…¶è¿”å›ã€‚</p>
</li>
<li>
<p><code>calloc()</code>è¶Šè¿‡<code>tcache</code>å–<code>chunk</code>ï¼Œé€šè¿‡<code>calloc()</code>åˆ†é…çš„å †å—ä¼š<strong>æ¸…é›¶</strong>ã€‚<strong>è¡¥å……ï¼š</strong><code>realloc()</code>çš„ç‰¹æ®Šç”¨æ³•ï¼š<code>size == 0</code>æ—¶ï¼Œç­‰åŒäº<code>free</code>ï¼›<code>realloc_ptr == 0 &amp;&amp; size &gt; 0</code> æ—¶ç­‰åŒäº<code>malloc</code>ã€‚å¦‚æœå½“å‰è¿ç»­å†…å­˜å—è¶³å¤Ÿ<code>realloc</code>çš„è¯ï¼Œåªæ˜¯å°†<code>p</code>æ‰€æŒ‡å‘çš„ç©ºé—´æ‰©å¤§ï¼Œå¹¶è¿”å›<code>p</code>çš„æŒ‡é’ˆåœ°å€ï¼›å¦‚æœå½“å‰è¿ç»­å†…å­˜å—ä¸å¤Ÿï¼Œåˆ™å†æ‰¾ä¸€ä¸ªè¶³å¤Ÿå¤§çš„åœ°æ–¹ï¼Œåˆ†é…ä¸€å—æ–°çš„å†…å­˜<code>q</code>ï¼Œå¹¶å°†<code>p</code>æŒ‡å‘çš„å†…å®¹<code>copy</code>åˆ°<code>q</code>ï¼Œè¿”å› <code>q</code>ã€‚å¹¶å°†<code>p</code>æ‰€æŒ‡å‘çš„å†…å­˜ç©ºé—´<code>free</code>ï¼›è‹¥æ˜¯é€šè¿‡<code>realloc</code>ç¼©å°å †å—ï¼Œåˆ™è¿”å›çš„æŒ‡é’ˆ<code>p</code>ä¸å˜ï¼Œä½†åŸå…ˆç›¸æ¯”ç¼©å°åå¤šä½™çš„é‚£éƒ¨åˆ†å°†ä¼šè¢«<code>free</code>æ‰ã€‚</p>
</li>
</ul>
<p>åœ¨libcç‰ˆæœ¬çš„è¿­ä»£ä¸­ï¼Œtcacheä¹Ÿæœ‰å¾ˆå¤šçš„ä¿æŠ¤æœºåˆ¶çš„æ›´æ–°ï¼Œåé¢ä¼šåœ¨å…·ä½“çš„åˆ©ç”¨ä¸­æåˆ°</p>
<h3 id="topchunk"><a class="header-anchor" href="#topchunk">Â¶</a>topchunk</h3>
<p>topchunkçš„åˆ©ç”¨è¾ƒå°‘ï¼Œå‡ ä¹åªæœ‰ä¸€ä¸ª<code>house of force</code>ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›å°trick</p>
<blockquote>
<p>å½“ç”³è¯·çš„<code>size</code>ä¸å¤§äº<code>mmap</code>çš„é˜ˆå€¼ï¼Œä½†<code>top chunk</code>å½“å‰çš„å¤§å°åˆä¸è¶³ä»¥åˆ†é…ï¼Œåˆ™ä¼šæ‰©å±•<code>top chunk</code>ï¼Œç„¶åä»æ–°<code>top chunk</code>é‡Œè¿›è¡Œåˆ†é…ã€‚</p>
</blockquote>
<p>ä½†æ˜¯ï¼Œå½“ç”³è¯·çš„sizeå¤§äºtopchunkçš„æ—¶å€™ï¼Œä¸ä¸€å®šä¼šç›´æ¥æ‰©å±•topchunkçš„å¤§å°ï¼Œè€Œæ˜¯freeåŸæ¥çš„topchunkï¼Œç„¶åå†mallocä¸€å—æ–°çš„topchunkï¼Œè¿™ç§æœºåˆ¶å†house of orangeä¸­è¢«ç”¨åˆ°ï¼Œå¸¸ç”¨äºç¨‹åºä¸­æ²¡æœ‰freeçš„æœºä¼šã€‚</p>
<p>å…·ä½“æ˜¯ï¼Œå¦‚æœ<code>brk</code>ç­‰äºè¯¥ä¸å¤Ÿå¤§å°çš„<code>top chunk</code>ï¼ˆè¢«è®°ä½œ<code>old_top_chunk</code>ï¼‰çš„<code>end</code>ä½ç½®ï¼ˆ<code>old_end</code>ï¼Œç­‰äº<code>old_top + old_size</code>ï¼‰ï¼Œå³<code>top chunk</code>çš„<code>size</code>å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå®Œå…¨æ˜¯è‡ªç„¶åœ°åˆ†é…å †å—ï¼Œå¯¼è‡´äº†<code>top chunk</code>ä¸å¤Ÿç”¨ï¼Œåˆ™ä¼šä»<code>old_top</code>å¤„å¼€è¾Ÿæ›´å¤§çš„ä¸€å—ç©ºé—´ä½œä¸ºæ–°çš„<code>top chunk</code>ï¼Œä¹Ÿå°±æ˜¯å°†åŸå…ˆçš„<code>old_top_chunk</code>è¿›è¡Œæ‰©å±•äº†ï¼Œæ­¤æ—¶æ²¡æœ‰<code>free</code>ï¼Œä¸”<code>top chunk</code>çš„èµ·å§‹ä½ç½®ä¹Ÿæ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯å¦‚æœ<code>brk</code>ä¸ç­‰äº<code>old_end</code>ï¼Œåˆ™ä¼šå…ˆ<code>free</code>æ‰<code>old_top_chunk</code>ï¼Œå†ä»<code>brk</code>å¤„å¼€è¾Ÿä¸€ç‰‡ç©ºé—´ä½œä¸º<code>new_top_chunk</code>ï¼Œæ­¤æ—¶çš„<code>top chunk</code>å¤´éƒ¨ä½ç½®å˜ä¸ºäº†åŸå…ˆçš„<code>brk</code>ï¼Œè€Œå¦‚ä»Šçš„<code>brk</code>ä¹Ÿåšäº†ç›¸åº”çš„æ‰©å±•ï¼Œå¹¶ä¸”<code>unsorted bin</code>æˆ–<code>tcache</code>ä¸­ï¼ˆä¸€èˆ¬ä¿®æ”¹çš„å¤§å°éƒ½è‡³å°‘ä¼šæ˜¯<code>small bin</code>èŒƒå›´ï¼Œä½†å…·ä½“åœ¨å“ªå¾—åˆ†æƒ…å†µçœ‹ï¼‰ä¼šæœ‰è¢«<code>free</code>çš„<code>old_top_chunk</code>ã€‚ å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ”¹å°<code>top chunk</code>çš„<code>size</code>ï¼Œå†ç”³è¯·å¤§å †å—ï¼Œåšåˆ°å¯¹æ—§<code>top chunk</code>çš„<code>free</code>ï¼Œä¸è¿‡ä¿®æ”¹çš„<code>size</code>éœ€è¦ç»•è¿‡ä¸€äº›æ£€æµ‹ã€‚ ç›¸å…³æºç å¦‚ä¸‹ï¼š</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">old_top <span class="token operator">=</span> av<span class="token operator">-></span>top<span class="token punctuation">;</span>  
old_size <span class="token operator">=</span> <span class="token function">chunksize</span> <span class="token punctuation">(</span>old_top<span class="token punctuation">)</span><span class="token punctuation">;</span>  
old_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">chunk_at_offset</span> <span class="token punctuation">(</span>old_top<span class="token punctuation">,</span> old_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// old_end = old_top + old_size  </span>
<span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>old_top <span class="token operator">==</span> <span class="token function">initial_top</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> old_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>  
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>old_size<span class="token punctuation">)</span> <span class="token operator">>=</span> MINSIZE <span class="token operator">&amp;&amp;</span>  
         <span class="token function">prev_inuse</span> <span class="token punctuation">(</span>old_top<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> old_end <span class="token operator">&amp;</span> <span class="token punctuation">(</span>pagesize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>éœ€è¦ç»•è¿‡ä»¥ä¸Šçš„æ–­è¨€ï¼Œä¸»è¦å°±æ˜¯è¦æ±‚è¢«ä¿®æ”¹çš„<code>top chunk</code>çš„<code>size</code>çš„<code>prev_inuse</code>ä½è¦ä¸º<code>1</code>å¹¶ä¸”<code>old_end</code>è¦å†…å­˜é¡µå¯¹é½ï¼Œæ‰€ä»¥å°±è¦æ±‚è¢«ä¿®æ”¹çš„<code>size</code>çš„åä¸‰ä½å’ŒåŸå…ˆè¦ä¿æŒä¸€è‡´ã€‚</p>
<h1>Vulnerable &amp; exploit</h1>
<p>ä¸‹é¢æ˜¯æ€»ç»“ä¸€äº›æ¼æ´å‡ºç°çš„æƒ…å†µå’Œåˆ©ç”¨æ–¹å¼</p>
<p>ç›®å‰æ¥çœ‹ï¼Œæ¼æ´å‡ºç°çš„æ¨¡å¼å°±åªæœ‰å››ç§ï¼š</p>
<ol>
<li>
<p>æº¢å‡ºï¼Œæœ´å®æ— åçš„æº¢å‡º</p>
</li>
<li>
<p>ç‰¹æ®Šçš„æº¢å‡ºï¼Œå³off_by_one</p>
</li>
<li>
<p>UAFï¼Œä»£ç ç¼–å†™ä¸Šçš„bug</p>
</li>
<li>
<p>å †é£æ°´</p>
</li>
</ol>
<p>åœ¨æ¼æ´åˆ©ç”¨ä¸Šé¢ï¼Œå…ˆä¸è€ƒè™‘æ¼æ´çš„ç±»å‹ï¼Œä»å †æ¼æ´åˆ°rceçš„è¿‡ç¨‹ä¸­ï¼Œæœ€æ ¸å¿ƒçš„å‡ ä¸ªæ­¥éª¤å°±æ˜¯èƒ½å¤Ÿleakï¼Œleakä¹‹åèƒ½å¤ŸåŠ«æŒchunkçš„åˆ†é…ï¼Œå³é€šè¿‡æ¼æ´è·å¾—ä»»æ„åœ°å€å†™ï¼Œä¿®æ”¹hookæˆ–è€…IOï¼Œè·å¾—shell</p>
<p>æŠŠæ¼æ´å’Œåˆ©ç”¨çš„ç›®çš„ç»“åˆåœ¨ä¸€èµ·çœ‹ï¼Œä¼¼ä¹æ›´èƒ½å¤Ÿçœ‹åˆ°å…¶ä¸­çš„è”ç³»</p>
<h2 id="leak"><a class="header-anchor" href="#leak">Â¶</a>leak?</h2>
<p>æ³„éœ²çš„æ–¹æ³•æœ‰ç‚¹å•è°ƒï¼Œåœ¨æ—©æœŸæ— éå°±æ˜¯unsorted binï¼Œé€šè¿‡UAFæˆ–è€…åˆ«çš„æ–¹æ³•ï¼Œè·å¾—unsorted binä¸­çš„æŒ‡é’ˆï¼Œä»è€Œæ³„éœ²å‡ºmain_arenaçš„åœ°å€ï¼Œåé¢åˆ™è¿˜å¯ä»¥é€šè¿‡IOçš„åŠ«æŒæ¥è¾¾åˆ°ç›®æ ‡ã€‚</p>
<p>å…ˆè¯´åŠ«æŒ<code>unsorted bin</code>ä¸­çš„æŒ‡é’ˆï¼Œå…¶ä¸­æœ‰ä¸€ç‚¹æ˜¯ï¼Œåœ¨æŸä¸ªç‰ˆæœ¬ä¹‹å‰ï¼Œunsorted binä¸­çš„chunkå–å‡ºæ¥çš„æ—¶å€™ä¸ä¼šæ¶ˆé™¤å…¶ä¸­æ®‹ç•™çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å¾ˆç®€å•çš„<code>free malloc</code>å°±å¯ä»¥è·å¾—libcçš„åŸºå€</p>
<p><img src="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122210635583.png" srcset="/img/loading.gif" lazyload alt="image-20221122210635583"></p>
<p>è¿™ç§æ–¹æ³•çœ‹èµ·æ¥ç®€å•ï¼Œä½†æ˜¯å®é™…ä¸Šè¿ç”¨çš„æ¯”è¾ƒå°‘ï¼Œæ¯•ç«Ÿè¿™ä¹ˆç®€å•çš„æœºä¼šï¼Œæ€»æœ‰äº›é™åˆ¶æ¡ä»¶ç»™passæ‰çš„ã€‚ä¸€èˆ¬èƒ½å¤Ÿåˆ©ç”¨çš„leakæ–¹æ³•å’ŒåŠ«æŒéƒ½æ˜¯ç›¸é€šçš„ï¼Œåœ¨æ²¡æœ‰ç›´æ¥UAFçš„æ¡ä»¶ä¸‹ï¼Œæ„é€ å‡ºæ¥<code>chunk overlap</code>å³ä¸€ä¸ªchunkåŒæ—¶å¤„åœ¨unsorted binå’Œåˆ«çš„ä½ç½®ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œptr1å’Œptr2éƒ½æŒ‡å‘chunkï¼Œä½†æ˜¯ptr2æŒ‡å‘unsorted binï¼Œæ‰€ä»¥å°±æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨ptr1æ³„éœ²ã€‚</p>
<p>æ­¤å¤–ï¼Œåˆ©ç”¨IOè¿›è¡Œleakä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•å¤šç”¨äºæ²¡æœ‰leakå‡½æ•°çš„æƒ…å†µï¼ŒIOçš„åˆ©ç”¨è¿™é‡Œä¸å¤šè®²ï¼Œå†…å®¹æ¯”è¾ƒå¤šï¼Œåé¢å•ç‹¬æ€»ç»“ã€‚</p>
<p>é™¤äº†libcçš„åŸºå€ä¹‹å¤–ï¼Œè¿˜æœ‰heapçš„åŸºå€ï¼Œheapçš„åŸºå€leakèµ·æ¥å’Œlibcå·®ä¸å¤šï¼Œä¸€èˆ¬libcçš„éš¾åº¦æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯ä¸æ’é™¤å‰é¢è®²çš„libcåŸºå€ç›´æ¥é€šè¿‡unsorted binå¸¦å‡ºæ¥ï¼Œè¿™ç§æƒ…å†µä¸‹leak heapçš„åœ°å€å°±è¦ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•ã€‚</p>
<p>è§‚å¯Ÿ<code>large bin</code>æ’å…¥chunkæ—¶çš„æºç ï¼Œå¯ä»¥å‘ç°å¦‚æœæ’å…¥çš„ä½ç½®åŸæ¥ä¸ºç©ºï¼Œåˆ™<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>éƒ½æŒ‡å‘è‡ªå·±</p>
<p><img src="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221122215109112.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>é€šè¿‡è¿™æ ·çš„ç‰¹æ®Šæ¡ä»¶å¯ä»¥leakå‡ºæ¥heapåŸºå€ã€‚</p>
<p>æ­¤å¤–ï¼Œåœ¨<code>libc2.32</code>ä»¥åŠä»¥åçš„ç‰ˆæœ¬ï¼Œä¼šå¯¹<code>tcache çš„ fd</code>æŒ‡é’ˆåšä¸€ä¸ªç‰¹æ®Šçš„å¼‚æˆ–ä¿æŠ¤æ“ä½œï¼Œä½†æ˜¯åœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼Œç¬¬ä¸€ä¸ªchunkè¢«é“¾å…¥çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥leakå‡ºå †åœ°å€ï¼Œè¿™ä¸ªåé¢å¯ä»¥è¯¦ç»†è¯´ã€‚</p>
<p>æ€»ç»“ä»¥ä¸Šçš„leakæ–¹æ³•ï¼Œåˆ†ä»¥ä¸‹å‡ ç§æƒ…å†µã€‚ï¼ˆéƒ½å»ºç«‹åœ¨æœ‰leak å‡½æ•°çš„æ¡ä»¶ï¼‰</p>
<ol>
<li>
<p>å¦‚æœå¯ä»¥ç›´æ¥ free mallocå¸¦å‡ºmain_arenaçš„åœ°å€ï¼Œå¯ä»¥ç›´æ¥leak</p>
</li>
<li>
<p>å¦‚æœä»¥ä¸Šæ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸”æ¼æ´æ¡ä»¶ä¸ºUAFï¼Œåˆ™ç›´æ¥freeä¹‹åå¯ä»¥leak</p>
</li>
<li>
<p>å¦‚æœæ¼æ´ä¸ä¸ºUAFï¼Œåˆ™éœ€è¦è€ƒè™‘åˆ«çš„æ–¹æ³•ï¼Œæ‰“ä¸€ä¸ªå †é‡å chunkè¿›unsorted bin</p>
</li>
</ol>
<h3 id="åˆ©ç”¨"><a class="header-anchor" href="#åˆ©ç”¨">Â¶</a>åˆ©ç”¨</h3>
<p>åˆ©ç”¨çš„æ–¹æ³•å°±æ¯”è¾ƒå¤šæ ·åŒ–äº†ï¼Œä½†æ˜¯åˆ©ç”¨çš„ç›®æ ‡è¿˜æ˜¯ä¸å˜çš„ï¼Œä»»æ„åœ°å€å†™æˆ–è€…è¯´ä»»æ„åœ°å€å †åˆ†é…çš„æƒåŠ›ï¼Œå†å¾€ä¸‹ç»†ä¸€ç‚¹å°±æ˜¯ï¼Œéœ€è¦åŠ«æŒ<code>fd</code>æŒ‡é’ˆï¼Œç„¶åå†è¿›ä¸€æ­¥æ§åˆ¶ç¨‹åºæµç¨‹ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™å°±ä¼šè€ƒè™‘åˆ°å¾ˆå¤šçš„ ä¿æŠ¤æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦å¯¹å„å¤§libcç‰ˆæœ¬çš„ä¿æŠ¤æ–¹æ³•åšä¸€ä¸ªæ€»ç»“</p>
<p>å…³æ³¨ç°åœ¨æ¯”è¾ƒä¸»æµçš„ï¼Œlibc2.27å¼€å§‹ä¸€ç›´åˆ°libc2.34ï¼Œ23ç‰ˆæœ¬å°±ä¸å¤šè¯´äº†ï¼Œå‡ºç°è¾ƒå°‘ï¼Œæ”»å‡»æ–¹å¼å®é™…ä¸Šä¹Ÿæ¯”è¾ƒå•ä¸€ã€‚</p>
<h4 id="libc2-27"><a class="header-anchor" href="#libc2-27">Â¶</a>libc2.27</h4>
<p>å®é™…ä¸Šåœ¨libc2.27åˆ†ä¸ºä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸»è¦æ˜¯åœ¨2.27ä¸­åšäº†ä¸€æ¬¡å°æ›´æ–°ï¼Œä¿®å¤äº†<code>tcache</code>çš„æ— è„‘<code>double free</code>ï¼Œå› ä¸ºåœ¨æœ€å¼€å§‹çš„tcacheä¸­æ²¡æœ‰double freeæ£€æŸ¥ï¼Œæ‰€ä»¥é‡åˆ°é¢˜ç›®æ˜¯2.27çš„ï¼Œéƒ½å¯ä»¥è¯•ä¸€ä¸‹èƒ½ä¸èƒ½double freeã€‚</p>
<p>å…¶æ¬¡ï¼Œtcacheæ˜¯å¯ä»¥ä»»æ„åœ°å€å†™çš„ï¼Œæ²¡æœ‰fast biné‚£ç§é™åˆ¶sizeçš„æ£€æŸ¥ï¼Œä½†åŒæ—¶è¦æ³¨æ„çš„æ˜¯<strong>fdæŒ‡å‘çš„å¹¶ä¸æ˜¯å †å¤´ï¼Œè€Œæ˜¯å †å†…å®¹</strong>ï¼Œå³ä¼ªé€ fdçš„æ—¶å€™ï¼Œ<code>fd</code>åº”è¯¥ç›´æ¥å†™åˆ°<code>target address</code>ï¼Œåœ¨æœ‰<code>tcache</code>çš„<code>libc</code>å‘è¡Œç‰ˆä¸­ï¼Œä¿æŠ¤æœ€è–„å¼±çš„å°±æ˜¯2.27äº†ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¥½æ€»ç»“çš„ï¼Œæ²¡æœ‰ç‰¹æ®Šçš„åˆ©ç”¨æ–¹æ³•ï¼Œå°±æ˜¯å¾ˆæœ´ç´ çš„åŠ«æŒfdæŒ‡é’ˆï¼Œç„¶åä»»æ„åœ°å€å†™ã€‚</p>
<p>è¿™é‡Œæä¸€ä¸ªæœ‰æ„çš„åˆ©ç”¨æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨åç»­çš„ç‰ˆæœ¬ä¸­ä¹Ÿé€‚ç”¨ï¼Œä½†æ˜¯é€ æˆçš„å±å®³ä¸ä¸€æ ·ã€‚</p>
<h5 id="Tcache-Stashing-Unlink-Attack"><a class="header-anchor" href="#Tcache-Stashing-Unlink-Attack">Â¶</a>Tcache Stashing Unlink Attack</h5>
<p>è¿™ç§attackåˆ©ç”¨çš„æ˜¯<code>small bin</code>å’Œtcacheçš„å…³ç³»ï¼Œåœ¨é«˜ç‰ˆæœ¬ä¸­è¿˜æœ‰proç‰ˆæœ¬ã€‚çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚  </span>
bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>  
<span class="token comment">// æ£€æŸ¥ bck->fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€   </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    errstr <span class="token operator">=</span> <span class="token string">"malloc(): smallbin double linked list corrupted"</span><span class="token punctuation">;</span>  
    <span class="token keyword">goto</span> errout<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
<span class="token comment">// è®¾ç½® victim å¯¹åº”çš„ inuse ä½  </span>
<span class="token function">set_inuse_bit_at_offset</span><span class="token punctuation">(</span>victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">// ä¿®æ”¹ small bin é“¾è¡¨ï¼Œå°† small bin çš„æœ€åä¸€ä¸ª chunk å–å‡ºæ¥  </span>
bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>  
bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>è¿™æ˜¯<code>small bin</code>å–å‡ºæœ€åä¸€ä¸ªchunkçš„æ“ä½œï¼Œå¯ä»¥å‘ç°ï¼Œæ£€æŸ¥äº†åŒé“¾çš„å®Œæ•´æ€§ï¼Œä½†æ˜¯æ²¡æœ‰æ£€æŸ¥bckçš„åˆæ³•æ€§ã€‚åœ¨ä¸Šé¢çš„tcacheç‰¹æ€§ä¸­æåˆ°äº†ï¼Œä»<code>small bin</code>ä¸­å–å‡ºä¸€ä¸ªchunkä¹‹åï¼Œå‰©ä¸‹çš„æ‰€æœ‰chunkä¼šæ»‘å…¥å¯¹åº”å¤§å°çš„<code>tcache bin</code>ä¸­ï¼Œä¸‹é¢çœ‹tcacheä¸­çš„ä»£ç </p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE    </span></span>
      <span class="token comment">/* While we're here, if we see other chunks of the same size,   
         stash them in the tcache. */</span>    
      <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–å¯¹åº”sizeçš„tcacheç´¢å¼•    </span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span> <span class="token comment">//å¦‚æœè¯¥ç´¢å¼•åœ¨tcache binèŒƒå›´    </span>
        <span class="token punctuation">&#123;</span>    
          mchunkptr tc_victim<span class="token punctuation">;</span>    
    
          <span class="token comment">/* While bin not empty and tcache not full, copy chunks over. */</span>    
          <span class="token keyword">while</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count  <span class="token comment">//å½“tcache binä¸ä¸ºç©ºå¹¶ä¸”æ²¡æ»¡ï¼Œå¹¶ä¸”small binä¸ä¸ºç©ºï¼Œåˆ™ä¾æ¬¡å–æœ€åä¸€ä¸ªchunkæ’å…¥åˆ°tcache biné‡Œ    </span>
             <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">=</span> <span class="token function">last</span> <span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> bin<span class="token punctuation">)</span>    
        <span class="token punctuation">&#123;</span>    
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    
            <span class="token punctuation">&#123;</span>    
              bck <span class="token operator">=</span> tc_victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>    
              <span class="token function">set_inuse_bit_at_offset</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>    
              <span class="token keyword">if</span> <span class="token punctuation">(</span>av <span class="token operator">!=</span> <span class="token operator">&amp;</span>main_arena<span class="token punctuation">)</span>    
            <span class="token function">set_non_main_arena</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">)</span><span class="token punctuation">;</span>    
              bin<span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span> <span class="token comment">//å°†å½“å‰chunkä»small biné‡Œå¸ä¸‹    </span>
              bck<span class="token operator">-></span>fd <span class="token operator">=</span> bin<span class="token punctuation">;</span>    
                      <span class="token comment">//æ”¾å…¥tcache biné‡Œ    </span>
              <span class="token function">tcache_put</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token punctuation">&#125;</span>    
        <span class="token punctuation">&#125;</span>    
        <span class="token punctuation">&#125;</span>    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>è¿™é‡Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œwhileå¾ªç¯ä¸­ï¼Œä¸æ–­çš„é€šè¿‡<code>tcache_put</code>ï¼ŒæŠŠchunkä»<code>small bin</code>ä¸­è½¬ç§»åˆ°tcacheä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ²¡æœ‰ä»»ä½•çš„æ£€æŸ¥ï¼Œå¹¶ä¸”ï¼Œè„±é“¾çš„æ—¶å€™ä¹Ÿæ²¡æœ‰æ£€æŸ¥é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œå› ä¸ºåœ¨å‰é¢çš„<code>small binè„±é“¾ä¸­</code>å·²ç»æ£€æŸ¥äº†å½“æ—¶çš„Victimå’Œbcké“¾è¡¨çš„å®Œæ•´ã€‚</p>
<p><strong>é‚£ä¹ˆå¯ä»¥æ€è€ƒ</strong>ï¼Œå¦‚æœsmall binä¸­å­˜åœ¨3ä¸ªchunkï¼Œåˆ†åˆ«ä¸ºchunk1 chunk2 chunk3ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶chunk2çš„bkæŒ‡é’ˆï¼ŒåŠ«æŒè¿™ä¸ªbkåˆ°target addressï¼Œç„¶åæ‰§è¡Œåˆ°<code>bck = tc_victim-&gt;bk;</code>çš„æ—¶å€™ï¼Œè¿™ä¸ªbckæ˜¯<code>target address</code>ï¼Œåé¢æ‰§è¡Œ<code>bck-&gt;fd=bin</code>åˆ™å¾€<code>target address+0x10</code>ä¸­å†™å…¥äº†ä¸€ä¸ª<code>main_arena</code>çš„åœ°å€ï¼Œå¹¶ä¸”é€šè¿‡<code>tcache_put</code>èƒ½å¤ŸæŠŠ<code>victim</code>å†™å…¥<code>tcache bin</code>ä¸­ï¼Œæ­¤å¤–è¿˜éœ€è¦ä¸€ä¸ªæ¡ä»¶ï¼Œå°±æ˜¯tcacheåˆšå¥½åªç•™ä¸‹æ¥äº†ä¸€ä¸ªä½ç½®ï¼Œè¿™æ˜¯æœ€ç†æƒ³çš„ï¼Œå› ä¸ºç†è®ºä¸Šåˆ†æï¼Œå¦‚æœæŸåsmall binçš„bkæŒ‡é’ˆï¼Œä¸‹ä¸€æ¬¡çš„æ“ä½œå¿…ç„¶ä¼šå‡ºç°é”™è¯¯ï¼Œæ‰€ä»¥æœ€å¥½æ˜¯èƒ½å¤Ÿæ§åˆ¶ä½tcacheçš„countï¼Œè¾¾åˆ°æ¼æ´ç›®æ ‡ä¹‹ååœæ­¢whileå¾ªç¯ã€‚</p>
<p>æ¼æ´å±å®³çœ‹èµ·æ¥è›®å¤§ï¼Œä½†æ˜¯æœ‰ä¸ªbugï¼Œæ¼æ´éœ€è¦çš„å‰ææ¡ä»¶æ˜¯ï¼Œä»small binä¸­å–å‡ºæ¥ä¸€ä¸ªchunkï¼Œä½†æ˜¯åœ¨æœ‰tcacheçš„æ¡ä»¶ä¸‹ï¼Œéœ€è¦tcacheä¸ºç©ºä¼¼ä¹æ‰å¯ä»¥è¾¾åˆ°è¿™ä¸ªæ¡ä»¶ï¼Œä½†æ˜¯è¿™æ ·çš„è¯å¦‚æœéœ€è¦ä»small binå–å‡ºchunkï¼Œé‚£ä¹ˆå°±éœ€è¦tcacheä¸ºç©ºï¼Œæ­¤æ—¶åˆæ— æ³•æ§åˆ¶tcacheçš„æ•°é‡ï¼Œæ‰€ä»¥è¯´å¦‚æœä»…ä»…æ˜¯mallocçš„è¯ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€å®šçŸ›ç›¾çš„ï¼Œæ‰€ä»¥è¿™ç§attackä¸€èˆ¬ä½¿ç”¨åœ¨callocçš„æ—¶å€™ã€‚</p>
<blockquote>
<p>æ•ˆæœ &amp; åˆ©ç”¨æ¡ä»¶</p>
</blockquote>
<p>é€ æˆçš„ç»“æœæ˜¯ä»»æ„åœ°å€å†™ä¸€ä¸ªmain_arenaçš„åœ°å€ï¼Œå’Œä»»æ„åœ°å€é“¾æ¥è¿›tcacheï¼Œåˆ©ç”¨æ¡ä»¶å¦‚ä¸‹</p>
<ul>
<li>æœ‰tcache</li>
<li>è‡³å°‘æœ‰ä¸€æ¬¡èƒ½å¤Ÿè¶Šè¿‡tcache ä»small binä¸­å–å‡ºchunk ï¼ˆ calloc ï¼‰</li>
<li>æœ‰æœºä¼šè®©chunkä»<code>unsorted bin</code>ä¸­æ»‘å…¥<code>small bin</code></li>
<li>å¯ä»¥åŠ«æŒbkæŒ‡é’ˆ<br>
åˆ©ç”¨ä¹‹åçš„å †ç©ºé—´</li>
</ul>
<p><img src="https://fortypra.oss-cn-hangzhou.aliyuncs.com/img/image-20221123201213840.png" srcset="/img/loading.gif" lazyload alt="image-20221123201213840"></p>
<blockquote>
<p>åˆ©ç”¨æ–¹æ³•</p>
</blockquote>
<ul>
<li>é¦–å…ˆå¡«æ»¡tcache</li>
<li>ç„¶åfreeä¸¤ä¸ªchunkè¿›unsorted binï¼Œï¼ˆä¸å¯ä»¥åˆå¹¶ï¼‰</li>
<li>ç„¶åç”³è¯·ä¸€ä¸ªå¤§çš„chunkï¼ŒæŠŠunsorted biné‡Œé¢çš„chunkæ»‘å…¥small bin</li>
<li>UAFåŠ«æŒå€’æ•°ç¬¬äºŒä¸ªchunkçš„bkï¼Œæ³¨æ„è¿™ä¸ªbkæ˜¯chunkå¤´ï¼Œå®ƒæ˜¯è¦è¢«é“¾å…¥tcacheçš„ã€‚è€Œfake_chunkæŒ‡å‘çš„bkå¯ä»¥æŒ‡å‘ä»»æ„ä½ç½®â†’vul_addrï¼Œè¯¥ä½ç½®è¢«è®¤ä¸ºæ˜¯ä¸‹ä¸€ä¸ªbckï¼Œä¼šé€ æˆvul_addr+0x10=bin</li>
</ul>
<h4 id="libc2-29"><a class="header-anchor" href="#libc2-29">Â¶</a>libc2.29</h4>
<p>ä»libc2.27åˆ°2.29æœ€æ˜æ˜¾çš„å°±æ˜¯æ·»åŠ äº†<code>tcache key</code>ï¼Œå³æ”¹å˜äº†tcacheçš„ç»“æ„ä½“ï¼Œç”¨äºè¡¨ç¤º<code>chunk</code>æ˜¯å¦å·²ç»åœ¨æ‰€å±çš„<code>tcache bin</code>ä¸­ï¼Œå¯¹äºæ¯ä¸ª<code>chunk</code>è€Œè¨€ï¼Œ<code>key</code>åœ¨å…¶<code>bk</code>æŒ‡é’ˆçš„ä½ç½®ä¸Šã€‚æ£€æŸ¥ä»£ç å¦‚ä¸‹ï¼š</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span><span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> tcache<span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  
    tcache_entry <span class="token operator">*</span>tmp<span class="token punctuation">;</span>  
    <span class="token function">LIBC_PROBE</span><span class="token punctuation">(</span>memory_tcache_double_free<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span> tmp<span class="token punctuation">;</span> tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">)</span>  
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> e<span class="token punctuation">)</span>  
        <span class="token function">malloc_printerr</span><span class="token punctuation">(</span><span class="token string">"free(): double free detected in tcache 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>æ£€æŸ¥äº†<code>double free</code>ï¼Œå¦‚æœå½“æ—¶eå·²ç»æœ‰keyäº†ï¼Œä¸”eå’Œtcache binçš„ç¬¬ä¸€ä¸ªchunkæ˜¯ä¸€æ ·çš„ï¼Œåˆ™è§¦å‘double freeçš„æ£€æŸ¥ï¼Œè¿™ä¸ªå…³é”®çš„<code>key</code>ï¼Œåœ¨è¿›è¡Œtcache_putçš„æ—¶å€™ä¼šè¢«èµ‹å€¼ä¸º<code>tcache_struct</code>çš„åœ°å€ï¼Œåœ¨<code>tcache_get</code>çš„æ—¶å€™è¿›è¡Œæ¸…ç©ºã€‚</p>
<p>ç»•è¿‡çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæƒ³åŠæ³•ç ´åæ‰è¿™ä¸ªkeyï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¿›å…¥ifçš„æ¡ä»¶ï¼Œæ­¤æ—¶ç›¸å½“äºå¯ä»¥ç›´æ¥double freeã€‚</p>
<p>æ­¤å¤–æ·»åŠ äº†ä¸€ä¸ª<code>unlink</code>æ£€æŸ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* consolidate backward */</span>  
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prev_inuse</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    prevsize <span class="token operator">=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    size <span class="token operator">+=</span> prevsize<span class="token punctuation">;</span>  
    p <span class="token operator">=</span> <span class="token function">chunk_at_offset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!=</span> prevsize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//add  </span>
        <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size while consolidating"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//add  </span>
    <span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ä»£ç æ·»åŠ åœ¨<code>free</code>çš„æ—¶å€™ï¼Œfreeæ“ä½œæ—¶ï¼Œä¼šæ‰§è¡Œä¸Šé¢çš„<code>unlink</code>æ£€æŸ¥ï¼Œè¿™ä¸ªæ£€æŸ¥æ£€æŸ¥äº†<code>pre_inuse</code>ä½ï¼Œå¦‚æœpçš„pre_inuseä¸º0ï¼Œå³å‰ä¸€ä¸ªchunkä¸ºfreeçŠ¶æ€ï¼Œé‚£ä¹ˆä¼šé€šè¿‡<code>pre_size</code>çš„å¤§å°è·å¾—å‰ä¸€ä¸ªchunkçš„sizeï¼Œç„¶åå†å‘ç”Ÿ<code>unlink</code>ã€‚åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸å­˜åœ¨è¿™ä¸ªæ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>off_by_NULL</code>å¾ˆç®€å•çš„æ„é€ <code>chunk_overlap</code>ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<h5 id="off-by-NULLåˆ©ç”¨"><a class="header-anchor" href="#off-by-NULLåˆ©ç”¨">Â¶</a>off_by_NULLåˆ©ç”¨</h5>
<blockquote>
<ul>
<li>
<p>malloc(0x500) è·å¾—chunk1 malloc(0xf8) * 3 è·å¾—chunk 2 3 4</p>
</li>
<li>
<p>ç¼–è¾‘chunk 3 æ”¹å˜chunk 4çš„presize = chunk1 + chunk2 + chunk3 ä¸”è¦†ç›–chunk4çš„pre_inuse</p>
</li>
<li>
<p>free chunk1 æ­¤æ—¶chunk1 è¿›å…¥unsorted bin</p>
</li>
<li>
<p>free chunk4 å¦‚æœæ²¡æœ‰ä¸Šè¿°æ£€æŸ¥åˆ™ï¼Œchunk4å’Œchunk1 å‘ç”Ÿunlinkï¼ŒæŠŠchunk1 åˆ°chunk4çš„æ‰€æœ‰ç©ºé—´åå…¥unsorted bin</p>
</li>
<li>
<p>æ­¤æ—¶chunk2 chunk3 æ—¢å­˜åœ¨äºunsorted binï¼Œåˆå¯ä»¥è¢«ç”¨æˆ·ä½¿ç”¨</p>
</li>
</ul>
</blockquote>
<p>å±äºoff_by_oneæ¯”è¾ƒç»å…¸çš„åˆ©ç”¨äº†ã€‚ä½†æ˜¯libc2.29åœ¨free chunk4çš„æ—¶å€™å‡ºç°äº†sizeçš„æ£€æŸ¥ï¼ŒæŒ‰ç…§åŸæ¥çš„æ–¹æ³•ï¼Œå¿…ç„¶æ˜¯ä¸èƒ½é€šè¿‡æ£€æŸ¥çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘å¦å¤–çš„æ–¹æ³•æ¥å®Œæˆåˆ©ç”¨ï¼Œæœ€ç®€å•ç›´æ¥çš„åŠæ³•å°±æ˜¯åœ¨chunkçš„user_dataåŸŸå†ä¼ªé€ ä¸€ä¸ªchunkï¼Œè¿™æ ·å°±å¯ä»¥æ»¡è¶³sizeçš„è¦æ±‚äº†ã€‚</p>
<p>ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œçœ‹<code>unlink</code>çš„ä»£ç </p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Take a chunk off a bin list. */</span>  
<span class="token keyword">static</span> <span class="token keyword">void</span>  
<span class="token function">unlink_chunk</span> <span class="token punctuation">(</span>mstate av<span class="token punctuation">,</span> mchunkptr p<span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">prev_size</span> <span class="token punctuation">(</span><span class="token function">next_chunk</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted size vs. prev_size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  mchunkptr fd <span class="token operator">=</span> p<span class="token operator">-></span>fd<span class="token punctuation">;</span>  
  mchunkptr bk <span class="token operator">=</span> p<span class="token operator">-></span>bk<span class="token punctuation">;</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>fd<span class="token operator">-></span>bk <span class="token operator">!=</span> p <span class="token operator">||</span> bk<span class="token operator">-></span>fd <span class="token operator">!=</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// é“¾è¡¨é‡Œï¼Œp->å‰å‘->åå‘==pã€‚  </span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"corrupted double-linked list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ç»•è¿‡äº†ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œunlinkä¾ç„¶è¦æ£€æŸ¥åŒå‘é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œæ­¤æ—¶å¯¹äºè¿™ä¸ªunlinkæ£€æŸ¥ï¼Œè€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>
<p>å¦‚æœå¯ä»¥è·å¾—heapåœ°å€ï¼Œç›´æ¥ä¼ªé€ å³å¯ï¼Œè®©fdå’Œbkéƒ½æŒ‡å‘è‡ªå·±ï¼ˆè¿™é‡Œçš„<code>fd</code>å’Œ<code>bk</code>æŒ‡çš„æ˜¯<code>fake_chunk</code>çš„<code>fd</code>å’Œ<code>bk</code>ï¼Œè‡ªå·±æŒ‡çš„æ˜¯<code>fake_chunk</code>ï¼‰</p>
</li>
<li>
<p>æ²¡æœ‰heap baseï¼Œæƒ³åŠæ³•åˆ›é€ æ¡ä»¶ï¼Œåˆ©ç”¨heapæ“ä½œæ®‹ç•™çš„heapåœ°å€</p>
</li>
</ul>
<p>ç¬¬äºŒç‚¹è”åˆç¬¬ä¸€ç‚¹å¾ˆå®¹æ˜“æƒ³èµ·æ¥<code>large bin</code>ï¼Œå½“<code>large bin</code>ä¸­åŒä¸€ä¸ªindexçš„chunkä½¿ç”¨<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ç›¸è¿æ¥ã€‚<br>
åœ¨æ²¡æœ‰æ³„éœ²çš„å‰æä¸‹åˆ©ç”¨<code>fd_nextsizeå’Œbk_nextsize</code>ä¸¤ä¸ªheapæŒ‡é’ˆï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ã€‚</p>
<h6 id="æ®‹ä½™çš„heapæŒ‡é’ˆï¼ˆåŸºæœ¬æ— æ³•ä½¿ç”¨ï¼‰"><a class="header-anchor" href="#æ®‹ä½™çš„heapæŒ‡é’ˆï¼ˆåŸºæœ¬æ— æ³•ä½¿ç”¨ï¼‰">Â¶</a>æ®‹ä½™çš„heapæŒ‡é’ˆï¼ˆåŸºæœ¬æ— æ³•ä½¿ç”¨ï¼‰</h6>
<ul>
<li>é¦–å…ˆmallocå‡ºæ¥ä¸€ä¸ªlarge bin chunkï¼Œç„¶åmallocå‡ºæ¥ï¼Œmallocå‡ºæ¥çš„æ—¶å€™åˆ©ç”¨editçš„æœºä¼šï¼Œå¯¹<code>fd_nextsize</code>è¿›è¡Œ<code>partial overwrite</code>ï¼Œä½¿å¾—è¯¥æŒ‡é’ˆæŒ‡å‘å¦å¤–ä¸€ä¸ªæœ‰heapæŒ‡é’ˆçš„chunkï¼Œè¿™æ—¶å€™fd_nextsizeä½œä¸ºfake chunkçš„fdæŒ‡é’ˆï¼Œåˆ©ç”¨å¦å¤–ä¸€ä¸ªæœ‰heapæŒ‡é’ˆçš„chunkï¼Œå®Œæˆäº†<code>fd-&gt;bk = p</code>çš„æ£€æŸ¥ï¼Œæ­¤å¤„æ³¨æ„ï¼Œè¿™ä¸ªæœ‰heapæŒ‡é’ˆçš„chunkä¹Ÿéœ€è¦æå‰è¿›è¡Œpartial overwriteä½¿å¾—å…¶heapæŒ‡é’ˆæŒ‡å‘pã€‚</li>
<li>free ä¸€ä¸ªchunkè¿›å…¥tcacheï¼Œç„¶åå†åˆ©ç”¨off_by_oneæ”¹å˜å‰é¢é‚£ä¸ªlarge bin chunkçš„å¤§å°ï¼Œä½¿å¾—å…¶ä¸ºtcacheå¤§å°ï¼Œç„¶åfree è¿™ä¸ªchunkï¼Œè¿™æ—¶å€™ï¼Œä¹‹å‰é‚£ä¸ªlarge bin chunkçš„fdæŒ‡é’ˆï¼ŒæŒ‡å‘äº†è¿™ä¸€æ­¥åˆšå¼€å§‹è¢«freeçš„tcacheï¼Œå³åœ¨large bin + 0x10çš„ä½ç½®è¸©å‡ºä¸€ä¸ªheapåœ°å€</li>
<li>æœ€åmallocå‡ºæ¥è¿™ä¸ªä¿®æ”¹å¤§å°åè¿›å…¥tcache çš„ large bin chunkï¼Œç„¶åpartial overwriteä¿®æ”¹ä½ä½ï¼Œä½¿å¾—+0x10ä½ç½®çš„heapåœ°å€æŒ‡å‘pï¼Œä»è€Œç»•è¿‡bk-&gt;fd = pçš„æ£€æŸ¥</li>
</ul>
<p>è¿‡ç¨‹æä¸ºç¹çï¼Œä¸”<strong>ä¸å®ç”¨</strong>ï¼Œåœ¨åæ¥çš„ç‰ˆæœ¬ï¼ˆ<font color="#ff0000">glibc2.29</font>ï¼‰ï¼Œå‡ºç°äº†tcacheçš„keyæœºåˆ¶ï¼Œå¯¼è‡´fake_chunkçš„sizeä¼šåœ¨è¸©å‡ºheapåœ°å€çš„æ—¶å€™è¢«keyè¦†ç›–ï¼Œæ‰€ä»¥æ–¹æ³•éœ€è¦æ”¹åˆ°<code>fast bin</code>ä¸­æ‰§è¡Œï¼Œè¿™æ˜¯é™åˆ¶æ¡ä»¶ä¹‹ä¸€ï¼Œé™åˆ¶æ¡ä»¶ä¹‹äºŒæ˜¯ï¼Œå¾ˆå¤šçš„è¾“å…¥è¦æ±‚ä¸­ï¼Œä¼šåœ¨è¾“å…¥çš„æœ«å°¾è¾“å…¥<code>\x00å’Œ\n</code>ï¼Œè¿™å¯¼è‡´äº†partial overwriteä¼šå¤±è´¥ï¼Œæˆ–è€…è¯´éœ€è¦çˆ†ç ´ã€‚</p>
<p>æ‰€ä»¥ä»¥ä¸Šçš„æ–¹æ³•ç°åœ¨åŸºæœ¬ä¸Šéƒ½æ— æ³•ä½¿ç”¨ã€‚ç°åœ¨ç”¨çš„å‡ ä¹éƒ½æ˜¯ä¸‹é¢çš„æ–¹æ³•ã€‚</p>
<h6 id="unsorted-binå’Œlarge-binçš„é“¾æœºåˆ¶"><a class="header-anchor" href="#unsorted-binå’Œlarge-binçš„é“¾æœºåˆ¶">Â¶</a>unsorted binå’Œlarge binçš„é“¾æœºåˆ¶</h6>
<p>è¿™ç§æ–¹æ³•æˆ‘æ˜¯ä»NepCTFä¸­å­¦æ¥çš„ï¼ŒNepCTFä¸­ç”±Nepæˆ˜é˜Ÿçš„FMYYå¸ˆå‚…å‡ºäº†ä¸€é“é¢˜ï¼Œ<strong>NULL_FXCK</strong>ï¼Œè¿™é“é¢˜çš„è§£æ³•å¤šæ ·ï¼Œä¸”å¯¹å †çš„æ„é€ è¦æ±‚æé«˜ï¼Œæ¯”èµ›ä¸­ä»…æœ‰cnitlrtå¸ˆå‚…å®Œæˆï¼Œæ˜¯ä¸€é“å¾ˆæœ‰æ„æ€çš„é¢˜ç›®ï¼ˆé£æ²äº‘çƒŸyydsï¼‰</p>
<p>åœ¨å‚è€ƒwjhå¸ˆå‚…çš„åšå®¢ä¹‹åï¼Œå½“æ—¶ç®—æ˜¯å®Œå–„äº†ä¸€å—çŸ­æ¿ï¼Œé‚£æ—¶å€™ä»æ¥æ²¡æœ‰åœ¨é«˜ç‰ˆæœ¬çš„libcä¸‹å°è¯•è¿‡off_by_oneçš„æ„é€ ã€‚</p>
<p>é¦–å…ˆè®²å¸¸è§„çš„åˆ©ç”¨large biné“¾å­çš„æ‰“æ³•ï¼Œè¿™ç§æ–¹æ³•æ˜¯éœ€è¦<font color="#ff0000">çˆ†ç ´</font>çš„ï¼Œå…·ä½“<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45209963/article/details/126758789">é“¾æ¥</a>ï¼Œåœ¨æˆ‘çœ‹æ¥æœ¬è´¨ä¸Šçš„åŒºåˆ«ä¸æ˜¯å¾ˆå¤šï¼Œä¸»è¦æ˜¯æ¢äº†unsorted binæ‰“ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„å¤æ‚åº¦ä¸Šä¸ä½äºä¸Šé¢çš„æ–¹æ³•ï¼Œåªæ˜¯unsorted binæ¯”fastbinç®€å•ï¼Œæœ€åçš„partial overwriteæ—¶ï¼Œå› ä¸ºéœ€è¦è¦†ç›–ä¸¤ä½ï¼Œæ‰€ä»¥å¯¹äºç¬¬äºŒä¸ªå­—èŠ‚çš„é«˜4bitæ˜¯æ— æ³•æ§åˆ¶çš„ï¼Œè¿™å°±éœ€è¦çˆ†ç ´ï¼Œæ¦‚ç‡ä¸º1/16ã€‚</p>
<p>ç„¶åè®²çš„æ˜¯ä¸€ç§ä¸éœ€è¦çˆ†ç ´çš„æ–¹æ³•ï¼Œ<strong>è¿™ç§æ–¹æ³•ä¸ä¾èµ–äºlarge bin</strong>ï¼Œè€Œæ˜¯å•çº¯çš„åˆ©ç”¨unsorted binå’Œheapåœ¨åˆå¹¶å’Œåˆ†å‰²çš„æ—¶å€™æ®‹ç•™çš„heapæŒ‡é’ˆã€‚<br>
ç¯‡å¹…æœ‰é™ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„æ–‡ç« ï¼š<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45209963/article/details/126758789">https://blog.csdn.net/weixin_45209963/article/details/126758789</a><br>
<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/archives/193/">https://blog.wjhwjhn.com/archives/193/</a></p>
<hr>
<p>é™¤äº†ä»¥ä¸Šçš„æ£€æŸ¥ä¹‹å¤–ï¼Œè¿˜æ·»åŠ äº†top chunkçš„æ£€æŸ¥ï¼Œé˜²æŠ¤ä½äº†house of forceçš„æ”»å‡»ï¼ŒåŒæ—¶ï¼Œunlinkç”±ä¸€ä¸ªå®ï¼Œå˜æˆäº†ä¸€ä¸ªä¸“é—¨çš„å‡½æ•°ï¼Œæ·»åŠ äº†åŒé“¾å®Œæ•´æ€§çš„æ£€æŸ¥ï¼Œä½¿å¾—unsorted bin attackå˜å¾—æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨é«˜ç‰ˆæœ¬ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨large bin attack æ›¿ä»£unsorted bin attackã€‚</p>
<h4 id="libc2-31"><a class="header-anchor" href="#libc2-31">Â¶</a>libc2.31</h4>
<p>è¯¥ç‰ˆæœ¬ä¸­ï¼Œå¯¹large binçš„fd_nextsizeå’Œbk_nextsizeåšäº†é™åˆ¶ï¼Œæ™®é€šçš„æ„é€ large bin attackçš„åŠæ³•å·²ç»å¤±æ•ˆï¼Œä½†æ˜¯å¦‚ä¸‹çš„payload Demoè¿˜èƒ½å¤Ÿä½¿ç”¨</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">p1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x4a8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p2 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x478</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// trigger chunk1 into largebin</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">free</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p1<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>victim<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">;</span>

<span class="token comment">// largebin attack</span>
<span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>ä¹‹åç›¸æ¯”äº2.29æ²¡æœ‰åšæ¯”è¾ƒå¤§çš„æ›´æ–°ï¼ŒåŸºæœ¬ä¸Šä¿æŠ¤æœºåˆ¶éƒ½ä¸€æ ·ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä»‹ç»å‡ ç§ç»å…¸çš„åˆ©ç”¨æ–¹æ³•ï¼Œå¹³æ—¶ä¹Ÿç®—æ¯”è¾ƒå°‘è§çš„ã€‚<br>
è¯¥ç‰ˆæœ¬ä¸‹ä¸»è¦åˆ©ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š<br>
tcache stash unlink å…¨å®¶æ¡¶ #House_of_botcake #fastbin_reverse_into_tcache<br>
ä»¥ä¸Šçš„ä¸‰ç§æ–¹æ³•å‡å¯ä»¥åˆ©ç”¨åœ¨libc2.29ç‰ˆæœ¬ï¼Œæˆ–è€…è¯´é€‚ç”¨äºtcacheç‰ˆæœ¬ã€‚<br>
tcache çš„stashæœºåˆ¶å‰é¢ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸»è¦æä¸€ä¸‹botcakeçš„åˆ©ç”¨æ–¹æ³•ã€‚ï¼ˆfastbinçš„åˆ©ç”¨æ–¹æ³•å’Œstashæœºåˆ¶ç±»ä¼¼ï¼Œä¸è¿‡æ„Ÿè§‰æœ‰ç‚¹é¸¡è‚‹ï¼‰</p>
<h5 id="house-of-botcake"><a class="header-anchor" href="#house-of-botcake">Â¶</a>house of botcake</h5>
<p>è¿™æ˜¯ä¸€ç§åœ¨UAFçš„æ¡ä»¶ä¸‹çš„åˆ©ç”¨ï¼Œä¸»è¦é€‚ç”¨äºï¼Œå­˜åœ¨UAFä½†æ˜¯æ²¡æœ‰editçš„åŠæ³•ï¼Œå³åªèƒ½å¤Ÿåœ¨mallocä¹‹åé©¬ä¸Šeditï¼Œè€Œä¸å¯ä»¥å•ç‹¬çš„æ‰§è¡Œeditã€‚<br>
æ¡ä»¶ï¼š</p>
<ul>
<li>æœ‰tcache</li>
<li>å¯ä»¥UAf<br>
åˆ©ç”¨çš„æœ¬è´¨æ˜¯ï¼ŒåŒä¸€ä¸ªchunkè¿›è¡Œä¸¤æ¬¡freeå¯¼è‡´chunkåˆ†åˆ«ä½äºunsorted binå’Œtcacheï¼Œç”±äºä½äº<code>unsorted bin</code>ä¸­çš„chunkæ²¡æœ‰keyï¼Œæ‰€ä»¥ç»•è¿‡äº†<code>tcache bin</code>çš„æ£€æŸ¥ã€‚<br>
åˆ©ç”¨è¿‡ç¨‹ï¼š</li>
<li>å¡«æ»¡tcache binï¼Œfree chunk1 chunk2ï¼Œæ­¤æ—¶chunk1å’Œ2è¿›å…¥äº†unsorted binï¼Œä¸”è¦ä¿è¯1 å’Œ 2ç›¸é‚»ï¼Œè¿›å…¥unsorted binä¹‹åäºŒè€…åˆå¹¶</li>
<li>mallocå‡ºæ¥ä¸€ä¸ªchunk3ï¼Œæ­¤æ—¶å†æ¬¡free chunk2 ï¼Œè¿™æ—¶å€™chunk2è¿›å…¥tcache binï¼Œé‚£ä¹ˆchunk2 æ—¢åœ¨unsorted binä¸­åˆåœ¨tcacheä¸­</li>
<li>mallocä¸€ä¸ªchunkï¼Œä½¿å¾—unsorted binåˆ†å‰²ï¼Œä¸”èƒ½å¤Ÿè·å¾—chunk2 user dataåŒºåŸŸçš„æ§åˆ¶æƒï¼Œå¦‚æ­¤ï¼Œå°±å¯ä»¥åŠ«æŒfdæŒ‡é’ˆäº†ã€‚</li>
</ul>
<p><strong>è¡¥å……</strong>ï¼š æœ‰æ—¶å€™ï¼Œé¢˜ç›®ä¼šå¯¹mallocçš„å¤§å°åšé™åˆ¶ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦ä¸€æ¬¡å°çš„malloc æ‰èƒ½å¤Ÿè¾¾åˆ°ä¸Šé¢çš„æ¡ä»¶ã€‚</p>
<h4 id="libc2-32"><a class="header-anchor" href="#libc2-32">Â¶</a>libc2.32</h4>
<p>è¿™ä¸ªç‰ˆæœ¬ä¸‹çš„æ–¹æ³•å¯ä»¥å…³æ³¨ <code>VNCTF2021</code> è¿™åœºæ¯”èµ›ä¸­å¤§éƒ¨åˆ†çš„pwné¢˜éƒ½æ˜¯2.32çš„ç‰ˆæœ¬ã€‚<br>
2.32å’Œ2.31çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œtcacheåˆåšäº†ä¸€æ¬¡å®‰å…¨åŠ å¼ºï¼Œtcache_putä»£ç å¦‚ä¸‹ï¼š</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's room
   for more chunks.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Mark this chunk as "in the tcache" so the test in _int_free will
     detect a double free.  */</span>
  e<span class="token operator">-></span>key <span class="token operator">=</span> tcache<span class="token punctuation">;</span>

  e<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token operator">-></span>next<span class="token punctuation">,</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's
   available chunks to remove.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): unaligned tcache chunk detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>æ”¹å˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>tcache_getå‡½æ•°ä¸­ï¼Œå¯¹å–å‡ºçš„chunkåšäº†å †åœ°å€å¯¹é½çš„æ£€æŸ¥</li>
<li>å¯¹nextæŒ‡é’ˆæ·»åŠ äº†åŠ å¯†å’Œè§£å¯†æ£€æŸ¥</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#define PROTECT_PTR(pos, ptr) \</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span>__typeof <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> pos<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#define REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>
<p>å³ï¼ŒnextæŒ‡é’ˆå­˜å‚¨çš„æ˜¯åŸæ¥çš„å€¼å³ç§»12ä½ï¼Œç„¶åå’Œè‡ªå·±çš„åœ°å€å¼‚æˆ–ä¹‹åçš„å€¼ï¼Œè¿™æ„å‘³ç€ï¼Œå¯¹fdè¿›è¡ŒåŠ«æŒä»è€Œä»»æ„å†™çš„å‰ææ˜¯ï¼Œå·²ç»leakäº†heapåœ°å€ã€‚ç»™ä¼ ç»Ÿçš„åˆ©ç”¨æ–¹æ³•å¢åŠ äº†ä¸å°‘éš¾åº¦ã€‚</p>
<blockquote>
<p>ä¸è¿‡è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥æ§åˆ¶Â <code>tcache struct</code>ï¼Œåˆ™ä»ç„¶å¯ä»¥ç›´æ¥è¿›è¡Œä»»æ„åœ°å€å†™ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ tcache struct ä¸­å­˜æ”¾çš„ä»æ˜¯æœªç»å¼‚æˆ–è¿ç®—çš„åŸå§‹ chunk åœ°å€</p>
</blockquote>
<p>é’ˆå¯¹æ–°çš„ä¿æŠ¤æ–¹æ³•ï¼ŒåŒæ ·çš„ä¹Ÿæœ‰æ–°çš„åˆ©ç”¨æ–¹æ³•ï¼Œä¸éš¾å‘ç°ï¼Œå½“ç¬¬ä¸€ä¸ªchunkè¿›å…¥tcacheçš„æ—¶å€™ï¼Œè‡ªå·±çš„nextå­˜å‚¨çš„æ˜¯NULLï¼Œè¿™æ—¶å€™ä¹Ÿä¼šè¿›è¡Œå¼‚æˆ–ï¼Œå¼‚æˆ–ä¹‹åå¾—åˆ°çš„å€¼å°±ç›´æ¥æ˜¯è‡ªå·±çš„åœ°å€ï¼Œå½“æœ‰UAFçš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥leakå‡ºæ¥heapåœ°å€äº†ã€‚</p>
<h4 id="libc2-34"><a class="header-anchor" href="#libc2-34">Â¶</a>libc2.34</h4>
<p>æ²¡å•¥å¥½è¯´çš„ï¼Œç›®å‰æ¥çœ‹ï¼Œä¸»æµæ–¹æ³•éƒ½æ˜¯æ‰“IOï¼ŒHookçš„å»é™¤å¯¼è‡´å¾ˆå¤šä¼ ç»Ÿçš„æ–¹æ³•éƒ½æ²¡äº†ä½œç”¨ã€‚</p>
<p>House of emma</p>
<h2 id="others"><a class="header-anchor" href="#others">Â¶</a>others</h2>
<p>äº†è§£äº†å„ä¸ªç‰ˆæœ¬ä¸­æ·»åŠ çš„ä¿æŠ¤ä¹‹åï¼Œä¹Ÿä¸ä¸€å®šèƒ½å¤Ÿè§£å†³å¤§éƒ¨åˆ†çš„å †é¢˜ç›®ï¼Œå› ä¸ºåœ¨æ¯ä¸ªé¢˜ä¸­çš„é™åˆ¶æ¡ä»¶ä¸ä¸€æ ·ï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹æ„é€ çš„å †åˆ©ç”¨æ–¹æ³•ä¸åŒã€‚</p>
<p>åˆ©ç”¨æ–¹æ³•ç›®å‰æ¯”è¾ƒå‡ºåçš„æ˜¯how2heapçš„ä¸€ç³»åˆ—åˆ©ç”¨æ–¹å¼ï¼Œå…¶ä¸­çš„house of ç³»åˆ—çš„åˆ©ç”¨æ–¹å¼è¾ƒä¸ºå¤šæ ·ï¼Œå¯ä»¥å¤šåšå­¦ä¹ ï¼Œè¿™é‡Œä¸ä¸€ä¸€ä»‹ç»ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å¾ˆæœ‰æ„æ€çš„trickï¼Œæ¯”å¦‚è¯´å¯¹<code>environ</code>ç¯å¢ƒå˜é‡çš„æ”»å‡»ï¼Œ<code>global_max_fast</code>çš„åˆ©ç”¨ï¼Œè¿˜æœ‰VN2021ä¸­å‡ºç°çš„<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/archives/192/">LittleReadFlower</a>ï¼Œä¿®æ”¹<code>TCACHE_MAX_BINS</code>ã€‚ã€‚ã€‚ã€‚</p>
<p>æ”»å‡»åˆ©ç”¨æ–¹æ³•å±‚å‡ºä¸ç©·ï¼Œè¿™é‡Œä¹Ÿæ— æ³•å®Œå…¨è®°å½•ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ç™¾æ— ç¦å¿Œï¼Œåªè¦èƒ½æƒ³åˆ°çš„æ–¹æ³•ï¼Œéƒ½å¯ä»¥åˆ©ç”¨èµ·æ¥ã€‚æ–‡ç« åˆ°æ­¤ç»“æŸï¼Œexploitä»æœªåœæ­¢ã€‚</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/heap/">#heap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>å †åˆ©ç”¨å›é¡¾</div>
      <div>http://example.com/2022/11/22/å †åˆ©ç”¨å›é¡¾/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Epiphany</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´11æœˆ22æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/18/web%E4%B8%AD%E4%B8%80%E4%BA%9B%E7%AE%80%E5%8D%95%E7%9A%84php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8Cjs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/" title="webä¸­ä¸€äº›ç®€å•çš„phpååºåˆ—åŒ–å’ŒjsåŸå‹é“¾æ±¡æŸ“">
                        <span class="hidden-mobile">webä¸­ä¸€äº›ç®€å•çš„phpååºåˆ—åŒ–å’ŒjsåŸå‹é“¾æ±¡æŸ“</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"QC4vvYPEM2BYGMlNkxfbdllW-gzGzoHsz","appKey":"nsnNub648pvsc3yts6pFQY1A","path":"window.location.pathname","placeholder":"ç•™è¨€å­","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://qc4vvype.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="website-duration">è½½å…¥ç½‘ç«™è¿è¡Œæ—¶é—´...</span> <script src="/js/duration.js"></script> </div>   
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
